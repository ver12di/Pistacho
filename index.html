<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雪茄品鉴评分主应用</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // 1. Tailwind CSS 配置
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <script>
        // 请确保这里的配置与您的 Firebase 项目配置完全一致
        const __app_id = 'pistacho-b9efe'; 

        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyDC-8qbWsjRyxBzJpfCi9n3ftzdg9FStF0", 
            authDomain: "pistacho-b9efe.firebaseapp.com",
            projectId: "pistacho-b9efe",
            storageBucket: "pistacho-b9efe.firebasestorage.app",
            messagingSenderId: "686695750713",
            appId: "1:686695750713:web:5314331be7b46e93f401e8",
            measurementId: "G-HQS7Q78LY7"
        });
    </script>
    
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global State and Setup ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        let db, auth;
        let ratingConfig = null; 
        let userRatings = {};    
        let userRole = 'unknown'; 
        let currentAuthUser = null; 
        
        const CONFIG_DOC_PATH = `/artifacts/${appId}/public/data/cigar_config/latest`;
        const USERS_COLLECTION_PATH = 'users'; 

        // 默认配置结构 (用于首次写入 Firestore)
        const defaultInitialConfig = {
            appTitle: "雪茄品鉴评分体系 V2.0 (默认配置)",
            description: "请点击右上角按钮修改配置。本评分体系基于主观印象权重，旨在提供一个详细且结构化的雪茄品鉴框架。",
            ratingCriteria: [
                {
                    category: "1. 外观与卷工",
                    detail: "雪茄的物理制造质量。",
                    criteriaList: [
                        { name: "茄标高级感", weight: 15, options: [{ description: "简陋", scorePct: 0.10 }, { description: "完美", scorePct: 1.00 }] },
                        { name: "卷工", weight: 15, options: [{ description: "不合格", scorePct: 0.10 }, { description: "正常", scorePct: 0.50 }, { description: "完美/精雕细琢", scorePct: 1.00 }] }
                    ]
                },
                {
                    category: "2. 燃烧与气道",
                    detail: "决定品鉴过程是否顺畅愉快的核心要素。",
                    criteriaList: [
                        { name: "吸阻", weight: 15, options: [{ description: "堵塞", scorePct: 0.0 }, { description: "完美", scorePct: 1.00 }] },
                        { name: "燃烧持续", weight: 50, options: [{ description: "不断补火", scorePct: 0.30 }, { description: "一根到底", scorePct: 1.00 }] }
                    ]
                }
            ]
        };

        // --- Utility Functions ---

        function calculateWeights(config) {
            let grandTotal = 0;
            config.ratingCriteria.forEach(category => {
                let categoryTotal = 0;
                category.criteriaList.forEach(criterion => {
                    categoryTotal += (criterion.weight || 0);
                });
                category.totalWeight = categoryTotal;
                grandTotal += categoryTotal;
            });
            config.totalWeightMax = grandTotal;
        }

        function calculateFinalScore() {
            if (!ratingConfig) return 0;
            let totalScore = 0;

            ratingConfig.ratingCriteria.forEach((category, catIndex) => {
                category.criteriaList.forEach((criterion, critIndex) => {
                    const id = `${catIndex}-${critIndex}`;
                    const selectedOptionIndex = userRatings[id];

                    if (selectedOptionIndex !== undefined && criterion.options[selectedOptionIndex]) {
                        const scorePct = criterion.options[selectedOptionIndex].scorePct;
                        const weightedScore = criterion.weight * scorePct;
                        totalScore += weightedScore;
                    }
                });
            });
            return totalScore;
        }

        // --- FIREBASE AUTHENTICATION & DATA LOADING ---
        
        /**
         * 关键函数：获取用户角色，如果非匿名用户角色文档不存在，则初始化为 'general'。
         */
        async function fetchUserRole(user) {
            const uid = user.uid;
            const roleDocRef = doc(db, USERS_COLLECTION_PATH, uid);
            
            try {
                const docSnap = await getDoc(roleDocRef);

                if (docSnap.exists() && docSnap.data().role) {
                    // 情况 A: 文档存在且包含角色信息，直接返回
                    return docSnap.data().role; 
                } 
                
                // 情况 B: 文档不存在或不包含角色字段
                if (!user.isAnonymous) {
                    // 只有非匿名用户（邮箱/密码用户）才需要初始化角色文档
                    console.log(`用户角色文档不存在 (${uid})，正在初始化为 'general'。`);
                    await setDoc(roleDocRef, { 
                        role: 'general',
                        email: user.email,
                        createdAt: new Date().toISOString()
                    }, { merge: true }); // 使用 merge: true 确保不会覆盖其他数据
                }

                // 无论是新创建的还是匿名的，如果文档没有 role 字段，默认角色都是 'general'
                return 'general'; 

            } catch (e) {
                console.warn("获取或设置用户角色失败，默认为 'general':", e);
                return 'general';
            }
        }
        
        /**
         * 登录/注册处理函数
         */
        window.handleLoginSignup = async function(isSignup) {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const loginStatus = document.getElementById('login-modal-status');
            loginStatus.textContent = isSignup ? '正在注册...' : '正在登录...';
            loginStatus.className = 'text-sm text-yellow-600 mt-2';

            try {
                if (isSignup) {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
                
                // 成功后关闭弹窗
                document.getElementById('login-modal').classList.add('hidden');
                loginStatus.textContent = ''; // 状态由 onAuthStateChanged 更新

            } catch (error) {
                const errorCode = error.code;
                let errorMessage = '发生错误。';
                if (errorCode.includes('auth/')) {
                    errorMessage = errorCode.replace('auth/', '').replace(/-/g, ' ').toUpperCase();
                } else {
                    errorMessage = error.message;
                }
                loginStatus.textContent = `失败: ${errorMessage}`;
                loginStatus.className = 'text-sm text-red-600 mt-2';
            }
        }

        /**
         * 退出登录处理函数
         */
        window.logout = async function() {
            try {
                await signOut(auth);
                // 登出后 onAuthStateChanged 会触发，自动处理UI更新和匿名登录。
            } catch (error) {
                console.error("Logout Error:", error);
            }
        }

        /**
         * 显示登录弹窗
         */
        window.showLoginModal = function() {
            document.getElementById('login-modal').classList.remove('hidden');
            document.getElementById('login-modal-status').textContent = '';
        }

        /**
         * 隐藏登录弹窗
         */
        window.hideLoginModal = function() {
            document.getElementById('login-modal').classList.add('hidden');
        }


        async function initFirebase() {
            if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId) {
                document.getElementById('app-container').innerHTML = `<div class="p-6 text-red-600 bg-red-100 rounded-lg max-w-xl mx-auto mt-10">🔴 Firebase 配置信息缺失。</div>`;
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 监听认证状态
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentAuthUser = user;

                        // 1. 获取用户角色（此函数现在包含初始化逻辑）
                        userRole = await fetchUserRole(user); 
                        
                        // 2. 渲染管理链接和登录状态
                        renderAdminLinks(); 
                        renderLoginStatus(user);
                        
                        // 3. 加载配置（所有认证用户都可以读取）
                        loadConfig(); 
                        
                        document.getElementById('config-load-status').textContent = `已认证。角色: ${userRole.toUpperCase()}`;

                    } else {
                        // 如果用户退出或未登录，尝试进行匿名登录
                        await signInAnonymously(auth);
                        document.getElementById('config-load-status').textContent = '正在进行匿名登录...';
                        
                        // 登出后重置状态
                        currentAuthUser = null;
                        userRole = 'general'; // 匿名用户默认是 general
                        renderAdminLinks(); 
                        renderLoginStatus(null);
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                document.getElementById('app-container').innerHTML = `<div class="p-6 text-red-600 bg-red-100 rounded-lg max-w-xl mx-auto mt-10">❌ Firebase 初始化失败：${error.message}</div>`;
            }
        }

        async function loadConfig() {
            const configDocRef = doc(db, CONFIG_DOC_PATH);
            const configStatusElement = document.getElementById('config-load-status');

            const docSnap = await getDoc(configDocRef);
            if (!docSnap.exists() || !docSnap.data().ratingCriteria) {
                const configToSave = JSON.parse(JSON.stringify(defaultInitialConfig));
                calculateWeights(configToSave);
                if (!docSnap.exists()) {
                    // 仅当文档不存在时才写入默认配置
                    await setDoc(configDocRef, configToSave);  
                }
                configStatusElement.textContent = `已自动加载默认配置。角色: ${userRole.toUpperCase()}`;
            }

            onSnapshot(configDocRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().ratingCriteria) {
                    ratingConfig = docSnap.data();
                    calculateWeights(ratingConfig);
                    renderRatingView(); 
                    configStatusElement.textContent = `配置已实时同步。角色: ${userRole.toUpperCase()}`;
                    configStatusElement.className = 'text-green-400';
                } else {
                    configStatusElement.textContent = '配置加载失败 (文档结构异常)';
                    configStatusElement.className = 'text-red-500';
                }
            }, (error) => {
                console.error("Error loading config:", error);
                configStatusElement.textContent = '配置实时监听失败';
                configStatusElement.className = 'text-red-500';
            });
        }

        // --- RATING VIEW LOGIC ---

        function renderAdminLinks() {
            const adminLinksContainer = document.getElementById('admin-links-container');
            let linksHtml = '';
            
            // 评分标准修改 (Admin 和 Super Admin 可见)
            if (userRole === 'admin' || userRole === 'super_admin') {
                linksHtml += `
                    <a href="cigar_rating_config.html"
                        class="flex items-center px-4 py-2 border border-white text-sm font-medium rounded-full shadow-sm text-white bg-indigo-600 hover:bg-indigo-500 transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        标准修改
                    </a>
                `;
            }

            // 用户角色管理 (Super Admin 可见)
            if (userRole === 'super_admin') {
                 linksHtml += `
                    <a href="role_management.html"
                        class="flex items-center px-4 py-2 border border-white text-sm font-medium rounded-full shadow-sm text-yellow-100 bg-purple-600 hover:bg-purple-500 transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                        角色管理
                    </a>
                `;
            }

            adminLinksContainer.innerHTML = linksHtml;
        }

        /**
         * 渲染登录状态和按钮
         */
        function renderLoginStatus(user) {
            const container = document.getElementById('login-status-container');
            if (user && user.email) {
                // 已登录 (Email/Password)
                container.innerHTML = `
                    <span class="text-sm font-medium text-yellow-300 mr-2 hidden sm:inline">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                        ${user.email}
                    </span>
                    <button onclick="logout()" class="px-3 py-1 text-xs font-medium rounded-full bg-red-500 text-white hover:bg-red-600 transition duration-150">
                        退出
                    </button>
                `;
            } else if (user && user.isAnonymous) {
                // 匿名登录
                 container.innerHTML = `
                    <span class="text-sm font-medium text-indigo-300 mr-2 hidden sm:inline">
                        当前为匿名用户
                    </span>
                    <button onclick="showLoginModal()" class="px-3 py-1 text-xs font-medium rounded-full bg-green-500 text-white hover:bg-green-600 transition duration-150">
                        登录/注册
                    </button>
                `;
            } else {
                // 未登录 (安全备用)
                 container.innerHTML = `
                    <button onclick="showLoginModal()" class="px-3 py-1 text-xs font-medium rounded-full bg-green-500 text-white hover:bg-green-600 transition duration-150">
                        登录/注册
                    </button>
                `;
            }
        }


        window.updateRatingSelection = function(catIndex, critIndex, optionIndex) {
            const id = `${catIndex}-${critIndex}`;
            userRatings[id] = optionIndex;
            renderRatingView(); 
        };

        function renderRatingView() {
            if (!ratingConfig) {
                document.getElementById('rating-form-container').innerHTML = `<p class="text-center text-gray-500 mt-10">正在加载评分配置...</p>`;
                return;
            }

            const totalScore = calculateFinalScore();
            
            // 1. Update Header / Score Display
            document.getElementById('app-title-display').textContent = ratingConfig.appTitle || '雪茄评分应用';
            document.getElementById('app-description-display').textContent = ratingConfig.description || '加载描述中...';
            document.getElementById('total-weight-max-display').textContent = ratingConfig.totalWeightMax || 0;
            
            const currentScoreDisplay = document.getElementById('current-score-display');
            currentScoreDisplay.textContent = totalScore.toFixed(2);
            currentScoreDisplay.classList.add('animate-pulse-score'); 
            setTimeout(() => {
                 currentScoreDisplay.classList.remove('animate-pulse-score'); 
            }, 500);

            // 2. Render Form
            const formContainer = document.getElementById('rating-form-container');
            formContainer.innerHTML = ratingConfig.ratingCriteria.map((category, catIndex) => `
                <div class="bg-white p-6 rounded-xl shadow-lg mb-8 border-l-4 border-indigo-500">
                    <h3 class="text-xl font-bold text-indigo-700 mb-2">${category.category} 
                        <span class="text-sm font-normal text-gray-500 ml-2">(${category.totalWeight.toFixed(2)} 分)</span>
                    </h3>
                    <p class="text-gray-500 text-sm mb-4">${category.detail || ''}</p>
                    
                    <div class="space-y-6">
                        ${category.criteriaList.map((criterion, critIndex) => renderRatingCriterion(catIndex, critIndex, criterion)).join('')}
                    </div>
                </div>
            `).join('');
        }

        function renderRatingCriterion(catIndex, critIndex, criterion) {
            const id = `${catIndex}-${critIndex}`;
            const selectedOptionIndex = userRatings[id];
            const currentWeight = criterion.weight || 0;

            let currentScore = 0;
            if (selectedOptionIndex !== undefined && criterion.options[selectedOptionIndex]) {
                currentScore = currentWeight * criterion.options[selectedOptionIndex].scorePct;
            }

            return `
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-lg font-semibold text-gray-800">${criterion.name} (${currentWeight} 分)</h4>
                        <span class="text-xl font-extrabold text-green-600">${currentScore.toFixed(2)}</span>
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2">
                        ${criterion.options.map((option, optIndex) => {
                            const isSelected = selectedOptionIndex === optIndex;
                            const score = (currentWeight * option.scorePct).toFixed(2);
                            return `
                                <button onclick="updateRatingSelection(${catIndex}, ${critIndex}, ${optIndex})" 
                                    class="p-2 text-sm text-center rounded-lg border transition duration-150 ${
                                        isSelected 
                                        ? 'bg-indigo-600 text-white shadow-md border-indigo-800' 
                                        : 'bg-white text-gray-700 hover:bg-indigo-50 border-gray-300'
                                    }">
                                    ${option.description} 
                                    <span class="block text-xs ${isSelected ? 'text-indigo-200' : 'text-gray-500'}">(得 ${score} 分)</span>
                                </button>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // --- Initialize on load ---
        window.onload = initFirebase;
    </script>
    <style>
        /* CSS for the score pulse animation */
        .animate-pulse-score {
            animation: pulse-score 0.5s ease;
        }
        @keyframes pulse-score {
            0% { transform: scale(1.0); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1.0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">

    <div id="app-container" class="max-w-6xl mx-auto p-4 md:p-8">

        <header class="mb-8 p-6 bg-indigo-700 text-white rounded-xl shadow-2xl relative">
            <h1 id="app-title-display" class="text-3xl font-extrabold mb-1">雪茄评分应用</h1>
            <p id="app-description-display" class="text-indigo-200 text-sm mb-4">加载描述中...</p>
            
            <div class="flex justify-between items-end">
                <div class="flex items-end space-x-2">
                    <span class="text-lg font-medium text-indigo-200">当前得分:</span>
                    <span id="current-score-display" class="rating-score-display text-6xl font-black leading-none">0.00</span>
                    <span class="text-lg font-medium text-indigo-200">/</span>
                    <span id="total-weight-max-display" class="text-lg font-medium text-indigo-200">0</span>
                    <span id="config-load-status" class="text-xs ml-4 text-yellow-300">正在加载配置...</span>
                </div>
                
                <div class="flex items-center space-x-3">
                    <div id="login-status-container" class="flex items-center">
                        </div>
                    <div id="admin-links-container" class="flex items-center space-x-3">
                        </div>
                </div>
            </div>
        </header>

        <div id="rating-form-container">
            <p class="text-center text-gray-500 mt-10">请等待配置加载...</p>
        </div>
        
        <footer class="mt-8 text-center text-gray-500 text-sm p-4 border-t">
            评分应用数据由云端配置中心实时同步。
        </footer>
    </div>

    <div id="login-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-indigo-700">登录或注册</h3>
            <label class="block mb-3">
                <span class="text-gray-700 text-sm">邮箱 (Email)</span>
                <input type="email" id="login-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="user@example.com">
            </label>
            <label class="block mb-4">
                <span class="text-gray-700 text-sm">密码 (Password)</span>
                <input type="password" id="login-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
            </label>
            
            <div class="flex space-x-3">
                <button onclick="handleLoginSignup(false)" class="flex-1 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150">
                    登录
                </button>
                <button onclick="handleLoginSignup(true)" class="flex-1 py-2 bg-gray-200 text-indigo-600 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">
                    注册
                </button>
            </div>
            
            <p id="login-modal-status" class="text-center mt-3"></p>
            
            <button onclick="hideLoginModal()" class="mt-4 text-sm text-gray-500 hover:text-gray-700 w-full">
                取消
            </button>
        </div>
    </div>

</body>
</html>
