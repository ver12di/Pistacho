<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雪茄评分配置管理 (Firestore Fix)</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div id="app" class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-3">雪茄评分配置管理</h1>
        <p class="text-gray-600 mb-6">
            您可以通过此界面保存或更新 **`cigar_rating_config.json`** 的内容到您的私有 Firestore 配置文档中。
            <br>
            <span class="font-semibold text-red-500">此文件已修复 Firebase 配置未提供的错误。</span>
        </p>

        <!-- 状态/消息显示区 -->
        <div id="status-message" class="p-3 mb-6 rounded-lg text-sm transition-all duration-300 hidden" role="alert"></div>

        <div class="space-y-4">
            <label for="config-json" class="block text-lg font-medium text-gray-700">配置 JSON 内容</label>
            <textarea id="config-json" rows="20" class="w-full p-4 border border-gray-300 rounded-lg shadow-inner focus:ring-blue-500 focus:border-blue-500 font-mono text-sm" placeholder="粘贴您的 JSON 配置..."></textarea>
            
            <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 sm:space-x-4">
                <button onclick="saveConfig()" id="save-button" class="w-full sm:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 ease-in-out disabled:opacity-50">
                    <span id="save-text">保存配置到 Firestore</span>
                    <span id="save-spinner" class="hidden animate-spin h-5 w-5 border-4 border-white border-t-transparent rounded-full ml-2"></span>
                </button>
                <div class="text-sm text-gray-500">
                    用户ID: <span id="user-id" class="font-mono text-gray-700">加载中...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase 初始化和业务逻辑 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let app;
        let db;
        let auth;
        let currentUserId = 'anonymous';

        // --- DOM Elements ---
        const statusEl = document.getElementById('status-message');
        const configTextArea = document.getElementById('config-json');
        const saveButton = document.getElementById('save-button');
        const saveText = document.getElementById('save-text');
        const saveSpinner = document.getElementById('save-spinner');
        const userIdEl = document.getElementById('user-id');

        // --- Firestore Paths and Document ID ---
        const CONFIG_COLLECTION_NAME = 'configuration';
        const CONFIG_DOC_ID = 'cigar_config';

        // 默认配置（用于首次加载或配置失败的场景）
        const DEFAULT_CONFIG_JSON = ${JSON.stringify(JSON.parse(document.getElementById('config-json') ? document.getElementById('config-json').value : '[]'), null, 2)};
        
        // **修复核心: 错误处理和初始化**
        function updateStatus(type, message, isSaving = false) {
            statusEl.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800');
            saveButton.disabled = isSaving;

            if (isSaving) {
                saveText.textContent = '保存中...';
                saveSpinner.classList.remove('hidden');
                statusEl.classList.add('bg-yellow-100', 'text-yellow-800');
            } else {
                saveText.textContent = '保存配置到 Firestore';
                saveSpinner.classList.add('hidden');
            }

            if (type === 'error') {
                statusEl.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'success') {
                statusEl.classList.add('bg-green-100', 'text-green-800');
            } else { // info or default
                statusEl.classList.add('bg-yellow-100', 'text-yellow-800');
            }

            statusEl.textContent = message;
        }

        /**
         * 初始化 Firebase, 处理配置和认证。
         */
        async function initFirebase() {
            // 确保使用 Canvas 提供的全局变量
            const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            
            try {
                const firebaseConfig = JSON.parse(firebaseConfigStr);

                // **关键检查点: 确保配置存在**
                if (Object.keys(firebaseConfig).length === 0) {
                    updateStatus('error', '致命错误：Firebase配置对象为空。无法连接数据库。');
                    configTextArea.value = JSON.stringify(DEFAULT_CONFIG_JSON, null, 2);
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 启用身份验证日志
                // setLogLevel('Debug'); 

                // 尝试使用 Canvas 提供的自定义令牌登录，否则匿名登录
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 监听认证状态变化
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdEl.textContent = currentUserId;
                        updateStatus('success', 'Firebase初始化和用户认证成功。', false);
                        loadConfig();
                    } else {
                        currentUserId = 'anonymous'; // Fallback
                        userIdEl.textContent = '匿名/未认证';
                        updateStatus('info', '已匿名登录，请尝试保存配置。', false);
                    }
                });

            } catch (e) {
                updateStatus('error', `Firebase初始化失败：${e.message}。请联系支持。`);
                console.error("Firebase Initialization Error:", e);
                configTextArea.value = JSON.stringify(DEFAULT_CONFIG_JSON, null, 2);
            }
        }

        /**
         * 从 Firestore 加载配置并显示
         */
        function loadConfig() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            if (!db || !currentUserId || appId === 'default-app-id') {
                updateStatus('error', '数据库或用户ID未准备好，无法加载配置。', false);
                return;
            }

            // 私有配置路径: /artifacts/{appId}/users/{userId}/configuration/{docId}
            const configDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/${CONFIG_COLLECTION_NAME}`, CONFIG_DOC_ID);
            
            // 使用 onSnapshot 实时监听配置变化
            onSnapshot(configDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const configData = docSnapshot.data().config;
                    configTextArea.value = JSON.stringify(configData, null, 2);
                    updateStatus('success', '配置加载成功。您可以修改后重新保存。');
                } else {
                    // 如果文档不存在，使用默认配置填充
                    configTextArea.value = JSON.stringify(DEFAULT_CONFIG_JSON, null, 2);
                    updateStatus('info', 'Firestore中找不到现有配置，已加载默认配置。请点击保存。');
                }
            }, (error) => {
                updateStatus('error', `加载配置失败: ${error.message}`);
                console.error("Load Config Error:", error);
            });
        }

        /**
         * 将配置保存到 Firestore
         */
        window.saveConfig = async function() {
            if (!db || !currentUserId) {
                updateStatus('error', '错误：数据库未初始化或用户未认证。请刷新页面重试。');
                return;
            }
            
            updateStatus('info', '正在保存...', true);

            let configObject;
            try {
                configObject = JSON.parse(configTextArea.value);
            } catch (e) {
                updateStatus('error', `JSON解析失败：请检查格式错误。${e.message}`);
                return;
            }

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const configDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/${CONFIG_COLLECTION_NAME}`, CONFIG_DOC_ID);
            
            try {
                // 使用 setDoc 写入数据（如果存在则覆盖，不存在则创建）
                await setDoc(configDocRef, { 
                    config: configObject, 
                    timestamp: new Date().toISOString() 
                });
                updateStatus('success', `配置成功保存到 Firestore! (${new Date().toLocaleTimeString()})`);
            } catch (error) {
                updateStatus('error', `保存到 Firestore 失败: ${error.message}`);
                console.error("Save Config Error:", error);
            }
        }

        // 页面加载完成后，初始化 Firebase
        window.onload = initFirebase;
        
        // 将默认 JSON 放入 textarea，以便用户看到内容
        configTextArea.value = JSON.stringify(DEFAULT_CONFIG_JSON, null, 2);

    </script>
</body>
</html>
