<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pistacho 评分社区</title> <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/i18next/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-http-backend/i18nextHttpBackend.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector/i18nextBrowserLanguageDetector.min.js"></script>

    <script>
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: {
                            sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                        },
                        aspectRatio: {
                            '1179/1572': '1179 / 1572',
                        },
                         fontSize: {
                            '2xs': ['0.625rem', { lineHeight: '0.8rem' }], // ~10px
                         }
                    }
                }
            }
        } else {
            console.warn('Tailwind object not found. Skipping config.');
        }
    </script>
    <style>
        .rating-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .nav-link { @apply block px-3 py-2 rounded-md text-base font-medium text-gray-600 hover:bg-gray-100 hover:text-indigo-600 transition-colors md:text-sm md:inline-block; }
        .nav-link-active { @apply block px-3 py-2 rounded-md text-base font-medium text-indigo-600 bg-indigo-50 font-semibold md:text-sm md:inline-block; }
        .main-container { padding-left: 0.75rem; padding-right: 0.75rem; padding-top: 1rem; padding-bottom: 2rem; margin-left: auto; margin-right: auto; }
        @media (min-width: 640px) { .main-container { padding-left: 1.5rem; padding-right: 1.5rem; } }
        @media (min-width: 768px) { .main-container { padding-left: 2rem; padding-right: 2rem; } }

        .line-clamp-2 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; }
        .line-clamp-1 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 1; }

        .action-buttons button { @apply py-1 px-3 text-xs rounded transition; }
        .action-buttons .btn-delete { @apply bg-red-500 text-white hover:bg-red-600; }
        .action-buttons .btn-certify { @apply bg-green-500 text-white hover:bg-green-600; }
        .action-buttons .btn-uncertify { @apply bg-yellow-600 text-white hover:bg-yellow-700; }
        .action-buttons .btn-pin { @apply bg-pink-500 text-white hover:bg-pink-600; }
        .action-buttons .btn-unpin { @apply bg-gray-500 text-white hover:bg-gray-600; }

        .pinned-indicator { position: absolute; top: 0.5rem; right: 0.5rem; background-color: #ec4899; color: white; padding: 0.1rem 0.5rem; border-radius: 9999px; font-size: 0.7rem; font-weight: bold; display: flex; align-items: center; z-index: 10; }
        .pinned-indicator svg { width: 0.7rem; height: 0.7rem; margin-right: 0.2rem; }

        .admin-actions details > summary {
             list-style: none;
             cursor: pointer;
             padding: 0.25rem 0;
             margin-top: 0.5rem;
             border-top: 1px solid #e5e7eb;
             font-size: 0.75rem;
             color: #4b5563;
             display: flex;
             justify-content: flex-end;
             align-items: center;
        }
        .admin-actions details > summary::-webkit-details-marker { display: none; }
        .admin-actions details > summary::after {
             content: '▶';
             font-size: 0.6em;
             margin-left: 0.25rem;
             transition: transform 0.2s;
        }
        .admin-actions details[open] > summary::after {
             transform: rotate(90deg);
        }
        .admin-actions details .action-buttons-content {
            margin-top: 0.5rem;
        }
        /* Style for language buttons */
        .lang-button {
            padding: 2px 6px;
            margin: 0 2px;
            border: 1px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem; /* text-xs */
            transition: background-color 0.2s, border-color 0.2s;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        .lang-button:hover {
            background-color: #e5e7eb; /* bg-gray-200 */
        }
        .lang-button.active {
            font-weight: bold;
            background-color: #e0e7ff; /* bg-indigo-100 */
            border-color: #a5b4fc; /* border-indigo-300 */
            color: #3730a3; /* text-indigo-800 */
            cursor: default;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="main-container max-w-7xl">
        <nav class="mb-6 bg-white p-3 rounded-lg shadow-sm">
             <div class="flex flex-wrap justify-between items-center">
                 <a href="index.html" class="text-base sm:text-lg font-bold text-indigo-600 whitespace-nowrap" data-i18n="nav.title">Pistacho评分</a>

                 <button id="menu-toggle" class="md:hidden p-2 rounded-md text-gray-500 hover:text-indigo-600 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500">
                     <svg class="h-6 w-6" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-8 6h8" />
                     </svg>
                 </button>

                 <div id="nav-links" class="hidden md:flex md:items-center md:space-x-1 w-full md:w-auto mt-4 md:mt-0">
                     <a href="index.html" class="nav-link-active" data-i18n="nav.community">社区动态</a>
                     <a href="rate.html" class="py-1.5 px-3 sm:py-2 sm:px-4 bg-green-500 text-white text-xs sm:text-sm font-semibold rounded-lg hover:bg-green-600 transition mx-2" data-i18n="nav.rate">去评分</a>
                     <a href="history.html" class="nav-link" data-i18n="nav.myRatings">我的评分</a>
                     <a href="certified.html" class="nav-link" data-i18n="nav.certified">认证评分</a>
                     <a id="config-admin-link" href="cigar_rating_config.html" class="nav-link hidden" data-i18n="nav.configAdmin">评分配置</a>
                 </div>

                 <div class="flex items-center ml-auto md:ml-0">
                    <div id="language-flags" class="flex items-center space-x-1 mr-2">
                        </div>
                    <div id="login-status-container" class="flex items-center"></div>
                 </div>
             </div>
        </nav>

        <div class="mb-6 bg-white p-4 rounded-lg shadow-sm flex flex-col md:flex-row gap-3 items-stretch md:items-center">
            <input type="text" id="search-input" data-i18n="indexPage.searchPlaceholder" placeholder="搜索雪茄名称, 产地, 尺寸, 点评, 用户..." class="flex-grow p-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-sm md:text-base">
            <select id="sort-select" class="p-3 border border-gray-300 rounded-md w-full md:w-auto text-sm md:text-base">
                <option value="latest" data-i18n="indexPage.sortLatest">最新发布</option>
                <option value="highest" data-i18n="indexPage.sortHighest">评分最高</option>
                <option value="lowest" data-i18n="indexPage.sortLowest">评分最低</option>
            </select>
            <button onclick="applyFilters()" class="py-3 px-5 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition w-full md:w-auto text-sm md:text-base" data-i18n="common.apply">应用</button>
        </div>

        <div id="ratings-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 md:gap-4">
            <p id="loading-message" class="col-span-full text-center text-gray-500 py-10" data-i18n="indexPage.loadingRatings">正在加载点评...</p>
        </div>

         <footer class="mt-8 text-center text-gray-500 text-sm">
             Pistacho 雪茄评分社区
         </footer>
    </div>

    <script type="module">
        let allRatings = [];
        let displayedRatings = {};
        let currentAuthUser = null;

        // --- i18n Functions ---
        async function initI18n() {
            return new Promise((resolve, reject) => {
                i18next
                    .use(i18nextHttpBackend)
                    .use(i18nextBrowserLanguageDetector)
                    .init({
                        fallbackLng: 'zh',
                        debug: true, // Keep debug on
                        ns: ['translation'],
                        defaultNS: 'translation',
                        backend: {
                            loadPath: '/locales/{{lng}}.json?v=1'
                        },
                        detection: {
                            order: ['localStorage', 'navigator'],
                            caches: ['localStorage']
                        }
                    }, (err, t) => {
                        if (err) {
                            console.error('i18next initialization failed:', err);
                            // Update title even on error, maybe show generic title
                            document.title = 'Pistacho Rating Community';
                            return reject(err); // Reject the promise
                        }
                        console.log('i18next initialized successfully.');
                        try {
                            updateContent(); // Perform initial update *inside* the callback
                            document.title = i18next.t('nav.title') + ' - ' + i18next.t('nav.community');
                            resolve(); // Resolve the promise
                        } catch (updateErr) {
                            console.error('Error during initial updateContent:', updateErr);
                            reject(updateErr); // Reject if update fails
                        }
                    });
            });
        }

        function updateContent() {
            console.log("Running updateContent...");
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                let value = ''; // Default to empty string
                try {
                     value = i18next.t(key); // Get translation
                     // Basic check if the value is still the key (translation missing)
                     if (value === key && key !== '') {
                         console.warn(`Translation missing for key: ${key}`);
                         // Optionally keep the key visible for debugging, or set to empty/default
                         // value = `[${key}]`; // Keep key visible
                     }
                } catch (e) {
                    console.error(`Error translating key "${key}":`, e);
                    // value = `[Error: ${key}]`; // Indicate error
                }


                // Exclude language buttons from direct update
                if (el.classList.contains('lang-button')) return;

                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    if (el.hasAttribute('placeholder')) el.placeholder = value;
                } else if (el.tagName === 'OPTION') {
                     el.textContent = value;
                }
                 else {
                    // Make sure value is a string before setting innerHTML
                    el.innerHTML = (typeof value === 'string' || typeof value === 'number') ? value : '';
                }
            });
            console.log("updateContent finished.");
        }

        function renderLanguageSwitcher() {
            const container = document.getElementById('language-flags');
            if (!container) return;
            container.innerHTML = '';
            const languages = ['zh', 'en', 'es'];
            // Ensure i18next is initialized before accessing language
            const currentLang = i18next.language ? i18next.language.split('-')[0] : 'zh';

            languages.forEach(lang => {
                const button = document.createElement('button');
                button.textContent = lang.toUpperCase();
                button.className = `lang-button ${lang === currentLang ? 'active' : ''}`;
                button.dataset.lang = lang;
                button.onclick = async (e) => {
                    const newLang = e.target.dataset.lang;
                    const oldLang = i18next.language ? i18next.language.split('-')[0] : 'zh';
                    if (newLang === oldLang) return;

                    console.log(`Changing language to: ${newLang}`);
                    try {
                        await i18next.changeLanguage(newLang);
                        console.log("Language changed, running updates...");
                        updateContent();
                        renderLanguageSwitcher();
                        renderLoginStatus(currentAuthUser);
                        renderAdminLinks();
                        // Re-fetch ratings if needed, or just re-render
                        // await fetchRatings(); // Could re-fetch if server sends localized data
                        applyFilters();      // Re-render grid based on current data
                        console.log("UI updates after language change finished.");
                    } catch (langErr) {
                        console.error(`Failed to change language to ${newLang}:`, langErr);
                    }
                };
                container.appendChild(button);
            });
        }
        // --- End i18n Functions ---


        window.handleStampError = function(imgElement) {
            console.warn('Certified stamp image failed to load.');
            imgElement.style.display = 'none';
        }

        // --- Element References --- (Moved getting elements here for clarity)
        const ratingsGrid = document.getElementById('ratings-grid');
        const loadingMessage = document.getElementById('loading-message');
        const searchInput = document.getElementById('search-input');
        const sortSelect = document.getElementById('sort-select');
        const menuToggle = document.getElementById('menu-toggle');
        const navLinks = document.getElementById('nav-links');
        // --- End Element References ---


        const AUTHING_APP_ID = '68f5b0b6875017c02b3bfdb3';
        const AUTHING_HOST = 'https://xfvu647mcdbk-demo.authing.cn';

        const GRADING_SCALE = [
            { "grade": "P", "nameKey": "resultsPage.grade.P", "min_score": 95, "color": "gold" },
            { "grade": "I", "nameKey": "resultsPage.grade.I", "min_score": 90, "color": "indigo" },
            { "grade": "S", "nameKey": "resultsPage.grade.S", "min_score": 80, "color": "purple" },
            { "grade": "T", "nameKey": "resultsPage.grade.T", "min_score": 70, "color": "blue" },
            { "grade": "A", "nameKey": "resultsPage.grade.A", "min_score": 60, "color": "green" },
            { "grade": "C", "nameKey": "resultsPage.grade.C", "min_score": 50, "color": "gray" },
            { "grade": "H", "nameKey": "resultsPage.grade.H", "min_score": 30, "color": "orange" },
            { "grade": "O", "nameKey": "resultsPage.grade.O", "min_score": 0, "color": "red" }
        ];

        // --- Authentication --- (Functions remain the same)
        window.login = function() {
            const redirectUri = window.location.origin;
            const authorizeUrl = new URL('/oidc/auth', AUTHING_HOST);
            authorizeUrl.search = new URLSearchParams({
                client_id: AUTHING_APP_ID,
                redirect_uri: redirectUri,
                response_type: 'code',
                scope: 'openid profile email phone',
                state: Math.random().toString(36).substring(2)
            }).toString();
            window.location.href = authorizeUrl.toString();
        }

        window.logout = function() {
            const logoutUrl = new URL('/oidc/session/end', AUTHING_HOST);
            logoutUrl.search = new URLSearchParams({
                post_logout_redirect_uri: window.location.origin
            }).toString();
            sessionStorage.removeItem('userInfo');
            sessionStorage.removeItem('accessToken');
            window.location.href = logoutUrl.toString();
        }

        function renderLoginStatus(user) {
            const container = document.getElementById('login-status-container');
            if (!container || !i18next.isInitialized) return; // Guard against premature call
            if (user) {
                const displayName = user.nickname || user.name || user.preferred_username || user.email || i18next.t('nav.login');
                container.innerHTML = `<span class="text-xs sm:text-sm font-medium text-gray-700 mr-2 hidden sm:inline">${displayName}</span><button onclick="logout()" class="px-3 py-1 text-xs font-medium rounded-full bg-red-500 text-white hover:bg-red-600">${i18next.t('nav.logout')}</button>`;
            } else {
                container.innerHTML = `<button onclick="login()" class="px-3 py-1 text-xs font-medium rounded-full bg-green-500 text-white hover:bg-green-600">${i18next.t('nav.login')}</button>`;
            }
        }

        function renderAdminLinks() {
            const configLink = document.getElementById('config-admin-link');
            if (!configLink || !i18next.isInitialized) return; // Guard
            configLink.classList.add('hidden');
            if (!currentAuthUser) return;

            const userRole = currentAuthUser.db_role;
            const isAdmin = userRole === 'admin' || userRole === 'super_admin';

            if (isAdmin) {
                configLink.classList.remove('hidden');
                configLink.textContent = i18next.t('nav.configAdmin');
            }
        }

        async function handleOidcCallback(code) {
            try {
                const redirectUri = window.location.origin;
                const apiUrl = new URL('/api/authing/callback', window.location.origin);
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code, redirect_uri: redirectUri })
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || '认证回调失败');
                }
                const fullUserProfile = await response.json();
                sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile));
                sessionStorage.setItem('accessToken', fullUserProfile.accessToken);
                return fullUserProfile;
            } catch (e) {
                console.error('认证回调处理失败:', e);
                // Use i18next only if initialized
                const errorMsg = i18next.isInitialized ? i18next.t('errors.loginFailed', { message: e.message }) : `Login failed: ${e.message}`;
                alert(errorMsg);
                sessionStorage.removeItem('userInfo');
                sessionStorage.removeItem('accessToken');
                return null;
            } finally {
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        async function validateSessionAndGetUser() {
            const token = sessionStorage.getItem('accessToken');
            if (!token) return null;
            try {
                const apiUrl = new URL('/api/me', window.location.origin);
                const response = await fetch(apiUrl, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    console.warn("Session validation failed:", response.status);
                    sessionStorage.removeItem('userInfo');
                    sessionStorage.removeItem('accessToken');
                    return null;
                }
                const fullUserProfile = await response.json();
                sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile));
                return fullUserProfile;
            } catch (e) {
                console.error("Session validation failed:", e);
                return null;
            }
        }
        // --- 认证功能结束 ---

        // --- Rating Actions (delete, certify, pin - remain the same) ---
        window.deleteRating = async function(ratingId, event) {
            event?.stopPropagation();
             if (!i18next.isInitialized) return; // Guard
            if (!confirm(i18next.t('common.confirmDeletion'))) { return; }
            const button = event ? (event.currentTarget || event.target) : null;
            const originalText = button ? button.textContent : i18next.t('common.delete');
            if (button) { button.textContent = i18next.t('common.loading'); button.disabled = true; }
            const token = sessionStorage.getItem('accessToken');
            if (!token) {
                alert(i18next.t('common.loginRequired'));
                if (button) { button.textContent = originalText; button.disabled = false; }
                return;
            }
            try {
                const apiUrl = new URL(`/api/ratings`, window.location.origin);
                const response = await fetch(apiUrl, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ ratingId: ratingId }) });
                const responseText = await response.text();
                let data;
                try { data = JSON.parse(responseText); } catch (parseError) { if (response.ok) { data = { success: true }; } else { data = { error: `Server returned invalid response (status ${response.status})` }; } }
                if (!response.ok) throw new Error(data?.error || `Delete failed (status ${response.status})`);
                const cardToRemove = document.getElementById(`rating-card-${ratingId}`);
                if (cardToRemove) { cardToRemove.style.transition = 'opacity 0.5s ease-out'; cardToRemove.style.opacity = '0'; setTimeout(() => cardToRemove.remove(), 500); }
                delete displayedRatings[ratingId];
                alert(i18next.t('common.deleteSuccess'));
            } catch (error) {
                console.error("[deleteRating @ index] Caught error:", error);
                alert(i18next.t('common.deleteFailed', { msg: error.message }));
                if (button) { button.textContent = originalText; button.disabled = false; }
            }
        }

        window.updateCertification = async function(ratingId, shouldCertify, event) {
            event?.stopPropagation();
             if (!i18next.isInitialized) return; // Guard
            const button = event ? (event.currentTarget || event.target) : null;
            const isCertifying = shouldCertify;
            const actionText = isCertifying ? i18next.t('common.certify') : i18next.t('common.uncertify');
            const originalText = button ? button.textContent : actionText;
            if (button) { button.textContent = i18next.t('common.loading'); button.disabled = true; }
            const token = sessionStorage.getItem('accessToken');
            if (!token) {
                alert(i18next.t('common.loginRequired'));
                if (button) { button.textContent = originalText; button.disabled = false; }
                return;
            }
            try {
                const apiUrl = new URL('/api/certify', window.location.origin);
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ ratingId: ratingId, certify: isCertifying }) });
                if (!response.ok) { let errorText = `${actionText} failed: ${response.status}`; try { const err = await response.json(); errorText = err.error || errorText; } catch(e){/*ignore*/} throw new Error(errorText); }
                const data = await response.json();
                if (displayedRatings[ratingId]) {
                    displayedRatings[ratingId].isCertified = isCertifying;
                    const cardElement = document.getElementById(`rating-card-${ratingId}`);
                    if (cardElement) { const newCard = createRatingCard(displayedRatings[ratingId]); cardElement.replaceWith(newCard); }
                }
                alert(i18next.t('common.opSuccess'));
            } catch (error) {
                console.error(`${actionText} failed:`, error);
                alert(i18next.t('common.opFailed', { msg: error.message }));
                if (button) { button.textContent = originalText; button.disabled = false; }
            }
        }

        window.updatePinStatus = async function(ratingId, shouldPin, event) {
            event?.stopPropagation();
             if (!i18next.isInitialized) return; // Guard
            const button = event ? (event.currentTarget || event.target) : null;
            const actionText = shouldPin ? i18next.t('common.pin') : i18next.t('common.unpin');
            const originalText = button ? button.textContent : actionText;
            if (button) { button.textContent = i18next.t('common.loading'); button.disabled = true; }
            const token = sessionStorage.getItem('accessToken');
            if (!token) {
                alert(i18next.t('common.loginRequired'));
                if (button) { button.textContent = originalText; button.disabled = false; }
                return;
            }
            try {
                const apiUrl = new URL('/api/pin', window.location.origin);
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ ratingId: ratingId, pin: shouldPin }) });
                if (!response.ok) { let errorText = `${actionText} failed: ${response.status}`; try { const err = await response.json(); errorText = err.error || errorText; } catch(e){/*ignore*/} throw new Error(errorText); }
                const data = await response.json();
                if (displayedRatings[ratingId]) {
                    displayedRatings[ratingId].isPinned = shouldPin;
                    const masterIndex = allRatings.findIndex(r => r.id === ratingId);
                    if(masterIndex > -1) allRatings[masterIndex].isPinned = shouldPin;
                    applyFilters(); // Re-sort and re-render the grid
                }
                alert(i18next.t('common.opSuccess'));
            } catch (error) {
                console.error(`${actionText} failed:`, error);
                alert(i18next.t('common.opFailed', { msg: error.message }));
                // Reset button state only on error, success re-renders
                if (button) { button.textContent = originalText; button.disabled = false; }
            }
        }
        // --- End Rating Actions ---

        // --- Data Fetching and Rendering ---
        async function fetchRatings() {
            // Guard: Make sure elements exist and i18n is ready
             if (!loadingMessage || !ratingsGrid || !i18next.isInitialized) {
                 console.error("fetchRatings called before DOM ready or i18n initialized.");
                 return;
             }
            loadingMessage.textContent = i18next.t('indexPage.loadingRatings');
            loadingMessage.style.display = 'block';
            ratingsGrid.innerHTML = ''; // Clear previous results
            try {
                const apiUrl = new URL('/api/ratings', window.location.origin);
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    let errorText = `Load failed: ${response.status}`;
                    try { const err = await response.json(); errorText = err.error || errorText; } catch (e) {}
                    throw new Error(errorText);
                }
                allRatings = await response.json();
                // Basic validation if data is array
                if (!Array.isArray(allRatings)) {
                    console.error("API did not return an array:", allRatings);
                    allRatings = []; // Reset to empty array
                    throw new Error("Invalid data received from server.");
                }

                displayedRatings = {};
                allRatings.forEach(r => displayedRatings[r.id] = r);
                applyFilters(); // Apply initial filter/sort and render
            } catch (error) {
                console.error("加载点评失败:", error);
                // Ensure loadingMessage is still accessible
                 if (loadingMessage) {
                    loadingMessage.textContent = i18next.t('indexPage.loadFailed', { msg: error.message });
                    loadingMessage.style.color = 'red';
                 } else {
                     // Fallback if loadingMessage somehow disappeared
                     ratingsGrid.innerHTML = `<p class="col-span-full text-center text-red-500 py-10">加载点评失败: ${error.message}</p>`;
                 }
            }
        }

        window.applyFilters = function() {
            // Guard: Make sure elements exist and i18n is ready
            if (!searchInput || !sortSelect || !ratingsGrid || !loadingMessage || !i18next.isInitialized) {
                console.error("applyFilters called before DOM ready or i18n initialized.");
                return;
            }
            const searchTerm = searchInput.value.toLowerCase().trim();
            const sortBy = sortSelect.value;

            // Ensure allRatings is an array before filtering
            if (!Array.isArray(allRatings)) {
                 console.error("Cannot filter ratings, data is not an array.");
                 renderGrid([]); // Render empty grid
                 return;
            }

            let filtered = allRatings.filter(rating => {
                // Add checks for potentially missing properties
                const nameMatch = rating?.cigarInfo?.name?.toLowerCase().includes(searchTerm);
                const originMatch = rating?.cigarInfo?.origin?.toLowerCase().includes(searchTerm);
                const sizeMatch = rating?.cigarInfo?.size?.toLowerCase().includes(searchTerm);
                const reviewMatch = rating?.cigarReview?.toLowerCase().includes(searchTerm);
                const authorMatch = rating?.userNickname?.toLowerCase().includes(searchTerm);
                return nameMatch || originMatch || sizeMatch || reviewMatch || authorMatch;
            });

            filtered.sort((a, b) => {
                const pinDiff = (b.isPinned || 0) - (a.isPinned || 0);
                if (sortBy === 'latest' && pinDiff !== 0) return pinDiff;
                if (sortBy === 'highest') return (b.normalizedScore ?? 0) - (a.normalizedScore ?? 0);
                if (sortBy === 'lowest') return (a.normalizedScore ?? 0) - (b.normalizedScore ?? 0);
                // Default: latest (pinned first)
                return pinDiff !== 0 ? pinDiff : (new Date(b.timestamp) - new Date(a.timestamp));
             });

            renderGrid(filtered);
        }

        function renderGrid(ratingsToRender) {
             // Guard
             if (!ratingsGrid || !loadingMessage || !i18next.isInitialized) return;

            ratingsGrid.innerHTML = '';
            if (!Array.isArray(ratingsToRender) || ratingsToRender.length === 0) {
                loadingMessage.textContent = i18next.t('indexPage.noMatches');
                loadingMessage.style.display = 'block';
                return;
            }
            loadingMessage.style.display = 'none';
            ratingsToRender.forEach(rating => {
                 // Basic check for rating ID
                 if (!rating || !rating.id) {
                     console.warn("Skipping rendering invalid rating object:", rating);
                     return;
                 }
                displayedRatings[rating.id] = rating;
                const card = createRatingCard(rating);
                if (card) { // createRatingCard might return null if data is bad
                     ratingsGrid.appendChild(card);
                }
            });
        }

        function createRatingCard(rating) {
            // Basic check for essential rating data
            if (!rating || !rating.id || !i18next.isInitialized) {
                console.warn("Cannot create card, invalid rating data or i18n not ready:", rating);
                return null; // Return null if data is invalid
            }

            const div = document.createElement('div');
            div.id = `rating-card-${rating.id}`;
            div.className = 'rating-card bg-white rounded-lg shadow-md overflow-hidden transition-all duration-300 cursor-pointer flex flex-col';
            div.onclick = (event) => {
                if (event.target.tagName === 'BUTTON' || event.target.closest('button, details')) {
                    return;
                }
                viewRatingDetails(rating.id);
            };

            const score = rating.normalizedScore !== undefined ? rating.normalizedScore.toFixed(2) : 'N/A';
            const author = rating.userNickname || rating.userEmail || i18next.t('common.anonymous');

            let coverImageUrl = null;
            if (Array.isArray(rating.imageUrl) && rating.imageUrl.length > 0) {
                coverImageUrl = rating.imageUrl[0];
            } else if (typeof rating.imageUrl === 'string' && rating.imageUrl) {
                 // Attempt to parse if it's a JSON string, otherwise assume it's a single key
                 try {
                     const parsed = JSON.parse(rating.imageUrl);
                     if (Array.isArray(parsed) && parsed.length > 0) {
                         coverImageUrl = parsed[0];
                     } else if (typeof parsed === 'string' && parsed) {
                          coverImageUrl = parsed; // Should not happen ideally
                     } else {
                         coverImageUrl = rating.imageUrl; // Fallback to using the string directly if parsing fails but it's not empty
                     }
                 } catch (e) {
                      coverImageUrl = rating.imageUrl; // Use string directly if parsing fails
                 }
            }


            const isCertified = rating.isCertified;
            const isPinned = rating.isPinned;
            const cacheBuster = `?t=${Date.now()}`;

            const isAdmin = currentAuthUser && (currentAuthUser.db_role === 'admin' || currentAuthUser.db_role === 'super_admin');
            let adminActionsHtml = '';
            if (isAdmin) {
                adminActionsHtml = `
                    <div class="admin-actions mt-1">
                        <details>
                            <summary>${i18next.t('common.adminActions')}</summary>
                            <div class="action-buttons-content action-buttons pt-2 border-t border-gray-100 flex items-center space-x-1 flex-wrap gap-1 justify-end">
                                <button onclick="deleteRating('${rating.id}', event)" class="btn-delete">${i18next.t('common.delete')}</button>
                                <button data-action="certify" onclick="updateCertification('${rating.id}', true, event)" class="btn-certify ${isCertified ? 'hidden' : ''}">${i18next.t('common.certify')}</button>
                                <button data-action="uncertify" onclick="updateCertification('${rating.id}', false, event)" class="btn-uncertify ${!isCertified ? 'hidden' : ''}">${i18next.t('common.uncertify')}</button>
                                <button data-action="pin" onclick="updatePinStatus('${rating.id}', true, event)" class="btn-pin ${isPinned ? 'hidden' : ''}">${i18next.t('common.pin')}</button>
                                <button data-action="unpin" onclick="updatePinStatus('${rating.id}', false, event)" class="btn-unpin ${!isPinned ? 'hidden' : ''}">${i18next.t('common.unpin')}</button>
                            </div>
                        </details>
                    </div>
                `;
            }

            const pinIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M9.03 2.5a.75.75 0 0 0-1.06 0l-4 4a.75.75 0 1 0 1.06 1.06L7 5.81v4.44a3.752 3.752 0 0 0-1.36.47l-1.88 1.1-.31.18a.75.75 0 0 0 .8 1.3l.3-.18 1.88-1.1a2.252 2.252 0 0 1 2.12 0l1.88 1.1.3.18a.75.75 0 0 0 .8-1.3l-.3-.18-1.88-1.1a3.752 3.752 0 0 0-1.36-.47V5.81l1.97 1.97a.75.75 0 1 0 1.06-1.06l-4-4Z"/></svg>`;

            div.innerHTML = `
                <div class="aspect-[1179/1572] w-full overflow-hidden flex-shrink-0 relative">
                     ${isPinned ? `<div class="pinned-indicator" title="${i18next.t('common.pin')}">${pinIconSvg} ${i18next.t('common.pin')}</div>` : ''}
                     ${isCertified ? `<img src="/Certifiedstamp.png${cacheBuster}" alt="Certified" class="absolute top-2 left-2 w-1/3 h-auto z-10" title="Pistacho 认证评分" onerror="handleStampError(this)">` : ''}
                     ${coverImageUrl ? `<img src="/api/image/${coverImageUrl}" alt="${rating.cigarInfo?.name || '雪茄图片'}" class="w-full h-full object-cover">` : `<div class="w-full h-full bg-gray-200 flex items-center justify-center text-gray-400 text-sm">${i18next.t('certifiedPage.noImage')}</div>`}
                </div>
                <div class="p-1.5 sm:p-2 flex-grow flex flex-col justify-between">
                     <div>
                         <h3 class="font-semibold text-xs sm:text-sm leading-tight line-clamp-1 mb-0.5" title="${rating.title || ''}"> ${rating.title || i18next.t('certifiedPage.noTitle')} </h3>
                         <p class="text-2xs sm:text-xs text-gray-500 line-clamp-1 mb-1" title="${rating.cigarInfo?.name || ''}"> ${rating.cigarInfo?.name || i18next.t('certifiedPage.unnamedCigar')} </p>
                     </div>
                     <div class="flex justify-between items-end mt-auto pt-0.5">
                         <span class="text-2xs sm:text-xs text-gray-500 line-clamp-1 flex items-center" title="${author}"> ${author} </span>
                         <div class="text-right flex-shrink-0"> <p class="font-bold text-indigo-600 text-sm sm:text-base leading-none">${score}</p> </div>
                     </div>
                     ${adminActionsHtml}
                </div>
            `;
            return div;
        }

        window.viewRatingDetails = function(ratingId) {
             // Guard
             if (!i18next.isInitialized) return;

            const ratingData = displayedRatings[ratingId];
            if (!ratingData) {
                console.error(`viewRatingDetails: Rating data not found in cache for ID: ${ratingId}`);
                alert(i18next.t('common.loadDetailFailed'));
                return;
            }
            let detailedData = {};
            const cigarInfo = ratingData.cigarInfo || { name: ratingData.cigarName, size: ratingData.cigarSize, origin: ratingData.cigarOrigin };

            const foundGrade = GRADING_SCALE.find(g => ratingData.normalizedScore >= g.min_score) || GRADING_SCALE[GRADING_SCALE.length - 1];
            const finalGrade = foundGrade ? {
                grade: foundGrade.grade,
                nameKey: foundGrade.nameKey,
                color: foundGrade.color
            } : null;

            if (!ratingData || ratingData.normalizedScore === undefined || !finalGrade || !cigarInfo || ratingData.title === undefined ) { // Check title defined
                console.error("viewRatingDetails: Essential data missing or couldn't be constructed!", {ratingData, finalGrade, cigarInfo});
                alert(i18next.t('resultsPage.loadErrorMissing'));
                return;
            }

            // Ensure imageUrls is always an array
            let imageUrls = [];
            if (Array.isArray(ratingData.imageUrl)) {
                 imageUrls = ratingData.imageUrl;
            } else if (typeof ratingData.imageUrl === 'string' && ratingData.imageUrl) {
                 try {
                     const parsed = JSON.parse(ratingData.imageUrl);
                     if (Array.isArray(parsed)) {
                         imageUrls = parsed;
                     } else if (typeof parsed === 'string' && parsed) {
                          imageUrls = [parsed]; // Treat as single key if parsing results in string
                     } else {
                         imageUrls = [ratingData.imageUrl]; // Use original string if parsing weird
                     }
                 } catch (e) {
                      imageUrls = [ratingData.imageUrl]; // Treat as single key if parsing fails
                 }
            }


            let selectedFlavors = [];
            if (ratingData.fullData && Array.isArray(ratingData.fullData.selectedFlavors)) {
                selectedFlavors = ratingData.fullData.selectedFlavors;
            } else if (Array.isArray(ratingData.selectedFlavors)) { // Fallback check
                selectedFlavors = ratingData.selectedFlavors;
            }

            const hasCompleteFullData = ratingData.fullData && ratingData.fullData.config && ratingData.fullData.ratings && ratingData.fullData.calculatedScore !== undefined;

            // Build detailedData object
            detailedData = {
                 ratingId: ratingData.id,
                 title: ratingData.title, // Already checked it exists
                 cigarInfo: cigarInfo,
                 cigarReview: ratingData.cigarReview || '', // Default to empty string
                 imageUrls: imageUrls, // Now guaranteed to be an array
                 normalizedScore: ratingData.normalizedScore,
                 finalGrade: finalGrade,
                 selectedFlavors: selectedFlavors,
                 timestamp: ratingData.timestamp,
                 userNickname: ratingData.userNickname,
                 userEmail: ratingData.userEmail,
                 isDraft: false // Ratings from index are never drafts
            };

            if (hasCompleteFullData) {
                 detailedData.config = ratingData.fullData.config;
                 detailedData.ratings = ratingData.fullData.ratings;
                 detailedData.calculatedScore = ratingData.fullData.calculatedScore;
            }

            try {
                 sessionStorage.setItem('cigarRatingResults', JSON.stringify(detailedData));
                 window.location.href = `results.html`;
            }
            catch (e) {
                console.error("Error setting sessionStorage:", e);
                alert(i18next.t('common.sessionStoreFailed'));
            }
        }
        // --- End Data Fetching and Rendering ---

        // ==================== Corrected window.onload ====================
        window.onload = async function() {
             console.log("window.onload started");
             try {
                 // 1. Initialize i18n (waits for callback including first updateContent)
                 console.log("Initializing i18n...");
                 await initI18n();
                 console.log("i18n initialized and first updateContent completed.");

                 // 2. Handle Authentication
                 console.log("Handling authentication...");
                 const urlParams = new URLSearchParams(window.location.search);
                 const code = urlParams.get('code');
                 let user = code ? await handleOidcCallback(code) : await validateSessionAndGetUser();
                 currentAuthUser = user;
                 console.log("Authentication handled. User:", currentAuthUser ? currentAuthUser.sub : 'None');

                 // 3. Render User UI (now that translations are ready)
                 console.log("Rendering user UI elements...");
                 renderLoginStatus(currentAuthUser);
                 renderAdminLinks();
                 renderLanguageSwitcher(); // Render language buttons
                 console.log("User UI elements rendered.");

                 // 4. Fetch Ratings (now that auth is potentially done and i18n ready)
                 console.log("Fetching ratings...");
                 // Ensure loading message is visible initially if not already set by i18n
                 if (loadingMessage && i18next.isInitialized) {
                    loadingMessage.textContent = i18next.t('indexPage.loadingRatings');
                    loadingMessage.style.display = 'block';
                 }
                 await fetchRatings();
                 console.log("Ratings fetch process completed."); // fetchRatings calls applyFilters/renderGrid

                 // 5. Add Event Listeners
                 console.log("Adding event listeners...");
                 // Ensure elements exist before adding listeners
                 if (searchInput) searchInput.addEventListener('keypress', function (e) { if (e.key === 'Enter') { applyFilters(); } });
                 if (sortSelect) sortSelect.addEventListener('change', applyFilters);
                 if (menuToggle && navLinks) {
                     menuToggle.addEventListener('click', () => {
                         navLinks.classList.toggle('hidden');
                     });
                 }
                 console.log("Event listeners added.");
                 console.log("window.onload finished successfully.");

             } catch (error) {
                 console.error("Initialization error in window.onload:", error);
                 // Display a user-friendly error message using i18n if available
                 let errorMsg = `页面加载初始化出错: ${error.message || error}`;
                 if (i18next.isInitialized) {
                     errorMsg = i18next.t('errors.initFailed', { msg: error.message || error });
                 }
                 if (loadingMessage) { // Check if loadingMessage exists
                    loadingMessage.textContent = errorMsg;
                    loadingMessage.style.color = 'red';
                    loadingMessage.style.display = 'block';
                 } else if (ratingsGrid) { // Fallback to grid if loading message gone
                    ratingsGrid.innerHTML = `<p class="col-span-full text-center text-red-500 py-10">${errorMsg}</p>`;
                 }
             }
        };
        // =============================================================
    </script>
</body>
</html>