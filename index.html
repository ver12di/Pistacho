<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pistacho 雪茄评分配置中心</title>
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase 导入 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase objects globally
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
        window.getDoc = getDoc;
        window.setLogLevel = setLogLevel;
    </script>
    <style>
        /* Custom styles */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background-color: #6366f1; border-radius: 2px; }
        .rating-input:checked + .rating-label {
            background-color: #4f46e5; 
            color: white;
            border-color: #4f46e5;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .tab-button.active {
            border-bottom: 4px solid #4f46e5;
            color: #4f46e5;
            font-weight: bold;
        }
        /* Style for JSON text area */
        #configJson {
            font-family: monospace;
            min-height: 500px;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased min-h-screen">

    <!-- 顶部固定标题栏和标签页切换 -->
    <header class="sticky top-0 z-20 bg-white shadow-xl">
        <div class="max-w-xl mx-auto py-3 px-4 sm:px-6 lg:px-8">
            <h1 class="text-2xl font-bold text-gray-800 tracking-wider">
                Pistacho 评分 <span class="text-indigo-500 text-sm">v2.0</span>
            </h1>
        </div>
        <!-- 标签页 -->
        <div class="max-w-xl mx-auto px-4 sm:px-6 lg:px-8 flex border-t border-gray-200">
            <button id="tabRating" onclick="switchTab('rating')" class="tab-button flex-1 py-3 text-center text-gray-500 hover:text-indigo-600 transition active">评分模式</button>
            <button id="tabConfig" onclick="switchTab('config')" class="tab-button flex-1 py-3 text-center text-gray-500 hover:text-indigo-600 transition">配置管理</button>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="max-w-xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
        
        <!-- 加载状态/错误提示 -->
        <div id="loadingStatus" class="p-6 text-center bg-yellow-100 text-yellow-800 rounded-xl shadow-lg mb-6">
            <p id="statusText">正在连接配置中心...</p>
        </div>

        <!-- 评分模式内容 -->
        <section id="ratingView" class="view-content">
            <form id="ratingForm" onsubmit="event.preventDefault(); calculateAndDisplayResults();">
                <!-- 1. 基本信息输入 -->
                <div class="mb-8 p-4 bg-white rounded-xl shadow-lg">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">雪茄基本信息 (记录用)</h2>
                    <div class="space-y-4">
                        <input type="text" id="brand" placeholder="品牌 Brand" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <input type="text" id="model" placeholder="型号 Model" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <input type="text" id="size" placeholder="尺寸 Size" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <input type="text" id="origin" placeholder="产地 Origin" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <!-- 2. 主观印象评分区 (动态生成) -->
                <div id="ratingInputs" class="space-y-6">
                    <!-- 评分项将由 JavaScript 动态插入 -->
                </div>

                <!-- 3. 提交按钮 -->
                <div class="mt-10 mb-20">
                    <button type="submit" class="w-full py-4 text-xl font-bold text-white bg-indigo-600 rounded-xl hover:bg-indigo-700 transition duration-150 shadow-lg shadow-indigo-300/50 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
                        计算 Pistacho 最终评分
                    </button>
                </div>
            </form>
        </section>

        <!-- 配置管理内容 -->
        <section id="configView" class="view-content hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Pistacho 评分配置 (JSON)</h2>
                <p class="text-sm text-gray-600 mb-4 bg-gray-50 p-3 rounded-lg border-l-4 border-yellow-500">
                    ⚠️ **警告:** 请确保 JSON 格式正确，否则将导致评分应用崩溃。请勿修改字段名 (如 `impression`, `weight`, `degrees`, `type`)。
                </p>
                <textarea id="configJson" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                
                <button onclick="saveConfigToFirestore()" class="w-full mt-4 py-3 text-lg font-bold text-white bg-green-600 rounded-xl hover:bg-green-700 transition duration-150 shadow-lg focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50">
                    保存配置到云端
                </button>
                <p id="saveMessage" class="mt-3 text-sm text-center text-green-700 hidden"></p>
            </div>
        </section>

        <!-- 4. 结果展示区 (初始隐藏) -->
        <section id="resultsSection" class="hidden fixed inset-0 bg-gray-100 z-30 overflow-y-auto pt-4 pb-20">
            <div class="p-4">
                <div class="bg-white rounded-xl shadow-2xl p-6 mb-6">
                    <h2 class="text-2xl font-extrabold text-indigo-600 mb-4">最终定级结果</h2>
                    
                    <div id="finalGradeDisplay" class="text-center mb-6 p-4 rounded-xl bg-gray-50 border border-gray-200">
                        <p class="text-sm text-gray-500">Pistacho 等级</p>
                        <div id="pistachoAcronymDisplay" class="flex justify-center items-end space-x-1 mb-2">
                        </div>
                        <p class="text-xl font-semibold" id="resultGradeName">---</p>
                    </div>

                    <div class="flex justify-between items-center bg-indigo-50 p-3 rounded-lg border-l-4 border-indigo-600">
                        <span class="text-gray-700 font-medium">总分数 (满分100)</span>
                        <span id="resultScore" class="text-2xl font-extrabold text-indigo-700">0.0</span>
                    </div>
                </div>

                <!-- 详细回顾与成就 -->
                <div class="bg-white rounded-xl shadow-2xl p-6 mb-6">
                    <h2 class="text-xl font-extrabold text-gray-800 mb-4 border-b pb-2">📝 详细回顾与成就</h2>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2 mt-4">雪茄信息回顾</h3>
                    <ul id="infoSummary" class="text-gray-600 space-y-2 list-none pl-0 mb-6 border-b pb-4">
                    </ul>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2 mt-4">🏆 获得的成就</h3>
                    <ul id="achievementList" class="space-y-2 text-sm text-gray-700 list-disc pl-5">
                    </ul>
                </div>
                
                <button onclick="document.getElementById('resultsSection').classList.add('hidden')" class="w-full py-3 text-lg font-bold text-indigo-600 bg-white border border-indigo-600 rounded-xl hover:bg-indigo-50 transition duration-150 shadow-md">
                    返回继续评价
                </button>
            </div>
        </section>
    </main>

    <!-- 核心数据和逻辑 -->
    <script>
        // =========================================================
        // 核心数据和 Firebase 配置
        // =========================================================

        let CIGAR_RATING_DATA = []; // 动态加载的评分数据
        let TOTAL_WEIGHT = 0; // 动态计算的总权重
        let isConfigLoaded = false;
        
        let app, db, auth;
        let userId;

        // Configuration path constants
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const CONFIG_DOC_PATH = `artifacts/${appId}/public/data/cigar_rating_config/main_config`;

        // Default configuration (used if Firestore is empty)
        const DEFAULT_RATING_DATA = [
            { impression: "茄标高级感", weight: 15, degrees: [{ level: "简陋", score: 0.10, achievement: "地摊货" }, { level: "中规中矩", score: 0.50, achievement: "礼品装" }, { level: "漂亮", score: 0.70, achievement: "奢侈品" }, { level: "高级感", score: 1.00, achievement: "大师馆藏" }], type: 'single' },
            { impression: "茄衣", weight: 15, degrees: [{ level: "简陋", score: 0.10, achievement: "廉价外套" }, { level: "中规中矩", score: 0.50, achievement: "正装出席" }, { level: "漂亮", score: 0.70, achievement: "丝绸触感" }, { level: "高级感", score: 1.00, achievement: "顶级皮具" }], type: 'single' },
            { impression: "卷工", weight: 15, degrees: [{ level: "不合格", score: 0.10, achievement: "匆忙赶工" }, { level: "正常", score: 0.50, achievement: "熟练工人" }, { level: "漂亮", score: 0.70, achievement: "精雕细琢" }, { level: "完美", score: 1.00, achievement: "浑然天成" }], type: 'single' },
            { impression: "吸阻", weight: 15, degrees: [{ level: "松", score: 0.50, achievement: "自由落体" }, { level: "完美", score: 1.00, achievement: "天选之吸" }, { level: "偏紧", score: 0.50, achievement: "倔强脾气" }, { level: "堵塞", score: 0.00, achievement: "物理绝缘" }], type: 'single' },
            { impression: "燃烧线", weight: 15, degrees: [{ level: "均匀", score: 1.00, achievement: "激光切割" }, { level: "略不均匀", score: 0.70, achievement: "艺术修饰" }, { level: "持续不均匀", score: 0.10, achievement: "自由发挥" }], type: 'single' },
            { impression: "前3口感觉", weight: 5, degrees: [{ level: "眼前一亮", score: 1.00, achievement: "开场爆棚" }, { level: "有期待", score: 0.70, achievement: "稳步升温" }, { level: "中规中矩", score: 0.50, achievement: "平淡如水" }, { level: "估计不怎么样", score: 0.10, achievement: "劝退警告" }], type: 'single' },
            { impression: "烟灰形态", weight: 10, degrees: [{ level: "完美可以尝试持茄", score: 1.00, achievement: "埃菲尔铁塔" }, { level: "需要主动弹", score: 0.70, achievement: "比萨斜塔" }, { level: "自动脱落", score: 0.30, achievement: "雷峰塔" }], type: 'single' },
            { impression: "第二香气宜人强度", weight: 15, degrees: [{ level: "没有", score: 0.00, achievement: "嗅觉失灵" }, { level: "一点点香", score: 0.30, achievement: "昙花一现" }, { level: "很香", score: 0.70, achievement: "芳香四溢" }, { level: "极香", score: 1.00, achievement: "香水喷雾" }], type: 'single' },
            { impression: "第二香气高级度", weight: 15, degrees: [{ level: "容易在其他茄获得", score: 0.30, achievement: "大众情人" }, { level: "不容易在其他茄获得但有偶碰到", score: 0.70, achievement: "偶然相遇" }, { level: "独特", score: 1.00, achievement: "独一无二" }], type: 'single' },
            { impression: "香气持续度", weight: 15, degrees: [{ level: "前段有", score: 0.333, achievement: "短暂闪光" }, { level: "中段有", score: 0.666, achievement: "稳健续航" }, { level: "后端有", score: 1.00, achievement: "陪伴到老" }], type: 'multi' },
            { impression: "多重（第三）香气", weight: 15, degrees: [{ level: "没有", score: 0.00, achievement: "单核处理" }, { level: "有", score: 1.00, achievement: "多核运行" }], type: 'single' },
            { impression: "多重（第三）香气持续度", weight: 15, degrees: [{ level: "前段有", score: 0.333, achievement: "尝鲜限定" }, { level: "中段有", score: 0.666, achievement: "深度体验" }, { level: "后端有", score: 1.00, achievement: "尾韵悠长" }], type: 'multi' },
            { impression: "三段变化", weight: 15, degrees: [{ level: "变化明显", score: 1.00, achievement: "过山车" }, { level: "似乎有变化", score: 0.50, achievement: "渐进变奏" }, { level: "始终如一", score: 0.10, achievement: "线性输出" }], type: 'single' },
            { impression: "燃烧持续", weight: 15, degrees: [{ level: "一根到底", score: 1.00, achievement: "永动机" }, { level: "偶尔补火", score: 0.70, achievement: "火力支援" }, { level: "不断补火", score: 0.30, achievement: "消防队员" }, { level: "点到试图放弃", score: 0.00, achievement: "劝退重来" }], type: 'single' },
            { impression: "烟雾量", weight: 15, degrees: [{ level: "没有", score: 0.00, achievement: "无烟区" }, { level: "少", score: 0.50, achievement: "隐士模式" }, { level: "正常", score: 1.00, achievement: "效率达人" }, { level: "浓", score: 0.80, achievement: "蒸汽列车" }, { level: "烟囱", score: 0.50, achievement: "火炬达人" }], type: 'single' },
            { impression: "尼古丁浓度", weight: 10, degrees: [{ level: "普通", score: 1.00, achievement: "基础挑战" }, { level: "困难", score: 0.90, achievement: "意志考验" }, { level: "噩梦", score: 0.70, achievement: "灵魂拷问" }, { level: "地狱", score: 0.30, achievement: "见阎王" }], type: 'single' },
            { impression: "过鼻顺畅度", weight: 15, degrees: [{ level: "无感", score: 0.50, achievement: "呼吸自如" }, { level: "柔顺", score: 1.00, achievement: "丝滑通行" }, { level: "略有刺激", score: 0.70, achievement: "鼻腔警报" }, { level: "辛辣", score: 0.30, achievement: "吃辣大赛" }], type: 'single' },
            { impression: "烟屁股抽完渴望度", weight: 10, degrees: [{ level: "马上想放弃", score: 0.00, achievement: "及时止损" }, { level: "抽到茄标", score: 0.30, achievement: "尊重标签" }, { level: "抽到烫手为止", score: 0.70, achievement: "极限挑战" }, { level: "抽到牙签烧完为止", score: 1.00, achievement: "榨干价值" }], type: 'single' },
            { impression: "获得容易度", weight: 10, degrees: [{ level: "容易", score: 1.00, achievement: "唾手可得" }, { level: "普通", score: 0.80, achievement: "市场流通" }, { level: "困难", score: 0.50, achievement: "预约排队" }, { level: "千载难逢", score: 0.30, achievement: "寻宝猎人" }], type: 'single' },
            { impression: "整体记忆度", weight: 15, degrees: [{ level: "芸芸众生", score: 0.00, achievement: "路人甲" }, { level: "略有印象", score: 0.30, achievement: "闪光一刻" }, { level: "念念不忘", score: 0.70, achievement: "午夜梦回" }, { level: "梦里寻她千百度", score: 1.00, achievement: "刻骨铭心" }], type: 'single' }
        ];

        // =========================================================
        // Firebase / Config Loading
        // =========================================================

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeAppAndAuth() {
            if (Object.keys(firebaseConfig).length === 0) {
                document.getElementById('statusText').textContent = '错误: Firebase 配置未提供。无法加载或保存配置。';
                return;
            }

            try {
                // setLogLevel('Debug'); // Enable for debugging
                app = window.initializeApp(firebaseConfig);
                db = window.getFirestore(app);
                auth = window.getAuth(app);

                const statusText = document.getElementById('statusText');
                
                if (typeof __initial_auth_token !== 'undefined') {
                    await window.signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await window.signInAnonymously(auth);
                }

                userId = auth.currentUser.uid;
                statusText.textContent = `认证成功 (UID: ${userId})，正在加载配置...`;
                
                // Start listening for configuration changes
                loadConfigListener();

            } catch (error) {
                console.error("Firebase Initialization or Auth Error:", error);
                document.getElementById('statusText').textContent = '错误: 认证或连接数据库失败。请检查控制台。';
            }
        }

        /**
         * Sets up a real-time listener for the rating configuration document.
         */
        function loadConfigListener() {
            const configDocRef = window.doc(db, CONFIG_DOC_PATH);

            window.onSnapshot(configDocRef, (docSnap) => {
                const statusElement = document.getElementById('loadingStatus');
                const statusText = document.getElementById('statusText');

                if (docSnap.exists() && docSnap.data().config) {
                    // Config found in Firestore
                    const configData = docSnap.data().config;
                    updateConfig(configData);
                    statusText.textContent = `配置加载成功 (${new Date(docSnap.data().lastUpdated).toLocaleString()})`;
                    statusElement.classList.replace('bg-yellow-100', 'bg-green-100');
                    statusElement.classList.replace('text-yellow-800', 'text-green-800');
                } else {
                    // No config found, use default and attempt to save it for the first time
                    console.warn("No config found in Firestore. Using default configuration and attempting to save it.");
                    updateConfig(DEFAULT_RATING_DATA);
                    statusText.textContent = '数据库配置为空，已使用默认配置。请切换到“配置管理”保存。';
                    statusElement.classList.replace('bg-yellow-100', 'bg-red-100');
                    statusElement.classList.replace('text-yellow-800', 'text-red-800');
                    
                    // Attempt to save default configuration if it's the initial load
                    if (!isConfigLoaded) {
                         // We don't save immediately here to avoid race conditions/unnecessary writes.
                         // User must explicitly save in the config view.
                    }
                }
                isConfigLoaded = true;
                
                // Update the config editor textarea
                document.getElementById('configJson').value = JSON.stringify(CIGAR_RATING_DATA, null, 2);
            }, (error) => {
                console.error("Firestore Listener Error:", error);
                statusText.textContent = '错误: 监听配置失败。请检查网络和权限。';
                statusElement.classList.replace('bg-yellow-100', 'bg-red-100');
                statusElement.classList.replace('text-yellow-800', 'text-red-800');
            });
        }

        /**
         * Updates global data variables and re-renders the rating form.
         */
        function updateConfig(newConfig) {
            CIGAR_RATING_DATA = newConfig;
            TOTAL_WEIGHT = CIGAR_RATING_DATA.reduce((sum, item) => sum + (item.weight || 0), 0);
            renderRatingForm();
        }

        /**
         * Saves the JSON content from the textarea to Firestore.
         */
        async function saveConfigToFirestore() {
            const jsonText = document.getElementById('configJson').value;
            const saveMsg = document.getElementById('saveMessage');
            saveMsg.classList.add('hidden');
            
            try {
                // 1. Validate and parse JSON
                const parsedConfig = JSON.parse(jsonText);
                if (!Array.isArray(parsedConfig) || parsedConfig.some(item => typeof item.impression !== 'string')) {
                    throw new Error("JSON 格式不正确，顶级结构应为数组，且每项应包含 'impression' 字段。");
                }

                // 2. Prepare data for Firestore
                const configDocRef = window.doc(db, CONFIG_DOC_PATH);
                const dataToSave = {
                    config: parsedConfig,
                    lastUpdated: Date.now(),
                    updatedBy: userId || 'anonymous'
                };
                
                // 3. Write to Firestore
                await window.setDoc(configDocRef, dataToSave);

                // 4. Success feedback
                saveMsg.textContent = '🎉 配置保存成功并已生效！';
                saveMsg.classList.remove('hidden');
                saveMsg.classList.add('text-green-700');
                saveMsg.classList.remove('text-red-700');

            } catch (error) {
                console.error("Save Configuration Error:", error);
                saveMsg.textContent = `❌ 保存失败: ${error.message || 'JSON 解析错误或数据库写入失败。'}`;
                saveMsg.classList.remove('hidden');
                saveMsg.classList.add('text-red-700');
                saveMsg.classList.remove('text-green-700');
            }
        }

        // =========================================================
        // UI & Tab Switching
        // =========================================================

        /**
         * Switches between the Rating View and the Config View.
         */
        function switchTab(viewName) {
            const ratingView = document.getElementById('ratingView');
            const configView = document.getElementById('configView');
            const tabRating = document.getElementById('tabRating');
            const tabConfig = document.getElementById('tabConfig');

            if (viewName === 'rating') {
                ratingView.classList.remove('hidden');
                configView.classList.add('hidden');
                tabRating.classList.add('active');
                tabConfig.classList.remove('active');
            } else {
                ratingView.classList.add('hidden');
                configView.classList.remove('hidden');
                tabRating.classList.remove('active');
                tabConfig.classList.add('active');
            }
        }

        // =========================================================
        // Rating Form Logic (Adapted from previous version)
        // =========================================================

        /**
         * Dynamically renders the rating form based on CIGAR_RATING_DATA.
         */
        function renderRatingForm() {
            const container = document.getElementById('ratingInputs');
            let html = '';

            // Guard clause if data is not loaded yet
            if (CIGAR_RATING_DATA.length === 0 && isConfigLoaded) {
                 container.innerHTML = '<p class="p-4 text-center text-red-700 bg-red-100 rounded-lg">配置数据为空或格式错误，请检查“配置管理”。</p>';
                 return;
            } else if (!isConfigLoaded) {
                 container.innerHTML = '<p class="p-4 text-center text-yellow-700 bg-yellow-100 rounded-lg">正在加载配置...</p>';
                 return;
            }

            CIGAR_RATING_DATA.forEach((item, index) => {
                const impressionId = `imp-${index}`;
                // Fallback for missing type (default to single)
                const inputType = item.type === 'multi' ? 'checkbox' : 'radio'; 
                const requiredAttr = item.type !== 'multi' ? 'required' : ''; 
                const multiSelectNote = item.type === 'multi' ? '<span class="text-sm text-red-600 font-bold ml-2">(可多选)</span>' : '';
                
                // Ensure item.weight is a valid number for display
                const weightDisplay = typeof item.weight === 'number' ? item.weight : '?';

                html += `
                    <div class="p-4 bg-white rounded-xl shadow-lg">
                        <h3 class="text-base font-semibold text-gray-800 mb-3 border-b pb-2">
                            ${item.impression} <span class="text-xs text-gray-500 font-normal"> (权重: ${weightDisplay})</span>
                            ${multiSelectNote}
                        </h3>
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                `;

                // Render degrees, ensuring item.degrees is an array
                if (Array.isArray(item.degrees)) {
                    item.degrees.forEach((degree, degIndex) => {
                        const uniqueId = `${impressionId}-${degIndex}`;
                        html += `
                            <div>
                                <input type="${inputType}" id="${uniqueId}" name="${item.impression}" value="${degree.level}" 
                                    class="rating-input hidden" ${requiredAttr}>
                                <label for="${uniqueId}" 
                                    class="rating-label block text-center p-2 border border-indigo-400 text-indigo-700 
                                    rounded-lg cursor-pointer transition duration-150 hover:bg-indigo-50 text-sm">
                                    ${degree.level}
                                </label>
                            </div>
                        `;
                    });
                }

                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        /**
         * Determines the Pistacho grade based on the final score.
         */
        function determinePistachoGrade(score) {
            if (score >= 95) return { grade: "P", name: "Perfection", chinese: "完美 / 臻品", color: "text-yellow-500" };
            if (score >= 90) return { grade: "I", name: "Iconic", chinese: "标志性 / 典范", color: "text-gray-500" };
            if (score >= 85) return { grade: "S", name: "Supreme", chinese: "至高 / 卓越", color: "text-amber-700" };
            if (score >= 80) return { grade: "T", name: "Treasured", chinese: "珍藏 / 珍爱", color: "text-blue-500" };
            if (score >= 70) return { grade: "A", name: "Acceptable", chinese: "可接受 / 合格", color: "text-green-600" };
            if (score >= 60) return { grade: "C", name: "Common", chinese: "普通 / 一般", color: "text-yellow-600" };
            if (score >= 40) return { grade: "H", name: "Hardship", chinese: "困难 / 缺陷多", color: "text-orange-600" };
            return { grade: "O", name: "Outright Failure", chinese: "彻底失败 / 不合格", color: "text-red-600" };
        }

        /**
         * Calculates the final score and displays the results.
         */
        function calculateAndDisplayResults() {
            // Check if configuration is loaded and valid
            if (CIGAR_RATING_DATA.length === 0 || TOTAL_WEIGHT === 0) {
                showCustomMessage('评分配置未加载或总权重为零。请检查“配置管理”后重试。');
                return;
            }

            let rawScoreSum = 0;
            let earnedAchievements = [];
            let allSingleItemsChecked = true;

            // 1. Iterate through configuration items
            for (const item of CIGAR_RATING_DATA) {
                const selectedInputs = document.querySelectorAll(`input[name="${item.impression}"]:checked`);
                let itemScoreMultiplier = 0;
                
                if (item.type === 'multi') {
                    // Multi-select logic (accumulate score, cap at 1.0)
                    if (selectedInputs.length > 0) {
                        let combinedAchievementParts = [];
                        
                        selectedInputs.forEach(input => {
                            const selectedDegree = item.degrees.find(d => d.level === input.value);
                            if (selectedDegree) {
                                itemScoreMultiplier += selectedDegree.score;
                                combinedAchievementParts.push(`${selectedDegree.achievement} (${selectedDegree.level})`);
                            }
                        });

                        if (combinedAchievementParts.length > 0) {
                            earnedAchievements.push({ impression: item.impression, achievement: combinedAchievementParts.join(' / ') });
                        }
                        
                        itemScoreMultiplier = Math.min(itemScoreMultiplier, 1.0);
                    }
                    
                } else {
                    // Single-select logic (must be checked for submission)
                    if (selectedInputs.length === 0) {
                        allSingleItemsChecked = false;
                        break; // Stop calculation
                    }
                    
                    const selectedDegree = item.degrees.find(d => d.level === selectedInputs[0].value);
                    
                    if (selectedDegree) {
                        itemScoreMultiplier = selectedDegree.score;
                        earnedAchievements.push({ impression: item.impression, achievement: selectedDegree.achievement });
                    }
                }
                
                // Add score (use item.weight as a fallback)
                const weight = item.weight || 0; 
                const itemScore = weight * itemScoreMultiplier;
                rawScoreSum += itemScore;
            }

            // 2. Check for required selections
            if (!allSingleItemsChecked) {
                showCustomMessage('请完成所有单选评分项的勾选，以便进行准确计算。');
                return;
            }

            // 3. Normalize score
            const finalScore = (rawScoreSum / TOTAL_WEIGHT) * 100;
            const roundedScore = Math.round(finalScore * 10) / 10;
            
            // 4. Determine Grade
            const finalGrade = determinePistachoGrade(roundedScore);

            // 5. Update and Show Results
            updateResultsDisplay(finalGrade, roundedScore, earnedAchievements);
            updateInfoSummary();
            document.getElementById('resultsSection').classList.remove('hidden');
        }

        /**
         * Updates the visual display of the PISTACHO acronym and final score.
         */
        function updateResultsDisplay(finalGrade, roundedScore, achievements) {
            const PISTACHO_ACRONYM = "PISTACHO";
            let acronymHtml = '';
            const mainGradeLetter = finalGrade.grade;

            for (const letter of PISTACHO_ACRONYM) {
                if (letter === mainGradeLetter) {
                    acronymHtml += `<span class="text-6xl font-black ${finalGrade.color} translate-y-0">${letter}</span>`;
                } else {
                    acronymHtml += `<span class="text-xl font-bold text-gray-400 transform translate-y-1">${letter}</span>`;
                }
            }
            
            document.getElementById('pistachoAcronymDisplay').innerHTML = acronymHtml;
            document.getElementById('resultGradeName').innerHTML = `${finalGrade.name} (${finalGrade.chinese})`;
            document.getElementById('resultScore').textContent = roundedScore.toFixed(1);

            const achievementList = document.getElementById('achievementList');
            achievementList.innerHTML = '';
            
            achievements.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `<span class="font-medium text-indigo-700">${item.impression}:</span> ${item.achievement}`;
                achievementList.appendChild(li);
            });
        }

        /**
         * Updates the summary of basic cigar information.
         */
        function updateInfoSummary() {
            const infoSummary = document.getElementById('infoSummary');
            infoSummary.innerHTML = `
                <li><span class="font-medium">品牌:</span> ${document.getElementById('brand').value || '未填写'}</li>
                <li><span class="font-medium">型号:</span> ${document.getElementById('model').value || '未填写'}</li>
                <li><span class="font-medium">尺寸:</span> ${document.getElementById('size').value || '未填写'}</li>
                <li><span class="font-medium">产地:</span> ${document.getElementById('origin').value || '未填写'}</li>
            `;
        }

        /**
         * Custom modal message box (replaces alert()).
         */
        function showCustomMessage(message) {
            console.error(message);
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            overlay.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm mx-4 transform transition-all scale-100">
                    <h4 class="text-xl font-bold text-red-600 mb-3">提示 (Notice)</h4>
                    <p class="text-gray-700 mb-6">${message}</p>
                    <button onclick="this.closest('.fixed').remove()" 
                        class="w-full py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        确认
                    </button>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        // Initialize Firebase and start loading config when the window loads
        window.onload = initializeAppAndAuth;
    </script>
</body>
</html>
