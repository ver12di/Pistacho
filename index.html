<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雪茄品鉴评分主应用</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                    },
                    transitionProperty: { 'width': 'width' }
                }
            }
        }
    </script>
    <script>
        const __app_id = 'pistacho-b9efe'; 
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyDC-8qbWsjRyxBzJpfCi9n3ftzdg9FStF0", 
            authDomain: "pistacho-b9efe.firebaseapp.com",
            projectId: "pistacho-b9efe",
            storageBucket: "pistacho-b9efe.firebasestorage.app",
            messagingSenderId: "686695750713",
            appId: "1:686695750713:web:5314331be7b46e93f401e8",
            measurementId: "G-HQS7Q78LY7"
        });
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        let db, auth;
        let ratingConfig = null; 
        let userRatings = {};    
        let userRole = 'unknown'; 
        let currentAuthUser = null; 
        let configUnsubscribe = null;
        
        const CONFIG_DOC_PATH = `/artifacts/${appId}/public/data/cigar_config/latest`;
        const USERS_COLLECTION_PATH = 'users';
        const RATINGS_COLLECTION_PATH = `/artifacts/${appId}/public/data/ratings`;

        // --- Utility Functions ---
        function calculateWeights(config) { /* ... same as before ... */ }
        function calculateFinalScore() { /* ... same as before ... */ }
        
        // --- Navigation ---
        window.showResults = async function() {
            if (!ratingConfig || Object.keys(userRatings).length === 0) {
                alert("请至少选择一个评分项后再查看报告。");
                return;
            }

            const cigarInfo = {
                name: document.getElementById('cigar-name').value || '未命名雪茄',
                size: document.getElementById('cigar-size').value || '未知尺寸',
                origin: document.getElementById('cigar-origin').value || '未知产地'
            };
            const cigarReview = document.getElementById('cigar-review').value || '无';
            const finalScore = calculateFinalScore();
            
            const resultsData = {
                config: ratingConfig,
                ratings: userRatings,
                calculatedScore: finalScore,
                cigarInfo: cigarInfo,
                cigarReview: cigarReview
            };
            
            // (*** 新增：保存到 Firestore ***)
            if (currentAuthUser) {
                const saveButton = document.querySelector('button[onclick="showResults()"]');
                saveButton.textContent = "正在保存...";
                saveButton.disabled = true;

                try {
                    const ratingToSave = {
                        userId: currentAuthUser.uid,
                        userEmail: currentAuthUser.email || 'Anonymous',
                        timestamp: serverTimestamp(),
                        ...resultsData 
                    };
                    await addDoc(collection(db, RATINGS_COLLECTION_PATH), ratingToSave);
                } catch (error) {
                    console.error("保存评分失败:", error);
                    alert(`保存评分记录失败: ${error.message}`);
                    saveButton.textContent = "查看完整评分报告";
                    saveButton.disabled = false;
                    return; // Abort if save fails
                }
            }
            
            // --- Then proceed to results page ---
            try {
                sessionStorage.setItem('cigarRatingResults', JSON.stringify(resultsData));
                window.location.href = 'results.html';
            } catch (e) {
                alert("无法保存会话数据。");
            }
        }
        
        // --- Other functions (reset, auth, init, loadConfig, rendering) ---
        // ... (All other functions remain the same as your latest correct version) ...
    </script>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">

    <div id="app-container" class="max-w-6xl mx-auto p-4 md:p-8">

        <!-- (*** 新增：导航栏 ***) -->
        <nav class="mb-4 flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
             <a href="index.html" class="text-xl font-bold text-indigo-600">Pistacho评分</a>
             <div class="space-x-4">
                 <a href="history.html" class="text-gray-600 hover:text-indigo-600">历史记录</a>
                 <a href="certified.html" class="text-gray-600 hover:text-indigo-600">认证评分</a>
             </div>
        </nav>

        <header class="mb-8 p-6 bg-indigo-700 text-white rounded-xl shadow-2xl">
            <!-- Header content (same as your latest version) -->
        </header>

        <section class="mb-8 p-6 bg-white rounded-xl shadow-lg">
            <!-- Cigar Info inputs (same as your latest version) -->
        </section>

        <div id="rating-form-container">
            <!-- Rating form rendered here -->
        </div>

        <section class="mt-8 p-6 bg-white rounded-xl shadow-lg">
            <!-- Cigar review textarea (same as your latest version) -->
        </section>
        
        <div class="mt-8 grid grid-cols-2 gap-4">
            <!-- Reset and Show Results buttons (same as your latest version) -->
        </div>
        
        <footer class="mt-8 text-center text-gray-500 text-sm p-4 border-t">
            <!-- Footer content (same as your latest version) -->
        </footer>
    </div>

    <div id="login-modal" class="fixed inset-0 ...">
       <!-- Login Modal Content (same as your latest version) -->
    </div>

</body>
</html>

