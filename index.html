<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›ªèŒ„å“é‰´è¯„åˆ†ä¸»åº”ç”¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // 1. Tailwind CSS é…ç½®
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <script>
        // åº”ç”¨ç¨‹åº ID - ç”¨äºæ„å»º Firestore è·¯å¾„ï¼š/artifacts/{appId}/...
        const __app_id = 'cigar-score-pro-v2-production'; // <-- å»ºè®®ä¿®æ”¹

        // æ‚¨çš„ Firebase é¡¹ç›®é…ç½® (ä½œä¸º JSON å­—ç¬¦ä¸²)
        // ** è¯·å°†ä»¥ä¸‹å ä½ç¬¦æ›¿æ¢ä¸ºæ‚¨ Firebase é¡¹ç›®çš„çœŸå®é…ç½®ï¼**
        const __firebase_config = JSON.stringify({
            apiKey: "YOUR_FIREBASE_API_KEY", 
            authDomain: "your-project-id.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project-id.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:abcdef1234567890",
            // measurementId å¯é€‰
        });
        
        // å¦‚æœæ‚¨ä½¿ç”¨è‡ªå®šä¹‰ä»¤ç‰Œè®¤è¯ï¼Œå¯ä»¥åœ¨æ­¤è®¾ç½®ï¼š
        // const __initial_auth_token = 'YOUR_CUSTOM_TOKEN_HERE'; 
    </script>
    
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global State and Setup ---
        // è¿™äº›å˜é‡ç°åœ¨åº”è¯¥ç”±ä¸Šæ–¹çš„ <script> å—æä¾›
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        let db, auth;
        let ratingConfig = null; // Stores the configuration loaded from Firestore
        let userRatings = {};    // Stores the user's current selections for the rating session
        
        const CONFIG_DOC_PATH = `/artifacts/${appId}/public/data/cigar_config/latest`;
        
        // Initial configuration structure (Used for first-time setup)
        const defaultInitialConfig = {
            appTitle: "é›ªèŒ„å“é‰´è¯„åˆ†ä½“ç³» V2.0 (é»˜è®¤é…ç½®)",
            description: "è¯·ç‚¹å‡»å³ä¸Šè§’æŒ‰é’®ä¿®æ”¹é…ç½®ã€‚æœ¬è¯„åˆ†ä½“ç³»åŸºäºä¸»è§‚å°è±¡æƒé‡ï¼Œæ—¨åœ¨æä¾›ä¸€ä¸ªè¯¦ç»†ä¸”ç»“æ„åŒ–çš„é›ªèŒ„å“é‰´æ¡†æ¶ã€‚",
            ratingCriteria: [
                {
                    category: "1. å¤–è§‚ä¸å·å·¥",
                    detail: "é›ªèŒ„çš„ç‰©ç†åˆ¶é€ è´¨é‡ã€‚",
                    criteriaList: [
                        { name: "èŒ„æ ‡é«˜çº§æ„Ÿ", weight: 15, options: [{ description: "ç®€é™‹", scorePct: 0.10 }, { description: "å®Œç¾", scorePct: 1.00 }] },
                        { name: "å·å·¥", weight: 15, options: [{ description: "ä¸åˆæ ¼", scorePct: 0.10 }, { description: "æ­£å¸¸", scorePct: 0.50 }, { description: "å®Œç¾/ç²¾é›•ç»†ç¢", scorePct: 1.00 }] }
                    ]
                },
                {
                    category: "2. ç‡ƒçƒ§ä¸æ°”é“",
                    detail: "å†³å®šå“é‰´è¿‡ç¨‹æ˜¯å¦é¡ºç•…æ„‰å¿«çš„æ ¸å¿ƒè¦ç´ ã€‚",
                    criteriaList: [
                        { name: "å¸é˜»", weight: 15, options: [{ description: "å µå¡", scorePct: 0.0 }, { description: "å®Œç¾", scorePct: 1.00 }] },
                        { name: "ç‡ƒçƒ§æŒç»­", weight: 50, options: [{ description: "ä¸æ–­è¡¥ç«", scorePct: 0.30 }, { description: "ä¸€æ ¹åˆ°åº•", scorePct: 1.00 }] }
                    ]
                }
            ]
        };

        // --- Utility Functions ---

        /**
         * è®¡ç®—é…ç½®ä¸­æ‰€æœ‰è¯„åˆ†æ ‡å‡†å’Œç±»åˆ«çš„æœ€å¤§æ€»æƒé‡ã€‚
         * @param {object} config - è¯„åˆ†é…ç½®å¯¹è±¡ã€‚
         */
        function calculateWeights(config) {
            let grandTotal = 0;
            config.ratingCriteria.forEach(category => {
                let categoryTotal = 0;
                category.criteriaList.forEach(criterion => {
                    categoryTotal += (criterion.weight || 0);
                });
                category.totalWeight = categoryTotal;
                grandTotal += categoryTotal;
            });
            config.totalWeightMax = grandTotal;
        }

        /**
         * è®¡ç®—ç”¨æˆ·å½“å‰é€‰æ‹©çš„æ€»å¾—åˆ†ã€‚
         * @returns {number} æœ€ç»ˆå¾—åˆ†ã€‚
         */
        function calculateFinalScore() {
            if (!ratingConfig) return 0;
            let totalScore = 0;

            ratingConfig.ratingCriteria.forEach((category, catIndex) => {
                category.criteriaList.forEach((criterion, critIndex) => {
                    const id = `${catIndex}-${critIndex}`;
                    const selectedOptionIndex = userRatings[id];

                    if (selectedOptionIndex !== undefined && criterion.options[selectedOptionIndex]) {
                        const scorePct = criterion.options[selectedOptionIndex].scorePct;
                        const weightedScore = criterion.weight * scorePct;
                        totalScore += weightedScore;
                    }
                });
            });
            return totalScore;
        }

        // --- FIREBASE AND DATA LOADING ---

        /**
         * åˆå§‹åŒ– Firebase åº”ç”¨ã€è®¤è¯å’Œ Firestoreã€‚
         */
        async function initFirebase() {
            // æ£€æŸ¥é…ç½®æ˜¯å¦ç¼ºå¤±
            if (Object.keys(firebaseConfig).length === 0) {
                document.getElementById('app-container').innerHTML = `<div class="p-6 text-red-600 bg-red-100 rounded-lg max-w-xl mx-auto mt-10">ğŸ”´ Firebase é…ç½®ä¿¡æ¯ç¼ºå¤±ã€‚è¯·æ£€æŸ¥ç¯å¢ƒè®¾ç½®è„šæœ¬ã€‚</div>`;
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // è®¤è¯
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    await signInWithCustomToken(auth, token);
                } else {
                    await signInAnonymously(auth);
                }
                
                loadConfig();

            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                document.getElementById('app-container').innerHTML = `<div class="p-6 text-red-600 bg-red-100 rounded-lg max-w-xl mx-auto mt-10">âŒ Firebase åˆå§‹åŒ–å¤±è´¥ï¼š${error.message}</div>`;
            }
        }

        /**
         * ä» Firestore åŠ è½½é…ç½®ï¼Œå¹¶è®¾ç½®å®æ—¶ç›‘å¬ã€‚
         */
        async function loadConfig() {
            const configDocRef = doc(db, CONFIG_DOC_PATH);
            const configStatusElement = document.getElementById('config-load-status');

            // 1. æ£€æŸ¥æ–‡æ¡£æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™å†™å…¥é»˜è®¤é…ç½®
            const docSnap = await getDoc(configDocRef);
            if (!docSnap.exists() || !docSnap.data().ratingCriteria) {
                const configToSave = JSON.parse(JSON.stringify(defaultInitialConfig));
                calculateWeights(configToSave);
                // ä»…åœ¨æ–‡æ¡£ä¸å­˜åœ¨æ—¶å†™å…¥ï¼Œé¿å…ä¸å¿…è¦çš„å†™å…¥æ“ä½œ
                if (!docSnap.exists()) {
                    await setDoc(configDocRef, configToSave);  
                }
                configStatusElement.textContent = 'å·²è‡ªåŠ¨åŠ è½½é»˜è®¤é…ç½®';
                configStatusElement.className = 'text-yellow-300';
            }

            // 2. å®æ—¶ç›‘å¬é…ç½®æ›´æ–°
            onSnapshot(configDocRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().ratingCriteria) {
                    ratingConfig = docSnap.data();
                    calculateWeights(ratingConfig);
                    renderRatingView(); 
                    configStatusElement.textContent = 'é…ç½®å·²å®æ—¶åŒæ­¥';
                    configStatusElement.className = 'text-green-400';
                } else {
                    configStatusElement.textContent = 'é…ç½®åŠ è½½å¤±è´¥ (æ–‡æ¡£ç»“æ„å¼‚å¸¸)';
                    configStatusElement.className = 'text-red-500';
                }
            }, (error) => {
                console.error("Error loading config:", error);
                configStatusElement.textContent = 'é…ç½®å®æ—¶ç›‘å¬å¤±è´¥';
                configStatusElement.className = 'text-red-500';
            });
        }

        // --- RATING VIEW LOGIC ---

        /**
         * æ›´æ–°ç”¨æˆ·é€‰æ‹©å¹¶è§¦å‘è§†å›¾åˆ·æ–°ã€‚
         * è¿™æ˜¯ä¸€ä¸ªå…¨å±€å‡½æ•°ï¼Œç”±è¯„åˆ†æŒ‰é’®çš„ onclick äº‹ä»¶è°ƒç”¨ã€‚
         * @param {number} catIndex - ç±»åˆ«ç´¢å¼•ã€‚
         * @param {number} critIndex - æ ‡å‡†ç´¢å¼•ã€‚
         * @param {number} optionIndex - é€‰é¡¹ç´¢å¼•ã€‚
         */
        window.updateRatingSelection = function(catIndex, critIndex, optionIndex) {
            const id = `${catIndex}-${critIndex}`;
            userRatings[id] = optionIndex;
            renderRatingView(); 
        };

        /**
         * æ¸²æŸ“æ•´ä¸ªè¯„åˆ†è§†å›¾ï¼šæ›´æ–°å¾—åˆ†æ˜¾ç¤ºå’Œé‡æ–°ç”Ÿæˆè¡¨å•ã€‚
         */
        function renderRatingView() {
            if (!ratingConfig) {
                document.getElementById('rating-form-container').innerHTML = `<p class="text-center text-gray-500 mt-10">æ­£åœ¨åŠ è½½è¯„åˆ†é…ç½®...</p>`;
                return;
            }

            const totalScore = calculateFinalScore();
            
            // 1. Update Header / Score Display
            document.getElementById('app-title-display').textContent = ratingConfig.appTitle || 'é›ªèŒ„è¯„åˆ†åº”ç”¨';
            document.getElementById('app-description-display').textContent = ratingConfig.description || 'åŠ è½½æè¿°ä¸­...';
            document.getElementById('total-weight-max-display').textContent = ratingConfig.totalWeightMax || 0;
            
            const currentScoreDisplay = document.getElementById('current-score-display');
            currentScoreDisplay.textContent = totalScore.toFixed(2);
            // æ¯æ¬¡å¾—åˆ†å˜åŒ–æ—¶è§¦å‘åŠ¨ç”»
            currentScoreDisplay.classList.add('animate-pulse-score'); 
            setTimeout(() => {
                 currentScoreDisplay.classList.remove('animate-pulse-score'); 
            }, 500);


            // 2. Render Form
            const formContainer = document.getElementById('rating-form-container');
            formContainer.innerHTML = ratingConfig.ratingCriteria.map((category, catIndex) => `
                <div class="bg-white p-6 rounded-xl shadow-lg mb-8 border-l-4 border-indigo-500">
                    <h3 class="text-xl font-bold text-indigo-700 mb-2">${category.category} 
                        <span class="text-sm font-normal text-gray-500 ml-2">(${category.totalWeight} åˆ†)</span>
                    </h3>
                    <p class="text-gray-500 text-sm mb-4">${category.detail || ''}</p>
                    
                    <div class="space-y-6">
                        ${category.criteriaList.map((criterion, critIndex) => renderRatingCriterion(catIndex, critIndex, criterion)).join('')}
                    </div>
                </div>
            `).join('');
        }

        /**
         * æ¸²æŸ“å•ä¸ªè¯„åˆ†æ ‡å‡†ï¼ˆCriteriaï¼‰çš„ HTML å—ã€‚
         */
        function renderRatingCriterion(catIndex, critIndex, criterion) {
            const id = `${catIndex}-${critIndex}`;
            const selectedOptionIndex = userRatings[id];
            const currentWeight = criterion.weight || 0;

            let currentScore = 0;
            if (selectedOptionIndex !== undefined && criterion.options[selectedOptionIndex]) {
                currentScore = currentWeight * criterion.options[selectedOptionIndex].scorePct;
            }

            return `
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-lg font-semibold text-gray-800">${criterion.name} (${currentWeight} åˆ†)</h4>
                        <span class="text-xl font-extrabold text-green-600">${currentScore.toFixed(2)}</span>
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2">
                        ${criterion.options.map((option, optIndex) => {
                            const isSelected = selectedOptionIndex === optIndex;
                            const score = (currentWeight * option.scorePct).toFixed(2);
                            return `
                                <button onclick="updateRatingSelection(${catIndex}, ${critIndex}, ${optIndex})" 
                                    class="p-2 text-sm text-center rounded-lg border transition duration-150 ${
                                        isSelected 
                                        ? 'bg-indigo-600 text-white shadow-md border-indigo-800' 
                                        : 'bg-white text-gray-700 hover:bg-indigo-50 border-gray-300'
                                    }">
                                    ${option.description} 
                                    <span class="block text-xs ${isSelected ? 'text-indigo-200' : 'text-gray-500'}">(å¾— ${score} åˆ†)</span>
                                </button>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // --- Initialize on load ---
        window.onload = initFirebase;
    </script>
    <style>
        /* CSS for the score pulse animation */
        .animate-pulse-score {
            animation: pulse-score 0.5s ease;
        }
        @keyframes pulse-score {
            0% { transform: scale(1.0); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1.0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">

    <div id="app-container" class="max-w-6xl mx-auto p-4 md:p-8">

        <header class="mb-8 p-6 bg-indigo-700 text-white rounded-xl shadow-2xl relative">
            <h1 id="app-title-display" class="text-3xl font-extrabold mb-1">é›ªèŒ„è¯„åˆ†åº”ç”¨</h1>
            <p id="app-description-display" class="text-indigo-200 text-sm mb-4">åŠ è½½æè¿°ä¸­...</p>
            
            <div class="flex justify-between items-end">
                <div class="flex items-end space-x-2">
                    <span class="text-lg font-medium text-indigo-200">å½“å‰å¾—åˆ†:</span>
                    <span id="current-score-display" class="rating-score-display text-6xl font-black leading-none">0.00</span>
                    <span class="text-lg font-medium text-indigo-200">/</span>
                    <span id="total-weight-max-display" class="text-lg font-medium text-indigo-200">0</span>
                    <span id="config-load-status" class="text-xs ml-4 text-yellow-300">æ­£åœ¨åŠ è½½é…ç½®...</span>
                </div>
                
                <a href="cigar_rating_config.html"
                    class="flex items-center px-4 py-2 border border-white text-sm font-medium rounded-full shadow-sm text-white bg-indigo-600 hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                    è¯„åˆ†æ ‡å‡†ä¿®æ”¹
                </a>
            </div>
        </header>

        <div id="rating-form-container">
            <p class="text-center text-gray-500 mt-10">è¯·ç­‰å¾…é…ç½®åŠ è½½...</p>
        </div>
        
        <footer class="mt-8 text-center text-gray-500 text-sm p-4 border-t">
            è¯„åˆ†åº”ç”¨æ•°æ®ç”±äº‘ç«¯é…ç½®ä¸­å¿ƒå®æ—¶åŒæ­¥ã€‚
        </footer>
    </div>

</body>
</html>
