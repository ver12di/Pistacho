<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pistacho 评分社区 (首页)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: {
                            sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                        },
                        aspectRatio: {
                            '1/1': '1 / 1', // 确保 1:1 比例可用
                        }
                    }
                }
            }
        } else {
             console.warn('Tailwind object not found. Skipping config.');
        }
    </script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <!-- **NAVBAR UPDATED for new structure** -->
        <nav class="mb-6 flex flex-wrap justify-between items-center bg-white p-3 rounded-lg shadow-sm gap-4">
            <a href="index.html" class="text-xl font-bold text-indigo-600">Pistacho评分</a>
            <div class="flex items-center space-x-4 flex-grow justify-center md:justify-start md:flex-grow-0 order-3 md:order-2 w-full md:w-auto">
                <!-- Highlight current page -->
                <a href="index.html" class="text-indigo-600 font-bold underline">社区动态</a>
                <a href="rate.html" class="py-2 px-4 bg-green-500 text-white text-sm font-semibold rounded-lg hover:bg-green-600 transition">去评分</a>
                <a href="history.html" class="text-gray-600 hover:text-indigo-600">我的点评历史</a>
                <a href="certified.html" class="text-gray-600 hover:text-indigo-600">认证评分</a>
            </div>
            <div id="login-status-container" class="flex items-center order-2 md:order-3">
                 <!-- Login/Logout button will be rendered here -->
            </div>
        </nav>
        <!-- **END NAVBAR UPDATE** -->

        <header class="mb-6">
            <h1 class="text-4xl font-extrabold text-gray-800">社区动态</h1>
            <p class="mt-2 text-lg text-gray-600">发现和分享大家的雪茄品鉴体验。</p>
        </header>

        <!-- 搜索和排序 -->
        <div class="mb-6 p-4 bg-white rounded-lg shadow-sm flex flex-col md:flex-row gap-4">
            <div class="flex-grow">
                <label for="search-input" class="sr-only">搜索点评</label>
                <input type="text" id="search-input" placeholder="搜索雪茄名称、产地或点评..." class="w-full p-2 border border-gray-300 rounded-lg">
            </div>
            <div class="flex-shrink-0">
                <label for="sort-select" class="sr-only">排序方式</label>
                <select id="sort-select" class="w-full md:w-auto p-2 border border-gray-300 rounded-lg">
                    <option value="latest">最新发布</option>
                    <option value="score_desc">分数最高</option>
                    <option value="score_asc">分数最低</option>
                </select>
            </div>
        </div>

        <!-- 评分网格 -->
        <div id="ratings-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
            <!-- 加载提示 -->
            <p id="loading-message" class="text-center text-gray-500 col-span-full">正在加载动态...</p>
        </div>
    </div>

    <script type="module">
        let allRatings = []; // 存储从 API 获取的原始数据
        let currentAuthUser = null; // 存储当前用户信息

        const AUTHING_APP_ID = '68f5b0b6875017c02b3bfdb3';
        const AUTHING_HOST = 'https://xfvu647mcdbk-demo.authing.cn';

        // --- 1. 认证逻辑 (用于导航栏) ---
        window.login = function() {
            const redirectUri = window.location.origin;
            const authorizeUrl = new URL('/oidc/auth', AUTHING_HOST);
            authorizeUrl.search = new URLSearchParams({
                client_id: AUTHING_APP_ID,
                redirect_uri: redirectUri,
                response_type: 'code',
                scope: 'openid profile email phone',
                state: Math.random().toString(36).substring(2)
            }).toString();
            window.location.href = authorizeUrl.toString();
        }

        window.logout = function() {
             const logoutUrl = new URL('/oidc/session/end', AUTHING_HOST);
             logoutUrl.search = new URLSearchParams({
                post_logout_redirect_uri: window.location.origin
             }).toString();
             sessionStorage.removeItem('userInfo');
             sessionStorage.removeItem('accessToken');
             window.location.href = logoutUrl.toString();
        }

        function renderLoginStatus(user) {
            const container = document.getElementById('login-status-container');
            if (!container) return;
            if (user) {
                const displayName = user.nickname || user.name || user.preferred_username || user.email || '已登录';
                container.innerHTML = `<span class="text-sm font-medium text-gray-700 mr-2 hidden sm:inline">${displayName}</span><button onclick="logout()" class="px-3 py-1 text-xs font-medium rounded-full bg-red-500 text-white hover:bg-red-600">退出</button>`;
            } else {
                container.innerHTML = `<button onclick="login()" class="px-3 py-1 text-xs font-medium rounded-full bg-green-500 text-white hover:bg-green-600">登录/注册</button>`;
            }
        }

        async function handleOidcCallback(code) {
             try {
                const redirectUri = window.location.origin;
                // **FIX**: Use absolute URL
                const apiUrl = new URL('/api/authing/callback', window.location.origin);
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code, redirect_uri: redirectUri })
                });
                if (!response.ok) {
                    const err = await response.json(); throw new Error(err.error || '认证回调失败');
                }
                const fullUserProfile = await response.json();
                sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile));
                sessionStorage.setItem('accessToken', fullUserProfile.accessToken);
                return fullUserProfile;
            } catch (e) {
                console.error('认证回调处理失败:', e); alert(`登录失败: ${e.message}`);
                sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken'); return null;
            } finally {
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        async function validateSessionAndGetUser() {
            const token = sessionStorage.getItem('accessToken'); if (!token) return null;
            try {
                // **FIX**: Use absolute URL
                const apiUrl = new URL('/api/me', window.location.origin);
                const response = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) {
                    sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken'); return null;
                }
                const fullUserProfile = await response.json();
                sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile)); return fullUserProfile;
            } catch (e) { console.error("Session validation failed:", e); return null; }
        }
        // --- 结束认证逻辑 ---


        // --- 2. 数据获取和渲染 ---
        async function fetchRatings() {
            const grid = document.getElementById('ratings-grid');
            const loadingMsg = document.getElementById('loading-message');
            try {
                // **FIX**: Use absolute URL
                const apiUrl = new URL('/api/ratings', window.location.origin);
                // **NEW**: Add public flag for community page
                apiUrl.searchParams.set('public', 'true');
                
                const response = await fetch(apiUrl); // No token needed for public view
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || '加载评分失败');
                }
                allRatings = await response.json();
                
                if (loadingMsg) loadingMsg.style.display = 'none'; // 隐藏加载提示
                
                if (allRatings.length === 0) {
                    grid.innerHTML = '<p class="text-center text-gray-500 col-span-full">还没有任何点评，快去<a href="rate.html" class="text-indigo-600 underline">发布第一条</a>吧！</p>';
                    return;
                }
                
                renderRatingGrid(allRatings); // 初始渲染
                
            } catch (e) {
                console.error("Fetch ratings error:", e);
                if (loadingMsg) loadingMsg.textContent = `加载失败: ${e.message}`;
            }
        }

        function renderRatingGrid(ratings) {
            const grid = document.getElementById('ratings-grid');
            grid.innerHTML = ''; // 清空
            
            ratings.forEach(rating => {
                const card = document.createElement('a');
                card.href = `results.html`; // 链接到结果页
                card.className = "block bg-white rounded-lg shadow-md overflow-hidden transition-shadow hover:shadow-lg";
                
                // 点击卡片时，保存数据到 sessionStorage
                card.onclick = (e) => {
                    e.preventDefault(); // 阻止立即跳转
                    if (rating.fullData && typeof rating.fullData === 'object') {
                       const detailedData = {
                          config: rating.fullData.config,
                          ratings: rating.fullData.ratings,
                          calculatedScore: rating.fullData.calculatedScore,
                          cigarInfo: rating.cigarInfo,
                          cigarReview: rating.cigarReview,
                          imageUrl: rating.imageUrl,
                          normalizedScore: rating.normalizedScore,
                          finalGrade: rating.finalGrade,
                          timestamp: rating.timestamp,
                          userNickname: rating.userNickname,
                          userEmail: rating.userEmail,
                          isDraft: false
                       };
                       sessionStorage.setItem('cigarRatingResults', JSON.stringify(detailedData));
                       window.location.href = `results.html`;
                    } else {
                        alert("无法查看详情，数据不完整。");
                    }
                };

                const date = rating.timestamp ? new Date(rating.timestamp).toLocaleDateString('zh-CN') : '';
                const author = rating.userNickname || rating.userEmail || '匿名';
                const score = rating.normalizedScore?.toFixed(2) || 'N/A';

                card.innerHTML = `
                    <!-- 强制 1:1 正方形图片 -->
                    <div class="w-full aspect-square bg-gray-200">
                        ${rating.imageUrl ? 
                            `<img src="/api/image/${rating.imageUrl}" alt="${rating.cigarInfo?.name || '雪茄图片'}" class="w-full h-full object-cover">` : 
                            '<div class="w-full h-full flex items-center justify-center text-gray-400 text-sm">无图片</div>'
                        }
                    </div>
                    
                    <div class="p-4">
                        <div class="flex justify-between items-center mb-1">
                            <h3 class="font-bold text-lg text-gray-900 truncate" title="${rating.cigarInfo?.name || ''}">${rating.cigarInfo?.name || '未命名'}</h3>
                            <span class="font-bold text-lg text-indigo-600 ml-2">${score}</span>
                        </div>
                        
                        <!-- 评级 -->
                        <p class="font-semibold text-sm text-gray-600 mb-2">
                            ${rating.finalGrade?.grade || ''} - ${rating.finalGrade?.name_cn || '未评级'}
                        </p>
                        
                        <!-- 文字评价 (截断) -->
                        <p class="text-sm text-gray-700 h-10 overflow-hidden text-ellipsis">
                            ${rating.cigarReview || '用户未填写评价。'}
                        </p>
                        
                        <!-- 作者和日期 -->
                        <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-100">
                            <span class="text-xs text-gray-500 truncate" title="${author}">${author}</span>
                            <span class="text-xs text-gray-400 flex-shrink-0 ml-2">${date}</span>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        // --- 3. 搜索和排序逻辑 ---
        function filterAndSort() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const sortValue = document.getElementById('sort-select').value;
            
            let filtered = allRatings;

            // 过滤
            if (searchTerm) {
                filtered = allRatings.filter(rating => 
                    (rating.cigarInfo?.name?.toLowerCase().includes(searchTerm)) ||
                    (rating.cigarInfo?.origin?.toLowerCase().includes(searchTerm)) ||
                    (rating.cigarReview?.toLowerCase().includes(searchTerm)) ||
                    (rating.userNickname?.toLowerCase().includes(searchTerm))
                );
            }
            
            // 排序
            switch (sortValue) {
                case 'score_desc':
                    filtered.sort((a, b) => (b.normalizedScore || 0) - (a.normalizedScore || 0));
                    break;
                case 'score_asc':
                    filtered.sort((a, b) => (a.normalizedScore || 0) - (b.normalizedScore || 0));
                    break;
                case 'latest':
                default:
                    filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    break;
            }
            
            renderRatingGrid(filtered);
        }

        // --- 4. 启动函数 ---
        window.onload = async function() {
            // 绑定事件
            document.getElementById('search-input').addEventListener('input', filterAndSort);
            document.getElementById('sort-select').addEventListener('change', filterAndSort);

            // 处理登录
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            let user = null;

            if (code) {
                user = await handleOidcCallback(code);
            } else {
                user = await validateSessionAndGetUser();
            }
            currentAuthUser = user;
            renderLoginStatus(currentAuthUser);
            
            // 加载数据
            await fetchRatings();
        };
    </script>
</body>
</html>

