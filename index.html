<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pistacho 评分社区</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: {
                            sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                        },
                        aspectRatio: {
                            '1179/1572': '1179 / 1572',
                        },
                         fontSize: {
                            '2xs': ['0.625rem', { lineHeight: '0.8rem' }], // ~10px
                         }
                    }
                }
            }
        } else {
            console.warn('Tailwind object not found. Skipping config.');
        }
    </script>
    <style>
        .rating-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .nav-link { @apply px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100 hover:text-indigo-600 transition-colors; }
        .nav-link-active { @apply px-3 py-2 rounded-md text-sm font-medium text-indigo-600 bg-indigo-50 font-semibold; }
        .main-container { padding-left: 1rem; padding-right: 1rem; padding-top: 1rem; padding-bottom: 2rem; margin-left: auto; margin-right: auto; }
        @media (min-width: 768px) { .main-container { padding-left: 2rem; padding-right: 2rem; padding-bottom: 2rem; } }

        .line-clamp-2 {
             overflow: hidden;
             display: -webkit-box;
             -webkit-box-orient: vertical;
             -webkit-line-clamp: 2;
        }
        .line-clamp-1 {
             overflow: hidden;
             display: -webkit-box;
             -webkit-box-orient: vertical;
             -webkit-line-clamp: 1;
        }

    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="main-container">
        <!-- Navbar --><nav class="mb-6 flex flex-wrap justify-between items-center bg-white p-3 rounded-lg shadow-sm gap-4 max-w-7xl mx-auto">
             <a href="index.html" class="text-lg font-bold text-indigo-600 whitespace-nowrap">Pistacho Cigar Rating System ｜ Pistacho雪茄评分</a>
             <div class="flex items-center space-x-1 flex-grow justify-center md:justify-start md:flex-grow-0 order-3 md:order-2 w-full md:w-auto">
                 <a href="index.html" class="nav-link-active">社区动态</a>
                 <a href="rate.html" class="py-2 px-4 bg-green-500 text-white text-sm font-semibold rounded-lg hover:bg-green-600 transition mx-2">去评分</a>
                 <a href="history.html" class="nav-link">我的点评历史</a>
                 <a href="certified.html" class="nav-link">认证评分</a>
             </div>
             <div id="login-status-container" class="flex items-center order-2 md:order-3"></div>
        </nav>

        <!-- Header --><header class="mb-6 max-w-7xl mx-auto">
            <h1 class="text-4xl font-extrabold text-gray-800 text-center">社区动态</h1>
            <p class="mt-2 text-lg text-gray-600 text-center">发现大家的精彩点评</p>
        </header>

        <!-- Search and Sort Controls --><div class="mb-6 bg-white p-4 rounded-lg shadow-sm flex flex-col md:flex-row gap-4 items-center max-w-7xl mx-auto">
            <input type="text" id="search-input" placeholder="搜索雪茄名称, 产地, 尺寸, 点评, 用户..." class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
            <select id="sort-select" class="p-2 border border-gray-300 rounded-md">
                <option value="latest">最新发布</option>
                <option value="highest">评分最高</option>
                <option value="lowest">评分最低</option>
            </select>
            <button onclick="applyFilters()" class="py-2 px-5 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition w-full md:w-auto">应用</button>
        </div>

        <!-- Ratings Grid --><div id="ratings-grid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-6">
            <p id="loading-message" class="col-span-full text-center text-gray-500 py-10">正在加载点评...</p>
        </div>

         <footer class="mt-8 text-center text-gray-500 text-sm">
             Pistacho 雪茄评分社区
         </footer>
    </div>

    <script type="module">
        let allRatings = [];
        let displayedRatings = [];
        let currentAuthUser = null;
        
        // **NEW** 调试函数，用于处理徽章加载失败
        window.handleStampError = function(imgElement) {
            console.error('[Debug] 认证徽章加载失败。尝试的路径:', imgElement.src);
            // 隐藏损坏的图片图标
            imgElement.style.display = 'none';
            
            // 添加一个备用的文字徽章
            try {
                const fallback = document.createElement('span');
                fallback.className = 'absolute top-1 left-1 bg-yellow-500 text-white text-xs font-bold px-2 py-1 rounded-full z-10';
                fallback.textContent = '认证';
                if (imgElement.parentNode) {
                    imgElement.parentNode.appendChild(fallback);
                } else {
                    console.error('[Debug] 无法找到父节点来添加备用徽章。');
                }
            } catch (e) {
                console.error('[Debug] 创建备用徽章时出错:', e);
            }
        }


        const ratingsGrid = document.getElementById('ratings-grid');
        const loadingMessage = document.getElementById('loading-message');
        const searchInput = document.getElementById('search-input');
        const sortSelect = document.getElementById('sort-select');

        const AUTHING_APP_ID = '68f5b0b6875017c02b3bfdb3';
        const AUTHING_HOST = 'https://xfvu647mcdbk-demo.authing.cn';

        // **NEW**: Grading scale needed to reconstruct finalGrade object
        const GRADING_SCALE = [
          { "grade": "P", "name_en": "Pinnacle", "name_cn": "顶峰 / 登峰造极", "min_score": 95, "color": "gold" },
          { "grade": "I", "name_en": "Impeccable", "name_cn": "无暇 / 完美无瑕", "min_score": 90, "color": "indigo" },
          { "grade": "S", "name_en": "Superior", "name_cn": "卓越 / 出众", "min_score": 80, "color": "purple" },
          { "grade": "T", "name_en": "Terrific", "name_cn": "极好 / 绝佳", "min_score": 70, "color": "blue" },
          { "grade": "A", "name_en": "Appreciable", "name_cn": "可圈可点 / 值得欣赏", "min_score": 60, "color": "green" },
          { "grade": "C", "name_en": "Commonplace", "name_cn": "平庸 / 普通", "min_score": 50, "color": "gray" },
          { "grade": "H", "name_en": "Hesitant", "name_cn": "犹豫 / 瑕瑜互见", "min_score": 30, "color": "orange" },
          { "grade": "O", "name_en": "Objectionable", "name_cn": "令人反感 / 极差", "min_score": 0, "color": "red" }
        ];


        // --- Authentication ---
         window.login = function() { const redirectUri = window.location.origin; const authorizeUrl = new URL('/oidc/auth', AUTHING_HOST); authorizeUrl.search = new URLSearchParams({ client_id: AUTHING_APP_ID, redirect_uri: redirectUri, response_type: 'code', scope: 'openid profile email phone', state: Math.random().toString(36).substring(2) }).toString(); window.location.href = authorizeUrl.toString(); }
         window.logout = function() { const logoutUrl = new URL('/oidc/session/end', AUTHING_HOST); logoutUrl.search = new URLSearchParams({ post_logout_redirect_uri: window.location.origin }).toString(); sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken'); window.location.href = logoutUrl.toString(); }
         function renderLoginStatus(user) { const container = document.getElementById('login-status-container'); if (!container) return; if (user) { const displayName = user.nickname || user.name || user.preferred_username || user.email || '已登录'; container.innerHTML = `<span class="text-sm font-medium text-gray-700 mr-2 hidden sm:inline">${displayName}</span><button onclick="logout()" class="px-3 py-1 text-xs font-medium rounded-full bg-red-500 text-white hover:bg-red-600">退出</button>`; } else { container.innerHTML = `<button onclick="login()" class="px-3 py-1 text-xs font-medium rounded-full bg-green-500 text-white hover:bg-green-600">登录/注册</button>`; } }
         async function handleOidcCallback(code) { try { const redirectUri = window.location.origin; const apiUrl = new URL('/api/authing/callback', window.location.origin); const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code: code, redirect_uri: redirectUri }) }); if (!response.ok) { const err = await response.json(); throw new Error(err.error || '认证回调失败'); } const fullUserProfile = await response.json(); sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile)); sessionStorage.setItem('accessToken', fullUserProfile.accessToken); return fullUserProfile; } catch (e) { console.error('认证回调处理失败:', e); alert(`登录失败: ${e.message}`); sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken'); return null; } finally { window.history.replaceState({}, document.title, window.location.pathname); } }
         async function validateSessionAndGetUser() { const token = sessionStorage.getItem('accessToken'); if (!token) return null; try { const apiUrl = new URL('/api/me', window.location.origin); const response = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${token}` } }); if (!response.ok) { sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken'); return null; } const fullUserProfile = await response.json(); sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile)); return fullUserProfile; } catch (e) { console.error("Session validation failed:", e); return null; } }
        // --- End Auth ---

        // --- Data Fetching ---
        async function fetchRatings() {
            loadingMessage.textContent = '正在加载点评...'; loadingMessage.style.display = 'block'; ratingsGrid.innerHTML = '';
            try {
                const apiUrl = new URL('/api/ratings', window.location.origin); const response = await fetch(apiUrl);
                if (!response.ok) { let errorText = `加载失败: ${response.status}`; try { const err = await response.json(); errorText = err.error || errorText; } catch (e) {} throw new Error(errorText); }
                allRatings = await response.json(); displayedRatings = [...allRatings]; applyFilters();
            } catch (error) { console.error("加载点评失败:", error); loadingMessage.textContent = `加载点评失败: ${error.message}`; loadingMessage.style.color = 'red'; }
        }

        // --- Filtering and Sorting ---
        window.applyFilters = function() {
            const searchTerm = searchInput.value.toLowerCase().trim(); const sortBy = sortSelect.value;
            let filtered = allRatings.filter(rating => { const nameMatch = rating.cigarInfo?.name?.toLowerCase().includes(searchTerm); const originMatch = rating.cigarInfo?.origin?.toLowerCase().includes(searchTerm); const sizeMatch = rating.cigarInfo?.size?.toLowerCase().includes(searchTerm); const reviewMatch = rating.cigarReview?.toLowerCase().includes(searchTerm); const authorMatch = rating.userNickname?.toLowerCase().includes(searchTerm); return nameMatch || originMatch || sizeMatch || reviewMatch || authorMatch; });
            if (sortBy === 'highest') { filtered.sort((a, b) => (b.normalizedScore ?? 0) - (a.normalizedScore ?? 0)); }
            else if (sortBy === 'lowest') { filtered.sort((a, b) => (a.normalizedScore ?? 0) - (b.normalizedScore ?? 0)); }
            else { filtered.sort((a, b) => (b.isPinned - a.isPinned) || (new Date(b.timestamp) - new Date(a.timestamp)));}
            displayedRatings = filtered; renderGrid();
        }

        // --- Rendering ---
        function renderGrid() {
            ratingsGrid.innerHTML = ''; if (displayedRatings.length === 0) { loadingMessage.textContent = '没有找到匹配的点评。'; loadingMessage.style.display = 'block'; return; }
            loadingMessage.style.display = 'none';
            displayedRatings.forEach(rating => { const card = createRatingCard(rating); ratingsGrid.appendChild(card); });
        }

        function createRatingCard(rating) {
            const div = document.createElement('div');
            div.className = 'rating-card bg-white rounded-lg shadow-md overflow-hidden transition-all duration-300 cursor-pointer flex flex-col';
            div.onclick = () => viewRatingDetails(rating);
            const score = rating.normalizedScore !== undefined ? rating.normalizedScore.toFixed(2) : 'N/A';
            const author = rating.userNickname || rating.userEmail || '匿名';
            // Use the first image URL as cover, or null if no images
            // **FIX**: Handle imageUrl being array or single string/null from API
            let coverImageUrl = null;
            if (Array.isArray(rating.imageUrl) && rating.imageUrl.length > 0) {
                 coverImageUrl = rating.imageUrl[0];
            } else if (typeof rating.imageUrl === 'string' && rating.imageUrl) {
                 // Should ideally be parsed to array by API, but handle defensively
                 coverImageUrl = rating.imageUrl;
            }
            
            // **NEW**: 检查是否被认证
            const isCertified = rating.isCertified;
            // **NEW**: 添加缓存破坏者 (Cache Buster)
            const cacheBuster = `?v=${new Date().getTime()}`;

            div.innerHTML = `
                <div class="aspect-[1179/1572] w-full overflow-hidden flex-shrink-0 relative"> <!-- 1. 添加 'relative' -->${isCertified
                        ? `<img src="/certifiedstamp.png${cacheBuster}" alt="Certified" class="absolute top-1 left-1 w-12 h-12 md:w-16 md:h-16 z-10" title="Pistacho 认证评分" onerror="handleStampError(this)">` // 2. (已修复) 修正为小写 's' 并添加 onerror
                        : ''
                    }
                    ${coverImageUrl
                        ? `<img src="/api/image/${coverImageUrl}" alt="${rating.cigarInfo?.name || '雪茄图片'}" class="w-full h-full object-cover">`
                        : '<div class="w-full h-full bg-gray-200 flex items-center justify-center text-gray-400 text-sm">无图</div>'
                    }
                </div>
                <div class="p-1.5 flex-grow flex flex-col justify-between">
                    <h3 class="font-semibold text-xs leading-tight line-clamp-2 mb-0.5" title="${rating.cigarInfo?.name || ''}">
                        ${rating.cigarInfo?.name || '未命名雪茄'}
                    </h3>
                    <div class="flex justify-between items-end mt-auto pt-0.5">
                         <span class="text-2xs text-gray-500 line-clamp-1 flex items-center" title="${author}">
                              ${author}
                         </span>
                         <div class="text-right flex-shrink-0">
                            <p class="font-bold text-indigo-600 text-sm leading-none">${score}</p>
                        </div>
                    </div>
                </div>
            `;
            return div;
        }

        // --- Navigation ---
        // **LOGIC UPDATED**: Always construct essential objects before sending
        window.viewRatingDetails = function(ratingData) {
            let detailedData = {};

            // **1. Construct essential objects from top-level data (ALWAYS do this)**
            const cigarInfo = ratingData.cigarInfo || { name: ratingData.cigarName, size: ratingData.cigarSize, origin: ratingData.cigarOrigin }; // Reconstruct if needed
            // Find the full grade definition based on score using the *local* GRADING_SCALE
            const foundGrade = GRADING_SCALE.find(g => ratingData.normalizedScore >= g.min_score) || GRADING_SCALE[GRADING_SCALE.length - 1];
            const finalGrade = foundGrade ? { grade: foundGrade.grade, name_cn: foundGrade.name_cn, name_en: foundGrade.name_en, color: foundGrade.color } : null; // Include color!

            // **2. Check if essential objects were successfully created/found**
            if (!ratingData || ratingData.normalizedScore === undefined || !finalGrade || !cigarInfo || !ratingData.title) {
                console.error("viewRatingDetails: Essential data missing or couldn't be constructed!", {ratingData, finalGrade, cigarInfo});
                alert("无法加载详情：缺少基本评分信息 (标题, 分数, 评级, 雪茄信息)。");
                return;
            }

            // **3. Handle imageUrl (ensure it's an array)**
            let imageUrls = ratingData.imageUrl;
            if (typeof imageUrls === 'string') { try { imageUrls = JSON.parse(imageUrls); if (!Array.isArray(imageUrls)) imageUrls = [ratingData.imageUrl]; } catch(e){ imageUrls = imageUrls ? [imageUrls] : []; } }
            else if (!Array.isArray(imageUrls)) { imageUrls = imageUrls ? [imageUrls] : []; }

            // **4. Check if fullData is valid for detailed view**
            const hasCompleteFullData = ratingData.fullData && ratingData.fullData.config && ratingData.fullData.ratings && ratingData.fullData.calculatedScore !== undefined;

            if (hasCompleteFullData) {
                 // If complete, send everything, using the reconstructed objects
                 detailedData = {
                     config: ratingData.fullData.config,
                     ratings: ratingData.fullData.ratings,
                     calculatedScore: ratingData.fullData.calculatedScore,
                     title: ratingData.title, // Add title
                     cigarInfo: cigarInfo,     // Use reconstructed
                     cigarReview: ratingData.cigarReview,
                     imageUrls: imageUrls,       // Use processed array
                     normalizedScore: ratingData.normalizedScore,
                     finalGrade: finalGrade,     // Use reconstructed
                     timestamp: ratingData.timestamp,
                     userNickname: ratingData.userNickname,
                     userEmail: ratingData.userEmail,
                     isDraft: false
                 };
                 console.log("Sending COMPLETE data to results.html:", detailedData);
            } else {
                 // If incomplete, send only top-level data, using reconstructed objects
                 console.warn(`fullData for rating ${ratingData?.id} is missing or incomplete. Sending only top-level data.`);
                 detailedData = {
                     // NO config, ratings, calculatedScore
                     title: ratingData.title, // Add title
                     cigarInfo: cigarInfo,    // Use reconstructed
                     cigarReview: ratingData.cigarReview,
                     imageUrls: imageUrls,      // Use processed array
                     normalizedScore: ratingData.normalizedScore,
                     finalGrade: finalGrade,    // Use reconstructed
                     timestamp: ratingData.timestamp,
                     userNickname: ratingData.userNickname,
                     userEmail: ratingData.userEmail,
                     isDraft: false
                 };
                 console.log("Sending INCOMPLETE (top-level) data to results.html:", detailedData);
            }

            // **5. Navigate**
            try { sessionStorage.setItem('cigarRatingResults', JSON.stringify(detailedData)); window.location.href = `results.html`; }
            catch (e) { console.error("Error setting sessionStorage:", e); alert("无法保存会话数据以查看详情。"); }
        }


        // --- Initialization ---
        window.onload = async function() {
             const urlParams = new URLSearchParams(window.location.search); const code = urlParams.get('code'); let user = null;
             if (code) { user = await handleOidcCallback(code); } else { user = await validateSessionAndGetUser(); }
             currentAuthUser = user; renderLoginStatus(currentAuthUser);
             fetchRatings();

             searchInput.addEventListener('keypress', function (e) { if (e.key === 'Enter') { applyFilters(); } });
             sortSelect.addEventListener('change', applyFilters);
        };
    </script>
</body>
</html>

