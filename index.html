<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›ªèŒ„å“é‰´è¯„åˆ†ä¸»åº”ç”¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                    },
                    transitionProperty: {
                        'width': 'width',
                    }
                }
            }
        }
    </script>
    
    <script>
        const __app_id = 'pistacho-b9efe'; 
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyDC-8qbWsjRyxBzJpfCi9n3ftzdg9FStF0", 
            authDomain: "pistacho-b9efe.firebaseapp.com",
            projectId: "pistacho-b9efe",
            storageBucket: "pistacho-b9efe.firebasestorage.app",
            messagingSenderId: "686695750713",
            appId: "1:686695750713:web:5314331be7b46e93f401e8",
            measurementId: "G-HQS7Q78LY7"
        });
    </script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        let db, auth;
        let ratingConfig = null; 
        let userRatings = {};    
        let userRole = 'unknown'; 
        let currentAuthUser = null; 
        let configUnsubscribe = null;
        
        const CONFIG_DOC_PATH = `/artifacts/${appId}/public/data/cigar_config/latest`;
        const USERS_COLLECTION_PATH = 'users'; 

        const defaultInitialConfig = {
            appTitle: "é›ªèŒ„å“é‰´è¯„åˆ†ä½“ç³»",
            description: "è¯·ä¸ºä»¥ä¸‹é¡¹ç›®è¯„åˆ†ï¼Œä»¥è·å¾—æœ€ç»ˆå“é‰´æŠ¥å‘Šã€‚",
            ratingCriteria: []
        };

        // --- Utility Functions ---

        function calculateWeights(config) {
            let grandTotal = 0;
            let totalCriteriaCount = 0;
            (config.ratingCriteria || []).forEach(category => {
                let categoryTotal = 0;
                (category.criteriaList || []).forEach(criterion => {
                    categoryTotal += (criterion.weight || 0);
                    totalCriteriaCount++;
                });
                category.totalWeight = categoryTotal;
                grandTotal += categoryTotal;
            });
            config.totalWeightMax = grandTotal;
            config.totalCriteriaCount = totalCriteriaCount;
        }

        function calculateFinalScore() {
            if (!ratingConfig) return 0;
            let totalScore = 0;
            (ratingConfig.ratingCriteria || []).forEach((category) => {
                (category.criteriaList || []).forEach((criterion) => {
                    const id = `${category.category}-${criterion.name}`;
                    const selectedOptionIndex = userRatings[id];
                    if (selectedOptionIndex !== undefined && criterion.options && criterion.options[selectedOptionIndex]) {
                        const scorePct = criterion.options[selectedOptionIndex].scorePct;
                        const weightedScore = (criterion.weight || 0) * scorePct;
                        totalScore += weightedScore;
                    }
                });
            });
            return totalScore;
        }
        
        // --- Navigation ---
        
        window.showResults = function() {
            if (!ratingConfig || Object.keys(userRatings).length === 0) {
                alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¯„åˆ†é¡¹åå†æŸ¥çœ‹æŠ¥å‘Šã€‚");
                return;
            }

            const cigarInfo = {
                name: document.getElementById('cigar-name').value || 'æœªå‘½åé›ªèŒ„',
                size: document.getElementById('cigar-size').value || 'æœªçŸ¥å°ºå¯¸',
                origin: document.getElementById('cigar-origin').value || 'æœªçŸ¥äº§åœ°'
            };

            // (*** æ–°å¢ï¼šæ”¶é›†æ–‡å­—è¯„ä»· ***)
            const cigarReview = document.getElementById('cigar-review').value || 'æ— ';

            const finalScore = calculateFinalScore();
            const resultsData = {
                config: ratingConfig,
                ratings: userRatings,
                calculatedScore: finalScore,
                cigarInfo: cigarInfo,
                cigarReview: cigarReview // (*** æ–°å¢ï¼šå°†è¯„ä»·åŠ å…¥æ•°æ®åŒ… ***)
            };
            try {
                sessionStorage.setItem('cigarRatingResults', JSON.stringify(resultsData));
                window.location.href = 'results.html';
            } catch (e) {
                alert("æ— æ³•ä¿å­˜ä¼šè¯æ•°æ®ï¼Œå¯èƒ½æ˜¯æµè§ˆå™¨éšç§è®¾ç½®è¿‡é«˜ã€‚");
            }
        }
        
        // --- Reset Ratings ---
        
        window.resetRatings = function() {
            if (confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰è¯„åˆ†é€‰æ‹©å’Œè¯„ä»·å—ï¼Ÿ")) {
                userRatings = {};
                document.getElementById('cigar-name').value = '';
                document.getElementById('cigar-size').value = '';
                document.getElementById('cigar-origin').value = '';
                document.getElementById('cigar-review').value = ''; // (*** æ–°å¢ï¼šé‡ç½®æ–‡å­—è¯„ä»· ***)
                renderRatingView();
            }
        }

        // --- Firebase Auth & Data ---
        
        async function fetchUserRole(user) {
            const uid = user.uid;
            const roleDocRef = doc(db, USERS_COLLECTION_PATH, uid);
            try {
                const docSnap = await getDoc(roleDocRef);
                if (docSnap.exists() && docSnap.data().role) {
                    return docSnap.data().role; 
                } 
                if (!user.isAnonymous) {
                    try {
                        await setDoc(roleDocRef, { role: 'general', email: user.email, createdAt: new Date().toISOString() }, { merge: true });
                    } catch (initError) {
                        console.error("åˆå§‹åŒ–ç”¨æˆ·è§’è‰²å¤±è´¥:", initError.message);
                    }
                }
                return 'general'; 
            } catch (e) {
                console.warn("è·å–ç”¨æˆ·è§’è‰²å¤±è´¥:", e);
                return 'general';
            }
        }
        
        window.handleLoginSignup = async function(isSignup) {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const loginStatus = document.getElementById('login-modal-status');
            loginStatus.textContent = isSignup ? 'æ­£åœ¨æ³¨å†Œ...' : 'æ­£åœ¨ç™»å½•...';
            loginStatus.className = 'text-sm text-yellow-600 mt-2';

            try {
                if (isSignup) {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
                document.getElementById('login-modal').classList.add('hidden');
                loginStatus.textContent = '';
            } catch (error) {
                const errorCode = error.code;
                let errorMessage = errorCode.replace('auth/', '').replace(/-/g, ' ').toUpperCase();
                loginStatus.textContent = `å¤±è´¥: ${errorMessage}`;
                loginStatus.className = 'text-sm text-red-600 mt-2';
            }
        }

        window.logout = async function() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout Error:", error);
            }
        }

        window.showLoginModal = function() {
            document.getElementById('login-modal').classList.remove('hidden');
            document.getElementById('login-modal-status').textContent = '';
        }
        window.hideLoginModal = function() {
            document.getElementById('login-modal').classList.add('hidden');
        }

        async function initFirebase() {
            if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId) {
                document.getElementById('app-container').innerHTML = `<div class="p-6 text-red-600 bg-red-100">ğŸ”´ Firebase é…ç½®ç¼ºå¤±ã€‚</div>`;
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentAuthUser = user;
                        userRole = await fetchUserRole(user); 
                        renderAdminLinks(); 
                        renderLoginStatus(user);
                        loadConfig(); 
                    } else {
                        await signInAnonymously(auth);
                        currentAuthUser = null;
                        userRole = 'general';
                        renderAdminLinks(); 
                        renderLoginStatus(null);
                    }
                });

            } catch (error) {
                document.getElementById('app-container').innerHTML = `<div class="p-6 text-red-600 bg-red-100">âŒ Firebase åˆå§‹åŒ–å¤±è´¥: ${error.message}</div>`;
            }
        }

        function loadConfig() {
            if (configUnsubscribe) {
                configUnsubscribe();
            }

            const configDocRef = doc(db, CONFIG_DOC_PATH);
            const configStatusElement = document.getElementById('config-load-status');

            configUnsubscribe = onSnapshot(configDocRef, (docSnap) => {
                console.log("onSnapshot fired: New config data received.");
                if (docSnap.exists() && docSnap.data().ratingCriteria) {
                    ratingConfig = docSnap.data();
                    calculateWeights(ratingConfig);
                    userRatings = {}; 
                    renderRatingView(); 
                    configStatusElement.textContent = `é…ç½®å·²åŒæ­¥`;
                    configStatusElement.className = 'text-xs text-green-400';
                } else {
                    ratingConfig = defaultInitialConfig;
                    calculateWeights(ratingConfig);
                    userRatings = {};
                    renderRatingView();
                    configStatusElement.textContent = 'åŠ è½½é»˜è®¤é…ç½®';
                    configStatusElement.className = 'text-xs text-yellow-400';
                    setDoc(configDocRef, ratingConfig).catch(err => console.error("å†™å…¥é»˜è®¤é…ç½®å¤±è´¥:", err));
                }
            }, (error) => {
                console.error("åŠ è½½é…ç½®å¤±è´¥:", error);
                configStatusElement.textContent = 'é…ç½®åŠ è½½å¤±è´¥';
                configStatusElement.className = 'text-xs text-red-400';
            });
        }
        
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && db) {
                console.log("Tab is visible again, forcing config reload.");
                loadConfig();
            }
        });

        // --- UI Rendering ---

        function renderAdminLinks() {
            const adminLinksContainer = document.getElementById('admin-links-container');
            let linksHtml = '';
            if (userRole === 'admin' || userRole === 'super_admin') {
                linksHtml += `<a href="cigar_rating_config.html" class="flex items-center px-3 py-1.5 border border-white text-xs font-medium rounded-full text-white bg-indigo-600 hover:bg-indigo-500 transition">æ ‡å‡†ä¿®æ”¹</a>`;
            }
            if (userRole === 'super_admin') {
                 linksHtml += `<a href="role_management.html" class="flex items-center px-3 py-1.5 border border-white text-xs font-medium rounded-full text-yellow-100 bg-purple-600 hover:bg-purple-500 transition">è§’è‰²ç®¡ç†</a>`;
            }
            adminLinksContainer.innerHTML = linksHtml;
        }
        
        function renderLoginStatus(user) {
            const container = document.getElementById('login-status-container');
            if (user && user.email) {
                container.innerHTML = `
                    <span class="text-sm font-medium text-yellow-300 mr-2 hidden sm:inline">${user.email}</span>
                    <button onclick="logout()" class="px-3 py-1 text-xs font-medium rounded-full bg-red-500 text-white hover:bg-red-600">é€€å‡º</button>
                `;
            } else {
                 container.innerHTML = `
                    <span class="text-sm font-medium text-indigo-300 mr-2 hidden sm:inline">åŒ¿åç”¨æˆ·</span>
                    <button onclick="showLoginModal()" class="px-3 py-1 text-xs font-medium rounded-full bg-green-500 text-white hover:bg-green-600">ç™»å½•/æ³¨å†Œ</button>
                `;
            }
        }

        window.updateRatingSelection = function(categoryName, criterionName, optionIndex) {
            const id = `${categoryName}-${criterionName}`;
            userRatings[id] = optionIndex;
            renderRatingView(); 
        };

        function renderRatingView() {
            if (!ratingConfig) {
                document.getElementById('rating-form-container').innerHTML = `<p class="text-center text-gray-500">åŠ è½½ä¸­...</p>`;
                return;
            }

            const totalScore = calculateFinalScore();
            
            document.getElementById('app-title-display').textContent = ratingConfig.appTitle || 'é›ªèŒ„è¯„åˆ†åº”ç”¨';
            document.getElementById('app-description-display').textContent = ratingConfig.description || '';
            document.getElementById('total-weight-max-display').textContent = ratingConfig.totalWeightMax || 0;
            
            document.getElementById('current-score-display').textContent = totalScore.toFixed(2);
            
            const ratedCount = Object.keys(userRatings).length;
            const totalCount = ratingConfig.totalCriteriaCount || 1;
            const progress = (ratedCount / totalCount) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('progress-text').textContent = `${ratedCount} / ${totalCount}`;

            const formContainer = document.getElementById('rating-form-container');
            formContainer.innerHTML = (ratingConfig.ratingCriteria || []).map((category) => `
                <div class="bg-white p-6 rounded-xl shadow-lg mb-8 border-l-4 border-indigo-500">
                    <h3 class="text-xl font-bold text-indigo-700 mb-2">${category.category}</h3>
                    <p class="text-gray-500 text-sm mb-4">${category.detail || ''}</p>
                    <div class="space-y-6">
                        ${(category.criteriaList || []).map((criterion) => renderRatingCriterion(category.category, criterion)).join('')}
                    </div>
                </div>
            `).join('');
        }

        function renderRatingCriterion(categoryName, criterion) {
            const id = `${categoryName}-${criterion.name}`;
            const selectedOptionIndex = userRatings[id];
            const currentWeight = criterion.weight || 0;

            let currentScore = 0;
            if (selectedOptionIndex !== undefined && criterion.options && criterion.options[selectedOptionIndex]) {
                currentScore = currentWeight * criterion.options[selectedOptionIndex].scorePct;
            }

            return `
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-lg font-semibold text-gray-800">${criterion.name} (${currentWeight} åˆ†)</h4>
                        <span class="text-xl font-extrabold text-green-600">${currentScore.toFixed(2)}</span>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2">
                        ${(criterion.options || []).map((option, optIndex) => {
                            const isSelected = selectedOptionIndex === optIndex;
                            const score = (currentWeight * (option.scorePct || 0)).toFixed(2);
                            return `
                                <button onclick="updateRatingSelection('${categoryName}', '${criterion.name}', ${optIndex})" 
                                    class="p-2 text-sm text-center rounded-lg border transition duration-150 ${
                                        isSelected 
                                        ? 'bg-indigo-600 text-white shadow-md border-indigo-800' 
                                        : 'bg-white text-gray-700 hover:bg-indigo-50 border-gray-300'
                                    }">
                                    ${option.description} 
                                    <span class="block text-xs ${isSelected ? 'text-indigo-200' : 'text-gray-500'}">(å¾— ${score} åˆ†)</span>
                                </button>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        window.onload = initFirebase;
    </script>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">

    <div id="app-container" class="max-w-6xl mx-auto p-4 md:p-8">

        <header class="mb-8 p-6 bg-indigo-700 text-white rounded-xl shadow-2xl">
            <div class="flex justify-between items-start">
                <div>
                    <h1 id="app-title-display" class="text-3xl font-extrabold mb-1">é›ªèŒ„è¯„åˆ†åº”ç”¨</h1>
                    <p id="app-description-display" class="text-indigo-200 text-sm max-w-lg">åŠ è½½æè¿°ä¸­...</p>
                </div>
                 <div class="flex items-center space-x-3 flex-shrink-0">
                    <div id="login-status-container" class="flex items-center"></div>
                    <div id="admin-links-container" class="flex items-center space-x-3"></div>
                </div>
            </div>
            
            <div class="mt-6 bg-black bg-opacity-20 p-4 rounded-lg">
                <div class="flex justify-between items-end">
                    <div>
                        <p class="text-sm font-medium text-indigo-200">å½“å‰å¾—åˆ†</p>
                        <div class="flex items-baseline">
                            <span id="current-score-display" class="text-6xl font-black leading-none">0.00</span>
                            <span class="text-lg font-medium text-indigo-200 ml-2">/ <span id="total-weight-max-display">0</span></span>
                        </div>
                    </div>
                    <div class="text-right">
                         <p class="text-sm font-medium text-indigo-200">å·²è¯„é¡¹ç›®</p>
                         <p id="progress-text" class="font-bold text-lg">0 / 0</p>
                    </div>
                </div>
                <div class="w-full bg-indigo-900 rounded-full h-2.5 mt-2">
                    <div id="progress-bar" class="bg-green-400 h-2.5 rounded-full transition-width duration-500" style="width: 0%"></div>
                </div>
            </div>
             <p id="config-load-status" class="text-xs text-yellow-300 mt-2 text-right">æ­£åœ¨è¿æ¥...</p>
        </header>

        <section class="mb-8 p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-xl font-bold text-gray-800 mb-4">é›ªèŒ„ä¿¡æ¯</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="cigar-name" class="block text-sm font-medium text-gray-700">åç§° (Name)</label>
                    <input type="text" id="cigar-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼šå¸•ç‰¹åŠ æ–¯D4">
                </div>
                <div>
                    <label for="cigar-size" class="block text-sm font-medium text-gray-700">å°ºå¯¸ (Size)</label>
                    <input type="text" id="cigar-size" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼šRobusto">
                </div>
                <div>
                    <label for="cigar-origin" class="block text-sm font-medium text-gray-700">äº§åœ° (Origin)</label>
                    <input type="text" id="cigar-origin" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼šå¤å·´">
                </div>
            </div>
        </section>

        <div id="rating-form-container">
            <p class="text-center text-gray-500 mt-10">è¯·ç­‰å¾…é…ç½®åŠ è½½...</p>
        </div>

        <!-- (*** æ–°å¢ï¼šæ–‡å­—è¯„ä»·åŒºåŸŸ ***) -->
        <section class="mt-8 p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-xl font-bold text-gray-800 mb-4">æ–‡å­—è¯„ä»·</h2>
            <div>
                <label for="cigar-review" class="sr-only">åœ¨æ­¤å¤„è¾“å…¥æ‚¨çš„è¯¦ç»†å“å¸æ„Ÿå—</label>
                <textarea id="cigar-review" rows="5" class="w-full p-3 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="åœ¨æ­¤å¤„è¾“å…¥æ‚¨çš„è¯¦ç»†å“å¸æ„Ÿå—ï¼Œä¾‹å¦‚é£å‘³å˜åŒ–ã€ç‡ƒçƒ§æƒ…å†µç­‰..."></textarea>
            </div>
        </section>
        
        <div class="mt-8 grid grid-cols-2 gap-4">
            <button onclick="resetRatings()" class="w-full py-3 px-6 bg-red-500 text-white font-bold text-lg rounded-lg shadow-md hover:bg-red-600 transition">
                é‡ç½®æ‰€æœ‰è¯„åˆ†
            </button>
            <button onclick="showResults()" class="w-full py-3 px-6 bg-green-600 text-white font-bold text-lg rounded-lg shadow-md hover:bg-green-700 transition">
                æŸ¥çœ‹å®Œæ•´è¯„åˆ†æŠ¥å‘Š
            </button>
        </div>
        
        <footer class="mt-8 text-center text-gray-500 text-sm p-4 border-t">
            è¯„åˆ†åº”ç”¨æ•°æ®ç”±äº‘ç«¯é…ç½®ä¸­å¿ƒå®æ—¶åŒæ­¥ã€‚
        </footer>
    </div>

    <div id="login-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center z-50">
       <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-indigo-700">ç™»å½•æˆ–æ³¨å†Œ</h3>
            <label class="block mb-3">
                <span class="text-gray-700 text-sm">é‚®ç®± (Email)</span>
                <input type="email" id="login-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="user@example.com">
            </label>
            <label class="block mb-4">
                <span class="text-gray-700 text-sm">å¯†ç  (Password)</span>
                <input type="password" id="login-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
            </label>
            <div class="flex space-x-3">
                <button onclick="handleLoginSignup(false)" class="flex-1 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">ç™»å½•</button>
                <button onclick="handleLoginSignup(true)" class="flex-1 py-2 bg-gray-200 text-indigo-600 font-semibold rounded-lg hover:bg-gray-300">æ³¨å†Œ</button>
            </div>
            <p id="login-modal-status" class="text-center mt-3"></p>
            <button onclick="hideLoginModal()" class="mt-4 text-sm text-gray-500 hover:text-gray-700 w-full">å–æ¶ˆ</button>
        </div>
    </div>

</body>
</html>

