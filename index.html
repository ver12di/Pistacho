<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pistacho é›ªèŒ„è¯„åˆ†é…ç½®ä¸­å¿ƒ</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase å¯¼å…¥ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase objects globally
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
        window.getDoc = getDoc;
        window.setLogLevel = setLogLevel;
    </script>
    <style>
        /* Custom styles */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background-color: #6366f1; border-radius: 2px; }
        .rating-input:checked + .rating-label {
            background-color: #4f46e5; 
            color: white;
            border-color: #4f46e5;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .tab-button.active {
            border-bottom: 4px solid #4f46e5;
            color: #4f46e5;
            font-weight: bold;
        }
        /* Style for JSON text area */
        #configJson {
            font-family: monospace;
            min-height: 500px;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased min-h-screen">

    <!-- é¡¶éƒ¨å›ºå®šæ ‡é¢˜æ å’Œæ ‡ç­¾é¡µåˆ‡æ¢ -->
    <header class="sticky top-0 z-20 bg-white shadow-xl">
        <div class="max-w-xl mx-auto py-3 px-4 sm:px-6 lg:px-8">
            <h1 class="text-2xl font-bold text-gray-800 tracking-wider">
                Pistacho è¯„åˆ† <span class="text-indigo-500 text-sm">v2.0</span>
            </h1>
        </div>
        <!-- æ ‡ç­¾é¡µ -->
        <div class="max-w-xl mx-auto px-4 sm:px-6 lg:px-8 flex border-t border-gray-200">
            <button id="tabRating" onclick="switchTab('rating')" class="tab-button flex-1 py-3 text-center text-gray-500 hover:text-indigo-600 transition active">è¯„åˆ†æ¨¡å¼</button>
            <button id="tabConfig" onclick="switchTab('config')" class="tab-button flex-1 py-3 text-center text-gray-500 hover:text-indigo-600 transition">é…ç½®ç®¡ç†</button>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="max-w-xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
        
        <!-- åŠ è½½çŠ¶æ€/é”™è¯¯æç¤º -->
        <div id="loadingStatus" class="p-6 text-center bg-yellow-100 text-yellow-800 rounded-xl shadow-lg mb-6">
            <p id="statusText">æ­£åœ¨è¿æ¥é…ç½®ä¸­å¿ƒ...</p>
        </div>

        <!-- è¯„åˆ†æ¨¡å¼å†…å®¹ -->
        <section id="ratingView" class="view-content">
            <form id="ratingForm" onsubmit="event.preventDefault(); calculateAndDisplayResults();">
                <!-- 1. åŸºæœ¬ä¿¡æ¯è¾“å…¥ -->
                <div class="mb-8 p-4 bg-white rounded-xl shadow-lg">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">é›ªèŒ„åŸºæœ¬ä¿¡æ¯ (è®°å½•ç”¨)</h2>
                    <div class="space-y-4">
                        <input type="text" id="brand" placeholder="å“ç‰Œ Brand" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <input type="text" id="model" placeholder="å‹å· Model" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <input type="text" id="size" placeholder="å°ºå¯¸ Size" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <input type="text" id="origin" placeholder="äº§åœ° Origin" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <!-- 2. ä¸»è§‚å°è±¡è¯„åˆ†åŒº (åŠ¨æ€ç”Ÿæˆ) -->
                <div id="ratingInputs" class="space-y-6">
                    <!-- è¯„åˆ†é¡¹å°†ç”± JavaScript åŠ¨æ€æ’å…¥ -->
                </div>

                <!-- 3. æäº¤æŒ‰é’® -->
                <div class="mt-10 mb-20">
                    <button type="submit" class="w-full py-4 text-xl font-bold text-white bg-indigo-600 rounded-xl hover:bg-indigo-700 transition duration-150 shadow-lg shadow-indigo-300/50 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
                        è®¡ç®— Pistacho æœ€ç»ˆè¯„åˆ†
                    </button>
                </div>
            </form>
        </section>

        <!-- é…ç½®ç®¡ç†å†…å®¹ -->
        <section id="configView" class="view-content hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Pistacho è¯„åˆ†é…ç½® (JSON)</h2>
                <p class="text-sm text-gray-600 mb-4 bg-gray-50 p-3 rounded-lg border-l-4 border-yellow-500">
                    âš ï¸ **è­¦å‘Š:** è¯·ç¡®ä¿ JSON æ ¼å¼æ­£ç¡®ï¼Œå¦åˆ™å°†å¯¼è‡´è¯„åˆ†åº”ç”¨å´©æºƒã€‚è¯·å‹¿ä¿®æ”¹å­—æ®µå (å¦‚ `impression`, `weight`, `degrees`, `type`)ã€‚
                </p>
                <textarea id="configJson" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                
                <button onclick="saveConfigToFirestore()" class="w-full mt-4 py-3 text-lg font-bold text-white bg-green-600 rounded-xl hover:bg-green-700 transition duration-150 shadow-lg focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50">
                    ä¿å­˜é…ç½®åˆ°äº‘ç«¯
                </button>
                <p id="saveMessage" class="mt-3 text-sm text-center text-green-700 hidden"></p>
            </div>
        </section>

        <!-- 4. ç»“æœå±•ç¤ºåŒº (åˆå§‹éšè—) -->
        <section id="resultsSection" class="hidden fixed inset-0 bg-gray-100 z-30 overflow-y-auto pt-4 pb-20">
            <div class="p-4">
                <div class="bg-white rounded-xl shadow-2xl p-6 mb-6">
                    <h2 class="text-2xl font-extrabold text-indigo-600 mb-4">æœ€ç»ˆå®šçº§ç»“æœ</h2>
                    
                    <div id="finalGradeDisplay" class="text-center mb-6 p-4 rounded-xl bg-gray-50 border border-gray-200">
                        <p class="text-sm text-gray-500">Pistacho ç­‰çº§</p>
                        <div id="pistachoAcronymDisplay" class="flex justify-center items-end space-x-1 mb-2">
                        </div>
                        <p class="text-xl font-semibold" id="resultGradeName">---</p>
                    </div>

                    <div class="flex justify-between items-center bg-indigo-50 p-3 rounded-lg border-l-4 border-indigo-600">
                        <span class="text-gray-700 font-medium">æ€»åˆ†æ•° (æ»¡åˆ†100)</span>
                        <span id="resultScore" class="text-2xl font-extrabold text-indigo-700">0.0</span>
                    </div>
                </div>

                <!-- è¯¦ç»†å›é¡¾ä¸æˆå°± -->
                <div class="bg-white rounded-xl shadow-2xl p-6 mb-6">
                    <h2 class="text-xl font-extrabold text-gray-800 mb-4 border-b pb-2">ğŸ“ è¯¦ç»†å›é¡¾ä¸æˆå°±</h2>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2 mt-4">é›ªèŒ„ä¿¡æ¯å›é¡¾</h3>
                    <ul id="infoSummary" class="text-gray-600 space-y-2 list-none pl-0 mb-6 border-b pb-4">
                    </ul>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2 mt-4">ğŸ† è·å¾—çš„æˆå°±</h3>
                    <ul id="achievementList" class="space-y-2 text-sm text-gray-700 list-disc pl-5">
                    </ul>
                </div>
                
                <button onclick="document.getElementById('resultsSection').classList.add('hidden')" class="w-full py-3 text-lg font-bold text-indigo-600 bg-white border border-indigo-600 rounded-xl hover:bg-indigo-50 transition duration-150 shadow-md">
                    è¿”å›ç»§ç»­è¯„ä»·
                </button>
            </div>
        </section>
    </main>

    <!-- æ ¸å¿ƒæ•°æ®å’Œé€»è¾‘ -->
    <script>
        // =========================================================
        // æ ¸å¿ƒæ•°æ®å’Œ Firebase é…ç½®
        // =========================================================

        let CIGAR_RATING_DATA = []; // åŠ¨æ€åŠ è½½çš„è¯„åˆ†æ•°æ®
        let TOTAL_WEIGHT = 0; // åŠ¨æ€è®¡ç®—çš„æ€»æƒé‡
        let isConfigLoaded = false;
        
        let app, db, auth;
        let userId;

        // Configuration path constants
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const CONFIG_DOC_PATH = `artifacts/${appId}/public/data/cigar_rating_config/main_config`;

        // Default configuration (used if Firestore is empty)
        const DEFAULT_RATING_DATA = [
            { impression: "èŒ„æ ‡é«˜çº§æ„Ÿ", weight: 15, degrees: [{ level: "ç®€é™‹", score: 0.10, achievement: "åœ°æ‘Šè´§" }, { level: "ä¸­è§„ä¸­çŸ©", score: 0.50, achievement: "ç¤¼å“è£…" }, { level: "æ¼‚äº®", score: 0.70, achievement: "å¥¢ä¾ˆå“" }, { level: "é«˜çº§æ„Ÿ", score: 1.00, achievement: "å¤§å¸ˆé¦†è—" }], type: 'single' },
            { impression: "èŒ„è¡£", weight: 15, degrees: [{ level: "ç®€é™‹", score: 0.10, achievement: "å»‰ä»·å¤–å¥—" }, { level: "ä¸­è§„ä¸­çŸ©", score: 0.50, achievement: "æ­£è£…å‡ºå¸­" }, { level: "æ¼‚äº®", score: 0.70, achievement: "ä¸ç»¸è§¦æ„Ÿ" }, { level: "é«˜çº§æ„Ÿ", score: 1.00, achievement: "é¡¶çº§çš®å…·" }], type: 'single' },
            { impression: "å·å·¥", weight: 15, degrees: [{ level: "ä¸åˆæ ¼", score: 0.10, achievement: "åŒ†å¿™èµ¶å·¥" }, { level: "æ­£å¸¸", score: 0.50, achievement: "ç†Ÿç»ƒå·¥äºº" }, { level: "æ¼‚äº®", score: 0.70, achievement: "ç²¾é›•ç»†ç¢" }, { level: "å®Œç¾", score: 1.00, achievement: "æµ‘ç„¶å¤©æˆ" }], type: 'single' },
            { impression: "å¸é˜»", weight: 15, degrees: [{ level: "æ¾", score: 0.50, achievement: "è‡ªç”±è½ä½“" }, { level: "å®Œç¾", score: 1.00, achievement: "å¤©é€‰ä¹‹å¸" }, { level: "åç´§", score: 0.50, achievement: "å€”å¼ºè„¾æ°”" }, { level: "å µå¡", score: 0.00, achievement: "ç‰©ç†ç»ç¼˜" }], type: 'single' },
            { impression: "ç‡ƒçƒ§çº¿", weight: 15, degrees: [{ level: "å‡åŒ€", score: 1.00, achievement: "æ¿€å…‰åˆ‡å‰²" }, { level: "ç•¥ä¸å‡åŒ€", score: 0.70, achievement: "è‰ºæœ¯ä¿®é¥°" }, { level: "æŒç»­ä¸å‡åŒ€", score: 0.10, achievement: "è‡ªç”±å‘æŒ¥" }], type: 'single' },
            { impression: "å‰3å£æ„Ÿè§‰", weight: 5, degrees: [{ level: "çœ¼å‰ä¸€äº®", score: 1.00, achievement: "å¼€åœºçˆ†æ£š" }, { level: "æœ‰æœŸå¾…", score: 0.70, achievement: "ç¨³æ­¥å‡æ¸©" }, { level: "ä¸­è§„ä¸­çŸ©", score: 0.50, achievement: "å¹³æ·¡å¦‚æ°´" }, { level: "ä¼°è®¡ä¸æ€ä¹ˆæ ·", score: 0.10, achievement: "åŠé€€è­¦å‘Š" }], type: 'single' },
            { impression: "çƒŸç°å½¢æ€", weight: 10, degrees: [{ level: "å®Œç¾å¯ä»¥å°è¯•æŒèŒ„", score: 1.00, achievement: "åŸƒè²å°”é“å¡”" }, { level: "éœ€è¦ä¸»åŠ¨å¼¹", score: 0.70, achievement: "æ¯”è¨æ–œå¡”" }, { level: "è‡ªåŠ¨è„±è½", score: 0.30, achievement: "é›·å³°å¡”" }], type: 'single' },
            { impression: "ç¬¬äºŒé¦™æ°”å®œäººå¼ºåº¦", weight: 15, degrees: [{ level: "æ²¡æœ‰", score: 0.00, achievement: "å—…è§‰å¤±çµ" }, { level: "ä¸€ç‚¹ç‚¹é¦™", score: 0.30, achievement: "æ˜™èŠ±ä¸€ç°" }, { level: "å¾ˆé¦™", score: 0.70, achievement: "èŠ³é¦™å››æº¢" }, { level: "æé¦™", score: 1.00, achievement: "é¦™æ°´å–·é›¾" }], type: 'single' },
            { impression: "ç¬¬äºŒé¦™æ°”é«˜çº§åº¦", weight: 15, degrees: [{ level: "å®¹æ˜“åœ¨å…¶ä»–èŒ„è·å¾—", score: 0.30, achievement: "å¤§ä¼—æƒ…äºº" }, { level: "ä¸å®¹æ˜“åœ¨å…¶ä»–èŒ„è·å¾—ä½†æœ‰å¶ç¢°åˆ°", score: 0.70, achievement: "å¶ç„¶ç›¸é‡" }, { level: "ç‹¬ç‰¹", score: 1.00, achievement: "ç‹¬ä¸€æ— äºŒ" }], type: 'single' },
            { impression: "é¦™æ°”æŒç»­åº¦", weight: 15, degrees: [{ level: "å‰æ®µæœ‰", score: 0.333, achievement: "çŸ­æš‚é—ªå…‰" }, { level: "ä¸­æ®µæœ‰", score: 0.666, achievement: "ç¨³å¥ç»­èˆª" }, { level: "åç«¯æœ‰", score: 1.00, achievement: "é™ªä¼´åˆ°è€" }], type: 'multi' },
            { impression: "å¤šé‡ï¼ˆç¬¬ä¸‰ï¼‰é¦™æ°”", weight: 15, degrees: [{ level: "æ²¡æœ‰", score: 0.00, achievement: "å•æ ¸å¤„ç†" }, { level: "æœ‰", score: 1.00, achievement: "å¤šæ ¸è¿è¡Œ" }], type: 'single' },
            { impression: "å¤šé‡ï¼ˆç¬¬ä¸‰ï¼‰é¦™æ°”æŒç»­åº¦", weight: 15, degrees: [{ level: "å‰æ®µæœ‰", score: 0.333, achievement: "å°é²œé™å®š" }, { level: "ä¸­æ®µæœ‰", score: 0.666, achievement: "æ·±åº¦ä½“éªŒ" }, { level: "åç«¯æœ‰", score: 1.00, achievement: "å°¾éŸµæ‚ é•¿" }], type: 'multi' },
            { impression: "ä¸‰æ®µå˜åŒ–", weight: 15, degrees: [{ level: "å˜åŒ–æ˜æ˜¾", score: 1.00, achievement: "è¿‡å±±è½¦" }, { level: "ä¼¼ä¹æœ‰å˜åŒ–", score: 0.50, achievement: "æ¸è¿›å˜å¥" }, { level: "å§‹ç»ˆå¦‚ä¸€", score: 0.10, achievement: "çº¿æ€§è¾“å‡º" }], type: 'single' },
            { impression: "ç‡ƒçƒ§æŒç»­", weight: 15, degrees: [{ level: "ä¸€æ ¹åˆ°åº•", score: 1.00, achievement: "æ°¸åŠ¨æœº" }, { level: "å¶å°”è¡¥ç«", score: 0.70, achievement: "ç«åŠ›æ”¯æ´" }, { level: "ä¸æ–­è¡¥ç«", score: 0.30, achievement: "æ¶ˆé˜²é˜Ÿå‘˜" }, { level: "ç‚¹åˆ°è¯•å›¾æ”¾å¼ƒ", score: 0.00, achievement: "åŠé€€é‡æ¥" }], type: 'single' },
            { impression: "çƒŸé›¾é‡", weight: 15, degrees: [{ level: "æ²¡æœ‰", score: 0.00, achievement: "æ— çƒŸåŒº" }, { level: "å°‘", score: 0.50, achievement: "éšå£«æ¨¡å¼" }, { level: "æ­£å¸¸", score: 1.00, achievement: "æ•ˆç‡è¾¾äºº" }, { level: "æµ“", score: 0.80, achievement: "è’¸æ±½åˆ—è½¦" }, { level: "çƒŸå›±", score: 0.50, achievement: "ç«ç‚¬è¾¾äºº" }], type: 'single' },
            { impression: "å°¼å¤ä¸æµ“åº¦", weight: 10, degrees: [{ level: "æ™®é€š", score: 1.00, achievement: "åŸºç¡€æŒ‘æˆ˜" }, { level: "å›°éš¾", score: 0.90, achievement: "æ„å¿—è€ƒéªŒ" }, { level: "å™©æ¢¦", score: 0.70, achievement: "çµé­‚æ‹·é—®" }, { level: "åœ°ç‹±", score: 0.30, achievement: "è§é˜ç‹" }], type: 'single' },
            { impression: "è¿‡é¼»é¡ºç•…åº¦", weight: 15, degrees: [{ level: "æ— æ„Ÿ", score: 0.50, achievement: "å‘¼å¸è‡ªå¦‚" }, { level: "æŸ”é¡º", score: 1.00, achievement: "ä¸æ»‘é€šè¡Œ" }, { level: "ç•¥æœ‰åˆºæ¿€", score: 0.70, achievement: "é¼»è…”è­¦æŠ¥" }, { level: "è¾›è¾£", score: 0.30, achievement: "åƒè¾£å¤§èµ›" }], type: 'single' },
            { impression: "çƒŸå±è‚¡æŠ½å®Œæ¸´æœ›åº¦", weight: 10, degrees: [{ level: "é©¬ä¸Šæƒ³æ”¾å¼ƒ", score: 0.00, achievement: "åŠæ—¶æ­¢æŸ" }, { level: "æŠ½åˆ°èŒ„æ ‡", score: 0.30, achievement: "å°Šé‡æ ‡ç­¾" }, { level: "æŠ½åˆ°çƒ«æ‰‹ä¸ºæ­¢", score: 0.70, achievement: "æé™æŒ‘æˆ˜" }, { level: "æŠ½åˆ°ç‰™ç­¾çƒ§å®Œä¸ºæ­¢", score: 1.00, achievement: "æ¦¨å¹²ä»·å€¼" }], type: 'single' },
            { impression: "è·å¾—å®¹æ˜“åº¦", weight: 10, degrees: [{ level: "å®¹æ˜“", score: 1.00, achievement: "å”¾æ‰‹å¯å¾—" }, { level: "æ™®é€š", score: 0.80, achievement: "å¸‚åœºæµé€š" }, { level: "å›°éš¾", score: 0.50, achievement: "é¢„çº¦æ’é˜Ÿ" }, { level: "åƒè½½éš¾é€¢", score: 0.30, achievement: "å¯»å®çŒäºº" }], type: 'single' },
            { impression: "æ•´ä½“è®°å¿†åº¦", weight: 15, degrees: [{ level: "èŠ¸èŠ¸ä¼—ç”Ÿ", score: 0.00, achievement: "è·¯äººç”²" }, { level: "ç•¥æœ‰å°è±¡", score: 0.30, achievement: "é—ªå…‰ä¸€åˆ»" }, { level: "å¿µå¿µä¸å¿˜", score: 0.70, achievement: "åˆå¤œæ¢¦å›" }, { level: "æ¢¦é‡Œå¯»å¥¹åƒç™¾åº¦", score: 1.00, achievement: "åˆ»éª¨é“­å¿ƒ" }], type: 'single' }
        ];

        // =========================================================
        // Firebase / Config Loading
        // =========================================================

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeAppAndAuth() {
            if (Object.keys(firebaseConfig).length === 0) {
                document.getElementById('statusText').textContent = 'é”™è¯¯: Firebase é…ç½®æœªæä¾›ã€‚æ— æ³•åŠ è½½æˆ–ä¿å­˜é…ç½®ã€‚';
                return;
            }

            try {
                // setLogLevel('Debug'); // Enable for debugging
                app = window.initializeApp(firebaseConfig);
                db = window.getFirestore(app);
                auth = window.getAuth(app);

                const statusText = document.getElementById('statusText');
                
                if (typeof __initial_auth_token !== 'undefined') {
                    await window.signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await window.signInAnonymously(auth);
                }

                userId = auth.currentUser.uid;
                statusText.textContent = `è®¤è¯æˆåŠŸ (UID: ${userId})ï¼Œæ­£åœ¨åŠ è½½é…ç½®...`;
                
                // Start listening for configuration changes
                loadConfigListener();

            } catch (error) {
                console.error("Firebase Initialization or Auth Error:", error);
                document.getElementById('statusText').textContent = 'é”™è¯¯: è®¤è¯æˆ–è¿æ¥æ•°æ®åº“å¤±è´¥ã€‚è¯·æ£€æŸ¥æ§åˆ¶å°ã€‚';
            }
        }

        /**
         * Sets up a real-time listener for the rating configuration document.
         */
        function loadConfigListener() {
            const configDocRef = window.doc(db, CONFIG_DOC_PATH);

            window.onSnapshot(configDocRef, (docSnap) => {
                const statusElement = document.getElementById('loadingStatus');
                const statusText = document.getElementById('statusText');

                if (docSnap.exists() && docSnap.data().config) {
                    // Config found in Firestore
                    const configData = docSnap.data().config;
                    updateConfig(configData);
                    statusText.textContent = `é…ç½®åŠ è½½æˆåŠŸ (${new Date(docSnap.data().lastUpdated).toLocaleString()})`;
                    statusElement.classList.replace('bg-yellow-100', 'bg-green-100');
                    statusElement.classList.replace('text-yellow-800', 'text-green-800');
                } else {
                    // No config found, use default and attempt to save it for the first time
                    console.warn("No config found in Firestore. Using default configuration and attempting to save it.");
                    updateConfig(DEFAULT_RATING_DATA);
                    statusText.textContent = 'æ•°æ®åº“é…ç½®ä¸ºç©ºï¼Œå·²ä½¿ç”¨é»˜è®¤é…ç½®ã€‚è¯·åˆ‡æ¢åˆ°â€œé…ç½®ç®¡ç†â€ä¿å­˜ã€‚';
                    statusElement.classList.replace('bg-yellow-100', 'bg-red-100');
                    statusElement.classList.replace('text-yellow-800', 'text-red-800');
                    
                    // Attempt to save default configuration if it's the initial load
                    if (!isConfigLoaded) {
                         // We don't save immediately here to avoid race conditions/unnecessary writes.
                         // User must explicitly save in the config view.
                    }
                }
                isConfigLoaded = true;
                
                // Update the config editor textarea
                document.getElementById('configJson').value = JSON.stringify(CIGAR_RATING_DATA, null, 2);
            }, (error) => {
                console.error("Firestore Listener Error:", error);
                statusText.textContent = 'é”™è¯¯: ç›‘å¬é…ç½®å¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œå’Œæƒé™ã€‚';
                statusElement.classList.replace('bg-yellow-100', 'bg-red-100');
                statusElement.classList.replace('text-yellow-800', 'text-red-800');
            });
        }

        /**
         * Updates global data variables and re-renders the rating form.
         */
        function updateConfig(newConfig) {
            CIGAR_RATING_DATA = newConfig;
            TOTAL_WEIGHT = CIGAR_RATING_DATA.reduce((sum, item) => sum + (item.weight || 0), 0);
            renderRatingForm();
        }

        /**
         * Saves the JSON content from the textarea to Firestore.
         */
        async function saveConfigToFirestore() {
            const jsonText = document.getElementById('configJson').value;
            const saveMsg = document.getElementById('saveMessage');
            saveMsg.classList.add('hidden');
            
            try {
                // 1. Validate and parse JSON
                const parsedConfig = JSON.parse(jsonText);
                if (!Array.isArray(parsedConfig) || parsedConfig.some(item => typeof item.impression !== 'string')) {
                    throw new Error("JSON æ ¼å¼ä¸æ­£ç¡®ï¼Œé¡¶çº§ç»“æ„åº”ä¸ºæ•°ç»„ï¼Œä¸”æ¯é¡¹åº”åŒ…å« 'impression' å­—æ®µã€‚");
                }

                // 2. Prepare data for Firestore
                const configDocRef = window.doc(db, CONFIG_DOC_PATH);
                const dataToSave = {
                    config: parsedConfig,
                    lastUpdated: Date.now(),
                    updatedBy: userId || 'anonymous'
                };
                
                // 3. Write to Firestore
                await window.setDoc(configDocRef, dataToSave);

                // 4. Success feedback
                saveMsg.textContent = 'ğŸ‰ é…ç½®ä¿å­˜æˆåŠŸå¹¶å·²ç”Ÿæ•ˆï¼';
                saveMsg.classList.remove('hidden');
                saveMsg.classList.add('text-green-700');
                saveMsg.classList.remove('text-red-700');

            } catch (error) {
                console.error("Save Configuration Error:", error);
                saveMsg.textContent = `âŒ ä¿å­˜å¤±è´¥: ${error.message || 'JSON è§£æé”™è¯¯æˆ–æ•°æ®åº“å†™å…¥å¤±è´¥ã€‚'}`;
                saveMsg.classList.remove('hidden');
                saveMsg.classList.add('text-red-700');
                saveMsg.classList.remove('text-green-700');
            }
        }

        // =========================================================
        // UI & Tab Switching
        // =========================================================

        /**
         * Switches between the Rating View and the Config View.
         */
        function switchTab(viewName) {
            const ratingView = document.getElementById('ratingView');
            const configView = document.getElementById('configView');
            const tabRating = document.getElementById('tabRating');
            const tabConfig = document.getElementById('tabConfig');

            if (viewName === 'rating') {
                ratingView.classList.remove('hidden');
                configView.classList.add('hidden');
                tabRating.classList.add('active');
                tabConfig.classList.remove('active');
            } else {
                ratingView.classList.add('hidden');
                configView.classList.remove('hidden');
                tabRating.classList.remove('active');
                tabConfig.classList.add('active');
            }
        }

        // =========================================================
        // Rating Form Logic (Adapted from previous version)
        // =========================================================

        /**
         * Dynamically renders the rating form based on CIGAR_RATING_DATA.
         */
        function renderRatingForm() {
            const container = document.getElementById('ratingInputs');
            let html = '';

            // Guard clause if data is not loaded yet
            if (CIGAR_RATING_DATA.length === 0 && isConfigLoaded) {
                 container.innerHTML = '<p class="p-4 text-center text-red-700 bg-red-100 rounded-lg">é…ç½®æ•°æ®ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥â€œé…ç½®ç®¡ç†â€ã€‚</p>';
                 return;
            } else if (!isConfigLoaded) {
                 container.innerHTML = '<p class="p-4 text-center text-yellow-700 bg-yellow-100 rounded-lg">æ­£åœ¨åŠ è½½é…ç½®...</p>';
                 return;
            }

            CIGAR_RATING_DATA.forEach((item, index) => {
                const impressionId = `imp-${index}`;
                // Fallback for missing type (default to single)
                const inputType = item.type === 'multi' ? 'checkbox' : 'radio'; 
                const requiredAttr = item.type !== 'multi' ? 'required' : ''; 
                const multiSelectNote = item.type === 'multi' ? '<span class="text-sm text-red-600 font-bold ml-2">(å¯å¤šé€‰)</span>' : '';
                
                // Ensure item.weight is a valid number for display
                const weightDisplay = typeof item.weight === 'number' ? item.weight : '?';

                html += `
                    <div class="p-4 bg-white rounded-xl shadow-lg">
                        <h3 class="text-base font-semibold text-gray-800 mb-3 border-b pb-2">
                            ${item.impression} <span class="text-xs text-gray-500 font-normal"> (æƒé‡: ${weightDisplay})</span>
                            ${multiSelectNote}
                        </h3>
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                `;

                // Render degrees, ensuring item.degrees is an array
                if (Array.isArray(item.degrees)) {
                    item.degrees.forEach((degree, degIndex) => {
                        const uniqueId = `${impressionId}-${degIndex}`;
                        html += `
                            <div>
                                <input type="${inputType}" id="${uniqueId}" name="${item.impression}" value="${degree.level}" 
                                    class="rating-input hidden" ${requiredAttr}>
                                <label for="${uniqueId}" 
                                    class="rating-label block text-center p-2 border border-indigo-400 text-indigo-700 
                                    rounded-lg cursor-pointer transition duration-150 hover:bg-indigo-50 text-sm">
                                    ${degree.level}
                                </label>
                            </div>
                        `;
                    });
                }

                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        /**
         * Determines the Pistacho grade based on the final score.
         */
        function determinePistachoGrade(score) {
            if (score >= 95) return { grade: "P", name: "Perfection", chinese: "å®Œç¾ / è‡»å“", color: "text-yellow-500" };
            if (score >= 90) return { grade: "I", name: "Iconic", chinese: "æ ‡å¿—æ€§ / å…¸èŒƒ", color: "text-gray-500" };
            if (score >= 85) return { grade: "S", name: "Supreme", chinese: "è‡³é«˜ / å“è¶Š", color: "text-amber-700" };
            if (score >= 80) return { grade: "T", name: "Treasured", chinese: "çè— / ççˆ±", color: "text-blue-500" };
            if (score >= 70) return { grade: "A", name: "Acceptable", chinese: "å¯æ¥å— / åˆæ ¼", color: "text-green-600" };
            if (score >= 60) return { grade: "C", name: "Common", chinese: "æ™®é€š / ä¸€èˆ¬", color: "text-yellow-600" };
            if (score >= 40) return { grade: "H", name: "Hardship", chinese: "å›°éš¾ / ç¼ºé™·å¤š", color: "text-orange-600" };
            return { grade: "O", name: "Outright Failure", chinese: "å½»åº•å¤±è´¥ / ä¸åˆæ ¼", color: "text-red-600" };
        }

        /**
         * Calculates the final score and displays the results.
         */
        function calculateAndDisplayResults() {
            // Check if configuration is loaded and valid
            if (CIGAR_RATING_DATA.length === 0 || TOTAL_WEIGHT === 0) {
                showCustomMessage('è¯„åˆ†é…ç½®æœªåŠ è½½æˆ–æ€»æƒé‡ä¸ºé›¶ã€‚è¯·æ£€æŸ¥â€œé…ç½®ç®¡ç†â€åé‡è¯•ã€‚');
                return;
            }

            let rawScoreSum = 0;
            let earnedAchievements = [];
            let allSingleItemsChecked = true;

            // 1. Iterate through configuration items
            for (const item of CIGAR_RATING_DATA) {
                const selectedInputs = document.querySelectorAll(`input[name="${item.impression}"]:checked`);
                let itemScoreMultiplier = 0;
                
                if (item.type === 'multi') {
                    // Multi-select logic (accumulate score, cap at 1.0)
                    if (selectedInputs.length > 0) {
                        let combinedAchievementParts = [];
                        
                        selectedInputs.forEach(input => {
                            const selectedDegree = item.degrees.find(d => d.level === input.value);
                            if (selectedDegree) {
                                itemScoreMultiplier += selectedDegree.score;
                                combinedAchievementParts.push(`${selectedDegree.achievement} (${selectedDegree.level})`);
                            }
                        });

                        if (combinedAchievementParts.length > 0) {
                            earnedAchievements.push({ impression: item.impression, achievement: combinedAchievementParts.join(' / ') });
                        }
                        
                        itemScoreMultiplier = Math.min(itemScoreMultiplier, 1.0);
                    }
                    
                } else {
                    // Single-select logic (must be checked for submission)
                    if (selectedInputs.length === 0) {
                        allSingleItemsChecked = false;
                        break; // Stop calculation
                    }
                    
                    const selectedDegree = item.degrees.find(d => d.level === selectedInputs[0].value);
                    
                    if (selectedDegree) {
                        itemScoreMultiplier = selectedDegree.score;
                        earnedAchievements.push({ impression: item.impression, achievement: selectedDegree.achievement });
                    }
                }
                
                // Add score (use item.weight as a fallback)
                const weight = item.weight || 0; 
                const itemScore = weight * itemScoreMultiplier;
                rawScoreSum += itemScore;
            }

            // 2. Check for required selections
            if (!allSingleItemsChecked) {
                showCustomMessage('è¯·å®Œæˆæ‰€æœ‰å•é€‰è¯„åˆ†é¡¹çš„å‹¾é€‰ï¼Œä»¥ä¾¿è¿›è¡Œå‡†ç¡®è®¡ç®—ã€‚');
                return;
            }

            // 3. Normalize score
            const finalScore = (rawScoreSum / TOTAL_WEIGHT) * 100;
            const roundedScore = Math.round(finalScore * 10) / 10;
            
            // 4. Determine Grade
            const finalGrade = determinePistachoGrade(roundedScore);

            // 5. Update and Show Results
            updateResultsDisplay(finalGrade, roundedScore, earnedAchievements);
            updateInfoSummary();
            document.getElementById('resultsSection').classList.remove('hidden');
        }

        /**
         * Updates the visual display of the PISTACHO acronym and final score.
         */
        function updateResultsDisplay(finalGrade, roundedScore, achievements) {
            const PISTACHO_ACRONYM = "PISTACHO";
            let acronymHtml = '';
            const mainGradeLetter = finalGrade.grade;

            for (const letter of PISTACHO_ACRONYM) {
                if (letter === mainGradeLetter) {
                    acronymHtml += `<span class="text-6xl font-black ${finalGrade.color} translate-y-0">${letter}</span>`;
                } else {
                    acronymHtml += `<span class="text-xl font-bold text-gray-400 transform translate-y-1">${letter}</span>`;
                }
            }
            
            document.getElementById('pistachoAcronymDisplay').innerHTML = acronymHtml;
            document.getElementById('resultGradeName').innerHTML = `${finalGrade.name} (${finalGrade.chinese})`;
            document.getElementById('resultScore').textContent = roundedScore.toFixed(1);

            const achievementList = document.getElementById('achievementList');
            achievementList.innerHTML = '';
            
            achievements.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `<span class="font-medium text-indigo-700">${item.impression}:</span> ${item.achievement}`;
                achievementList.appendChild(li);
            });
        }

        /**
         * Updates the summary of basic cigar information.
         */
        function updateInfoSummary() {
            const infoSummary = document.getElementById('infoSummary');
            infoSummary.innerHTML = `
                <li><span class="font-medium">å“ç‰Œ:</span> ${document.getElementById('brand').value || 'æœªå¡«å†™'}</li>
                <li><span class="font-medium">å‹å·:</span> ${document.getElementById('model').value || 'æœªå¡«å†™'}</li>
                <li><span class="font-medium">å°ºå¯¸:</span> ${document.getElementById('size').value || 'æœªå¡«å†™'}</li>
                <li><span class="font-medium">äº§åœ°:</span> ${document.getElementById('origin').value || 'æœªå¡«å†™'}</li>
            `;
        }

        /**
         * Custom modal message box (replaces alert()).
         */
        function showCustomMessage(message) {
            console.error(message);
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            overlay.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm mx-4 transform transition-all scale-100">
                    <h4 class="text-xl font-bold text-red-600 mb-3">æç¤º (Notice)</h4>
                    <p class="text-gray-700 mb-6">${message}</p>
                    <button onclick="this.closest('.fixed').remove()" 
                        class="w-full py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        ç¡®è®¤
                    </button>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        // Initialize Firebase and start loading config when the window loads
        window.onload = initializeAppAndAuth;
    </script>
</body>
</html>
