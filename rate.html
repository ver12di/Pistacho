<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雪茄评分输入</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cropper.js CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
    <script>
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: {
                            sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                        },
                        transitionProperty: { 'width': 'width' }
                    }
                }
            }
        } else {
            console.warn('Tailwind object not found. Skipping config.');
        }
    </script>
    <style>
        .cropper-container { max-height: 60vh; }
        .cropper-modal-content { width: 90%; max-width: 800px; }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">
    <div id="app-container" class="max-w-6xl mx-auto p-4 md:p-8">
        <!-- **NAVBAR UPDATED** -->
        <nav class="mb-6 flex flex-wrap justify-between items-center bg-white p-3 rounded-lg shadow-sm gap-4">
            <a href="index.html" class="text-xl font-bold text-indigo-600">Pistacho评分</a>
            <div class="flex items-center space-x-4 flex-grow justify-center md:justify-start md:flex-grow-0 order-3 md:order-2 w-full md:w-auto">
                <a href="index.html" class="text-gray-600 hover:text-indigo-600">社区动态</a>
                <!-- Highlight current page -->
                <a href="rate.html" class="text-indigo-600 font-bold underline">去评分</a>
                <a href="history.html" class="text-gray-600 hover:text-indigo-600">我的点评历史</a>
                <a href="certified.html" class="text-gray-600 hover:text-indigo-600">认证评分</a>
            </div>
            <div id="login-status-container" class="flex items-center order-2 md:order-3">
                 <!-- Login/Logout button will be rendered here -->
            </div>
        </nav>
        <!-- **END NAVBAR UPDATE** -->

        <!-- Header Scoreboard -->
        <header class="mb-8 p-6 bg-indigo-700 text-white rounded-xl shadow-2xl">
            <div class="flex justify-between items-start">
                <div>
                    <h1 id="app-title-display" class="text-3xl font-extrabold mb-1">雪茄评分应用</h1>
                    <p id="app-description-display" class="text-indigo-200 text-sm max-w-lg">正在加载描述...</p>
                </div>
                 <div class="flex items-center space-x-3 flex-shrink-0">
                    <div id="admin-links-container" class="flex items-center space-x-3"></div>
                </div>
            </div>
            <div class="mt-6 bg-black bg-opacity-20 p-4 rounded-lg">
                <div class="flex justify-between items-end">
                    <div>
                        <p class="text-sm font-medium text-indigo-200">当前得分</p>
                        <div class="flex items-baseline">
                            <span id="current-score-display" class="text-6xl font-black leading-none">0.00</span>
                            <span class="text-lg font-medium text-indigo-200 ml-2">/ <span id="total-weight-max-display">0</span></span>
                        </div>
                    </div>
                    <div class="text-right">
                         <p class="text-sm font-medium text-indigo-200">已评项目</p>
                         <p id="progress-text" class="font-bold text-lg">0 / 0</p>
                    </div>
                </div>
                <div class="w-full bg-indigo-900 rounded-full h-2.5 mt-2">
                    <div id="progress-bar" class="bg-green-400 h-2.5 rounded-full transition-width duration-500" style="width: 0%"></div>
                </div>
            </div>
             <p id="config-load-status" class="text-xs text-yellow-300 mt-2 text-right">正在连接...</p>
        </header>

        <!-- Main Content -->
        <main id="main-content">
            <!-- Cigar Info Section -->
            <section class="mb-8 p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-4">雪茄信息</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="cigar-name" class="block text-sm font-medium text-gray-700">名称</label>
                        <input type="text" id="cigar-name" autocomplete="off" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="例如：帕特加斯D4">
                    </div>
                    <div>
                        <label for="cigar-size" class="block text-sm font-medium text-gray-700">尺寸</label>
                        <input type="text" id="cigar-size" autocomplete="off" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="例如：Robusto">
                    </div>
                    <div>
                        <label for="cigar-origin" class="block text-sm font-medium text-gray-700">产地</label>
                        <input type="text" id="cigar-origin" autocomplete="off" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="例如：古巴">
                    </div>
                </div>
            </section>

            <!-- Rating Form Container -->
            <div id="rating-form-container"></div>

            <!-- Image Upload Section -->
            <section class="mt-8 p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-4">上传封面图片</h2>
                <div class="flex flex-col md:flex-row gap-6 items-start">
                    <div id="image-preview-container" class="w-full md:w-1/3 h-48 bg-gray-100 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-300 overflow-hidden">
                        <span class="text-gray-400 text-3xl font-bold">???</span>
                    </div>
                    <div class="flex-grow">
                        <label for="image-upload-input" class="w-full text-center py-3 px-6 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 cursor-pointer inline-block">
                            选择图片
                        </label>
                        <input type="file" id="image-upload-input" class="hidden" accept="image/png, image/jpeg, image/webp" onchange="handleFileSelect(event)">
                        <button id="image-remove-button" onclick="removeImage()" class="w-full mt-2 py-2 px-6 bg-red-500 text-white font-medium rounded-lg shadow-md hover:bg-red-600 hidden">
                            删除图片
                        </button>
                        <p class="text-sm text-gray-500 mt-2">支持 JPG, PNG, WEBP。最大 5MB。</p>
                        <p id="image-upload-status" class="text-sm font-medium text-indigo-600 mt-2"></p>
                    </div>
                </div>
            </section>

            <!-- Review Section -->
            <section class="mt-8 p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-4">文字评价</h2>
                <div>
                    <textarea id="cigar-review" rows="5" class="w-full p-3 border rounded-md" placeholder="在此处输入您的详细品吸感受..."></textarea>
                </div>
            </section>

            <!-- Action Buttons -->
            <div class="mt-8 grid grid-cols-2 gap-4">
                <button onclick="resetRatings()" class="w-full py-3 px-6 bg-red-500 text-white font-bold text-lg rounded-lg shadow-md hover:bg-red-600">重置</button>
                <button id="main-action-button" onclick="showResults()" class="w-full py-3 px-6 bg-green-600 text-white font-bold text-lg rounded-lg shadow-md hover:bg-green-700">查看报告</button>
            </div>
        </main>

        <footer class="mt-8 text-center text-gray-500 text-sm p-4 border-t">评分应用数据由云端配置中心实时同步。</footer>
    </div>

    <!-- Cropper Modal -->
    <div id="cropper-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 cropper-modal-content">
            <h2 class="text-2xl font-bold mb-4">裁切图片</h2>
            <div class="cropper-container">
                <img id="cropper-image" src="" alt="Image to crop">
            </div>
            <p id="cropper-status" class="text-sm font-medium text-indigo-600 my-2"></p>
            <div class="flex justify-end gap-4 mt-4">
                <button onclick="cancelCrop()" class="py-2 px-5 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">取消</button>
                <button onclick="confirmCropAndUpload()" class="py-2 px-5 bg-blue-600 text-white rounded-lg hover:bg-blue-700">确认并上传</button>
            </div>
        </div>
    </div>

    <!-- Cropper.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <!-- App Logic -->
    <script type="module">
        // --- Global Variables ---
        let ratingConfig = null;
        let userRatings = {};
        let currentAuthUser = null;
        let currentImageKey = null; // R2 image key
        let isEditMode = false;
        let editRatingId = null;
        let cropper = null;
        const cropperModal = document.getElementById('cropper-modal');
        const cropperImage = document.getElementById('cropper-image');
        const cropperStatus = document.getElementById('cropper-status');
        const AUTHING_APP_ID = '68f5b0b6875017c02b3bfdb3';
        const AUTHING_HOST = 'https://xfvu647mcdbk-demo.authing.cn';

        // **NEW**: Grading scale needed for finalGrade calculation
        const GRADING_SCALE = [
          { "grade": "P", "name_en": "Pinnacle", "name_cn": "顶峰 / 登峰造极", "min_score": 95 },
          { "grade": "I", "name_en": "Impeccable", "name_cn": "无暇 / 完美无瑕", "min_score": 90 },
          { "grade": "S", "name_en": "Superior", "name_cn": "卓越 / 出众", "min_score": 85 },
          { "grade": "T", "name_en": "Terrific", "name_cn": "极好 / 绝佳", "min_score": 80 },
          { "grade": "A", "name_en": "Appreciable", "name_cn": "可圈可点 / 值得欣赏", "min_score": 70 },
          { "grade": "C", "name_en": "Commonplace", "name_cn": "平庸 / 普通", "min_score": 60 },
          { "grade": "H", "name_en": "Hesitant", "name_cn": "犹豫 / 瑕瑜互见", "min_score": 40 },
          { "grade": "O", "name_en": "Ordinary", "name_cn": "乏善可陈 / 平淡", "min_score": 0 }
        ];

        // --- Authentication ---
        window.login = function() {
            const redirectUri = window.location.origin;
            const authorizeUrl = new URL('/oidc/auth', AUTHING_HOST);
            authorizeUrl.search = new URLSearchParams({
                client_id: AUTHING_APP_ID, redirect_uri: redirectUri, response_type: 'code',
                scope: 'openid profile email phone', state: Math.random().toString(36).substring(2)
            }).toString();
            window.location.href = authorizeUrl.toString();
        }
        window.logout = function() {
             const logoutUrl = new URL('/oidc/session/end', AUTHING_HOST);
             logoutUrl.search = new URLSearchParams({ post_logout_redirect_uri: window.location.origin }).toString();
             sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken');
             window.location.href = logoutUrl.toString(); // Redirect to index after logout
        }
        function renderLoginStatus(user) {
            const container = document.getElementById('login-status-container'); if (!container) return;
            if (user) {
                const displayName = user.nickname || user.name || user.preferred_username || user.email || '已登录';
                container.innerHTML = `<span class="text-sm font-medium text-gray-700 mr-2 hidden sm:inline">${displayName}</span><button onclick="logout()" class="px-3 py-1 text-xs font-medium rounded-full bg-red-500 text-white hover:bg-red-600">退出</button>`;
            } else {
                 // **LINK UPDATED**: Login should happen on rate page if needed
                container.innerHTML = `<button onclick="login()" class="px-3 py-1 text-xs font-medium rounded-full bg-green-500 text-white hover:bg-green-600">登录/注册</button>`;
            }
        }
        function renderAdminLinks() {
            const adminLinksContainer = document.getElementById('admin-links-container'); adminLinksContainer.innerHTML = ''; if (!adminLinksContainer || !currentAuthUser) return;
            const userRole = currentAuthUser.db_role; const isAdmin = userRole === 'admin' || userRole === 'super_admin'; const isSuperAdmin = userRole === 'super_admin';
            if (isAdmin) { adminLinksContainer.innerHTML += `<a href="cigar_rating_config.html" class="flex items-center px-3 py-1.5 border text-xs font-medium rounded-full text-white bg-blue-600 hover:bg-blue-500">评分配置</a>`; }
            if (isSuperAdmin) { adminLinksContainer.innerHTML += `<a href="role_management.html" class="flex items-center px-3 py-1.5 border text-xs font-medium rounded-full text-yellow-100 bg-purple-600 hover:bg-purple-500 ml-2">用户管理</a>`; }
        }
        async function handleOidcCallback(code) {
             try {
                const redirectUri = window.location.origin; const apiUrl = new URL('/api/authing/callback', window.location.origin);
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code: code, redirect_uri: redirectUri }) });
                if (!response.ok) { const err = await response.json(); throw new Error(err.error || '认证回调失败'); }
                const fullUserProfile = await response.json(); sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile)); sessionStorage.setItem('accessToken', fullUserProfile.accessToken); return fullUserProfile;
            } catch (e) { console.error('认证回调处理失败:', e); alert(`登录失败: ${e.message}`); sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken'); return null; } finally { window.history.replaceState({}, document.title, window.location.pathname); }
        }
        async function validateSessionAndGetUser() {
            const token = sessionStorage.getItem('accessToken'); if (!token) return null;
            try {
                const apiUrl = new URL('/api/me', window.location.origin); const response = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) { sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken'); return null; }
                const fullUserProfile = await response.json(); sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile)); return fullUserProfile;
            } catch (e) { console.error("Session validation failed:", e); return null; }
        }
        function setUser(user) { currentAuthUser = user; renderLoginStatus(currentAuthUser); setTimeout(() => { renderAdminLinks(); }, 0); }
        // --- End Auth ---


        // --- Image Cropping and Upload ---
        function updateImagePreview(imageKey) { /* ... (no change) ... */
             const preview = document.getElementById('image-preview-container'); const removeBtn = document.getElementById('image-remove-button'); const status = document.getElementById('image-upload-status');
            if (imageKey) { preview.innerHTML = `<img src="/api/image/${imageKey}" alt="Cigar preview" class="w-full h-full object-cover">`; removeBtn.classList.remove('hidden'); status.textContent = '图片已上传。'; }
            else { preview.innerHTML = `<span class="text-gray-400 text-3xl font-bold">???</span>`; removeBtn.classList.add('hidden'); status.textContent = ''; }
        }
        window.handleFileSelect = function(event) { /* ... (no change) ... */
            const file = event.target.files[0]; const status = document.getElementById('image-upload-status'); if (!file) return; if (!currentAuthUser) { alert("请先登录再上传图片。"); return; } if (file.size > 5 * 1024 * 1024) { alert("图片太大，请选择 5MB 以下的文件。"); return; }
            const reader = new FileReader(); reader.onload = (e) => {
                cropperModal.classList.remove('hidden'); cropperImage.src = e.target.result; if (cropper) { cropper.destroy(); }
                cropper = new Cropper(cropperImage, { aspectRatio: 1179 / 1572, viewMode: 1, autoCropArea: 0.9, background: false, }); cropperStatus.textContent = '请调整裁切框，然后点击确认。';
            }; reader.readAsDataURL(file);
        }
        window.confirmCropAndUpload = async function() { /* ... (no change) ... */
             if (!cropper) return; const token = sessionStorage.getItem('accessToken'); if (!token) { alert("会话已过期，请重新登录。"); return; } cropperStatus.textContent = '正在裁切并上传...';
            const canvas = cropper.getCroppedCanvas({ width: 600, height: 800, imageSmoothingQuality: 'high', });
            canvas.toBlob(async (blob) => { if (!blob) { cropperStatus.textContent = '裁切失败，请重试。'; return; }
                try { const formData = new FormData(); formData.append('image', blob, 'cropped-image.jpg');
                    const response = await fetch('/api/upload-image', { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: formData }); const result = await response.json(); if (!response.ok) { throw new Error(result.error || '上传失败'); }
                    currentImageKey = result.imageKey; updateImagePreview(currentImageKey); cancelCrop();
                } catch (e) { console.error("上传图片失败:", e); cropperStatus.textContent = `上传失败: ${e.message}`; }
            }, 'image/jpeg', 0.9);
        }
        window.cancelCrop = function() { /* ... (no change) ... */
            cropperModal.classList.add('hidden'); if (cropper) { cropper.destroy(); cropper = null; } document.getElementById('image-upload-input').value = null; cropperStatus.textContent = '';
        }
        window.removeImage = function() { /* ... (no change) ... */
            currentImageKey = null; document.getElementById('image-upload-input').value = null; updateImagePreview(null); if (cropper) { cropper.destroy(); cropper = null; }
        }
        // --- End Image ---


        // --- Core Rating Logic ---
        async function loadConfig() {
            document.getElementById('config-load-status').textContent = '正在同步配置...';
            try {
                const apiUrl = new URL('/api/config/latest', window.location.origin);
                const response = await fetch(apiUrl); if (!response.ok) throw new Error(`服务器错误: ${response.statusText}`);
                ratingConfig = await response.json();
                if (!ratingConfig || !ratingConfig.ratingCriteria) throw new Error("加载的配置无效。"); // Add validation
                calculateWeights(ratingConfig); userRatings = {}; renderRatingView();
                document.getElementById('config-load-status').textContent = `配置已同步`;
            } catch (error) {
                console.error("加载配置失败:", error); document.getElementById('config-load-status').textContent = '配置加载失败';
                alert(`加载应用核心配置失败，请刷新页面重试。\n错误详情: ${error.message}`);
            }
        }
        function getRatingId(category, criterion) { return `${String(category || '').trim()}-${String(criterion || '').trim()}`; }
        function calculateWeights(config) { if (!config || !config.ratingCriteria) return; let grandTotal = 0, totalCriteriaCount = 0; config.ratingCriteria.forEach(category => { let categoryTotal = 0; (category.criteriaList || []).forEach(criterion => { categoryTotal += (criterion.weight || 0); totalCriteriaCount++; }); category.totalWeight = categoryTotal; grandTotal += categoryTotal; }); config.totalWeightMax = grandTotal; config.totalCriteriaCount = totalCriteriaCount; }
        function calculateFinalScore() { if (!ratingConfig || !ratingConfig.ratingCriteria) return 0; let totalScore = 0; ratingConfig.ratingCriteria.forEach(category => { (category.criteriaList || []).forEach(criterion => { const id = getRatingId(category.category, criterion.name); const selectedOptionIndex = userRatings[id]; if (selectedOptionIndex !== undefined && criterion.options?.[selectedOptionIndex]) { totalScore += (criterion.weight || 0) * (criterion.options[selectedOptionIndex].scorePct || 0); } }); }); return totalScore; }
        window.updateRatingSelection = function(categoryName, criterionName, optionIndex) { const id = getRatingId(categoryName, criterionName); if (userRatings[id] === optionIndex) { delete userRatings[id]; } else { userRatings[id] = optionIndex; } renderRatingView(); };
        function renderRatingView() {
            if (!ratingConfig || !ratingConfig.ratingCriteria) { const formContainer = document.getElementById('rating-form-container'); formContainer.innerHTML = `<div class="text-center p-6 bg-white rounded-lg shadow"><p>无法加载评分标准。</p></div>`; return; };
            const totalScore = calculateFinalScore(); document.getElementById('app-title-display').textContent = ratingConfig.appTitle; document.getElementById('app-description-display').textContent = ratingConfig.description; document.getElementById('total-weight-max-display').textContent = ratingConfig.totalWeightMax ?? 0; document.getElementById('current-score-display').textContent = totalScore.toFixed(2); const ratedCount = Object.keys(userRatings).length; const totalCount = ratingConfig.totalCriteriaCount || 1; document.getElementById('progress-bar').style.width = `${(ratedCount / totalCount) * 100}%`; document.getElementById('progress-text').textContent = `${ratedCount} / ${totalCount}`; const formContainer = document.getElementById('rating-form-container');
            formContainer.innerHTML = ratingConfig.ratingCriteria.map((category) => `
                <div class="bg-white p-6 rounded-xl shadow-lg mb-8 border-l-4 border-indigo-500">
                    <h3 class="text-xl font-bold text-indigo-700 mb-2">${category.category}</h3> <p class="text-gray-500 text-sm mb-4">${category.detail || ''}</p>
                    <div class="space-y-6">${(category.criteriaList || []).map((criterion) => renderRatingCriterion(category.category, criterion)).join('')}</div>
                </div>`).join('');
        }
        function renderRatingCriterion(categoryName, criterion) {
            const id = getRatingId(categoryName, criterion.name); const selectedOptionIndex = userRatings[id]; const currentWeight = criterion.weight || 0; let currentScore = 0; if (selectedOptionIndex !== undefined && criterion.options?.[selectedOptionIndex]) { currentScore = currentWeight * (criterion.options[selectedOptionIndex].scorePct || 0); } const isSuperAdmin = currentAuthUser?.db_role === 'super_admin';
            return `<div class="bg-gray-50 p-4 rounded-lg border"> <div class="flex justify-between items-center mb-3"> <h4 class="text-lg font-semibold text-gray-800">${criterion.name} ${isSuperAdmin ? `(${currentWeight} 分)` : ''}</h4> ${isSuperAdmin ? `<span class="text-xl font-extrabold text-green-600">${currentScore.toFixed(2)}</span>` : ''} </div> <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2"> ${(criterion.options || []).map((option, optIndex) => { const isSelected = selectedOptionIndex === optIndex; const score = (currentWeight * (option.scorePct || 0)).toFixed(2); return `<button onclick="updateRatingSelection('${categoryName}', '${criterion.name}', ${optIndex})" class="p-2 text-sm text-center rounded-lg border transition ${ isSelected ? 'bg-indigo-600 text-white shadow-md' : 'bg-white hover:bg-indigo-50' }"> ${option.description} ${isSuperAdmin ? `<span class="block text-xs ${isSelected ? 'text-indigo-200' : 'text-gray-500'}">(得 ${score} 分)</span>` : ''} </button>`; }).join('')} </div> </div>`;
        }
        // --- End Core Rating Logic ---


        // --- Actions (Reset, Show Results / Save Changes) ---
        window.resetRatings = function() {
            if (confirm("确定要重置所有评分选择和图片吗？")) { userRatings = {}; document.getElementById('cigar-name').value = ''; document.getElementById('cigar-size').value = ''; document.getElementById('cigar-origin').value = ''; document.getElementById('cigar-review').value = ''; removeImage();
                if (isEditMode) { isEditMode = false; editRatingId = null; const actionButton = document.getElementById('main-action-button'); actionButton.textContent = "查看报告"; actionButton.classList.remove('bg-blue-600', 'hover:bg-blue-700'); actionButton.classList.add('bg-green-600', 'hover:bg-green-700'); window.history.replaceState({}, document.title, window.location.pathname); }
                renderRatingView();
            }
        }

        window.showResults = async function() {
            const token = sessionStorage.getItem('accessToken');
            if (!isEditMode && (!currentAuthUser || !token)) { // Check login only for NEW ratings
                return alert("请登录后才能提交评分。");
            }
            if (!ratingConfig || Object.keys(userRatings).length === 0) { return alert("请至少选择一个评分项后再操作。"); }

            const cigarInfo = { name: document.getElementById('cigar-name').value || '未命名雪茄', size: document.getElementById('cigar-size').value || '未知尺寸', origin: document.getElementById('cigar-origin').value || '未知产地' };
            const cigarReview = document.getElementById('cigar-review').value || '无';
            const finalScore = calculateFinalScore();

            // **FIX**: Calculate normalizedScore and finalGrade *before* saving to sessionStorage
            const maxScore = ratingConfig.totalWeightMax || 1; // Avoid division by zero
            const normalizedScore = maxScore > 0 ? (finalScore / maxScore) * 100 : 0;
            const finalGrade = GRADING_SCALE.find(g => normalizedScore >= g.min_score) || GRADING_SCALE[GRADING_SCALE.length - 1];

            const resultsData = {
                config: ratingConfig,
                ratings: userRatings,
                calculatedScore: finalScore,
                cigarInfo: cigarInfo,
                cigarReview: cigarReview,
                imageUrl: currentImageKey,
                // **FIX**: Add these top-level fields
                normalizedScore: normalizedScore,
                finalGrade: finalGrade,
                // isDraft is needed by results.html to show save button
                isDraft: !isEditMode // Only new ratings are drafts initially
            };

            console.log("Data being prepared for results/save:", resultsData); // Debug log

            if (isEditMode && editRatingId) {
                // --- Save Changes (PUT request) ---
                const actionButton = document.getElementById('main-action-button'); actionButton.textContent = "正在保存..."; actionButton.disabled = true;
                try {
                    if (!token) throw new Error("会话已过期，请重新登录。"); // Need token to save changes
                    resultsData.ratingId = editRatingId; // Add ID for PUT request
                    const apiUrl = new URL(`/api/ratings`, window.location.origin);
                    const response = await fetch(apiUrl, {
                        method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(resultsData)
                    });
                    if (!response.ok) { const err = await response.json(); throw new Error(err.error || '更新失败'); }
                    alert("更改已保存！"); window.location.href = 'history.html'; // Go to history after saving
                } catch (e) { alert(`保存失败: ${e.message}`); actionButton.textContent = "保存更改"; actionButton.disabled = false; }
            } else {
                // --- Show Results (Save to sessionStorage, navigate) ---
                try {
                    sessionStorage.setItem('cigarRatingResults', JSON.stringify(resultsData));
                    window.location.href = 'results.html';
                } catch (e) { alert("无法保存会话数据 (sessionStorage)。"); }
            }
        }
        // --- End Actions ---


        // --- Edit Mode Logic ---
        async function loadRatingForEdit(ratingId) {
            const token = sessionStorage.getItem('accessToken'); if (!token) { alert("无法验证身份，请重新登录。"); window.location.href = 'history.html'; return; }
            document.getElementById('config-load-status').textContent = `正在加载点评 ${ratingId}...`;
            try {
                const apiUrl = new URL(`/api/ratings?id=${ratingId}`, window.location.origin);
                const response = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${token}` } }); if (!response.ok) { const err = await response.json(); throw new Error(err.error || '加载点评失败'); }
                const ratingData = await response.json(); if (!ratingData) { throw new Error(`点评 ${ratingId} 未找到或无权访问。`); }
                // Need fullData for editing
                if (!ratingData.fullData || !ratingData.fullData.ratings) { throw new Error("加载的点评数据不完整，无法编辑。"); }

                // Check ratingConfig again, just in case
                if (!ratingConfig) { await loadConfig(); if(!ratingConfig) throw new Error("无法加载评分配置，无法编辑。"); }

                document.getElementById('cigar-name').value = ratingData.cigarInfo?.name || ''; document.getElementById('cigar-size').value = ratingData.cigarInfo?.size || ''; document.getElementById('cigar-origin').value = ratingData.cigarInfo?.origin || ''; document.getElementById('cigar-review').value = ratingData.cigarReview || '';
                // Load original ratings selections from fullData
                userRatings = ratingData.fullData.ratings || {};
                currentImageKey = ratingData.imageUrl || null; updateImagePreview(currentImageKey); isEditMode = true; editRatingId = ratingId;
                const actionButton = document.getElementById('main-action-button'); actionButton.textContent = "保存更改"; actionButton.classList.remove('bg-green-600', 'hover:bg-green-700'); actionButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                renderRatingView(); document.getElementById('config-load-status').textContent = `已加载点评 ${ratingId} (编辑模式)`;
            } catch (e) { alert(`加载点评失败: ${e.message}`); window.location.href = 'history.html'; }
        }
        // --- End Edit Mode ---


        // --- Initialization ---
        window.onload = async function() {
            const urlParams = new URLSearchParams(window.location.search); const code = urlParams.get('code'); const editId = urlParams.get('edit'); let user = null;
            if (code) { user = await handleOidcCallback(code); } else { user = await validateSessionAndGetUser(); } setUser(user); console.log("Current User Object:", currentAuthUser);
            await loadConfig(); // Ensure config loads first
            if (editId) { await loadRatingForEdit(editId); }
            // Clean URL only if edit param was present and loading was attempted
            if (editId) { window.history.replaceState({}, document.title, window.location.pathname); }
        };
    </script>
</body>
</html>

