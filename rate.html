<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="ratePage.title">发布雪茄点评</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <script src="https://unpkg.com/i18next/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-http-backend/i18nextHttpBackend.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector/i18nextBrowserLanguageDetector.min.js"></script>
    
    <script>
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: { sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'], },
                        transitionProperty: { 'width': 'width' }
                    }
                }
            }
        } else { console.warn('Tailwind object not found. Skipping config.'); }
    </script>
    <style>
        .cropper-container { max-height: 60vh; }
        .cropper-modal-content { width: 90%; max-width: 800px; }
        /* ... (all other styles remain the same) ... */
        .preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.5rem; }
        .preview-item {
            position: relative; aspect-ratio: 1179 / 1572; overflow: hidden; border-radius: 0.375rem; /* rounded-md */
            border: 1px solid #e5e7eb; /* border-gray-200 */
            cursor: grab; /* Add grab cursor for draggable items */
        }
        .preview-item:active { cursor: grabbing; } /* Change cursor while dragging */
        .preview-item img { display: block; width: 100%; height: 100%; object-fit: cover; }
        .preview-item .remove-btn { position: absolute; top: 2px; right: 2px; background-color: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 1.25rem; height: 1.25rem; font-size: 0.75rem; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; z-index: 10; }
        .preview-item .remove-btn:hover { background-color: rgba(239, 68, 68, 0.8); /* hover:bg-red-500 */ }
        /* Style for "Set Cover" button */
        .preview-item .set-cover-btn {
            position: absolute; bottom: 2px; left: 2px; background-color: rgba(0, 0, 0, 0.6); color: white; border: none; border-radius: 0.25rem; /* rounded-sm */
            padding: 1px 4px; font-size: 0.65rem; /* Smaller text */ line-height: 1; cursor: pointer; z-index: 10;
        }
        .preview-item .set-cover-btn:hover { background-color: rgba(67, 56, 202, 0.8); /* hover:bg-indigo-700 */ }
        .preview-item.is-cover .set-cover-btn { /* Style for the current cover */
            background-color: rgba(22, 163, 74, 0.8); /* bg-green-600 */ cursor: default; pointer-events: none; /* Disable click */
        }
        /* Style for the element being dragged */
        .sortable-ghost { opacity: 0.4; background: #c8ebfb; }
        .sortable-drag { opacity: 1 !important; /* Ensure dragged item is fully visible */ }
        /* Style for flavor buttons */
        .flavor-btn {
            padding: 0.375rem 0.75rem; /* px-3 py-1.5 */
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 9999px; /* rounded-full */
            font-size: 0.875rem; /* text-sm */
            margin-right: 0.5rem; /* mr-2 */
            margin-bottom: 0.5rem; /* mb-2 */
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
            color: #374151; /* text-gray-700 */
        }
        .flavor-btn:hover:not(.selected) { /* Apply hover only if not selected */
            background-color: #f3f4f6; /* bg-gray-100 */
            border-color: #9ca3af; /* border-gray-400 */
        }
        .flavor-btn.selected {
            background-color: #4f46e5; /* bg-indigo-600 */
            color: white;
            border-color: #4f46e5; /* border-indigo-600 */
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">
    <div id="app-container" class="max-w-4xl mx-auto p-4 md:p-8">
        <nav class="mb-6 flex flex-wrap justify-between items-center bg-white p-3 rounded-lg shadow-sm gap-4">
            <a href="index.html" class="text-xl font-bold text-indigo-600" data-i18n="nav.title">Pistacho评分</a>
            <div class="flex items-center space-x-4 flex-grow justify-center md:justify-start md:flex-grow-0 order-3 md:order-2 w-full md:w-auto">
                <a href="index.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.community">社区动态</a>
                <a href="rate.html" class="text-indigo-600 font-bold underline" data-i18n="nav.rate">去评分</a>
                <a href="history.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.myRatings">我的点评历史</a>
                <a href="certified.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.certified">认证评分</a>
            </div>
            <div class="flex items-center order-2 md:order-3">
               <select id="language-switcher" class="text-xs p-1 rounded border border-gray-300 mr-2 h-7" style="line-height: 1;">
                   <option value="zh">简体中文</option>
                   <option value="en">English</option>
                   <option value="es">Español</option>
               </select>
               <div id="login-status-container" class="flex items-center"></div>
            </div>
        </nav>
        <header class="mb-8 p-6 bg-indigo-700 text-white rounded-xl shadow-2xl">
             <div class="flex justify-between items-start">
                 <div> <h1 id="app-title-display" class="text-3xl font-extrabold mb-1">雪茄评分应用</h1> <p id="app-description-display" class="text-indigo-200 text-sm max-w-lg">正在加载描述...</p> </div>
                 <div class="flex items-center space-x-3 flex-shrink-0"> <div id="admin-links-container" class="flex items-center space-x-3"></div> </div>
             </div>
             <div class="mt-6 bg-black bg-opacity-20 p-4 rounded-lg">
                 <div class="flex justify-between items-end">
                     <div>
                        <p class="text-sm font-medium text-indigo-200" data-i18n="ratePage.currentScore">当前得分</p>
                        <div class="flex items-baseline"> <span id="current-score-display" class="text-6xl font-black leading-none">0.00</span> <span class="text-lg font-medium text-indigo-200 ml-2">/ <span id="total-weight-max-display">0</span></span> </div>
                     </div>
                     <div class="text-right">
                        <p class="text-sm font-medium text-indigo-200" data-i18n="ratePage.itemsRated">已评项目</p>
                        <p id="progress-text" class="font-bold text-lg">0 / 0</p>
                     </div>
                 </div>
                 <div class="w-full bg-indigo-900 rounded-full h-2.5 mt-2"> <div id="progress-bar" class="bg-green-400 h-2.5 rounded-full transition-width duration-500" style="width: 0%"></div> </div>
             </div>
              <p id="config-load-status" class="text-xs text-yellow-300 mt-2 text-right" data-i18n="ratePage.configSyncing">正在连接...</p>
        </header>

        <div id="login-prompt" class="hidden text-center p-6 bg-yellow-100 text-yellow-800 rounded-lg shadow mb-8">
             <p class="font-semibold mb-3" data-i18n="ratePage.loginPrompt">请先登录才能进行评分。</p>
             <button onclick="login()" class="px-5 py-2 text-sm font-medium rounded-lg bg-green-500 text-white hover:bg-green-600" data-i18n="nav.login">前往登录/注册</button>
        </div>


        <main id="main-content">

            <section class="mb-8 p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-4" data-i18n="ratePage.ratingTitle">点评标题 <span class="text-red-500">*</span></h2>
                <input type="text" id="rating-title" maxlength="22" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-indigo-500 focus:ring-indigo-500" data-i18n="ratePage.ratingTitlePlaceholder" placeholder="填写标题会被更多人看到 (最多22字)">
                <p id="title-char-count" class="text-xs text-gray-500 text-right mt-1">0 / 22</p>
            </section>

            <section class="mb-8 p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-4" data-i18n="ratePage.uploadImages" data-i18n-options='{ "max": 5 }'>上传图片 (最多5张, 可拖拽排序) <span class="text-red-500">*</span></h2>
                <p class="text-sm text-gray-600 mb-3" data-i18n="ratePage.uploadImagesDesc">第一张图片将作为封面图显示。点击图片左下角按钮更换封面。</p>
                <div class="preview-grid mb-4" id="image-preview-grid">
                    </div>
                <div>
                    <label for="image-upload-input" id="image-upload-label" class="w-full md:w-auto text-center py-2 px-6 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 cursor-pointer inline-block" data-i18n="ratePage.selectImages">
                        选择图片
                    </label>
                    <input type="file" id="image-upload-input" class="hidden" accept="image/png, image/jpeg, image/webp" multiple onchange="handleFileSelect(event)">
                    <p class="text-sm text-gray-500 mt-2 inline-block md:ml-4" data-i18n="ratePage.imageSupport">支持 JPG, PNG, WEBP。单张最大 5MB。</p>
                    <p id="image-upload-status" class="text-sm font-medium text-indigo-600 mt-2"></p>
                </div>
            </section>

            <section class="mb-8 p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-4" data-i18n="ratePage.reviewAndFlavors">文字评价与风味选择</h2>
                <div class="mb-4 border-b pb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="ratePage.selectFlavors">选择您感受到的主要风味 (可选):</label>
                    <div id="flavor-buttons-container" class="flex flex-wrap">
                        </div>
                </div>
                <div>
                    <label for="cigar-review" class="block text-sm font-medium text-gray-700 mb-2" data-i18n="ratePage.detailedReview">详细文字评价:</label>
                    <textarea id="cigar-review" rows="6" maxlength="1500" class="w-full p-3 border rounded-md focus:border-indigo-500 focus:ring-indigo-500" data-i18n="ratePage.reviewPlaceholder" placeholder="在此处输入您的详细品吸感受..."></textarea>
                    <p id="review-char-count" class="text-xs text-gray-500 text-right mt-1">0 / 1500</p>
                </div>
            </section>

            <section class="mb-8 p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-4" data-i18n="ratePage.cigarInfo">雪茄信息</h2>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="cigar-name" class="block text-sm font-medium text-gray-700" data-i18n="ratePage.cigarNameRequired">名称 <span class="text-red-500">*</span></label>
                        <input type="text" id="cigar-name" autocomplete="off" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" data-i18n="ratePage.cigarNamePlaceholder" placeholder="例如：帕特加斯D4">
                    </div>
                    <div>
                        <label for="cigar-size" class="block text-sm font-medium text-gray-700" data-i18n="ratePage.cigarSize">尺寸</label>
                        <input type="text" id="cigar-size" autocomplete="off" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" data-i18n="ratePage.cigarSizePlaceholder" placeholder="例如：Robusto">
                    </div>
                    <div>
                        <label for="cigar-origin" class="block text-sm font-medium text-gray-700" data-i18n="ratePage.cigarOrigin">产地</label>
                        <input type="text" id="cigar-origin" autocomplete="off" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" data-i18n="ratePage.cigarOriginPlaceholder" placeholder="例如：古巴">
                    </div>
                 </div>
            </section>

            <div id="rating-form-container">
                 <p class="text-center text-gray-500 py-10" data-i18n="common.loading">正在加载评分项...</p>
            </div>

            <div class="mt-8 grid grid-cols-2 gap-4">
                <button onclick="resetRatings()" class="w-full py-3 px-6 bg-red-500 text-white font-bold text-lg rounded-lg shadow-md hover:bg-red-600" data-i18n="ratePage.reset">重置</button>
                <button id="main-action-button" onclick="showResults()" class="w-full py-3 px-6 bg-green-600 text-white font-bold text-lg rounded-lg shadow-md hover:bg-green-700" data-i18n="ratePage.viewReport">查看报告</button>
            </div>
        </main>

        <footer class="mt-8 text-center text-gray-500 text-sm p-4 border-t">评分应用数据由云端配置中心实时同步。</footer>
    </div>

    <div id="cropper-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
         <div class="bg-white rounded-lg shadow-xl p-6 cropper-modal-content">
            <h2 class="text-2xl font-bold mb-4" data-i18n="ratePage.cropImage">裁切图片</h2>
            <div class="cropper-container"> <img id="cropper-image" src="" alt="Image to crop"> </div>
            <p id="cropper-status" class="text-sm font-medium text-indigo-600 my-2"></p>
            <div class="flex justify-end gap-4 mt-4">
                <button onclick="cancelCrop()" class="py-2 px-5 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400" data-i18n="common.cancel">取消</button>
                <button onclick="confirmCropAndUpload()" class="py-2 px-5 bg-blue-600 text-white rounded-lg hover:bg-blue-700" data-i18n="ratePage.cropAndUpload">确认并上传</button>
            </div>
         </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <script type="module">
        // --- i18n Functions ---
        async function initI18n() {
            await i18next
                .use(i18nextHttpBackend)
                .use(i18nextBrowserLanguageDetector)
                .init({
                    fallbackLng: 'zh',
                    debug: true, // Keep debug on for development
                    ns: ['translation'],
                    defaultNS: 'translation',
                    backend: {
                        loadPath: '/locales/{{lng}}.json?v=1'
                    },
                    detection: {
                        order: ['localStorage', 'navigator'],
                        caches: ['localStorage']
                    }
                });
            updateContent();
        }

        function updateContent() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const options = el.dataset.i18nOptions ? JSON.parse(el.dataset.i18nOptions) : undefined;
                const value = i18next.t(key, options);
                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    if (el.type !== 'file' && el.hasAttribute('placeholder')) el.placeholder = value;
                } else if (el.tagName === 'OPTION') {
                    el.textContent = value;
                } else {
                    el.innerHTML = value;
                }
            });
            // 更新 document title
            const titleKey = isEditMode ? 'ratePage.editTitle' : 'ratePage.title';
            document.title = i18next.t(titleKey);
        }

        function setupLanguageSwitcher() {
            const switcher = document.getElementById('language-switcher');
            if (!switcher) return;
            const currentLang = i18next.language.split('-')[0];
            switcher.value = ['zh', 'en', 'es'].includes(currentLang) ? currentLang : 'zh';
            
            switcher.addEventListener('change', async (e) => {
                const newLang = e.target.value;
                await i18next.changeLanguage(newLang);
                updateContent();
                // 重新渲染动态内容
                renderRatingView();
                renderLoginStatus(currentAuthUser);
                renderAdminLinks();
                renderFlavorButtons();
            });
        }
        // --- End i18n Functions ---

        // --- Global Variables ---
        let ratingConfig = null; let userRatings = {}; let currentAuthUser = null;
        let currentImageKeys = []; let sortableInstance = null;
        let isEditMode = false; let editRatingId = null; let cropper = null;
        let selectedFlavors = [];
        const cropperModal = document.getElementById('cropper-modal');
        const cropperImage = document.getElementById('cropper-image');
        const cropperStatus = document.getElementById('cropper-status');
        const AUTHING_APP_ID = '68f5b0b6875017c02b3bfdb3';
        const AUTHING_HOST = 'https://xfvu647mcdbk-demo.authing.cn';
        
        // **MODIFIED**: GRADING_SCALE uses nameKey
        const GRADING_SCALE = [
            { "grade": "P", "nameKey": "resultsPage.grade.P", "min_score": 95 },
            { "grade": "I", "nameKey": "resultsPage.grade.I", "min_score": 90 },
            { "grade": "S", "nameKey": "resultsPage.grade.S", "min_score": 80 },
            { "grade": "T", "nameKey": "resultsPage.grade.T", "min_score": 70 },
            { "grade": "A", "nameKey": "resultsPage.grade.A", "min_score": 60 },
            { "grade": "C", "nameKey": "resultsPage.grade.C", "min_score": 50 },
            { "grade": "H", "nameKey": "resultsPage.grade.H", "min_score": 30 },
            { "grade": "O", "nameKey": "resultsPage.grade.O", "min_score": 0 }
        ];
        
        const COMMON_FLAVORS = [ "咖啡", "巧克力", "雪松", "泥土", "干草", "皮革", "坚果", "香料", "木质", "甜味", "奶油", "花香", "果香", "焦糖", "香草", "柑橘" ];

        // --- Authentication ---
         window.login = function() { const redirectUri = window.location.origin; const authorizeUrl = new URL('/oidc/auth', AUTHING_HOST); authorizeUrl.search = new URLSearchParams({ client_id: AUTHING_APP_ID, redirect_uri: redirectUri, response_type: 'code', scope: 'openid profile email phone', state: Math.random().toString(36).substring(2) }).toString(); window.location.href = authorizeUrl.toString(); }
         window.logout = function() { const logoutUrl = new URL('/oidc/session/end', AUTHING_HOST); logoutUrl.search = new URLSearchParams({ post_logout_redirect_uri: window.location.origin }).toString(); sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken'); window.location.href = logoutUrl.toString(); }
         
         function renderLoginStatus(user) {
            const container = document.getElementById('login-status-container');
            if (!container) return;
            if (user) {
                const displayName = user.nickname || user.name || user.preferred_username || user.email || i18next.t('nav.login');
                container.innerHTML = `<span class="text-sm font-medium text-gray-700 mr-2 hidden sm:inline">${displayName}</span><button onclick="logout()" class="px-3 py-1 text-xs font-medium rounded-full bg-red-500 text-white hover:bg-red-600">${i18next.t('nav.logout')}</button>`;
            } else {
                container.innerHTML = `<button onclick="login()" class="px-3 py-1 text-xs font-medium rounded-full bg-green-500 text-white hover:bg-green-600">${i18next.t('nav.login')}</button>`;
            }
         }
         
         function renderAdminLinks() {
            const adminLinksContainer = document.getElementById('admin-links-container');
            adminLinksContainer.innerHTML = '';
            if (!adminLinksContainer || !currentAuthUser) return;
            const userRole = currentAuthUser.db_role;
            const isAdmin = userRole === 'admin' || userRole === 'super_admin';
            const isSuperAdmin = userRole === 'super_admin';
            if (isAdmin) {
                adminLinksContainer.innerHTML += `<a href="cigar_rating_config.html" class="flex items-center px-3 py-1.5 border text-xs font-medium rounded-full text-white bg-blue-600 hover:bg-blue-500">${i18next.t('nav.configAdmin')}</a>`;
            }
            if (isSuperAdmin) {
                adminLinksContainer.innerHTML += `<a href="role_management.html" class="flex items-center px-3 py-1.5 border text-xs font-medium rounded-full text-yellow-100 bg-purple-600 hover:bg-purple-500 ml-2">${i18next.t('nav.userAdmin')}</a>`;
            }
         }
         
         async function handleOidcCallback(code) { try { const redirectUri = window.location.origin; const apiUrl = new URL('/api/authing/callback', window.location.origin); const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code: code, redirect_uri: redirectUri }) }); if (!response.ok) { const err = await response.json(); throw new Error(err.error || `Token exchange failed (status ${response.status})`); } const fullUserProfile = await response.json(); sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile)); sessionStorage.setItem('accessToken', fullUserProfile.accessToken); return fullUserProfile; } catch (e) { console.error('认证回调处理失败:', e); alert(`登录失败: ${e.message}`); sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken'); return null; } finally { window.history.replaceState({}, document.title, window.location.pathname + window.location.search.replace(/&?code=[^&]*/, '').replace(/&?state=[^&]*/, '')); } }
         async function validateSessionAndGetUser() { const token = sessionStorage.getItem('accessToken'); if (!token) return null; try { const apiUrl = new URL('/api/me', window.location.origin); const response = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${token}` } }); if (!response.ok) { console.warn("Session validation failed:", response.status); sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken'); return null; } const fullUserProfile = await response.json(); sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile)); return fullUserProfile; } catch (e) { console.error("Session validation failed:", e); return null; } }
         function setUser(user) { currentAuthUser = user; renderLoginStatus(currentAuthUser); setTimeout(() => { renderAdminLinks(); }, 0); }

        // --- Flavor Selection Logic ---
         function renderFlavorButtons() {
            const container = document.getElementById('flavor-buttons-container');
            container.innerHTML = '';
            // TODO: Flavor list itself should be internationalized if keys are available
            COMMON_FLAVORS.forEach(flavor => {
                const isSelected = selectedFlavors.includes(flavor);
                const button = document.createElement('button');
                button.type = 'button';
                button.className = `flavor-btn ${isSelected ? 'selected' : ''}`;
                button.textContent = flavor; // This will remain Chinese for now
                button.onclick = () => toggleFlavorSelection(flavor, button);
                container.appendChild(button);
            });
         }
         function toggleFlavorSelection(flavor, button) { const index = selectedFlavors.indexOf(flavor); if (index > -1) { selectedFlavors.splice(index, 1); button.classList.remove('selected'); } else { selectedFlavors.push(flavor); button.classList.add('selected'); } }

        // --- Image Handling (with Sorting and Cover Selection) ---
         const MAX_IMAGES = 5; let filesToProcess = []; let currentFileIndex = 0;
         
         function renderImagePreviews() {
            const grid = document.getElementById('image-preview-grid');
            const uploadLabel = document.getElementById('image-upload-label');
            const uploadInput = document.getElementById('image-upload-input');
            grid.innerHTML = '';
            currentImageKeys.forEach((key, index) => {
                const item = document.createElement('div');
                item.className = `preview-item ${index === 0 ? 'is-cover' : ''}`;
                item.dataset.key = key;
                const coverText = index === 0 ? i18next.t('common.cover') : i18next.t('ratePage.setCover'); // Ensure 'ratePage.setCover' is in JSON
                item.innerHTML = `
                    <img src="/api/image/${key}" alt="${i18next.t('common.image')} ${index + 1}">
                    <button class="remove-btn" onclick="removeImage(${index})" title="${i18next.t('common.delete')} ${i18next.t('common.image')}">&times;</button>
                    <button class="set-cover-btn" onclick="setCoverImage(${index})" title="${coverText}">
                        ${coverText}
                    </button>
                `;
                grid.appendChild(item);
            });
            if (currentImageKeys.length >= MAX_IMAGES) {
                uploadLabel.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                uploadLabel.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                uploadInput.disabled = true;
            } else {
                uploadLabel.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                uploadLabel.classList.add('bg-blue-600', 'hover:bg-blue-700');
                uploadInput.disabled = false;
            }
         }
         
         function initializeSortable() { const grid = document.getElementById('image-preview-grid'); if (sortableInstance) { sortableInstance.destroy(); } sortableInstance = Sortable.create(grid, { animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', onEnd: (evt) => { if (evt.oldIndex !== evt.newIndex) { const movedItem = currentImageKeys.splice(evt.oldIndex, 1)[0]; currentImageKeys.splice(evt.newIndex, 0, movedItem); renderImagePreviews(); } } }); }
         window.setCoverImage = function(index) { if (index === 0 || index >= currentImageKeys.length) return; const coverKey = currentImageKeys.splice(index, 1)[0]; currentImageKeys.unshift(coverKey); renderImagePreviews(); }
         window.removeImage = function(indexToRemove) { if (indexToRemove < 0 || indexToRemove >= currentImageKeys.length) return; currentImageKeys.splice(indexToRemove, 1); renderImagePreviews(); }
         
         window.handleFileSelect = function(event) {
            const status = document.getElementById('image-upload-status');
            status.textContent = '';
            const selectedFiles = Array.from(event.target.files);
            if (selectedFiles.length === 0) return;
            if (!currentAuthUser) {
                alert(i18next.t('ratePage.loginToUpload'));
                return;
            }
            const allowedFiles = [];
            for (const file of selectedFiles) {
                if (currentImageKeys.length + allowedFiles.length >= MAX_IMAGES) {
                    alert(i18next.t('ratePage.maxImages', { max: MAX_IMAGES }));
                    break;
                }
                if (file.size > 5 * 1024 * 1024) {
                    alert(i18next.t('ratePage.imageTooLarge', { name: file.name }));
                    continue;
                }
                if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) {
                    alert(i18next.t('ratePage.imageTypeNotSupported', { name: file.name }));
                    continue;
                }
                allowedFiles.push(file);
            }
            if (allowedFiles.length > 0) {
                filesToProcess = allowedFiles;
                currentFileIndex = 0;
                showCropperForNextFile();
            }
            event.target.value = null;
         }
         
         function showCropperForNextFile() {
            if (currentFileIndex >= filesToProcess.length) {
                filesToProcess = [];
                cancelCrop();
                return;
            }
            const file = filesToProcess[currentFileIndex];
            const reader = new FileReader();
            reader.onload = (e) => {
                cropperModal.classList.remove('hidden');
                cropperImage.src = e.target.result;
                if (cropper) cropper.destroy();
                cropper = new Cropper(cropperImage, { aspectRatio: 1179 / 1572, viewMode: 1, autoCropArea: 0.9, background: false, });
                cropperStatus.textContent = i18next.t('ratePage.processingImage', { current: currentFileIndex + 1, total: filesToProcess.length });
            };
            reader.readAsDataURL(file);
         }
         
         window.confirmCropAndUpload = async function() {
            if (!cropper || !filesToProcess[currentFileIndex]) return;
            const token = sessionStorage.getItem('accessToken');
            if (!token) {
                alert(i18next.t('common.sessionExpired'));
                return;
            }
            cropperStatus.textContent = i18next.t('ratePage.croppingAndUploading', { current: currentFileIndex + 1 });
            const fileName = filesToProcess[currentFileIndex].name;
            const canvas = cropper.getCroppedCanvas({ width: 600, height: 800, imageSmoothingQuality: 'high', });
            canvas.toBlob(async (blob) => {
                if (!blob) {
                    cropperStatus.textContent = i18next.t('ratePage.cropFailed');
                    return;
                }
                try {
                    const formData = new FormData();
                    formData.append('image', blob, fileName);
                    const response = await fetch('/api/upload-image', { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: formData });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'Upload failed');
                    currentImageKeys.push(result.imageKey);
                    renderImagePreviews();
                    currentFileIndex++;
                    showCropperForNextFile();
                } catch (e) {
                    console.error("上传图片失败:", e);
                    cropperStatus.textContent = i18next.t('ratePage.uploadFailed', { msg: e.message });
                }
            }, 'image/jpeg', 0.9);
         }
         
         window.cancelCrop = function() { if (cropper) { cropper.destroy(); cropper = null; } cropperImage.src = ''; cropperModal.classList.add('hidden'); cropperStatus.textContent = ''; }

        // --- Core Rating Logic ---
         async function loadConfig() {
            document.getElementById('config-load-status').textContent = i18next.t('ratePage.configSyncing');
            try {
                const apiUrl = new URL('/api/config/latest', window.location.origin);
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
                ratingConfig = await response.json();
                console.log("Loaded config:", ratingConfig); // Add log
                if (!ratingConfig || !ratingConfig.ratingCriteria) throw new Error("Loaded config is invalid.");
                calculateWeights(ratingConfig);
                userRatings = {};
                renderRatingView();
                document.getElementById('config-load-status').textContent = i18next.t('ratePage.configSynced');
            } catch (error) {
                console.error("加载配置失败:", error);
                document.getElementById('config-load-status').textContent = i18next.t('ratePage.configFailed');
                 // Ensure renderRatingView shows an error if config fails
                 renderRatingView(); 
                alert(`Failed to load core app config. Please refresh.\nDetails: ${error.message}`);
            }
         }
         
         // **MODIFIED**: Use keys for ID generation
         function getRatingId(categoryKey, criterionKey) {
            // Basic validation
             if (!categoryKey || !criterionKey) {
                 console.error("Cannot get rating ID: Missing categoryKey or criterionKey", {categoryKey, criterionKey});
                 return `error-invalid-key`;
             }
            return `${categoryKey}-${criterionKey}`;
         }

         function calculateWeights(config) {
            let totalWeight = 0;
            let totalCriteria = 0;
            if (config && config.ratingCriteria) {
                config.ratingCriteria.forEach(category => {
                    if (category.criteriaList) {
                        category.criteriaList.forEach(criterion => {
                            totalWeight += criterion.weight || 0;
                            totalCriteria++;
                        });
                    }
                });
            }
             // Store calculated totals in the config object itself for easier access
             config.totalWeightMax = totalWeight;
             config.totalCriteriaCount = totalCriteria;
             console.log("Calculated weights:", {totalWeight, totalCriteria}); // Add log
         }

         // **MODIFIED**: Use key-based ID and find criterion by key
         function calculateFinalScore() {
             let totalScore = 0;
             if (!ratingConfig || !ratingConfig.ratingCriteria) {
                 return 0; // Config not loaded or invalid
             }

             // Iterate through userRatings (which now use key-based IDs)
             for (const ratingId in userRatings) {
                 const selectedOptionIndex = userRatings[ratingId];
                 if (selectedOptionIndex === undefined) continue;

                 // Parse the categoryKey and criterionKey from the ratingId
                 const keys = ratingId.split('-');
                 if (keys.length < 2) {
                      console.warn(`Invalid rating ID format found: ${ratingId}`);
                      continue; // Skip invalid IDs
                 }
                 const categoryKey = keys[0];
                 // Reconstruct criterionKey (might contain hyphens)
                 const criterionKey = keys.slice(1).join('-');

                 // Find the corresponding criterion in the config using the keys
                 let foundCriterion = null;
                 for (const category of ratingConfig.ratingCriteria) {
                      // Check if categoryKey matches (or fallback to old category name if needed)
                      if (category.categoryKey === categoryKey || category.category === categoryKey) {
                         foundCriterion = category.criteriaList?.find(
                              crit => crit.nameKey === criterionKey || crit.name === criterionKey // Check nameKey or fallback to old name
                         );
                         if (foundCriterion) break; // Found it, exit inner loop
                      }
                 }


                 if (foundCriterion && foundCriterion.options && foundCriterion.options[selectedOptionIndex]) {
                     const criterionWeight = foundCriterion.weight || 0;
                     const optionScorePct = foundCriterion.options[selectedOptionIndex].scorePct || 0;
                     totalScore += criterionWeight * optionScorePct;
                 } else {
                      console.warn(`Could not find criterion or option for ratingId: ${ratingId}, categoryKey: ${categoryKey}, criterionKey: ${criterionKey}, optionIndex: ${selectedOptionIndex}`);
                 }
             }
             return totalScore;
         }

         // **MODIFIED**: Accept keys, use key-based ID
         window.updateRatingSelection = function(categoryKey, criterionKey, optionIndex) {
            const id = getRatingId(categoryKey, criterionKey);
            userRatings[id] = optionIndex;
            renderRatingView(); // Re-render to update score and buttons
         };
         
         // **MODIFIED**: Use i18n keys for rendering
         function renderRatingView() {
            const formContainer = document.getElementById('rating-form-container');
            // Check if config is loaded and valid
            if (!ratingConfig || !ratingConfig.ratingCriteria) {
                formContainer.innerHTML = `<div class="text-center p-6 bg-white rounded-lg shadow"><p class="text-red-500">${i18next.t('ratePage.configFailed')}</p></div>`;
                // Clear score displays as well
                document.getElementById('current-score-display').textContent = 'ERR';
                document.getElementById('total-weight-max-display').textContent = '0';
                document.getElementById('progress-bar').style.width = '0%';
                document.getElementById('progress-text').textContent = `0 / 0`;
                return;
            };

            // Calculate score *before* rendering to display correctly
            const totalScore = calculateFinalScore();
            const ratedCount = Object.keys(userRatings).length;
            const totalCount = ratingConfig.totalCriteriaCount || 1; // Use pre-calculated count

            // Update header elements using i18n keys from config
            document.getElementById('app-title-display').textContent = i18next.t(ratingConfig.appTitleKey || ratingConfig.appTitle || ''); // Use key, fallback to old title
            document.getElementById('app-description-display').textContent = i18next.t(ratingConfig.descriptionKey || ratingConfig.description || ''); // Use key, fallback to old desc
            document.getElementById('total-weight-max-display').textContent = ratingConfig.totalWeightMax ?? 0; // Use pre-calculated weight
            document.getElementById('current-score-display').textContent = totalScore.toFixed(2);
            document.getElementById('progress-bar').style.width = `${(ratedCount / totalCount) * 100}%`;
            document.getElementById('progress-text').textContent = `${ratedCount} / ${totalCount}`;

            // Render form sections
            formContainer.innerHTML = ratingConfig.ratingCriteria.map((category) => {
                 // Get keys, fallback to old properties if keys don't exist
                 const categoryKey = category.categoryKey || category.category || 'unknownCategory';
                 const detailKey = category.detailKey || category.detail || '';
                 
                 // Translate using keys
                 const categoryName = i18next.t(categoryKey);
                 const categoryDetail = i18next.t(detailKey);

                 return `
                 <div class="bg-white p-6 rounded-xl shadow-lg mb-8 border-l-4 border-indigo-500">
                      <h3 class="text-xl font-bold text-indigo-700 mb-2">${categoryName}</h3>
                      <p class="text-gray-500 text-sm mb-4">${categoryDetail}</p>
                      <div class="space-y-6">
                           ${(category.criteriaList || []).map((criterion) => renderRatingCriterion(categoryKey, criterion)).join('')}
                      </div>
                 </div>`;
            }).join('');
         }
         
         // **MODIFIED**: Accept categoryKey, use i18n keys for rendering and function calls
         function renderRatingCriterion(categoryKey, criterion) {
            // Get keys, fallback to old properties
             const criterionKey = criterion.nameKey || criterion.name || 'unknownCriterion';
             const id = getRatingId(categoryKey, criterionKey); // Use keys to generate ID
             const selectedOptionIndex = userRatings[id];
             const currentWeight = criterion.weight || 0;
             let currentScore = 0;
             if (selectedOptionIndex !== undefined && criterion.options?.[selectedOptionIndex]) {
                 currentScore = currentWeight * (criterion.options[selectedOptionIndex].scorePct || 0);
             }
             const isSuperAdmin = currentAuthUser?.db_role === 'super_admin';
            
             // Translate name using key
             const criterionName = i18next.t(criterionKey);

             return `<div class="bg-gray-50 p-4 rounded-lg border">
                 <div class="flex justify-between items-center mb-3">
                     <h4 class="text-lg font-semibold text-gray-800">${criterionName} ${isSuperAdmin ? `(${currentWeight} 分)` : ''}</h4>
                     ${isSuperAdmin ? `<span class="text-xl font-extrabold text-green-600">${currentScore.toFixed(2)}</span>` : ''}
                 </div>
                 <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2">
                 ${(criterion.options || []).map((option, optIndex) => {
                     const isSelected = selectedOptionIndex === optIndex;
                     const score = (currentWeight * (option.scorePct || 0)).toFixed(2);
                     
                     // Get description key, fallback to old property
                     const descriptionKey = option.descriptionKey || option.description || 'unknownOption';
                     // Translate description using key
                     const optionDescription = i18next.t(descriptionKey);

                     // **MODIFIED**: Pass KEYS to updateRatingSelection
                     return `<button onclick="updateRatingSelection('${categoryKey}', '${criterionKey}', ${optIndex})"
                         class="p-2 text-sm text-center rounded-lg border transition ${ isSelected ? 'bg-indigo-600 text-white shadow-md' : 'bg-white hover:bg-indigo-50' }">
                         ${optionDescription}
                         ${isSuperAdmin ? `<span class="block text-xs ${isSelected ? 'text-indigo-200' : 'text-gray-500'}">(得 ${score} 分)</span>` : ''}
                     </button>`;
                 }).join('')}
                 </div>
             </div>`;
         }

        // --- Character Counters ---
         function updateCharCounts() {
             const titleInput = document.getElementById('rating-title');
             const titleCount = document.getElementById('title-char-count');
             const reviewInput = document.getElementById('cigar-review');
             const reviewCount = document.getElementById('review-char-count');
             if(titleInput && titleCount) titleCount.textContent = `${titleInput.value.length} / ${titleInput.maxLength}`;
             if(reviewInput && reviewCount) reviewCount.textContent = `${reviewInput.value.length} / ${reviewInput.maxLength}`;
         }


        // --- Actions (Reset, Show Results / Save Changes) ---
         window.resetRatings = function() {
            if (confirm(i18next.t('ratePage.confirmReset'))) {
                userRatings = {};
                document.getElementById('rating-title').value = '';
                document.getElementById('cigar-name').value = '';
                document.getElementById('cigar-size').value = '';
                document.getElementById('cigar-origin').value = '';
                document.getElementById('cigar-review').value = '';
                currentImageKeys = [];
                selectedFlavors = [];
                renderFlavorButtons();
                renderImagePreviews();
                if (isEditMode) {
                    isEditMode = false;
                    editRatingId = null;
                    const actionButton = document.getElementById('main-action-button');
                    actionButton.textContent = i18next.t('ratePage.viewReport');
                    actionButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    actionButton.classList.add('bg-green-600', 'hover:bg-green-700');
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
                renderRatingView();
                updateCharCounts();
            }
         }
         
         window.showResults = async function() {
            const token = sessionStorage.getItem('accessToken');
            if (!isEditMode && (!currentAuthUser || !token)) {
                return alert(i18next.t('ratePage.loginToSubmit'));
            }
            // Check if config loaded AND at least one rating was selected
            if (!ratingConfig || !ratingConfig.ratingCriteria || Object.keys(userRatings).length === 0) {
                 return alert(i18next.t('ratePage.selectOneOption'));
            }
            const title = document.getElementById('rating-title').value.trim();
            if (!title) {
                return alert(i18next.t('ratePage.titleRequired'));
            }
            if (currentImageKeys.length === 0) {
                return alert(i18next.t('ratePage.imageRequired'));
            }
            const cigarNameValue = document.getElementById('cigar-name').value.trim();
            if (!cigarNameValue) {
                return alert(i18next.t('ratePage.nameRequired'));
            }
            
            const cigarInfo = { name: cigarNameValue, size: document.getElementById('cigar-size').value || i18next.t('common.unknown'), origin: document.getElementById('cigar-origin').value || i18next.t('common.unknown') };
            const cigarReview = document.getElementById('cigar-review').value || i18next.t('common.noReview');
            const finalScore = calculateFinalScore();
            const maxScore = ratingConfig.totalWeightMax || 1;
            const normalizedScore = maxScore > 0 ? (finalScore / maxScore) * 100 : 0;
            
            // **MODIFIED**: Pass the nameKey, not the translated string
            const foundGrade = GRADING_SCALE.find(g => normalizedScore >= g.min_score) || GRADING_SCALE[GRADING_SCALE.length - 1]; // Ensure fallback
            const finalGrade = foundGrade ? {
                grade: foundGrade.grade,
                nameKey: foundGrade.nameKey, // Pass the key
                color: foundGrade.color
            } : null; // Handle potential case where GRADING_SCALE is empty or invalid
             
            if (!finalGrade) {
                 console.error("Could not determine final grade.");
                 alert("Error: Could not determine final grade."); // User-facing error
                 return;
            }

            const resultsData = {
                title: title,
                config: ratingConfig,
                ratings: userRatings, // Contains selections with key-based IDs
                calculatedScore: finalScore,
                cigarInfo: cigarInfo,
                cigarReview: cigarReview,
                imageUrls: currentImageKeys,
                normalizedScore: normalizedScore,
                finalGrade: finalGrade, // Contains nameKey
                selectedFlavors: selectedFlavors,
                isDraft: !isEditMode, // True if creating new, false if editing
                 ratingId: isEditMode ? editRatingId : undefined // Include ID if editing
            };
            
            if (isEditMode && editRatingId) {
                const actionButton = document.getElementById('main-action-button');
                actionButton.textContent = i18next.t('common.loading');
                actionButton.disabled = true;
                try {
                    if (!token) throw new Error(i18next.t('common.sessionExpired'));
                    // resultsData.ratingId = editRatingId; // Already added above
                    const apiUrl = new URL(`/api/ratings`, window.location.origin);
                    const response = await fetch(apiUrl, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(resultsData) });
                    if (!response.ok) { const err = await response.json(); throw new Error(err.error || 'Update failed'); }
                    alert(i18next.t('common.saveSuccess'));
                    window.location.href = 'history.html';
                } catch (e) {
                    alert(i18next.t('common.saveFailed', { msg: e.message }));
                    actionButton.textContent = i18next.t('ratePage.saveChanges');
                    actionButton.disabled = false;
                }
            } else {
                try {
                    sessionStorage.setItem('cigarRatingResults', JSON.stringify(resultsData));
                     window.location.href = `results.html`;
                } catch (e) {
                     alert(i18next.t('common.sessionStoreFailed') + `: ${e.message}`);
                }
            }
         }

        // --- Initialization ---
         async function initializePage() {
             try {
                await initI18n(); // Wait for translations
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                editRatingId = urlParams.get('edit'); // Check if in edit mode
                isEditMode = !!editRatingId;

                let user = code ? await handleOidcCallback(code) : await validateSessionAndGetUser();
                setUser(user); // Sets currentAuthUser and renders login status/admin links

                setupLanguageSwitcher(); // Setup language dropdown
                renderFlavorButtons(); // Render flavor buttons (static for now)
                initializeSortable(); // Setup image drag-and-drop
                renderImagePreviews(); // Render initial empty image previews
                 
                 // Add listeners for character counts
                 document.getElementById('rating-title').addEventListener('input', updateCharCounts);
                 document.getElementById('cigar-review').addEventListener('input', updateCharCounts);
                 updateCharCounts(); // Initial count update


                if (!currentAuthUser && !isEditMode) {
                     // Show login prompt only if creating new and not logged in
                     document.getElementById('login-prompt').classList.remove('hidden');
                     document.getElementById('main-content').classList.add('hidden'); // Hide main form
                     document.getElementById('config-load-status').textContent = i18next.t('ratePage.loginPrompt'); // Update status
                 } else {
                      document.getElementById('login-prompt').classList.add('hidden');
                      document.getElementById('main-content').classList.remove('hidden');
                     
                      // Load config first
                      await loadConfig();

                      // If in edit mode, load the specific rating data AFTER config is ready
                      if (isEditMode && editRatingId) {
                          await loadRatingForEdit(editRatingId);
                      }
                 }

             } catch (error) {
                 console.error("Page initialization failed:", error);
                 document.getElementById('config-load-status').textContent = i18next.t('errors.initFailed', { msg: error.message });
                 document.getElementById('rating-form-container').innerHTML = `<p class="text-red-500">${i18next.t('errors.initFailed', { msg: error.message })}</p>`;
             }
         }

        // --- Edit Mode Logic ---
         async function loadRatingForEdit(id) {
            document.getElementById('config-load-status').textContent = i18next.t('ratePage.loadingEdit', { id: id });
            const actionButton = document.getElementById('main-action-button');
            actionButton.textContent = i18next.t('ratePage.saveChanges'); // Change button text
            actionButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            actionButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            document.title = i18next.t('ratePage.editTitle'); // Change page title

            try {
                 const token = sessionStorage.getItem('accessToken');
                 if (!token) throw new Error(i18next.t('common.sessionExpired'));
                 const apiUrl = new URL(`/api/ratings?id=${id}`, window.location.origin);
                 const response = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${token}` } });
                 if (!response.ok) { const err = await response.json(); throw new Error(err.error || `Load failed status ${response.status}`); }
                 const data = await response.json();
                
                 // --- Populate fields ---
                 document.getElementById('rating-title').value = data.title || '';
                 document.getElementById('cigar-name').value = data.cigarInfo?.name || '';
                 document.getElementById('cigar-size').value = data.cigarInfo?.size || '';
                 document.getElementById('cigar-origin').value = data.cigarInfo?.origin || '';
                 document.getElementById('cigar-review').value = data.cigarReview || '';
                 
                 // Images
                 currentImageKeys = Array.isArray(data.imageUrl) ? data.imageUrl : [];
                 renderImagePreviews();
                 
                 // Flavors
                 selectedFlavors = Array.isArray(data.fullData?.selectedFlavors) ? data.fullData.selectedFlavors : [];
                 renderFlavorButtons();
                 
                 // Ratings - IMPORTANT: Use the key-based IDs from fullData.ratings
                 userRatings = data.fullData?.ratings || {}; 
                 
                 renderRatingView(); // Re-render form with loaded selections
                 updateCharCounts(); // Update character counts
                 document.getElementById('config-load-status').textContent = i18next.t('ratePage.editLoaded', { id: id });
                
            } catch (error) {
                console.error("加载待编辑点评失败:", error);
                document.getElementById('config-load-status').textContent = i18next.t('ratePage.editLoadFailed', { msg: error.message });
                alert(i18next.t('ratePage.editLoadFailed', { msg: error.message }));
                 // Optionally disable form or redirect
            }
         }

        // --- Start Initialization ---
         window.addEventListener('load', initializePage);
        
    </script>
</body>
</html>
