<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>发布雪茄点评</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cropper.js CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
    <!-- SortableJS Script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script>
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: { sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'], },
                        transitionProperty: { 'width': 'width' }
                    }
                }
            }
        } else { console.warn('Tailwind object not found. Skipping config.'); }
    </script>
    <style>
        .cropper-container { max-height: 60vh; }
        .cropper-modal-content { width: 90%; max-width: 800px; }
        /* Style for image previews */
        .preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.5rem; }
        .preview-item {
            position: relative; aspect-ratio: 1179 / 1572; overflow: hidden; border-radius: 0.375rem; /* rounded-md */
            border: 1px solid #e5e7eb; /* border-gray-200 */
            cursor: grab; /* Add grab cursor for draggable items */
        }
        .preview-item:active { cursor: grabbing; } /* Change cursor while dragging */
        .preview-item img { display: block; width: 100%; height: 100%; object-fit: cover; }
        .preview-item .remove-btn { position: absolute; top: 2px; right: 2px; background-color: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 1.25rem; height: 1.25rem; font-size: 0.75rem; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; z-index: 10; }
        .preview-item .remove-btn:hover { background-color: rgba(239, 68, 68, 0.8); /* hover:bg-red-500 */ }
        /* Style for "Set Cover" button */
        .preview-item .set-cover-btn {
            position: absolute; bottom: 2px; left: 2px; background-color: rgba(0, 0, 0, 0.6); color: white; border: none; border-radius: 0.25rem; /* rounded-sm */
            padding: 1px 4px; font-size: 0.65rem; /* Smaller text */ line-height: 1; cursor: pointer; z-index: 10;
        }
        .preview-item .set-cover-btn:hover { background-color: rgba(67, 56, 202, 0.8); /* hover:bg-indigo-700 */ }
        .preview-item.is-cover .set-cover-btn { /* Style for the current cover */
            background-color: rgba(22, 163, 74, 0.8); /* bg-green-600 */ cursor: default; pointer-events: none; /* Disable click */
        }
        /* Style for the element being dragged */
        .sortable-ghost { opacity: 0.4; background: #c8ebfb; }
        .sortable-drag { opacity: 1 !important; /* Ensure dragged item is fully visible */ }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">
    <div id="app-container" class="max-w-4xl mx-auto p-4 md:p-8">
        <!-- Navbar -->
        <nav class="mb-6 flex flex-wrap justify-between items-center bg-white p-3 rounded-lg shadow-sm gap-4">
            <a href="index.html" class="text-xl font-bold text-indigo-600">Pistacho评分</a>
            <div class="flex items-center space-x-4 flex-grow justify-center md:justify-start md:flex-grow-0 order-3 md:order-2 w-full md:w-auto">
                <a href="index.html" class="text-gray-600 hover:text-indigo-600">社区动态</a>
                <a href="rate.html" class="text-indigo-600 font-bold underline">去评分</a>
                <a href="history.html" class="text-gray-600 hover:text-indigo-600">我的点评历史</a>
                <a href="certified.html" class="text-gray-600 hover:text-indigo-600">认证评分</a>
            </div>
            <div id="login-status-container" class="flex items-center order-2 md:order-3"></div>
        </nav>
        <!-- End Navbar -->

        <!-- Header Scoreboard -->
        <header class="mb-8 p-6 bg-indigo-700 text-white rounded-xl shadow-2xl">
            <!-- Scoreboard content remains the same -->
             <div class="flex justify-between items-start">
                 <div> <h1 id="app-title-display" class="text-3xl font-extrabold mb-1">雪茄评分应用</h1> <p id="app-description-display" class="text-indigo-200 text-sm max-w-lg">正在加载描述...</p> </div>
                 <div class="flex items-center space-x-3 flex-shrink-0"> <div id="admin-links-container" class="flex items-center space-x-3"></div> </div>
             </div>
             <div class="mt-6 bg-black bg-opacity-20 p-4 rounded-lg">
                 <div class="flex justify-between items-end">
                     <div> <p class="text-sm font-medium text-indigo-200">当前得分</p> <div class="flex items-baseline"> <span id="current-score-display" class="text-6xl font-black leading-none">0.00</span> <span class="text-lg font-medium text-indigo-200 ml-2">/ <span id="total-weight-max-display">0</span></span> </div> </div>
                     <div class="text-right"> <p class="text-sm font-medium text-indigo-200">已评项目</p> <p id="progress-text" class="font-bold text-lg">0 / 0</p> </div>
                 </div>
                 <div class="w-full bg-indigo-900 rounded-full h-2.5 mt-2"> <div id="progress-bar" class="bg-green-400 h-2.5 rounded-full transition-width duration-500" style="width: 0%"></div> </div>
             </div>
              <p id="config-load-status" class="text-xs text-yellow-300 mt-2 text-right">正在连接...</p>
        </header>

        <!-- Main Content -->
        <main id="main-content">

            <!-- Title Section -->
            <section class="mb-8 p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-4">点评标题 <span class="text-red-500">*</span></h2>
                <input type="text" id="rating-title" maxlength="22" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-indigo-500 focus:ring-indigo-500" placeholder="填写标题会被更多人看到 (最多22字)">
                <p id="title-char-count" class="text-xs text-gray-500 text-right mt-1">0 / 22</p>
            </section>

            <!-- Image Upload Section -->
            <section class="mb-8 p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-4">上传图片 (最多5张, 可拖拽排序) <span class="text-red-500">*</span></h2>
                <p class="text-sm text-gray-600 mb-3">第一张图片将作为封面图显示。点击图片左下角按钮更换封面。</p>
                <!-- **MODIFIED**: Added ID for SortableJS -->
                <div class="preview-grid mb-4" id="image-preview-grid">
                    <!-- Image previews will be added here -->
                </div>
                <div>
                    <label for="image-upload-input" id="image-upload-label" class="w-full md:w-auto text-center py-2 px-6 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 cursor-pointer inline-block">
                        选择图片
                    </label>
                    <input type="file" id="image-upload-input" class="hidden" accept="image/png, image/jpeg, image/webp" multiple onchange="handleFileSelect(event)">
                    <p class="text-sm text-gray-500 mt-2 inline-block md:ml-4">支持 JPG, PNG, WEBP。单张最大 5MB。</p>
                    <p id="image-upload-status" class="text-sm font-medium text-indigo-600 mt-2"></p>
                </div>
            </section>

            <!-- Review Section -->
            <section class="mb-8 p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-4">文字评价</h2>
                <div>
                    <textarea id="cigar-review" rows="8" maxlength="1500" class="w-full p-3 border rounded-md focus:border-indigo-500 focus:ring-indigo-500" placeholder="在此处输入您的详细品吸感受..."></textarea>
                    <p id="review-char-count" class="text-xs text-gray-500 text-right mt-1">0 / 1500</p>
                </div>
            </section>

            <!-- Cigar Info Section -->
            <section class="mb-8 p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-4">雪茄信息</h2>
                 <!-- Inputs remain the same -->
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6"> <div> <label for="cigar-name" class="block text-sm font-medium text-gray-700">名称 <span class="text-red-500">*</span></label> <input type="text" id="cigar-name" autocomplete="off" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="例如：帕特加斯D4"> </div> <div> <label for="cigar-size" class="block text-sm font-medium text-gray-700">尺寸</label> <input type="text" id="cigar-size" autocomplete="off" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="例如：Robusto"> </div> <div> <label for="cigar-origin" class="block text-sm font-medium text-gray-700">产地</label> <input type="text" id="cigar-origin" autocomplete="off" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="例如：古巴"> </div> </div>
            </section>

            <!-- Rating Form Container -->
            <div id="rating-form-container"></div>

            <!-- Action Buttons -->
            <div class="mt-8 grid grid-cols-2 gap-4">
                <button onclick="resetRatings()" class="w-full py-3 px-6 bg-red-500 text-white font-bold text-lg rounded-lg shadow-md hover:bg-red-600">重置</button>
                <button id="main-action-button" onclick="showResults()" class="w-full py-3 px-6 bg-green-600 text-white font-bold text-lg rounded-lg shadow-md hover:bg-green-700">查看报告</button>
            </div>
        </main>

        <footer class="mt-8 text-center text-gray-500 text-sm p-4 border-t">评分应用数据由云端配置中心实时同步。</footer>
    </div>

    <!-- Cropper Modal -->
    <div id="cropper-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <!-- Modal content remains the same -->
         <div class="bg-white rounded-lg shadow-xl p-6 cropper-modal-content"> <h2 class="text-2xl font-bold mb-4">裁切图片</h2> <div class="cropper-container"> <img id="cropper-image" src="" alt="Image to crop"> </div> <p id="cropper-status" class="text-sm font-medium text-indigo-600 my-2"></p> <div class="flex justify-end gap-4 mt-4"> <button onclick="cancelCrop()" class="py-2 px-5 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">取消</button> <button onclick="confirmCropAndUpload()" class="py-2 px-5 bg-blue-600 text-white rounded-lg hover:bg-blue-700">确认并上传</button> </div> </div>
    </div>

    <!-- Cropper.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <!-- App Logic -->
    <script type="module">
        // --- Global Variables ---
        let ratingConfig = null; let userRatings = {}; let currentAuthUser = null;
        let currentImageKeys = []; // Stores the ordered image keys
        let sortableInstance = null; // To hold the SortableJS instance
        let isEditMode = false; let editRatingId = null; let cropper = null;
        const cropperModal = document.getElementById('cropper-modal');
        const cropperImage = document.getElementById('cropper-image');
        const cropperStatus = document.getElementById('cropper-status');
        const AUTHING_APP_ID = '68f5b0b6875017c02b3bfdb3';
        const AUTHING_HOST = 'https://xfvu647mcdbk-demo.authing.cn';
        const GRADING_SCALE = [ /* ... Grading scale ... */ ];

        // --- Authentication ---
        // ... Auth functions (login, logout, renderLoginStatus, etc.) remain the same ...
         window.login = function() { const redirectUri = window.location.origin; const authorizeUrl = new URL('/oidc/auth', AUTHING_HOST); authorizeUrl.search = new URLSearchParams({ client_id: AUTHING_APP_ID, redirect_uri: redirectUri, response_type: 'code', scope: 'openid profile email phone', state: Math.random().toString(36).substring(2) }).toString(); window.location.href = authorizeUrl.toString(); }
         window.logout = function() { const logoutUrl = new URL('/oidc/session/end', AUTHING_HOST); logoutUrl.search = new URLSearchParams({ post_logout_redirect_uri: window.location.origin }).toString(); sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken'); window.location.href = logoutUrl.toString(); }
         function renderLoginStatus(user) { const container = document.getElementById('login-status-container'); if (!container) return; if (user) { const displayName = user.nickname || user.name || user.preferred_username || user.email || '已登录'; container.innerHTML = `<span class="text-sm font-medium text-gray-700 mr-2 hidden sm:inline">${displayName}</span><button onclick="logout()" class="px-3 py-1 text-xs font-medium rounded-full bg-red-500 text-white hover:bg-red-600">退出</button>`; } else { container.innerHTML = `<button onclick="login()" class="px-3 py-1 text-xs font-medium rounded-full bg-green-500 text-white hover:bg-green-600">登录/注册</button>`; } }
         function renderAdminLinks() { const adminLinksContainer = document.getElementById('admin-links-container'); adminLinksContainer.innerHTML = ''; if (!adminLinksContainer || !currentAuthUser) return; const userRole = currentAuthUser.db_role; const isAdmin = userRole === 'admin' || userRole === 'super_admin'; const isSuperAdmin = userRole === 'super_admin'; if (isAdmin) { adminLinksContainer.innerHTML += `<a href="cigar_rating_config.html" class="flex items-center px-3 py-1.5 border text-xs font-medium rounded-full text-white bg-blue-600 hover:bg-blue-500">评分配置</a>`; } if (isSuperAdmin) { adminLinksContainer.innerHTML += `<a href="role_management.html" class="flex items-center px-3 py-1.5 border text-xs font-medium rounded-full text-yellow-100 bg-purple-600 hover:bg-purple-500 ml-2">用户管理</a>`; } }
         async function handleOidcCallback(code) { try { const redirectUri = window.location.origin; const apiUrl = new URL('/api/authing/callback', window.location.origin); const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code: code, redirect_uri: redirectUri }) }); if (!response.ok) { const err = await response.json(); throw new Error(err.error || '认证回调失败'); } const fullUserProfile = await response.json(); sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile)); sessionStorage.setItem('accessToken', fullUserProfile.accessToken); return fullUserProfile; } catch (e) { console.error('认证回调处理失败:', e); alert(`登录失败: ${e.message}`); sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken'); return null; } finally { window.history.replaceState({}, document.title, window.location.pathname); } }
         async function validateSessionAndGetUser() { const token = sessionStorage.getItem('accessToken'); if (!token) return null; try { const apiUrl = new URL('/api/me', window.location.origin); const response = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${token}` } }); if (!response.ok) { sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken'); return null; } const fullUserProfile = await response.json(); sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile)); return fullUserProfile; } catch (e) { console.error("Session validation failed:", e); return null; } }
         function setUser(user) { currentAuthUser = user; renderLoginStatus(currentAuthUser); setTimeout(() => { renderAdminLinks(); }, 0); }

        // --- Image Handling (with Sorting and Cover Selection) ---
        const MAX_IMAGES = 5;
        let filesToProcess = []; let currentFileIndex = 0;

        /** Renders image previews based on currentImageKeys order */
        function renderImagePreviews() {
            const grid = document.getElementById('image-preview-grid');
            const uploadLabel = document.getElementById('image-upload-label');
            const uploadInput = document.getElementById('image-upload-input');
            grid.innerHTML = ''; // Clear existing previews

            currentImageKeys.forEach((key, index) => {
                const item = document.createElement('div');
                item.className = `preview-item ${index === 0 ? 'is-cover' : ''}`;
                // Store the key in a data attribute for SortableJS update
                item.dataset.key = key;

                item.innerHTML = `
                    <img src="/api/image/${key}" alt="Preview ${index + 1}">
                    <button class="remove-btn" onclick="removeImage(${index})" title="删除图片">&times;</button>
                    <button class="set-cover-btn" onclick="setCoverImage(${index})" title="设为封面">
                        ${index === 0 ? '封面' : '设为封面'}
                    </button>
                `;
                grid.appendChild(item);
            });

            // Update upload button state
            if (currentImageKeys.length >= MAX_IMAGES) {
                uploadLabel.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                uploadLabel.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                uploadInput.disabled = true;
            } else {
                uploadLabel.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                uploadLabel.classList.add('bg-blue-600', 'hover:bg-blue-700');
                uploadInput.disabled = false;
            }

            // Initialize or update SortableJS
            initializeSortable();
        }

        /** Initialize SortableJS on the preview grid */
        function initializeSortable() {
            const grid = document.getElementById('image-preview-grid');
            if (sortableInstance) {
                sortableInstance.destroy(); // Destroy previous instance if exists
            }
            if (grid && currentImageKeys.length > 1) { // Only enable sorting if more than one image
                sortableInstance = new Sortable(grid, {
                    animation: 150, // Animation speed
                    ghostClass: 'sortable-ghost', // Class for the drop placeholder
                    dragClass: 'sortable-drag', // Class for the item being dragged
                    onEnd: function (evt) {
                        // Update the currentImageKeys array based on the new DOM order
                        const items = grid.querySelectorAll('.preview-item');
                        const newOrderKeys = Array.from(items).map(item => item.dataset.key);
                        currentImageKeys = newOrderKeys;
                        console.log("Image order updated:", currentImageKeys);
                        // Re-render to update cover button states
                        renderImagePreviews();
                    }
                });
            } else {
                sortableInstance = null; // Ensure instance is null if not sortable
            }
        }

        /** Sets the image at the given index as the cover (moves it to the start) */
        window.setCoverImage = function(index) {
            if (index > 0 && index < currentImageKeys.length) { // Only move if it's not already the cover
                const keyToMove = currentImageKeys.splice(index, 1)[0]; // Remove the item
                currentImageKeys.unshift(keyToMove); // Add it to the beginning
                console.log("Set new cover image. New order:", currentImageKeys);
                renderImagePreviews(); // Re-render to reflect the change
            }
        }

        /** Removes an image by index */
        window.removeImage = function(indexToRemove) {
            if (indexToRemove >= 0 && indexToRemove < currentImageKeys.length) {
                const removedKey = currentImageKeys.splice(indexToRemove, 1);
                console.log("Removed image key:", removedKey);
                renderImagePreviews(); // Re-render after removal
            }
        }

        // --- File Selection and Cropping ---
        // ... handleFileSelect, showCropperForNextFile, confirmCropAndUpload, cancelCrop remain the same ...
        window.handleFileSelect = function(event) { /* ... same ... */ }
        function showCropperForNextFile() { /* ... same ... */ }
        window.confirmCropAndUpload = async function() { /* ... same, but calls renderImagePreviews after push ... */
            // Inside the try block, after currentImageKeys.push(result.imageKey);
            renderImagePreviews(); // <-- Add this call
            currentFileIndex++;
            showCropperForNextFile(); // This stays
        }
        window.cancelCrop = function() { /* ... same ... */ }

        // --- Core Rating Logic ---
        // ... loadConfig, getRatingId, calculateWeights, calculateFinalScore, updateRatingSelection, renderRatingView, renderRatingCriterion remain the same ...
        async function loadConfig() { /* ... same ... */ }
        function getRatingId(category, criterion) { /* ... same ... */ }
        function calculateWeights(config) { /* ... same ... */ }
        function calculateFinalScore() { /* ... same ... */ }
        window.updateRatingSelection = function(categoryName, criterionName, optionIndex) { /* ... same ... */ }
        function renderRatingView() { /* ... same ... */ }
        function renderRatingCriterion(categoryName, criterion) { /* ... same ... */ }


        // --- Actions (Reset, Show Results / Save Changes) ---
        // ... resetRatings and showResults remain the same (they already use currentImageKeys) ...
        window.resetRatings = function() { /* ... same ... */ }
        window.showResults = async function() { /* ... same validation logic ... */
             const token = sessionStorage.getItem('accessToken'); if (!isEditMode && (!currentAuthUser || !token)) { return alert("请登录后才能提交点评。"); } if (!ratingConfig || Object.keys(userRatings).length === 0) { return alert("请至少选择一个评分项后再操作。"); } const title = document.getElementById('rating-title').value.trim(); if (!title) { return alert("请填写点评标题。"); }
            
            // --- 必填项验证 ---
            if (currentImageKeys.length === 0) {
                return alert("请至少上传一张图片。");
            }
            const cigarNameValue = document.getElementById('cigar-name').value.trim();
            if (!cigarNameValue) {
                return alert("请填写雪茄名称。");
            }
            // --- 验证结束 ---

            const cigarInfo = { name: cigarNameValue, size: document.getElementById('cigar-size').value || '未知尺寸', origin: document.getElementById('cigar-origin').value || '未知产地' }; const cigarReview = document.getElementById('cigar-review').value || '无'; const finalScore = calculateFinalScore(); const maxScore = ratingConfig.totalWeightMax || 1; const normalizedScore = maxScore > 0 ? (finalScore / maxScore) * 100 : 0;
            const foundGrade = GRADING_SCALE.find(g => normalizedScore >= g.min_score);
            const finalGrade = foundGrade ? { grade: foundGrade.grade, name_cn: foundGrade.name_cn, name_en: foundGrade.name_en } : { grade: 'O', name_cn: '乏善可陈 / 平淡', name_en: 'Ordinary' };
            
            // **IMPORTANT**: imageUrls uses the correctly ordered currentImageKeys
            const resultsData = { title: title, config: ratingConfig, ratings: userRatings, calculatedScore: finalScore, cigarInfo: cigarInfo, cigarReview: cigarReview, imageUrls: currentImageKeys, normalizedScore: normalizedScore, finalGrade: finalGrade, isDraft: !isEditMode }; 
            console.log("Data being prepared for results/save:", resultsData);
            
            if (isEditMode && editRatingId) { const actionButton = document.getElementById('main-action-button'); actionButton.textContent = "正在保存..."; actionButton.disabled = true; try { if (!token) throw new Error("会话已过期，请重新登录。"); resultsData.ratingId = editRatingId; const apiUrl = new URL(`/api/ratings`, window.location.origin); const response = await fetch(apiUrl, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(resultsData) }); if (!response.ok) { const err = await response.json(); throw new Error(err.error || '更新失败'); } alert("更改已保存！"); window.location.href = 'history.html'; } catch (e) { alert(`保存失败: ${e.message}`); actionButton.textContent = "保存更改"; actionButton.disabled = false; } }
            else { try { sessionStorage.setItem('cigarRatingResults', JSON.stringify(resultsData)); window.location.href = 'results.html'; } catch (e) { alert("无法保存会话数据 (sessionStorage)。"); } }
        }


        // --- Edit Mode Logic ---
        // ... loadRatingForEdit remains the same (it already populates currentImageKeys correctly) ...
        async function loadRatingForEdit(ratingId) { /* ... same ... */ }


        // Character Counters
        function updateCharCounts() { /* ... same ... */ }

        // --- Initialization ---
        window.onload = async function() {
            const urlParams = new URLSearchParams(window.location.search); const code = urlParams.get('code'); const editId = urlParams.get('edit'); let user = null;
            if (code) { user = await handleOidcCallback(code); } else { user = await validateSessionAndGetUser(); } setUser(user); console.log("Current User Object:", currentAuthUser);
            await loadConfig();
            if (editId) {
                await loadRatingForEdit(editId); // This populates currentImageKeys
            } else {
                renderImagePreviews(); // Initialize empty preview grid
                updateCharCounts();
            }
            // Initialize SortableJS AFTER potential images are loaded in edit mode or grid is initially rendered
            initializeSortable();

            document.getElementById('rating-title')?.addEventListener('input', updateCharCounts); document.getElementById('cigar-review')?.addEventListener('input', updateCharCounts);
            if (editId) { window.history.replaceState({}, document.title, window.location.pathname); }
        };
    </script>
</body>
</html>

