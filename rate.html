<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="ratePage.title">发布雪茄点评</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script src="https://unpkg.com/i18next/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-http-backend/i18nextHttpBackend.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector/i18nextBrowserLanguageDetector.min.js"></script>

    <script>
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: { sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'], },
                        transitionProperty: { 'width': 'width' }
                    }
                }
            }
        } else { console.warn('Tailwind object not found. Skipping config.'); }
    </script>
    <style>
        .cropper-container { max-height: 60vh; }
        .cropper-modal-content { width: 90%; max-width: 800px; }
        /* ... (all other styles remain the same) ... */
        .preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.5rem; }
        .preview-item {
            position: relative; aspect-ratio: 1179 / 1572; overflow: hidden; border-radius: 0.375rem; /* rounded-md */
            border: 1px solid #e5e7eb; /* border-gray-200 */
            cursor: grab; /* Add grab cursor for draggable items */
        }
        .preview-item:active { cursor: grabbing; } /* Change cursor while dragging */
        .preview-item img { display: block; width: 100%; height: 100%; object-fit: cover; }
        .preview-item .remove-btn { position: absolute; top: 2px; right: 2px; background-color: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 1.25rem; height: 1.25rem; font-size: 0.75rem; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; z-index: 10; }
        .preview-item .remove-btn:hover { background-color: rgba(239, 68, 68, 0.8); /* hover:bg-red-500 */ }
        /* Style for "Set Cover" button */
        .preview-item .set-cover-btn {
            position: absolute; bottom: 2px; left: 2px; background-color: rgba(0, 0, 0, 0.6); color: white; border: none; border-radius: 0.25rem; /* rounded-sm */
            padding: 1px 4px; font-size: 0.65rem; /* Smaller text */ line-height: 1; cursor: pointer; z-index: 10;
        }
        .preview-item .set-cover-btn:hover { background-color: rgba(67, 56, 202, 0.8); /* hover:bg-indigo-700 */ }
        .preview-item.is-cover .set-cover-btn { /* Style for the current cover */
            background-color: rgba(22, 163, 74, 0.8); /* bg-green-600 */ cursor: default; pointer-events: none; /* Disable click */
        }
        /* Style for the element being dragged */
        .sortable-ghost { opacity: 0.4; background: #c8ebfb; }
        .sortable-drag { opacity: 1 !important; /* Ensure dragged item is fully visible */ }
        /* Style for flavor buttons */
        .flavor-btn {
            padding: 0.375rem 0.75rem; /* px-3 py-1.5 */
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 9999px; /* rounded-full */
            font-size: 0.875rem; /* text-sm */
            margin-right: 0.5rem; /* mr-2 */
            margin-bottom: 0.5rem; /* mb-2 */
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
            color: #374151; /* text-gray-700 */
        }
        .flavor-btn:hover:not(.selected) { /* Apply hover only if not selected */
            background-color: #f3f4f6; /* bg-gray-100 */
            border-color: #9ca3af; /* border-gray-400 */
        }
        .flavor-btn.selected {
            background-color: #4f46e5; /* bg-indigo-600 */
            color: white;
            border-color: #4f46e5; /* border-indigo-600 */
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">
    <div id="app-container" class="max-w-4xl mx-auto p-4 md:p-8">
        <nav class="mb-6 flex flex-wrap justify-between items-center bg-white p-3 rounded-lg shadow-sm gap-4">
            <a href="index.html" class="text-xl font-bold text-indigo-600" data-i18n="nav.title">Pistacho评分</a>
            <div class="flex items-center space-x-4 flex-grow justify-center md:justify-start md:flex-grow-0 order-3 md:order-2 w-full md:w-auto">
                <a href="index.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.community">社区动态</a>
                <a href="rate.html" class="text-indigo-600 font-bold underline" data-i18n="nav.rate">去评分</a>
                <a href="history.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.myRatings">我的点评历史</a>
                <a href="certified.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.certified">认证评分</a>
            </div>
            <div class="flex items-center order-2 md:order-3">
               <select id="language-switcher" class="text-xs p-1 rounded border border-gray-300 mr-2 h-7" style="line-height: 1;">
                   <option value="zh">简体中文</option>
                   <option value="en">English</option>
                   <option value="es">Español</option>
               </select>
               <div id="login-status-container" class="flex items-center"></div>
            </div>
        </nav>
        <header class="mb-8 p-6 bg-indigo-700 text-white rounded-xl shadow-2xl">
             <div class="flex justify-between items-start">
                 <div> <h1 id="app-title-display" class="text-3xl font-extrabold mb-1">雪茄评分应用</h1> <p id="app-description-display" class="text-indigo-200 text-sm max-w-lg">正在加载描述...</p> </div>
                 <div class="flex items-center space-x-3 flex-shrink-0"> <div id="admin-links-container" class="flex items-center space-x-3"></div> </div>
             </div>
             <div class="mt-6 bg-black bg-opacity-20 p-4 rounded-lg">
                 <div class="flex justify-between items-end">
                     <div>
                        <p class="text-sm font-medium text-indigo-200" data-i18n="ratePage.currentScore">当前得分</p>
                        <div class="flex items-baseline"> <span id="current-score-display" class="text-6xl font-black leading-none">0.00</span> <span class="text-lg font-medium text-indigo-200 ml-2">/ <span id="total-weight-max-display">0</span></span> </div>
                     </div>
                     <div class="text-right">
                        <p class="text-sm font-medium text-indigo-200" data-i18n="ratePage.itemsRated">已评项目</p>
                        <p id="progress-text" class="font-bold text-lg">0 / 0</p>
                     </div>
                 </div>
                 <div class="w-full bg-indigo-900 rounded-full h-2.5 mt-2"> <div id="progress-bar" class="bg-green-400 h-2.5 rounded-full transition-width duration-500" style="width: 0%"></div> </div>
             </div>
              <p id="config-load-status" class="text-xs text-yellow-300 mt-2 text-right" data-i18n="ratePage.configSyncing">正在连接...</p>
        </header>

        <div id="login-prompt" class="hidden text-center p-6 bg-yellow-100 text-yellow-800 rounded-lg shadow mb-8">
             <p class="font-semibold mb-3" data-i18n="ratePage.loginPrompt">请先登录才能进行评分。</p>
             <button onclick="login()" class="px-5 py-2 text-sm font-medium rounded-lg bg-green-500 text-white hover:bg-green-600" data-i18n="nav.login">前往登录/注册</button>
        </div>


        <main id="main-content">

            <section class="mb-8 p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-4" data-i18n="ratePage.ratingTitle">点评标题 <span class="text-red-500">*</span></h2>
                <input type="text" id="rating-title" maxlength="22" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-indigo-500 focus:ring-indigo-500" data-i18n="ratePage.ratingTitlePlaceholder" placeholder="填写标题会被更多人看到 (最多22字)">
                <p id="title-char-count" class="text-xs text-gray-500 text-right mt-1">0 / 22</p>
            </section>

            <section class="mb-8 p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-4" data-i18n="ratePage.uploadImages" data-i18n-options='{ "max": 5 }'>上传图片 (最多5张, 可拖拽排序) <span class="text-red-500">*</span></h2>
                <p class="text-sm text-gray-600 mb-3" data-i18n="ratePage.uploadImagesDesc">第一张图片将作为封面图显示。点击图片左下角按钮更换封面。</p>
                <div class="preview-grid mb-4" id="image-preview-grid">
                    <!-- Image previews will be rendered here -->
                </div>
                <div>
                    <label for="image-upload-input" id="image-upload-label" class="w-full md:w-auto text-center py-2 px-6 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 cursor-pointer inline-block" data-i18n="ratePage.selectImages">
                        选择图片
                    </label>
                    <input type="file" id="image-upload-input" class="hidden" accept="image/png, image/jpeg, image/webp" multiple onchange="handleFileSelect(event)">
                    <p class="text-sm text-gray-500 mt-2 inline-block md:ml-4" data-i18n="ratePage.imageSupport">支持 JPG, PNG, WEBP。单张最大 5MB。</p>
                    <p id="image-upload-status" class="text-sm font-medium text-indigo-600 mt-2"></p>
                </div>
            </section>

            <section class="mb-8 p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-4" data-i18n="ratePage.reviewAndFlavors">文字评价与风味选择</h2>
                <div class="mb-4 border-b pb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="ratePage.selectFlavors">选择您感受到的主要风味 (可选):</label>
                    <div id="flavor-buttons-container" class="flex flex-wrap">
                        <!-- Flavor buttons will be rendered here -->
                    </div>
                </div>
                <div>
                    <label for="cigar-review" class="block text-sm font-medium text-gray-700 mb-2" data-i18n="ratePage.detailedReview">详细文字评价:</label>
                    <textarea id="cigar-review" rows="6" maxlength="1500" class="w-full p-3 border rounded-md focus:border-indigo-500 focus:ring-indigo-500" data-i18n="ratePage.reviewPlaceholder" placeholder="在此处输入您的详细品吸感受..."></textarea>
                    <p id="review-char-count" class="text-xs text-gray-500 text-right mt-1">0 / 1500</p>
                </div>
            </section>

            <section class="mb-8 p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-4" data-i18n="ratePage.cigarInfo">雪茄信息</h2>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="cigar-name" class="block text-sm font-medium text-gray-700" data-i18n="ratePage.cigarNameRequired">名称 <span class="text-red-500">*</span></label>
                        <input type="text" id="cigar-name" autocomplete="off" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" data-i18n="ratePage.cigarNamePlaceholder" placeholder="例如：帕特加斯D4">
                    </div>
                    <div>
                        <label for="cigar-size" class="block text-sm font-medium text-gray-700" data-i18n="ratePage.cigarSize">尺寸</label>
                        <input type="text" id="cigar-size" autocomplete="off" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" data-i18n="ratePage.cigarSizePlaceholder" placeholder="例如：Robusto">
                    </div>
                    <div>
                        <label for="cigar-origin" class="block text-sm font-medium text-gray-700" data-i18n="ratePage.cigarOrigin">产地</label>
                        <input type="text" id="cigar-origin" autocomplete="off" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" data-i18n="ratePage.cigarOriginPlaceholder" placeholder="例如：古巴">
                    </div>
                 </div>
            </section>

            <div id="rating-form-container">
                <!-- Rating criteria will be rendered here -->
            </div>

            <div class="mt-8 grid grid-cols-2 gap-4">
                <button onclick="resetRatings()" class="w-full py-3 px-6 bg-red-500 text-white font-bold text-lg rounded-lg shadow-md hover:bg-red-600" data-i18n="ratePage.reset">重置</button>
                <button id="main-action-button" onclick="showResults()" class="w-full py-3 px-6 bg-green-600 text-white font-bold text-lg rounded-lg shadow-md hover:bg-green-700" data-i18n="ratePage.viewReport">查看报告</button>
            </div>
        </main>

        <footer class="mt-8 text-center text-gray-500 text-sm p-4 border-t">评分应用数据由云端配置中心实时同步。</footer>
    </div>

    <!-- Cropper Modal -->
    <div id="cropper-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
         <div class="bg-white rounded-lg shadow-xl p-6 cropper-modal-content">
            <h2 class="text-2xl font-bold mb-4" data-i18n="ratePage.cropImage">裁切图片</h2>
            <div class="cropper-container"> <img id="cropper-image" src="" alt="Image to crop"> </div>
            <p id="cropper-status" class="text-sm font-medium text-indigo-600 my-2"></p>
            <div class="flex justify-end gap-4 mt-4">
                <button onclick="cancelCrop()" class="py-2 px-5 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400" data-i18n="common.cancel">取消</button>
                <button onclick="confirmCropAndUpload()" class="py-2 px-5 bg-blue-600 text-white rounded-lg hover:bg-blue-700" data-i18n="ratePage.cropAndUpload">确认并上传</button>
            </div>
         </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <script type="module">
        // --- i18n Functions ---
        async function initI18n() {
            await i18next
                .use(i18nextHttpBackend)
                .use(i18nextBrowserLanguageDetector)
                .init({
                    fallbackLng: 'zh',
                    debug: false, // Turn off debug for production/less console noise
                    ns: ['translation'],
                    defaultNS: 'translation',
                    backend: {
                        loadPath: '/locales/{{lng}}.json?v=1' // Add cache busting
                    },
                    detection: {
                        order: ['localStorage', 'navigator'],
                        caches: ['localStorage']
                    }
                });
            updateContent(); // Initial content update after init
        }

        function updateContent() {
            // Update static elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const options = el.dataset.i18nOptions ? JSON.parse(el.dataset.i18nOptions) : undefined;
                let value = '';
                try {
                     value = i18next.t(key, options);
                     if (value === key && key !== '') console.warn(`Translation missing for key: ${key}`);
                } catch (e) { console.error(`Error translating key "${key}":`, e); value = `[Error: ${key}]`; }

                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    if (el.type !== 'file' && el.hasAttribute('placeholder')) el.placeholder = value;
                } else if (el.tagName === 'OPTION') {
                    el.textContent = value;
                } else {
                    el.innerHTML = value; // Use innerHTML for most elements
                }
            });
            // Update document title dynamically based on edit mode
            const titleKey = isEditMode ? 'ratePage.editTitle' : 'ratePage.title';
            document.title = i18next.t(titleKey);
        }

        function setupLanguageSwitcher() {
            const switcher = document.getElementById('language-switcher');
            if (!switcher) return;
            // Set initial value based on detected language
            const currentLang = i18next.language ? i18next.language.split('-')[0] : 'zh';
            switcher.value = ['zh', 'en', 'es'].includes(currentLang) ? currentLang : 'zh';

            // Add event listener for language change
            switcher.addEventListener('change', async (e) => {
                const newLang = e.target.value;
                await i18next.changeLanguage(newLang);
                updateContent(); // Update all static text
                // Re-render dynamic content that depends on translations
                renderRatingView();
                renderLoginStatus(currentAuthUser);
                renderAdminLinks();
                renderFlavorButtons(); // Re-render flavor buttons with new translations
            });
        }
        // --- End i18n Functions ---

        // --- Global Variables ---
        let ratingConfig = null; // Holds the structure fetched from API
        let userRatings = {}; // Holds user's selections { "categoryKey-criterionKey": optionIndex }
        let currentAuthUser = null; // Holds user info after login
        let currentImageKeys = []; // Array of R2 image keys, order matters (index 0 is cover)
        let sortableInstance = null; // Instance for SortableJS on image previews
        let isEditMode = false; // Flag for editing an existing rating
        let editRatingId = null; // ID of the rating being edited
        let cropper = null; // CropperJS instance
        let selectedFlavors = []; // Array of selected flavor *keys* (e.g., "flavors.coffee")

        // DOM Element references for modals and cropper
        const cropperModal = document.getElementById('cropper-modal');
        const cropperImage = document.getElementById('cropper-image');
        const cropperStatus = document.getElementById('cropper-status');

        // Authing configuration constants
        const AUTHING_APP_ID = '68f5b0b6875017c02b3bfdb3'; // Replace with your actual App ID
        const AUTHING_HOST = 'https://xfvu647mcdbk-demo.authing.cn'; // Replace with your actual Authing host

        // Grading scale (used for calculating final grade, relies on i18n keys)
        const GRADING_SCALE = [
            { "grade": "P", "nameKey": "resultsPage.grade.P", "min_score": 95 },
            { "grade": "I", "nameKey": "resultsPage.grade.I", "min_score": 90 },
            { "grade": "S", "nameKey": "resultsPage.grade.S", "min_score": 80 },
            { "grade": "T", "nameKey": "resultsPage.grade.T", "min_score": 70 },
            { "grade": "A", "nameKey": "resultsPage.grade.A", "min_score": 60 },
            { "grade": "C", "nameKey": "resultsPage.grade.C", "min_score": 50 },
            { "grade": "H", "nameKey": "resultsPage.grade.H", "min_score": 30 },
            { "grade": "O", "nameKey": "resultsPage.grade.O", "min_score": 0 }
        ];

        // Define FLAVOR_KEYS using i18n keys
        const FLAVOR_KEYS = [
             "flavors.coffee", "flavors.chocolate", "flavors.cedar", "flavors.earth",
             "flavors.hay", "flavors.leather", "flavors.nuts", "flavors.spice",
             "flavors.wood", "flavors.sweetness", "flavors.cream", "flavors.floral",
             "flavors.fruit", "flavors.caramel", "flavors.vanilla", "flavors.citrus"
        ];


        // --- Authentication ---
        window.login = function() {
            const redirectUri = window.location.origin + window.location.pathname; // Use current page as redirect
            const authorizeUrl = new URL('/oidc/auth', AUTHING_HOST);
            authorizeUrl.search = new URLSearchParams({
                client_id: AUTHING_APP_ID,
                redirect_uri: redirectUri,
                response_type: 'code',
                scope: 'openid profile email phone', // Request necessary scopes
                state: Math.random().toString(36).substring(2) // Basic CSRF protection
            }).toString();
            window.location.href = authorizeUrl.toString();
        }

        window.logout = function() {
            const logoutUrl = new URL('/oidc/session/end', AUTHING_HOST);
             // Redirect back to the current page after logout
            logoutUrl.search = new URLSearchParams({
                post_logout_redirect_uri: window.location.origin + window.location.pathname
            }).toString();
            sessionStorage.removeItem('userInfo');
            sessionStorage.removeItem('accessToken');
            window.location.href = logoutUrl.toString();
        }

        function renderLoginStatus(user) {
            const container = document.getElementById('login-status-container');
            const loginPrompt = document.getElementById('login-prompt');
            const mainContent = document.getElementById('main-content');
            if (!container) return; // Ensure container exists

            if (user) {
                // User is logged in
                const displayName = user.nickname || user.name || user.preferred_username || user.email || i18next.t('nav.loggedIn'); // Use i18n fallback
                container.innerHTML = `<span class="text-sm font-medium text-gray-700 mr-2 hidden sm:inline">${displayName}</span><button onclick="logout()" class="px-3 py-1 text-xs font-medium rounded-full bg-red-500 text-white hover:bg-red-600">${i18next.t('nav.logout')}</button>`;
                if (loginPrompt) loginPrompt.classList.add('hidden'); // Hide login prompt
                if (mainContent) mainContent.style.display = 'block'; // Show main content
            } else {
                // User is not logged in
                container.innerHTML = `<button onclick="login()" class="px-3 py-1 text-xs font-medium rounded-full bg-green-500 text-white hover:bg-green-600">${i18next.t('nav.login')}</button>`;
                if (loginPrompt) loginPrompt.classList.remove('hidden'); // Show login prompt
                if (mainContent) mainContent.style.display = 'none'; // Hide main content
            }
        }

        function renderAdminLinks() {
            const adminLinksContainer = document.getElementById('admin-links-container');
            adminLinksContainer.innerHTML = ''; // Clear previous links
            if (!adminLinksContainer || !currentAuthUser) return; // Exit if container or user not available

            const userRole = currentAuthUser.db_role; // Get role from our DB check
            const isAdmin = userRole === 'admin' || userRole === 'super_admin';
            const isSuperAdmin = userRole === 'super_admin';

            if (isAdmin) {
                adminLinksContainer.innerHTML += `<a href="cigar_rating_config.html" class="flex items-center px-3 py-1.5 border text-xs font-medium rounded-full text-white bg-blue-600 hover:bg-blue-500 transition duration-150">${i18next.t('nav.configAdmin')}</a>`;
            }
            if (isSuperAdmin) {
                adminLinksContainer.innerHTML += `<a href="role_management.html" class="flex items-center px-3 py-1.5 border text-xs font-medium rounded-full text-yellow-100 bg-purple-600 hover:bg-purple-500 ml-2 transition duration-150">${i18next.t('nav.userAdmin')}</a>`;
            }
        }

        async function handleOidcCallback(code) {
            try {
                const redirectUri = window.location.origin + window.location.pathname; // Match the redirect used in login()
                const apiUrl = new URL('/api/authing/callback', window.location.origin);
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code, redirect_uri: redirectUri }) // Send the correct redirect_uri
                });
                if (!response.ok) {
                    let errorText = i18next.t('errors.authCallbackFailed', { status: response.status });
                    try { const err = await response.json(); errorText = err.error || errorText; } catch(e){}
                    throw new Error(errorText);
                }
                const fullUserProfile = await response.json();
                sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile));
                sessionStorage.setItem('accessToken', fullUserProfile.accessToken);
                return fullUserProfile;
            } catch (e) {
                console.error('认证回调处理失败:', e);
                alert(i18next.t('errors.loginFailed', { message: e.message }));
                sessionStorage.removeItem('userInfo');
                sessionStorage.removeItem('accessToken');
                return null;
            } finally {
                // Clean up URL by removing code and state parameters
                const cleanUrl = window.location.origin + window.location.pathname + window.location.search.replace(/&?code=[^&]*/, '').replace(/&?state=[^&]*/, '');
                window.history.replaceState({}, document.title, cleanUrl);
            }
        }

        async function validateSessionAndGetUser() {
            const token = sessionStorage.getItem('accessToken');
            if (!token) return null;
            try {
                // Call our '/api/me' endpoint which validates the token AND gets the DB role
                const apiUrl = new URL('/api/me', window.location.origin);
                const response = await fetch(apiUrl, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    // Token invalid or expired, clear session
                    sessionStorage.removeItem('userInfo');
                    sessionStorage.removeItem('accessToken');
                    return null;
                }
                const fullUserProfile = await response.json();
                // Refresh userInfo in sessionStorage (in case role/nickname changed)
                sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile));
                return fullUserProfile; // Contains db_role
            } catch (e) {
                console.error("Session validation failed:", e);
                return null; // Treat errors as logged out
            }
        }

        // Helper function to set the current user and update UI
        function setUser(user) {
            currentAuthUser = user;
            renderLoginStatus(currentAuthUser); // Update login/logout button and visibility
            setTimeout(() => { renderAdminLinks(); }, 0); // Update admin links (needs timeout for DOM update)
        }
        // --- End Authentication ---


        // --- Flavor Selection Logic ---
        // Uses FLAVOR_KEYS and i18n
        function renderFlavorButtons() {
            const container = document.getElementById('flavor-buttons-container');
            if (!container || !i18next.isInitialized) return; // Ensure container and i18n are ready
            container.innerHTML = ''; // Clear previous buttons
            FLAVOR_KEYS.forEach(flavorKey => {
                const isSelected = selectedFlavors.includes(flavorKey);
                const button = document.createElement('button');
                button.type = 'button';
                button.className = `flavor-btn ${isSelected ? 'selected' : ''}`;
                button.textContent = i18next.t(flavorKey); // Display translated flavor
                button.dataset.flavorKey = flavorKey; // Store the key on the button
                button.onclick = () => toggleFlavorSelection(flavorKey, button);
                container.appendChild(button);
            });
        }

        // Works with flavorKey
        function toggleFlavorSelection(flavorKey, button) {
            const index = selectedFlavors.indexOf(flavorKey);
            if (index > -1) {
                // Flavor is selected, remove it
                selectedFlavors.splice(index, 1);
                button.classList.remove('selected');
            } else {
                // Flavor is not selected, add it
                selectedFlavors.push(flavorKey);
                button.classList.add('selected');
            }
            console.log("Selected flavor keys:", selectedFlavors); // Log the keys
        }
        // --- End Flavor Selection ---


        // --- Image Handling (with Sorting and Cover Selection) ---
        const MAX_IMAGES = 5; // Maximum number of images allowed
        let filesToProcess = []; // Array of files selected by user, waiting for cropping/upload
        let currentFileIndex = 0; // Index of the file currently being processed

        // Function to render the image previews in the grid
        function renderImagePreviews() {
            const grid = document.getElementById('image-preview-grid');
            const uploadLabel = document.getElementById('image-upload-label');
            const uploadInput = document.getElementById('image-upload-input');
            grid.innerHTML = ''; // Clear existing previews

            currentImageKeys.forEach((key, index) => {
                const item = document.createElement('div');
                item.className = `preview-item ${index === 0 ? 'is-cover' : ''}`; // Add 'is-cover' class to the first image
                item.dataset.key = key; // Store the image key

                // Use i18n for button text/titles
                const coverButtonText = index === 0 ? i18next.t('common.cover') : i18next.t('ratePage.setCover');
                const deleteTitle = i18next.t('common.delete') + ' ' + i18next.t('common.image');

                item.innerHTML = `
                    <img src="/api/image/${key}" alt="${i18next.t('common.image')} ${index + 1}">
                    <button class="remove-btn" onclick="removeImage(${index})" title="${deleteTitle}">&times;</button>
                    <button class="set-cover-btn" onclick="setCoverImage(${index})" title="${coverButtonText}">
                        ${coverButtonText}
                    </button>
                `;
                grid.appendChild(item);
            });

            // Disable upload button if max images reached
            if (currentImageKeys.length >= MAX_IMAGES) {
                uploadLabel.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                uploadLabel.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                uploadInput.disabled = true;
            } else {
                uploadLabel.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                uploadLabel.classList.add('bg-blue-600', 'hover:bg-blue-700');
                uploadInput.disabled = false;
            }
        }

        // Initialize SortableJS for drag-and-drop reordering of images
        function initializeSortable() {
            const grid = document.getElementById('image-preview-grid');
            if (sortableInstance) {
                sortableInstance.destroy(); // Destroy previous instance if exists
            }
            sortableInstance = new Sortable(grid, {
                animation: 150, // Animation speed
                ghostClass: 'sortable-ghost', // Class for the placeholder
                dragClass: 'sortable-drag', // Class for the item being dragged
                onEnd: function (evt) {
                    // Update the order of keys in currentImageKeys array
                    const movedItemKey = currentImageKeys.splice(evt.oldIndex, 1)[0];
                    currentImageKeys.splice(evt.newIndex, 0, movedItemKey);
                    // Re-render previews to update cover status and button text
                    renderImagePreviews();
                }
            });
        }

        // Function called when "Set Cover" button is clicked
        window.setCoverImage = function(index) {
            if (index > 0 && index < currentImageKeys.length) {
                // Move the selected image key to the beginning of the array
                const newCoverKey = currentImageKeys.splice(index, 1)[0];
                currentImageKeys.unshift(newCoverKey);
                // Re-render previews to reflect the change
                renderImagePreviews();
            }
        }

        // Function called when remove (×) button is clicked
        window.removeImage = function(indexToRemove) {
            if (indexToRemove >= 0 && indexToRemove < currentImageKeys.length) {
                currentImageKeys.splice(indexToRemove, 1); // Remove the key
                renderImagePreviews(); // Re-render previews
            }
        }

        // Function called when files are selected via the input
        window.handleFileSelect = function(event) {
            const status = document.getElementById('image-upload-status');
            status.textContent = ''; // Clear previous status
            const selectedFiles = Array.from(event.target.files);
            if (selectedFiles.length === 0) return;

            // Check if user is logged in
            if (!currentAuthUser) {
                alert(i18next.t('ratePage.loginToUpload'));
                return;
            }

            const allowedFiles = [];
            // Filter selected files based on count, size, and type
            for (const file of selectedFiles) {
                if (currentImageKeys.length + allowedFiles.length >= MAX_IMAGES) {
                    alert(i18next.t('ratePage.maxImages', { max: MAX_IMAGES }));
                    break; // Stop processing if max count reached
                }
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    alert(i18next.t('ratePage.imageTooLarge', { name: file.name }));
                    continue; // Skip this file
                }
                if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) {
                    alert(i18next.t('ratePage.imageTypeNotSupported', { name: file.name }));
                    continue; // Skip this file
                }
                allowedFiles.push(file);
            }

            // If valid files were selected, start the cropping process
            if (allowedFiles.length > 0) {
                filesToProcess = allowedFiles;
                currentFileIndex = 0;
                showCropperForNextFile();
            }
            event.target.value = null; // Reset file input
        }

        // Show the cropper modal for the next file in the queue
        function showCropperForNextFile() {
            if (currentFileIndex >= filesToProcess.length) {
                // All files processed
                filesToProcess = [];
                cancelCrop(); // Hide modal
                return;
            }
            const file = filesToProcess[currentFileIndex];
            const reader = new FileReader();
            reader.onload = (e) => {
                cropperModal.classList.remove('hidden'); // Show modal
                cropperImage.src = e.target.result; // Load image data
                if (cropper) cropper.destroy(); // Destroy previous cropper instance
                // Initialize CropperJS
                cropper = new Cropper(cropperImage, {
                    aspectRatio: 1179 / 1572, // Set aspect ratio
                    viewMode: 1, // Restrict crop box to canvas
                    autoCropArea: 0.9, // Initial crop area size
                    background: false, // No grid background
                });
                // Update status message
                cropperStatus.textContent = i18next.t('ratePage.processingImage', { current: currentFileIndex + 1, total: filesToProcess.length });
            };
            reader.readAsDataURL(file); // Read file as Data URL
        }

        // Function called when "Confirm & Upload" is clicked in the modal
        window.confirmCropAndUpload = async function() {
            if (!cropper || !filesToProcess[currentFileIndex]) return;

            const token = sessionStorage.getItem('accessToken');
            if (!token) {
                alert(i18next.t('common.sessionExpired')); // Use i18n
                return;
            }

            cropperStatus.textContent = i18next.t('ratePage.croppingAndUploading', { current: currentFileIndex + 1 }); // Update status
            const originalFileName = filesToProcess[currentFileIndex].name;

            // Get cropped image data as a canvas
            const canvas = cropper.getCroppedCanvas({
                width: 600, // Desired width
                height: 800, // Desired height based on aspect ratio
                imageSmoothingQuality: 'high',
            });

            // Convert canvas to Blob (JPEG format, 90% quality)
            canvas.toBlob(async (blob) => {
                if (!blob) {
                    cropperStatus.textContent = i18next.t('ratePage.cropFailed');
                    return;
                }
                try {
                    const formData = new FormData();
                    // Append blob with original filename (extension might change due to conversion)
                    formData.append('image', blob, originalFileName.replace(/\.\w+$/, '.jpg'));

                    // Send blob to the upload API endpoint
                    const response = await fetch('/api/upload-image', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'Upload failed');

                    currentImageKeys.push(result.imageKey); // Add the returned key
                    renderImagePreviews(); // Update previews
                    currentFileIndex++; // Move to the next file
                    showCropperForNextFile(); // Show cropper for the next file or close modal
                } catch (e) {
                    console.error("上传图片失败:", e);
                    cropperStatus.textContent = i18next.t('ratePage.uploadFailed', { msg: e.message }); // Show error
                }
            }, 'image/jpeg', 0.9); // Specify MIME type and quality
        }

        // Function called when "Cancel" is clicked in the modal
        window.cancelCrop = function() {
            if (cropper) cropper.destroy(); // Clean up cropper instance
            cropper = null;
            cropperImage.src = ''; // Clear image source
            cropperModal.classList.add('hidden'); // Hide modal
            cropperStatus.textContent = ''; // Clear status message
            // Optionally clear remaining filesToProcess if needed
            // filesToProcess = [];
        }
        // --- End Image Handling ---


        // --- Core Rating Logic ---
        // Function to load the rating configuration from the API
        async function loadConfig() {
            document.getElementById('config-load-status').textContent = i18next.t('ratePage.configSyncing');
            try {
                const apiUrl = new URL('/api/config/latest', window.location.origin);
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
                ratingConfig = await response.json();
                if (!ratingConfig || !ratingConfig.ratingCriteria) throw new Error("Loaded config is invalid.");

                calculateWeights(ratingConfig); // Calculate total weights and counts
                userRatings = {}; // Reset user selections
                renderRatingView(); // Render the form based on the config
                renderFlavorButtons(); // Render flavor buttons (now uses i18n keys)
                document.getElementById('config-load-status').textContent = i18next.t('ratePage.configSynced');
            } catch (error) {
                console.error("加载配置失败:", error);
                document.getElementById('config-load-status').textContent = i18next.t('ratePage.configFailed');
                alert(`Failed to load core app config. Please refresh.\nDetails: ${error.message}`);
                // Optionally disable the form or show a more prominent error
            }
        }

        // Generates a unique ID for each criterion based on its i18n key
        function getRatingId(categoryKey, criterionKey) {
            // Use keys directly for a stable ID
            return `${categoryKey}-${criterionKey}`;
        }

        // Calculate total possible weight and number of criteria from the config
        function calculateWeights(config) {
            let totalWeight = 0;
            let criteriaCount = 0;
            if (config && config.ratingCriteria) {
                config.ratingCriteria.forEach(cat => {
                    if (cat.criteriaList) {
                        cat.criteriaList.forEach(crit => {
                            totalWeight += (crit.weight || 0);
                            criteriaCount++;
                        });
                    }
                });
            }
            config.totalWeightMax = totalWeight; // Store calculated max weight
            config.totalCriteriaCount = criteriaCount; // Store total criteria count
        }

        // Calculate the user's current total score based on selections
        function calculateFinalScore() {
            let score = 0;
            if (!ratingConfig || !ratingConfig.ratingCriteria) return 0;

            for (const ratingId in userRatings) {
                // Parse keys from ratingId
                 // More robust split needed if keys contain hyphens
                 let categoryKey = '';
                 let criterionKey = '';
                 // Try to find a valid category key first by iterating through possible splits
                 const keys = ratingId.split('-');
                 for (let i = 1; i < keys.length; i++) {
                     let potentialCatKey = keys.slice(0, i).join('-');
                     // Check if this potential key exists in the config's category keys
                     if (ratingConfig.ratingCriteria.some(cat => cat.categoryKey === potentialCatKey)) {
                         categoryKey = potentialCatKey;
                         criterionKey = keys.slice(i).join('-'); // The rest is the criterion key
                         break;
                     }
                 }

                 if (!categoryKey || !criterionKey) {
                     console.warn("Could not parse keys from ratingId:", ratingId);
                     continue; // Skip if parsing fails
                 }


                const selectedOptionIndex = userRatings[ratingId];

                // Find the corresponding category and criterion in the config
                const category = ratingConfig.ratingCriteria.find(cat => cat.categoryKey === categoryKey);
                const criterion = category?.criteriaList?.find(crit => crit.nameKey === criterionKey);

                if (criterion && criterion.options && selectedOptionIndex < criterion.options.length) {
                    const weight = criterion.weight || 0;
                    const scorePct = criterion.options[selectedOptionIndex]?.scorePct || 0;
                    score += weight * scorePct;
                } else {
                     console.warn(`Could not find criterion or option for: ${ratingId} with index ${selectedOptionIndex}`);
                }
            }
            return score;
        }

        // Update user's selection for a criterion using keys
        window.updateRatingSelection = function(categoryKey, criterionKey, optionIndex) {
            const id = getRatingId(categoryKey, criterionKey); // Generate ID using keys
            userRatings[id] = optionIndex; // Store the selected option index
            renderRatingView(); // Re-render to update score, progress, and button styles
        };

        // Render the entire rating form based on the loaded config and user selections
        function renderRatingView() {
            const formContainer = document.getElementById('rating-form-container');
            if (!formContainer || !i18next.isInitialized) return; // Exit if container not found or i18n not ready

            // Handle case where config failed to load
            if (!ratingConfig || !ratingConfig.ratingCriteria) {
                formContainer.innerHTML = `<div class="text-center p-6 bg-white rounded-lg shadow"><p>${i18next.t('ratePage.configFailed')}</p></div>`;
                // Update header displays to zero/default
                document.getElementById('app-title-display').textContent = i18next.t('ratePage.title'); // Default title
                document.getElementById('app-description-display').textContent = '';
                document.getElementById('total-weight-max-display').textContent = '0';
                document.getElementById('current-score-display').textContent = '0.00';
                document.getElementById('progress-bar').style.width = '0%';
                document.getElementById('progress-text').textContent = '0 / 0';
                return;
            };

            // Update header displays
            const totalScore = calculateFinalScore();
            // Use i18n for title/description if keys are provided, otherwise use the text directly
            document.getElementById('app-title-display').textContent = i18next.t(ratingConfig.appTitle || 'ratePage.title');
            document.getElementById('app-description-display').textContent = i18next.t(ratingConfig.description || '');
            document.getElementById('total-weight-max-display').textContent = ratingConfig.totalWeightMax ?? 0;
            document.getElementById('current-score-display').textContent = totalScore.toFixed(2);

            // Update progress bar
            const ratedCount = Object.keys(userRatings).length;
            const totalCount = ratingConfig.totalCriteriaCount || 1; // Avoid division by zero
            document.getElementById('progress-bar').style.width = `${(ratedCount / totalCount) * 100}%`;
            document.getElementById('progress-text').textContent = `${ratedCount} / ${totalCount}`;

            // Generate HTML for each category and its criteria
            formContainer.innerHTML = ratingConfig.ratingCriteria.map((category) => `
                <div class="bg-white p-6 rounded-xl shadow-lg mb-8 border-l-4 border-indigo-500">
                    <h3 class="text-xl font-bold text-indigo-700 mb-2">${i18next.t(category.categoryKey || '')}</h3>
                    <p class="text-gray-500 text-sm mb-4">${i18next.t(category.detailKey || '')}</p>
                    <div class="space-y-6">
                        ${(category.criteriaList || []).map((criterion) => renderRatingCriterion(category.categoryKey, criterion)).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Render a single criterion section with its options
        function renderRatingCriterion(categoryKey, criterion) {
            const criterionKey = criterion.nameKey; // Use the key
            if (!criterionKey) { console.warn("Criterion missing nameKey:", criterion); return ''; } // Add guard for missing key

            const id = getRatingId(categoryKey, criterionKey); // Generate ID using keys
            const selectedOptionIndex = userRatings[id]; // Get user selection for this criterion
            const currentWeight = criterion.weight || 0; // Get weight or default to 0
            let currentScore = 0; // Calculate score for this criterion based on selection
            if (selectedOptionIndex !== undefined && criterion.options?.[selectedOptionIndex]) {
                currentScore = currentWeight * (criterion.options[selectedOptionIndex].scorePct || 0);
            }

            // Check if current user is super admin to show score details
            const isSuperAdmin = currentAuthUser?.db_role === 'super_admin';

            return `
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-lg font-semibold text-gray-800">
                            ${i18next.t(criterionKey)} ${isSuperAdmin ? `(${currentWeight} ${i18next.t('common.points')})` : ''}
                        </h4>
                        ${isSuperAdmin ? `<span class="text-xl font-extrabold text-green-600">${currentScore.toFixed(2)}</span>` : ''}
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2">
                    ${(criterion.options || []).map((option, optIndex) => {
                        const isSelected = selectedOptionIndex === optIndex; // Check if this option is selected
                        const score = (currentWeight * (option.scorePct || 0)).toFixed(2); // Calculate potential score
                        const descriptionKey = option.descriptionKey; // Use the key
                        if (!descriptionKey) { console.warn("Option missing descriptionKey:", option); return ''; } // Add guard

                        return `
                            <button
                                type="button"
                                onclick="updateRatingSelection('${categoryKey}', '${criterionKey}', ${optIndex})"
                                class="p-2 text-sm text-center rounded-lg border transition ${isSelected ? 'bg-indigo-600 text-white shadow-md ring-2 ring-indigo-300 ring-offset-1' : 'bg-white text-gray-700 hover:bg-indigo-50 hover:border-indigo-300'}">
                                ${i18next.t(descriptionKey)}
                                ${isSuperAdmin ? `<span class="block text-xs ${isSelected ? 'text-indigo-200' : 'text-gray-500'}">(${i18next.t('common.score')} ${score} ${i18next.t('common.points')})</span>` : ''}
                            </button>
                        `;
                    }).join('')}
                    </div>
                </div>
            `;
        }
        // --- End Core Rating Logic ---


        // --- Actions (Reset, Show Results / Save Changes) ---
        // Function to reset all selections and input fields
        window.resetRatings = function() {
            if (confirm(i18next.t('ratePage.confirmReset'))) {
                userRatings = {}; // Clear selections
                // Clear input fields
                document.getElementById('rating-title').value = '';
                document.getElementById('cigar-name').value = '';
                document.getElementById('cigar-size').value = '';
                document.getElementById('cigar-origin').value = '';
                document.getElementById('cigar-review').value = '';
                // Clear images and flavors
                currentImageKeys = [];
                selectedFlavors = [];
                renderFlavorButtons(); // Re-render flavors (will be empty)
                renderImagePreviews(); // Re-render images (will be empty)

                // If in edit mode, switch back to create mode
                if (isEditMode) {
                    isEditMode = false;
                    editRatingId = null;
                    const actionButton = document.getElementById('main-action-button');
                    actionButton.textContent = i18next.t('ratePage.viewReport'); // Change button text back
                    actionButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    actionButton.classList.add('bg-green-600', 'hover:bg-green-700'); // Change button color back
                    // Clean URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
                renderRatingView(); // Re-render the form (will show 0 score etc.)
                updateCharCounts(); // Reset character counters
            }
        }

        // Prepares resultsData with keys for flavors and handles saving or redirecting
        window.showResults = async function() {
            // --- Validation Checks ---
            const token = sessionStorage.getItem('accessToken');
            // Login check (only if creating new, not editing)
            if (!isEditMode && (!currentAuthUser || !token)) {
                return alert(i18next.t('ratePage.loginToSubmit'));
            }
            // Config and selection checks
            if (!ratingConfig || Object.keys(userRatings).length === 0) {
                return alert(i18next.t('ratePage.selectOneOption'));
            }
            // Required field checks
            const title = document.getElementById('rating-title').value.trim();
            if (!title) {
                return alert(i18next.t('ratePage.titleRequired'));
            }
            if (currentImageKeys.length === 0) {
                return alert(i18next.t('ratePage.imageRequired'));
            }
            const cigarNameValue = document.getElementById('cigar-name').value.trim();
            if (!cigarNameValue) {
                return alert(i18next.t('ratePage.nameRequired'));
            }
            // --- End Validation ---

            // --- Prepare Data ---
            const cigarInfo = {
                name: cigarNameValue,
                size: document.getElementById('cigar-size').value || i18next.t('common.unknown'), // Use i18n for default
                origin: document.getElementById('cigar-origin').value || i18next.t('common.unknown') // Use i18n for default
            };
            const cigarReview = document.getElementById('cigar-review').value || ''; // Default to empty string
            const finalScore = calculateFinalScore();
            const maxScore = ratingConfig.totalWeightMax || 1; // Avoid division by zero
            const normalizedScore = maxScore > 0 ? (finalScore / maxScore) * 100 : 0;

            // Find the grade based on normalized score
            const foundGrade = GRADING_SCALE.find(g => normalizedScore >= g.min_score) || GRADING_SCALE[GRADING_SCALE.length - 1]; // Default to lowest grade
            const finalGrade = foundGrade ? {
                grade: foundGrade.grade,
                nameKey: foundGrade.nameKey, // Pass the i18n key for the grade name
                color: foundGrade.color
            } : null; // Should always find a grade

            // Construct the data object to be saved or passed to results page
            const resultsData = {
                title: title,
                config: ratingConfig,       // Include the config structure used
                ratings: userRatings,       // User's selections { "catKey-critKey": index }
                calculatedScore: finalScore,// Raw score based on weights
                cigarInfo: cigarInfo,
                cigarReview: cigarReview,
                imageUrls: currentImageKeys,// Array of R2 image keys
                normalizedScore: normalizedScore, // Score normalized to 0-100
                finalGrade: finalGrade,     // Grade object { grade: 'P', nameKey: '...', color: '...' }
                selectedFlavors: selectedFlavors, // Array of selected flavor *keys*
                isDraft: !isEditMode        // Mark as draft if creating new
            };
            // --- End Prepare Data ---

            // --- Save Changes (Edit Mode) or Show Results (Create Mode) ---
            if (isEditMode && editRatingId) {
                // --- Save Changes Logic ---
                const actionButton = document.getElementById('main-action-button');
                actionButton.textContent = i18next.t('common.saving'); // Update button text
                actionButton.disabled = true;
                try {
                    if (!token) throw new Error(i18next.t('common.sessionExpired')); // Check token again
                    resultsData.ratingId = editRatingId; // Add the ID for the PUT request
                    const apiUrl = new URL(`/api/ratings`, window.location.origin);
                    const response = await fetch(apiUrl, {
                        method: 'PUT', // Use PUT for update
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify(resultsData)
                    });
                    if (!response.ok) {
                        let errorText = i18next.t('errors.saveFailedNoMsg');
                        try { const err = await response.json(); errorText = err.error || errorText; } catch(e){}
                        throw new Error(errorText);
                    }
                    alert(i18next.t('common.saveSuccess')); // Show success message
                    window.location.href = 'history.html'; // Redirect to history page
                } catch (e) {
                    alert(i18next.t('common.saveFailed', { msg: e.message })); // Show error message
                    actionButton.textContent = i18next.t('ratePage.saveChanges'); // Reset button text
                    actionButton.disabled = false;
                }
                // --- End Save Changes Logic ---
            } else {
                // --- Show Results Logic ---
                try {
                    // Store the results in session storage for the results page to pick up
                    sessionStorage.setItem('cigarRatingResults', JSON.stringify(resultsData));
                    window.location.href = 'results.html'; // Redirect to results page
                } catch (e) {
                    console.error("存储 Session Storage 失败:", e);
                    alert(i18next.t('common.sessionStoreFailed')); // Show error
                }
                // --- End Show Results Logic ---
            }
        };
        // --- End Actions ---


        // --- Initialization and Edit Mode Handling ---
        // Function to load data for editing
        async function loadRatingForEdit(ratingId) {
             const statusElement = document.getElementById('config-load-status');
             statusElement.textContent = i18next.t('ratePage.loadingEdit', { id: ratingId.substring(0, 8) }); // Show loading message
            try {
                const token = sessionStorage.getItem('accessToken');
                if (!token) throw new Error(i18next.t('common.loginRequired')); // Check login

                const apiUrl = new URL(`/api/ratings?id=${ratingId}`, window.location.origin);
                const response = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) {
                     let errorText = i18next.t('ratePage.editLoadFailed', { msg: `Status ${response.status}` });
                     try { const err = await response.json(); errorText = err.error || errorText; } catch(e){}
                     throw new Error(errorText);
                }
                const data = await response.json();

                // Populate form fields
                document.getElementById('rating-title').value = data.title || '';
                document.getElementById('cigar-name').value = data.cigarInfo?.name || '';
                document.getElementById('cigar-size').value = data.cigarInfo?.size || '';
                document.getElementById('cigar-origin').value = data.cigarInfo?.origin || '';
                document.getElementById('cigar-review').value = data.cigarReview || '';

                // Load images
                currentImageKeys = Array.isArray(data.imageUrl) ? data.imageUrl : (data.imageUrl ? [data.imageUrl] : []);
                renderImagePreviews();
                initializeSortable(); // Init sortable after images are loaded

                // Load flavor selections (expecting keys)
                selectedFlavors = Array.isArray(data.fullData?.selectedFlavors) ? data.fullData.selectedFlavors : []; // Use fullData if available
                renderFlavorButtons(); // Render and mark selected flavors

                // Load rating selections (using the structure with keys)
                userRatings = data.fullData?.ratings || {}; // Assumes ratings are stored with key-based IDs

                // Ensure the config is loaded before rendering the view with selections
                if (!ratingConfig) {
                    await loadConfig(); // Wait for config if not already loaded
                }
                 // IMPORTANT: Re-render rating view *after* config is potentially loaded and userRatings are set
                renderRatingView();


                statusElement.textContent = i18next.t('ratePage.editLoaded', { id: ratingId.substring(0, 8) }); // Show success message

                // Update button text and style for saving changes
                const actionButton = document.getElementById('main-action-button');
                actionButton.textContent = i18next.t('ratePage.saveChanges');
                actionButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                actionButton.classList.add('bg-blue-600', 'hover:bg-blue-700');

            } catch (error) {
                console.error("加载编辑数据失败:", error);
                statusElement.textContent = i18next.t('ratePage.editLoadFailed', { msg: error.message }); // Show error
                alert(i18next.t('ratePage.editLoadFailed', { msg: error.message }));
                // Optionally redirect or disable form
                window.location.href = 'history.html'; // Redirect back if load fails
            }
        }

        // --- Character Counters ---
        function updateCharCounts() {
             const titleInput = document.getElementById('rating-title');
             const reviewInput = document.getElementById('cigar-review');
             const titleCount = document.getElementById('title-char-count');
             const reviewCount = document.getElementById('review-char-count');
             if(titleInput && titleCount) titleCount.textContent = `${titleInput.value.length} / ${titleInput.maxLength}`;
             if(reviewInput && reviewCount) reviewCount.textContent = `${reviewInput.value.length} / ${reviewInput.maxLength}`;
        }

        // --- Window Onload ---
        window.onload = async function() {
            await initI18n(); // 1. Initialize i18n first

            // 2. Handle Authentication
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const editIdParam = urlParams.get('edit'); // Check for 'edit' parameter
            let user = code ? await handleOidcCallback(code) : await validateSessionAndGetUser();
            setUser(user); // Set user and update UI (login status, admin links)

            // 3. Setup UI elements dependent on i18n
            setupLanguageSwitcher(); // Setup language switcher now that i18n is ready

            // Add event listeners for character counts
            document.getElementById('rating-title')?.addEventListener('input', updateCharCounts);
            document.getElementById('cigar-review')?.addEventListener('input', updateCharCounts);

            // 4. Load Core Config OR Edit Data
            if (editIdParam && user) { // Only load edit data if logged in
                // Edit Mode
                isEditMode = true;
                editRatingId = editIdParam;
                // loadConfig will be called inside loadRatingForEdit if needed
                await loadRatingForEdit(editRatingId);
            } else if (user) { // Only load config if logged in (for create mode)
                // Create Mode
                isEditMode = false;
                await loadConfig(); // Load the default config for rating
                renderImagePreviews(); // Render empty image previews
                initializeSortable(); // Initialize sortable for images
            } else {
                 // Not logged in and not an auth callback - main content remains hidden by renderLoginStatus
                 document.getElementById('config-load-status').textContent = i18next.t('ratePage.loginPrompt');
            }
             updateCharCounts(); // Initial count update
        };
        // --- End Window Onload ---

    </script>
</body>
</html>

