<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Pistacho 站内留言给管理员的联系方式页面" data-i18n="contactPage.metaDescription" data-i18n-attr="content">
    <title data-i18n="contactPage.pageTitle">联系管理员 - Pistacho</title>
    <link rel="icon" type="image/png" href="Certifiedstamp.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/i18next/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-http-backend/i18nextHttpBackend.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector/i18nextBrowserLanguageDetector.min.js"></script>
    <script type="module" src="scripts/navbar.js"></script>
    <style>
        .lang-button {
            padding: 2px 6px;
            margin: 0 2px;
            border: 1px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: background-color 0.2s, border-color 0.2s;
            background-color: #f3f4f6;
        }
        .lang-button:hover {
            background-color: #e5e7eb;
        }
        .lang-button.active {
            font-weight: 600;
            background-color: #e0e7ff;
            border-color: #a5b4fc;
            color: #3730a3;
            cursor: default;
        }
    </style>
</head>
<body class="bg-slate-100 font-sans">
    <div class="main-container mx-auto max-w-4xl px-4 py-6 sm:px-6 lg:px-8">
        <div data-include-nav data-active="contact" data-language="flags"></div>

        <main class="space-y-6">
            <section class="rounded-2xl border border-indigo-100/70 bg-white/95 p-6 shadow-md backdrop-blur">
                <div class="space-y-2">
                    <h1 class="text-2xl font-semibold text-slate-800" data-i18n="contactPage.title">联系社区管理员</h1>
                    <p class="text-sm text-slate-600" data-i18n="contactPage.description">如果你在使用 Pistacho 时遇到问题或有任何建议，可以在这里留言联系我们的管理员。请留下你的邮箱以便我们回复。</p>
                </div>

                <form id="contact-form" class="mt-6 space-y-4">
                    <div>
                        <label for="contact-email" class="block text-sm font-medium text-slate-700" data-i18n="contactPage.emailLabel">联系邮箱</label>
                        <input type="email" id="contact-email" name="email" required placeholder="name@example.com" data-i18n="contactPage.emailPlaceholder" data-i18n-attr="placeholder"
                               class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200">
                    </div>
                    <div>
                        <label for="contact-message" class="block text-sm font-medium text-slate-700" data-i18n="contactPage.messageLabel">留言内容</label>
                        <textarea id="contact-message" name="message" rows="6" required maxlength="1000" placeholder="请输入具体的问题或建议" data-i18n="contactPage.messagePlaceholder" data-i18n-attr="placeholder"
                                  class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm shadow-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-200"></textarea>
                        <p class="mt-1 text-xs text-slate-400" data-i18n="contactPage.messageHint">留言内容最多支持 1000 字。</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button type="submit" id="contact-submit" class="inline-flex items-center justify-center rounded-full bg-indigo-600 px-5 py-2 text-sm font-semibold text-white shadow-md transition hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-300" data-i18n="contactPage.submitButton">发送留言</button>
                        <span id="form-status" class="text-sm"></span>
                    </div>
                </form>
            </section>

            <section id="admin-messages-section" class="hidden rounded-2xl border border-emerald-100/70 bg-white/95 p-6 shadow-md backdrop-blur">
                <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                    <div>
                        <h2 class="text-xl font-semibold text-emerald-700" data-i18n="contactPage.adminSectionTitle">管理员留言箱</h2>
                        <p class="text-sm text-slate-600" data-i18n="contactPage.adminSectionDescription">只有管理员可以查看所有用户的留言。</p>
                    </div>
                    <button id="refresh-messages" class="inline-flex items-center justify-center rounded-full border border-emerald-200 bg-emerald-50 px-4 py-2 text-sm font-medium text-emerald-700 transition hover:bg-emerald-100 focus:outline-none focus:ring-2 focus:ring-emerald-200" data-i18n="contactPage.refreshButton">刷新列表</button>
                </div>
                <div id="admin-error" class="mt-3 hidden rounded-xl border border-red-100 bg-red-50 px-4 py-3 text-sm text-red-600"></div>
                <div id="admin-no-messages" class="mt-6 rounded-xl border border-dashed border-slate-200 bg-slate-50 px-4 py-6 text-center text-sm text-slate-500" data-i18n="contactPage.adminNoMessages">目前还没有用户留言。</div>
                <div id="admin-messages-list" class="mt-4 space-y-4"></div>
            </section>
        </main>
    </div>

    <script type="module">
        const AUTHING_APP_ID = '68f5b0b6875017c02b3bfdb3';
        const AUTHING_HOST = 'https://xfvu647mcdbk-demo.authing.cn';

        let currentAuthUser = null;
        let contactMessages = [];
        let isAdminUser = false;
        let lastStatus = { type: null, messageKey: null };
        let adminErrorMessageKey = null;

        const contactForm = document.getElementById('contact-form');
        const emailInput = document.getElementById('contact-email');
        const messageInput = document.getElementById('contact-message');
        const submitButton = document.getElementById('contact-submit');
        const statusText = document.getElementById('form-status');
        const adminSection = document.getElementById('admin-messages-section');
        const adminList = document.getElementById('admin-messages-list');
        const adminEmpty = document.getElementById('admin-no-messages');
        const adminError = document.getElementById('admin-error');
        const refreshButton = document.getElementById('refresh-messages');

        function sanitizeInput(value = '') {
            return value.replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F\u007F]/g, '').trim();
        }

        function updateStatus(type, messageKey, fallbackText = '') {
            lastStatus = { type, messageKey };
            if (!statusText) return;
            if (!messageKey) {
                statusText.textContent = '';
                statusText.className = 'text-sm';
                return;
            }
            let translated = fallbackText;
            if (i18next.isInitialized) {
                try {
                    translated = i18next.t(messageKey, { msg: fallbackText });
                } catch (error) {
                    console.error('Failed to translate status message:', error);
                }
            }
            statusText.textContent = translated || fallbackText;
            let colorClass = 'text-slate-500';
            if (type === 'error') {
                colorClass = 'text-red-600';
            } else if (type === 'success') {
                colorClass = 'text-emerald-600';
            }
            statusText.className = `text-sm ${colorClass}`;
        }

        function renderAdminLinks() {
            const configLink = document.getElementById('config-admin-link');
            if (!configLink) return;
            configLink.classList.add('hidden');
            if (!currentAuthUser) return;
            const role = currentAuthUser.db_role;
            if (role === 'admin' || role === 'super_admin') {
                configLink.classList.remove('hidden');
                if (i18next.isInitialized) {
                    configLink.textContent = i18next.t('nav.configAdmin');
                }
            }
        }

        function renderLoginStatus(user) {
            const container = document.getElementById('login-status-container');
            if (!container) return;
            if (user) {
                const displayName = user.nickname || user.name || user.preferred_username || user.email || (i18next.isInitialized ? i18next.t('nav.login') : '登录');
                container.innerHTML = `<span class="hidden text-xs font-medium text-gray-700 sm:inline">${displayName}</span><button onclick="logout()" class="rounded-full bg-red-500 px-3 py-1 text-xs font-medium text-white hover:bg-red-600">${i18next.isInitialized ? i18next.t('nav.logout') : '退出'}</button>`;
            } else {
                container.innerHTML = `<button onclick="login()" class="rounded-full bg-green-500 px-3 py-1 text-xs font-medium text-white hover:bg-green-600">${i18next.isInitialized ? i18next.t('nav.login') : '登录'}</button>`;
            }
        }

        function renderLanguageSwitcher() {
            const container = document.getElementById('language-flags');
            if (!container || !i18next.isInitialized) return;
            container.innerHTML = '';
            const languages = ['zh', 'en', 'es'];
            const currentLang = i18next.language ? i18next.language.split('-')[0] : 'zh';
            languages.forEach(lang => {
                const button = document.createElement('button');
                button.textContent = lang.toUpperCase();
                button.className = `lang-button ${lang === currentLang ? 'active' : ''}`;
                button.dataset.lang = lang;
                button.onclick = async (event) => {
                    const newLang = event.currentTarget.dataset.lang;
                    const oldLang = i18next.language ? i18next.language.split('-')[0] : 'zh';
                    if (newLang === oldLang) return;
                    try {
                        await i18next.changeLanguage(newLang);
                        updateContent();
                        renderLanguageSwitcher();
                        renderLoginStatus(currentAuthUser);
                        renderAdminLinks();
                        if (isAdminUser) {
                            renderAdminMessages();
                        }
                        if (lastStatus.messageKey) {
                            updateStatus(lastStatus.type, lastStatus.messageKey);
                        }
                        if (adminErrorMessageKey && !adminError.classList.contains('hidden')) {
                            adminError.textContent = i18next.t(adminErrorMessageKey);
                        }
                    } catch (error) {
                        console.error('Failed to change language:', error);
                    }
                };
                container.appendChild(button);
            });
        }

        function updateContent() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (!key) return;
                let value = '';
                try {
                    value = i18next.t(key);
                } catch (error) {
                    console.error(`Failed to translate key ${key}:`, error);
                }

                const attrListRaw = el.getAttribute('data-i18n-attr');
                const targetAttributes = attrListRaw ? attrListRaw.split(',').map(attr => attr.trim()).filter(Boolean) : [];
                if (targetAttributes.length) {
                    targetAttributes.forEach(attrName => {
                        if (!attrName) return;
                        if (attrName === 'content') {
                            el.setAttribute(attrName, value);
                        } else if (attrName === 'placeholder') {
                            el.setAttribute(attrName, value);
                        } else {
                            el.setAttribute(attrName, value);
                        }
                    });
                    return;
                }

                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    if (el.hasAttribute('placeholder')) {
                        el.placeholder = value;
                    }
                } else if (el.tagName === 'TITLE') {
                    el.textContent = (typeof value === 'string' || typeof value === 'number') ? value : '';
                    document.title = el.textContent;
                } else {
                    el.innerHTML = (typeof value === 'string' || typeof value === 'number') ? value : '';
                }
            });
        }

        window.login = function() {
            const redirectUri = window.location.origin + '/contact.html';
            const authorizeUrl = new URL('/oidc/auth', AUTHING_HOST);
            authorizeUrl.search = new URLSearchParams({
                client_id: AUTHING_APP_ID,
                redirect_uri: redirectUri,
                response_type: 'code',
                scope: 'openid profile email phone',
                state: Math.random().toString(36).substring(2)
            }).toString();
            window.location.href = authorizeUrl.toString();
        };

        window.logout = function() {
            const logoutUrl = new URL('/oidc/session/end', AUTHING_HOST);
            logoutUrl.search = new URLSearchParams({
                post_logout_redirect_uri: window.location.origin + '/contact.html'
            }).toString();
            sessionStorage.removeItem('userInfo');
            sessionStorage.removeItem('accessToken');
            window.location.href = logoutUrl.toString();
        };

        async function handleOidcCallback(code) {
            try {
                const redirectUri = window.location.origin + '/contact.html';
                const apiUrl = new URL('/api/authing/callback', window.location.origin);
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code, redirect_uri: redirectUri })
                });
                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.error || '认证失败');
                }
                const fullUserProfile = await response.json();
                sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile));
                sessionStorage.setItem('accessToken', fullUserProfile.accessToken);
                return fullUserProfile;
            } catch (error) {
                console.error('handleOidcCallback error:', error);
                updateStatus('error', 'contactPage.submitError', `登录失败: ${error.message}`);
                sessionStorage.removeItem('userInfo');
                sessionStorage.removeItem('accessToken');
                return null;
            } finally {
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        async function validateSessionAndGetUser() {
            const token = sessionStorage.getItem('accessToken');
            if (!token) return null;
            try {
                const apiUrl = new URL('/api/me', window.location.origin);
                const response = await fetch(apiUrl, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    sessionStorage.removeItem('userInfo');
                    sessionStorage.removeItem('accessToken');
                    return null;
                }
                const fullUserProfile = await response.json();
                sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile));
                return fullUserProfile;
            } catch (error) {
                console.error('validateSessionAndGetUser error:', error);
                return null;
            }
        }

        function prefillEmailFromUser() {
            if (!currentAuthUser || !emailInput) return;
            const email = currentAuthUser.email || '';
            if (email) {
                emailInput.value = email;
            }
        }

        function renderAdminMessages() {
            if (!isAdminUser || !adminSection) return;
            adminList.innerHTML = '';
            if (!contactMessages.length) {
                adminEmpty.classList.remove('hidden');
                return;
            }
            adminEmpty.classList.add('hidden');

            contactMessages.forEach(message => {
                const wrapper = document.createElement('article');
                wrapper.className = 'rounded-xl border border-slate-200 bg-white px-4 py-4 shadow-sm';

                const header = document.createElement('div');
                header.className = 'flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between';

                const fromText = document.createElement('div');
                fromText.className = 'text-sm font-semibold text-slate-700';
                fromText.textContent = i18next.t('contactPage.adminMessageFrom', { email: message.email });
                header.appendChild(fromText);

                const created = new Date(message.createdAt);
                const submittedAt = isNaN(created.getTime()) ? message.createdAt : created.toLocaleString();
                const timeText = document.createElement('div');
                timeText.className = 'text-xs text-slate-500';
                timeText.textContent = i18next.t('contactPage.adminMessageAt', { time: submittedAt });
                header.appendChild(timeText);

                wrapper.appendChild(header);

                const displayName = message.userNickname || message.userId || '';
                if (displayName) {
                    const userLine = document.createElement('div');
                    userLine.className = 'mt-1 text-xs text-slate-500';
                    userLine.textContent = i18next.t('contactPage.adminMessageUser', { user: displayName });
                    wrapper.appendChild(userLine);
                }

                const messageParagraph = document.createElement('p');
                messageParagraph.className = 'mt-3 whitespace-pre-line text-sm text-slate-700';
                messageParagraph.textContent = message.message;
                wrapper.appendChild(messageParagraph);

                adminList.appendChild(wrapper);
            });
        }

        async function fetchAdminMessages() {
            const token = sessionStorage.getItem('accessToken');
            if (!token) {
                adminError.classList.remove('hidden');
                adminErrorMessageKey = 'contactPage.adminNeedsLogin';
                adminError.textContent = i18next.t(adminErrorMessageKey);
                return;
            }
            adminError.classList.add('hidden');
            adminError.textContent = '';
            adminErrorMessageKey = null;
            try {
                refreshButton.disabled = true;
                refreshButton.classList.add('opacity-60');
                const response = await fetch('/api/contact-messages', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                contactMessages = Array.isArray(data.messages) ? data.messages : [];
                renderAdminMessages();
            } catch (error) {
                console.error('Failed to fetch contact messages:', error);
                adminError.classList.remove('hidden');
                adminErrorMessageKey = 'contactPage.adminLoadError';
                adminError.textContent = i18next.t(adminErrorMessageKey);
            } finally {
                refreshButton.disabled = false;
                refreshButton.classList.remove('opacity-60');
            }
        }

        async function submitContactForm(event) {
            event.preventDefault();
            const email = sanitizeInput(emailInput.value);
            const message = sanitizeInput(messageInput.value);

            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                updateStatus('error', 'contactPage.formInvalidEmail');
                return;
            }
            if (!message) {
                updateStatus('error', 'contactPage.formEmptyMessage');
                return;
            }

            submitButton.disabled = true;
            submitButton.classList.add('opacity-70');
            updateStatus(null, null);

            const token = sessionStorage.getItem('accessToken');
            const headers = { 'Content-Type': 'application/json' };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            try {
                updateStatus('info', 'contactPage.submitting', '提交中...');
                const response = await fetch('/api/contact-messages', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ email, message })
                });
                const responseText = await response.text();
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (error) {
                    if (response.ok) {
                        data = { success: true };
                    } else {
                        throw new Error(responseText || 'Invalid server response');
                    }
                }

                if (!response.ok) {
                    const errorMessage = data?.error || 'Unknown error';
                    throw new Error(errorMessage);
                }

                updateStatus('success', 'contactPage.submitSuccess');
                messageInput.value = '';
                if (!currentAuthUser?.email) {
                    emailInput.value = '';
                }
                if (isAdminUser) {
                    await fetchAdminMessages();
                }
            } catch (error) {
                console.error('Failed to submit contact message:', error);
                updateStatus('error', 'contactPage.submitError', error.message);
            } finally {
                submitButton.disabled = false;
                submitButton.classList.remove('opacity-70');
            }
        }

        async function initI18n() {
            return new Promise((resolve, reject) => {
                i18next
                    .use(i18nextHttpBackend)
                    .use(i18nextBrowserLanguageDetector)
                    .init({
                        fallbackLng: 'zh',
                        nonExplicitSupportedLngs: true,
                        load: 'languageOnly',
                        debug: false,
                        backend: { loadPath: '/locales/{{lng}}.json?v=1' },
                        detection: { order: ['localStorage', 'navigator'], caches: ['localStorage'] }
                    }, (err) => {
                        if (err) {
                            console.error('i18next init failed:', err);
                            return reject(err);
                        }
                        updateContent();
                        resolve();
                    });
            });
        }

        async function initializePage() {
            try {
                await initI18n();
                const storedUser = sessionStorage.getItem('userInfo');
                if (storedUser) {
                    try {
                        currentAuthUser = JSON.parse(storedUser);
                    } catch (error) {
                        console.warn('Failed to parse stored user info:', error);
                        currentAuthUser = null;
                    }
                }
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                if (code) {
                    currentAuthUser = await handleOidcCallback(code);
                } else if (!currentAuthUser) {
                    currentAuthUser = await validateSessionAndGetUser();
                }

                renderLoginStatus(currentAuthUser);
                renderAdminLinks();
                renderLanguageSwitcher();
                prefillEmailFromUser();

                isAdminUser = ['admin', 'super_admin'].includes(currentAuthUser?.db_role);
                if (isAdminUser) {
                    adminSection.classList.remove('hidden');
                    await fetchAdminMessages();
                } else {
                    adminSection.classList.add('hidden');
                }
            } catch (error) {
                console.error('Initialization error:', error);
                updateStatus('error', 'contactPage.submitError', error.message);
            }
        }

        document.addEventListener('navbar:loaded', () => {
            renderLoginStatus(currentAuthUser);
            renderAdminLinks();
            renderLanguageSwitcher();
        });

        if (contactForm) {
            contactForm.addEventListener('submit', submitContactForm);
        }
        if (refreshButton) {
            refreshButton.addEventListener('click', async (event) => {
                event.preventDefault();
                if (isAdminUser) {
                    await fetchAdminMessages();
                }
            });
        }

        initializePage();
    </script>
</body>
</html>
