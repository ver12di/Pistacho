<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="certifiedPage.title">Pistacho 认证评分</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/i18next/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-http-backend/i18nextHttpBackend.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector/i18nextBrowserLanguageDetector.min.js"></script>
    <script type="module" src="scripts/navbar.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                    },
                    aspectRatio: {
                        '1179/1572': '1179 / 1572',
                    },
                     fontSize: {
                        '2xs': ['0.625rem', { lineHeight: '0.8rem' }], // ~10px
                     }
                }
            }
        }
    </script>
    <style>
        /* ... (all styles remain the same) ... */
        .rating-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .line-clamp-2 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; }
        .line-clamp-1 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 1; }
        .admin-action-btn {
             padding: 0.25rem 0.75rem;
             font-size: 0.75rem;
             font-weight: 600;
             background-color: #D97706;
             color: white;
             border-radius: 0.375rem;
             transition: background-color 0.2s;
        }
        .admin-action-btn:hover {
             background-color: #B45309;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="px-4 sm:px-6 lg:px-8 pt-4">
        <div class="mx-auto max-w-7xl">
            <div data-include-nav data-active="certified" data-language="switcher"></div>
        </div>
    </div>
    <div class="max-w-4xl mx-auto p-4 md:p-8">

        <header class="mb-6">
            <h1 class="text-4xl font-extrabold text-gray-800" data-i18n="certifiedPage.title">Pistacho 认证评分</h1>
            <p class="mt-2 text-lg text-gray-600" data-i18n="certifiedPage.subtitle">由我们的超级管理员精选的优秀品鉴记录。</p>
        </header>

        <div id="loading-indicator" class="text-center p-10 text-gray-500">
            <p data-i18n="certifiedPage.loading">正在加载认证评分...</p>
        </div>

        <div id="certified-container" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6">
            </div>
         <footer class="mt-8 text-center">
            <a href="index.html" class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700" data-i18n="nav.community">&larr; 返回主页</a>
        </footer>
    </div>

    <script type="module">
        // --- i18n Functions ---
        async function initI18n() {
            await i18next
                .use(i18nextHttpBackend)
                .use(i18nextBrowserLanguageDetector)
                .init({
                    fallbackLng: 'zh',
                    debug: false,
                    ns: ['translation'],
                    defaultNS: 'translation',
                    backend: {
                        loadPath: '/locales/{{lng}}.json?v=1'
                    },
                    detection: {
                        order: ['localStorage', 'navigator'],
                        caches: ['localStorage']
                    }
                });
            updateContent();
        }

        function updateContent() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const value = i18next.t(key);
                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    el.placeholder = value;
                } else if (el.tagName === 'OPTION') {
                    el.textContent = value;
                } else {
                    el.innerHTML = value;
                }
            });
            document.title = i18next.t('certifiedPage.title');
        }

        function setupLanguageSwitcher() {
            const switcher = document.getElementById('language-switcher');
            if (!switcher) return;
            const currentLang = i18next.language.split('-')[0];
            switcher.value = ['zh', 'en', 'es'].includes(currentLang) ? currentLang : 'zh';

            switcher.addEventListener('change', async (e) => {
                const newLang = e.target.value;
                await i18next.changeLanguage(newLang);
                updateContent();
                // 重新渲染动态内容
                await fetchAndRenderCertified(); // 重载数据和UI
                renderLoginStatus(currentAuthUser);
            });
        }
        document.addEventListener('navbar:loaded', () => {
            setupLanguageSwitcher();
            renderLoginStatus(currentAuthUser);
        });
        // --- End i18n Functions ---
    
        // --- Global Variables ---
        let currentAuthUser = null;
        let accessToken = null;
        let allCertifiedRatings = [];
        let userRole = 'guest';

        const container = document.getElementById('certified-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const loginStatusContainer = document.getElementById('login-status-container');

        // **MODIFIED**: GRADING_SCALE uses nameKey
        const GRADING_SCALE = [
            { "grade": "P", "nameKey": "resultsPage.grade.P", "min_score": 95, "color": "gold" },
            { "grade": "I", "nameKey": "resultsPage.grade.I", "min_score": 90, "color": "indigo" },
            { "grade": "S", "nameKey": "resultsPage.grade.S", "min_score": 80, "color": "purple" },
            { "grade": "T", "nameKey": "resultsPage.grade.T", "min_score": 70, "color": "blue" },
            { "grade": "A", "nameKey": "resultsPage.grade.A", "min_score": 60, "color": "green" },
            { "grade": "C", "nameKey": "resultsPage.grade.C", "min_score": 50, "color": "gray" },
            { "grade": "H", "nameKey": "resultsPage.grade.H", "min_score": 30, "color": "orange" },
            { "grade": "O", "nameKey": "resultsPage.grade.O", "min_score": 0, "color": "red" }
        ];

        // --- Authentication Functions ---
        const AUTHING_APP_ID = '68f5b0b6875017c02b3bfdb3';
        const AUTHING_HOST = 'https://xfvu647mcdbk-demo.authing.cn';
        
        window.login = function() { /* ... (same) ... */ }
        window.logout = function() { /* ... (same) ... */ }
        
        function renderLoginStatus(user) {
            if (!loginStatusContainer) return;
            if (user) {
                const displayName = user.nickname || user.name || user.preferred_username || user.email || i18next.t('nav.login');
                loginStatusContainer.innerHTML = `<span class="text-sm font-medium text-gray-700 mr-2 hidden sm:inline">${displayName}</span><button onclick="logout()" class="px-3 py-1 text-xs font-medium rounded-full bg-red-500 text-white hover:bg-red-600">${i18next.t('nav.logout')}</button>`;
            } else {
                loginStatusContainer.innerHTML = `<button onclick="login()" class="px-3 py-1 text-xs font-medium rounded-full bg-green-500 text-white hover:bg-green-600">${i18next.t('nav.login')}</button>`;
            }
        }
        
        async function handleOidcCallback(code) { /* ... (same) ... */ }
        async function validateSessionAndGetUser() { /* ... (same) ... */ }


        // --- Core API Call with Improved Error Handling ---
        async function fetchAndRenderCertified() {
             loadingIndicator.textContent = i18next.t('certifiedPage.loading');
             loadingIndicator.style.display = 'block';
             container.innerHTML = '';
             const isAdmin = userRole === 'admin' || userRole === 'super_admin';

            try {
                const apiUrl = new URL('/api/ratings', window.location.origin);
                apiUrl.searchParams.set('certified', 'true');
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    // ... (error handling remains same) ...
                    throw new Error(errorText);
                }

                let ratings = await response.json();
                allCertifiedRatings = ratings;

                if (ratings.length === 0) {
                    loadingIndicator.innerHTML = `<div class="col-span-full text-center p-6 bg-white rounded-lg shadow"><p>${i18next.t('certifiedPage.noRatings')}</p></div>`;
                    return;
                }

                ratings.forEach(data => {
                    const card = createCardHTML(data, isAdmin);
                    container.appendChild(card);
                });

                loadingIndicator.style.display = 'none';

            } catch (error) {
                console.error("获取认证评分失败:", error);
                loadingIndicator.innerHTML = `<div class="col-span-full text-center p-6 bg-red-100 text-red-700 rounded-lg shadow"><p>${i18next.t('certifiedPage.loadFailed', { msg: error.message })}</p></div>`;
            }
        }

        /**
         * Creates card HTML similar to index.html
         */
        function createCardHTML(rating, isAdmin) {
             const div = document.createElement('div');
             div.className = 'rating-card bg-white rounded-lg shadow-md overflow-hidden transition-all duration-300 cursor-pointer flex flex-col';
             div.id = `rating-card-${rating.id}`;
             div.onclick = () => viewRatingDetails(rating.id);

             const score = rating.normalizedScore !== undefined ? rating.normalizedScore.toFixed(2) : 'N/A';
             const author = rating.userNickname || rating.userEmail || i18next.t('common.anonymous');
             let coverImageUrl = null;
             if (Array.isArray(rating.imageUrl) && rating.imageUrl.length > 0) { coverImageUrl = rating.imageUrl[0]; }
             else if (typeof rating.imageUrl === 'string' && rating.imageUrl) { coverImageUrl = rating.imageUrl; }
             const cacheBuster = `?v=${new Date().getTime()}`;

             div.innerHTML = `
                 <div class="aspect-[1179/1572] w-full overflow-hidden flex-shrink-0 relative">
                      <img src="/Certifiedstamp.png${cacheBuster}" alt="Certified" class="absolute top-1 left-1 w-12 h-12 md:w-16 md:h-16 z-10" title="Pistacho 认证评分" onerror="this.style.display='none'">
                     ${coverImageUrl
                         ? `<img src="/api/image/${coverImageUrl}" alt="${rating.cigarInfo?.name || '雪茄图片'}" class="w-full h-full object-cover">`
                         : `<div class="w-full h-full bg-gray-200 flex items-center justify-center text-gray-400 text-sm">${i18next.t('certifiedPage.noImage')}</div>`
                     }
                 </div>
                 <div class="p-1.5 flex-grow flex flex-col justify-between">
                     <div>
                          <h3 class="font-semibold text-xs leading-tight line-clamp-1 mb-0.5" title="${rating.title || ''}"> ${rating.title || i18next.t('certifiedPage.noTitle')} </h3>
                          <p class="text-2xs text-gray-600 line-clamp-1 mb-0.5" title="${rating.cigarInfo?.name || ''}"> ${rating.cigarInfo?.name || i18next.t('certifiedPage.unnamedCigar')} </p>
                     </div>
                     <div class="flex justify-between items-end mt-auto pt-0.5">
                          <span class="text-2xs text-gray-500 line-clamp-1 flex items-center" title="${author}"> ${author} </span>
                          <div class="text-right flex-shrink-0"> <p class="font-bold text-indigo-600 text-sm leading-none">${score}</p> </div>
                     </div>
                      ${isAdmin && accessToken ? `
                      <div class="border-t pt-1.5 mt-1.5 flex justify-end">
                          <button onclick="window.updateCertification('${rating.id}', false, event)" class="admin-action-btn"> ${i18next.t('certifiedPage.uncertify')} </button>
                      </div>
                      ` : ''}
                 </div>
             `;
             return div;
        }


        // --- Button Click Events ---
        window.viewRatingDetails = function(ratingId) {
            const ratingData = allCertifiedRatings.find(r => r.id === ratingId);
            if (!ratingData) {
                alert(i18next.t('certifiedPage.loadDetailFailed'));
                return;
            }
            let detailedData = {};
            const cigarInfo = ratingData.cigarInfo || { name: ratingData.cigarName, size: ratingData.cigarSize, origin: ratingData.cigarOrigin };
            
            // **MODIFIED**: Reconstruct grade using i18n
            const foundGrade = GRADING_SCALE.find(g => ratingData.normalizedScore >= g.min_score) || GRADING_SCALE[GRADING_SCALE.length - 1];
            const finalGrade = foundGrade ? {
                grade: foundGrade.grade,
                nameKey: foundGrade.nameKey, // Pass the key
                color: foundGrade.color
            } : null;

            // ... (rest of the image/flavor logic remains same) ...
            let imageUrls = ratingData.imageUrl;
            if (typeof imageUrls === 'string') { try { imageUrls = JSON.parse(imageUrls); if (!Array.isArray(imageUrls)) imageUrls = [ratingData.imageUrl]; } catch(e){ imageUrls = imageUrls ? [imageUrls] : []; } }
            else if (!Array.isArray(imageUrls)) { imageUrls = imageUrls ? [imageUrls] : []; }
            const selectedFlavors = Array.isArray(ratingData.fullData?.selectedFlavors) ? ratingData.fullData.selectedFlavors : [];
            
            if (!ratingData || ratingData.normalizedScore === undefined || !finalGrade || !cigarInfo) {
                 alert(i18next.t('resultsPage.loadErrorMissing'));
                 return;
            }
            
            detailedData.ratingId = ratingData.id;
            const hasCompleteFullData = ratingData.fullData && ratingData.fullData.config && ratingData.fullData.ratings && ratingData.fullData.calculatedScore !== undefined;
            
            if (hasCompleteFullData) {
                 detailedData = {
                     ...detailedData,
                     config: ratingData.fullData.config,
                     ratings: ratingData.fullData.ratings,
                     calculatedScore: ratingData.fullData.calculatedScore,
                     title: ratingData.title || i18next.t('certifiedPage.noTitle'),
                     cigarInfo: cigarInfo,
                     cigarReview: ratingData.cigarReview || '无',
                     imageUrls: imageUrls,
                     normalizedScore: ratingData.normalizedScore,
                     finalGrade: finalGrade, // Pass grade object with nameKey
                     selectedFlavors: selectedFlavors,
                     timestamp: ratingData.timestamp,
                     userNickname: ratingData.userNickname,
                     userEmail: ratingData.userEmail,
                     isDraft: false
                 };
            } else {
                 detailedData = {
                     ...detailedData,
                     title: ratingData.title || i18next.t('certifiedPage.noTitle'),
                     cigarInfo: cigarInfo,
                     cigarReview: ratingData.cigarReview || '无',
                     imageUrls: imageUrls,
                     normalizedScore: ratingData.normalizedScore,
                     finalGrade: finalGrade, // Pass grade object with nameKey
                     selectedFlavors: selectedFlavors,
                     timestamp: ratingData.timestamp,
                     userNickname: ratingData.userNickname,
                     userEmail: ratingData.userEmail,
                     isDraft: false
                 };
            }
            try {
                 sessionStorage.setItem('cigarRatingResults', JSON.stringify(detailedData));
                 window.location.href = 'results.html';
            }
            catch (e) {
                console.error("Error setting sessionStorage:", e);
                alert(i18next.t('certifiedPage.sessionStoreFailed'));
            }
        }

        /**
         * Uncertify Action
         */
        window.updateCertification = async function(ratingId, certify, event) {
             event.stopPropagation();
             if (!accessToken) {
                return alert(i18next.t('common.loginRequired'));
             }
             const button = event.target.closest('button');
             const originalText = button.textContent;
             button.textContent = i18next.t('common.loading');
             button.disabled = true;
             try {
                const response = await fetch('/api/certify', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` }, body: JSON.stringify({ ratingId, certify }) });
                if (!response.ok) { const err = await response.json(); throw new Error(err.error || 'Operation failed'); }
                
                const cardToRemove = document.getElementById(`rating-card-${ratingId}`);
                if (cardToRemove) {
                    cardToRemove.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                    cardToRemove.style.opacity = '0';
                    cardToRemove.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        cardToRemove.remove();
                        allCertifiedRatings = allCertifiedRatings.filter(r => r.id !== ratingId);
                        if (allCertifiedRatings.length === 0) {
                            loadingIndicator.innerHTML = `<div class="col-span-full text-center p-6 bg-white rounded-lg shadow"><p>${i18next.t('certifiedPage.noRatings')}</p></div>`;
                            loadingIndicator.style.display = 'block';
                        }
                    }, 500);
                }
             } catch (error) {
                alert(i18next.t('common.opFailed', { msg: error.message }));
                button.textContent = originalText;
                button.disabled = false;
             }
        }

        // --- Initialization ---
        window.onload = async function() {
             await initI18n(); // Wait for i18n
             
             const urlParams = new URLSearchParams(window.location.search);
             const code = urlParams.get('code');
             let user = null;
             if (code) { user = await handleOidcCallback(code); } else { user = await validateSessionAndGetUser(); }
             currentAuthUser = user;
             accessToken = sessionStorage.getItem('accessToken');
             userRole = currentAuthUser?.db_role ?? 'guest';
             
             renderLoginStatus(currentAuthUser); // Render login *after* i18n
             setupLanguageSwitcher(); // Setup switcher
             
             await fetchAndRenderCertified();
             
             if (code) { window.history.replaceState({}, document.title, window.location.pathname); }
        };
    </script>
</body>
</html>