<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pistacho 认证评分</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="max-w-4xl mx-auto p-4 md:p-8">
        <nav class="mb-4 flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
             <a href="index.html" class="text-xl font-bold text-indigo-600">Pistacho评分</a>
             <div class="space-x-4">
                 <a href="history.html" class="text-gray-600 hover:text-indigo-600">历史记录</a>
                 <a href="certified.html" class="text-indigo-600 font-bold underline">认证评分</a>
             </div>
        </nav>
        <header class="mb-6">
            <h1 class="text-4xl font-extrabold text-gray-800">Pistacho 认证评分</h1>
            <p class="mt-2 text-lg text-gray-600">由我们的超级管理员精选的优秀品鉴记录。</p>
        </header>
        <div id="certified-container">
            <!-- Certified ratings will be rendered here -->
        </div>
         <footer class="mt-8 text-center">
            <a href="index.html" class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">&larr; 返回主页</a>
        </footer>
    </div>
    
    <script type="module">
        let currentAuthUser = null;
        let accessToken = null;
        let historicalRatings = {}; 

        // --- API 调用封装 ---
        async function apiFetch(endpoint, options = {}) {
            const headers = { 'Content-Type': 'application/json', ...options.headers };
            if (accessToken) {
                 headers['Authorization'] = `Bearer ${accessToken}`;
            }
            const apiUrl = new URL(endpoint, window.location.origin);
            const response = await fetch(apiUrl, { ...options, headers });
            
            if (!response.ok) {
                let errorData = { error: `请求失败 (${response.status})` };
                try { errorData = await response.json(); } catch(e) {}
                let errorMessage = errorData.error || `请求失败 (${response.status})`;
                if (response.status === 401) errorMessage = '认证失败，请重新登录。';
                if (response.status === 403) errorMessage = '权限不足。';
                throw new Error(errorMessage);
            }
            return response.json();
        }
        
        // --- 认证功能 ---
        async function updateCertification(ratingId, certify, button) {
             const originalText = button.textContent;
             button.textContent = '处理中...';
             button.disabled = true;
             try {
                await apiFetch('/api/certify', {
                    method: 'POST',
                    body: JSON.stringify({ ratingId: ratingId, certify: certify })
                });
                // 成功后刷新列表
                fetchAndRenderCertified(); 
             } catch(e) {
                alert(`操作失败: ${e.message}`);
                button.textContent = originalText;
                button.disabled = false;
             }
        }
        
        window.uncertifyRating = function(ratingId, event) {
            event.stopPropagation();
             if (confirm("确定要取消此评分的 Pistacho 官方认证吗？")) {
                updateCertification(ratingId, false, event.target);
            }
        }

        // --- 评分管理 ---
        window.viewRatingDetails = function(ratingId) {
            const ratingData = historicalRatings[ratingId];
            if (ratingData) {
                const fullData = (typeof ratingData.fullData === 'string') 
                    ? JSON.parse(ratingData.fullData) 
                    : ratingData.fullData;
                sessionStorage.setItem('cigarRatingResults', JSON.stringify({ ...fullData, isDraft: false, ratingId: ratingId }));
                window.location.href = 'results.html';
            } else {
                alert("无法加载该评分的详细信息。");
            }
        }

        // --- 数据获取和渲染 ---
        async function fetchAndRenderCertified() {
            const container = document.getElementById('certified-container');
            container.innerHTML = `<div class="text-center p-6"><p>正在加载认证评分...</p></div>`;
            
            try {
                // 调用 API 获取 ?certified=true 的评分
                const results = await apiFetch('/api/ratings?certified=true');
                
                if (results.length === 0) {
                    container.innerHTML = `<div class="text-center p-6 bg-white rounded-lg shadow"><p>还没有任何认证评分。</p></div>`;
                    return;
                }

                // 确定用户角色
                const userRole = currentAuthUser?.db_role;
                const isAdmin = userRole === 'admin' || userRole === 'super_admin';

                let certifiedHtml = '<div class="space-y-4">';
                historicalRatings = {}; // 清空缓存
                
                results.forEach(data => {
                    const ratingId = data.id;
                    historicalRatings[ratingId] = data; // 缓存数据
                    
                    const fullData = (typeof data.fullData === 'string') 
                        ? JSON.parse(data.fullData) 
                        : data.fullData;

                    const date = data.timestamp ? new Date(data.timestamp).toLocaleDateString('zh-CN') : '未知日期';
                    const scoreDisplay = data.normalizedScore !== undefined ? data.normalizedScore.toFixed(2) : 'N/A';
                    const gradeDisplay = data.finalGrade_grade ? `${data.finalGrade_grade} - ${data.finalGrade_name_cn}` : '未评级';
                    const cigarInfo = fullData.cigarInfo || { name: data.cigarName, size: data.cigarSize, origin: data.cigarOrigin };

                    // 认证按钮（仅限管理员）
                    let uncertifyButtonHtml = '';
                    if (isAdmin) {
                        uncertifyButtonHtml = `<button onclick="uncertifyRating('${ratingId}', event)" class="w-full text-sm py-1 px-3 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition">取消认证</button>`;
                    }

                    certifiedHtml += `
                        <a href="#" onclick="viewRatingDetails('${ratingId}'); return false;" class="block bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-lg font-bold text-gray-800">${cigarInfo.name}</p>
                                    <p class="text-sm text-gray-500">${cigarInfo.size} | ${cigarInfo.origin}</p>
                                    <p class="text-xs text-gray-400 pt-1">用户: ${data.userNickname || data.userEmail || 'N/A'} | ${date}</p>
                                </div>
                                <div class="text-right flex-shrink-0 ml-4">
                                    <p class="text-2xl font-black text-indigo-600">${scoreDisplay}</p>
                                    <p class="font-bold text-gray-600">${gradeDisplay}</p>
                                </div>
                            </div>
                            ${uncertifyButtonHtml ? `<div class="mt-3 border-t pt-3">${uncertifyButtonHtml}</div>` : ''}
                        </a>
                    `;
                });
                certifiedHtml += '</div>';
                container.innerHTML = certifiedHtml;
            } catch (error) {
                console.error("获取认证评分失败:", error);
                container.innerHTML = `<div class="text-center p-6 bg-red-100 text-red-700 rounded-lg shadow"><p>加载认证评分失败: ${error.message}</p></div>`;
            }
        }
        
        window.onload = function() {
            const storedUser = sessionStorage.getItem('userInfo');
            accessToken = sessionStorage.getItem('accessToken');
            
            if (storedUser && accessToken) {
                currentAuthUser = JSON.parse(storedUser);
            } else {
                currentAuthUser = null;
            }
            
            fetchAndRenderCertified();
        }
    </script>
</body>
</html>
