<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雪茄品鉴 - 点评报告</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/11.0.5/swiper-bundle.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/11.0.5/swiper-bundle.min.js" defer></script>

    <script src="https://unpkg.com/i18next/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-http-backend/i18nextHttpBackend.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector/i18nextBrowserLanguageDetector.min.js"></script>

    <script>
        if (typeof tailwind !== 'undefined') { /* Tailwind config */ } else { console.warn('Tailwind object not found.'); }
    </script>
    <style>
        /* 您的所有 CSS 样式保持不变 */
        .tooltip { /* ... */ } .tooltip .tooltiptext { /* ... */ } .tooltip .tooltiptext::after { /* ... */ } .tooltip:hover .tooltiptext { /* ... */ }
        .swiper-container.main-swiper { width: 100%; position: relative; }
        .swiper-slide { height: auto; display: flex; flex-direction: column; }
        .swiper-slide img { display: block; width: 100%; height: auto; object-fit: contain; max-height: 80vh; }
        .swiper-slide.share-image-slide img { max-height: none; object-fit: contain; }
        .swiper-button-next, .swiper-button-prev { color: #fff; background-color: rgba(0,0,0,0.3); padding: 10px; border-radius: 50%; width: 40px; height: 40px; } .swiper-button-next::after, .swiper-button-prev::after { font-size: 1.2rem; }
        .swiper-pagination { position: absolute; bottom: 20px !important; left: 50%; transform: translateX(-50%); width: auto; z-index: 10; }
        .swiper-pagination-bullet { background-color: rgba(128, 128, 128, 0.7); opacity: 1; width: 8px; height: 8px; }
        .swiper-pagination-bullet-active { background: #FFFFFF; }
        .thumbnail-swiper .swiper-slide { width: 60px !important; height: 80px; opacity: 0.6; cursor: pointer; border: 2px solid transparent; transition: opacity 0.3s, border-color 0.3s; }
        .thumbnail-swiper .swiper-slide img { object-fit: cover; }
        .thumbnail-swiper .swiper-slide-thumb-active { opacity: 1; border-color: #4f46e5; } .thumbnail-swiper { margin-top: 0.5rem; padding: 5px 0; }
        #narrative-summary-container, #cigar-review-container, #selected-flavors-container { max-width: 100%; }
        .flavor-tag { display: inline-block; background-color: #e5e7eb; color: #374151; font-size: 0.75rem; font-weight: 600; margin-right: 0.5rem; margin-bottom: 0.5rem; padding: 0.125rem 0.625rem; border-radius: 9999px; }

        /* Share Card Styles */
        #share-card-container { position: absolute; left: -9999px; top: 0; width: 350px; background-color: white; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); overflow: hidden; border: 1px solid #e5e7eb; visibility: hidden; z-index: -1; }
        #share-card-image-wrapper { background-color: #e5e7eb; display: flex; align-items: center; justify-content: center; aspect-ratio: 1179 / 1572; }
        #share-card-image { width: 100%; height: 100%; object-fit: cover; }
        #share-card-content { padding: 0.25rem; position: relative; }
        #share-card-score-grade { display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 0.1rem; }
        #share-card-score { font-size: 2.75rem; font-weight: 900; line-height: 1; margin-bottom: 0.3rem; }
        #share-card-grade-badge { display: inline-block; padding: 0.1rem 0.4rem; border-radius: 9999px; font-size: 0.6rem; font-weight: 600; margin-bottom: 0.2rem; }
        .share-card-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 0; }
        #share-card-watermark { font-size: 0.55rem; color: #9ca3af; width: 65%; line-height: 1.1; margin: 0; }
        #share-card-qrcode { width: 32%; height: auto; background-color: white; padding: 0; border: 1px solid #eee; box-shadow: 0 0 2px rgba(0,0,0,0.1); }
        #share-card-qrcode img { display: block; width: 100%; height: 100%; }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">
    <div class="max-w-6xl mx-auto p-4 md:p-8 relative">
        <div id="error-container" class="hidden bg-red-100 p-6 rounded-lg shadow-lg text-red-700 font-medium"></div>
        <div id="loading-indicator" class="hidden text-center py-10 text-gray-500" data-i18n="common.loadingDetails">正在加载评分详情...</div>
        
        <div id="main-content" class="opacity-0">
            <nav class="mb-6 flex flex-wrap justify-between items-center bg-white p-3 rounded-lg shadow-sm gap-4">
                 <a href="index.html" class="text-xl font-bold text-indigo-600" data-i18n="nav.title">Pistacho评分</a>
                 <div class="flex items-center space-x-4 flex-grow justify-center md:justify-start md:flex-grow-0 order-3 md:order-2 w-full md:w-auto">
                     <a href="index.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.community">社区动态</a>
                     <a href="rate.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.rate">去评分</a>
                     <a href="history.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.myRatings">我的评分</a>
                     <a href="certified.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.certified">认证评分</a>
                 </div>
                 <div class="flex items-center order-2 md:order-3">
                    <select id="language-switcher" class="text-xs p-1 rounded border border-gray-300 mr-2" style="height: 30px; line-height: 1.5;">
                        <option value="zh">简体中文</option>
                        <option value="en">English</option>
                        <option value="es">Español</option>
                    </select>
                    <div id="login-status-container" class="flex items-center"></div>
                 </div>
            </nav>

            <div class="flex flex-col md:flex-row gap-6 md:gap-8 mb-8">
                <div class="w-full md:w-2/5 flex-shrink-0">
                     <div id="image-gallery-container" class="bg-white rounded-lg shadow-md overflow-hidden">
                         <div class="swiper-container main-swiper bg-gray-200 relative">
                              <div class="swiper-wrapper" id="main-swiper-wrapper">
                                  <div class="swiper-slide flex items-center justify-center text-gray-400 aspect-[1179/1572]" data-i18n="common.loading">加载中...</div>
                              </div>
                              <div class="swiper-pagination"></div>
                              <div class="swiper-button-next"></div>
                              <div class="swiper-button-prev"></div>
                         </div>
                         <div class="swiper-container thumbnail-swiper hidden"> <div class="swiper-wrapper" id="thumbnail-swiper-wrapper"> </div> </div>
                     </div>
                </div>
                 <div class="w-full md:flex-grow bg-white rounded-lg shadow-md p-6">
                     <p class="text-sm text-gray-500 mb-1">
                         <span data-i18n="resultsPage.reviewFrom">点评来自:</span> 
                         <span id="user-nickname" class="font-medium text-gray-700" data-i18n="common.loading">加载中...</span>
                     </p>
                     <h1 id="rating-title" class="text-3xl font-bold mb-3" data-i18n="common.loading">加载中...</h1>
                     <h2 id="cigar-name" class="text-xl font-semibold mb-1" data-i18n="common.loading">加载中...</h2>
                     <div class="mb-4 text-sm text-gray-600 flex space-x-4">
                         <span><span data-i18n="resultsPage.size">尺寸</span>: <strong id="cigar-size">...</strong></span>
                         <span><span data-i18n="resultsPage.origin">产地</span>: <strong id="cigar-origin">...</strong></span>
                     </div>
                     <div id="cigar-review-container" class="prose prose-sm max-w-none text-gray-700 border-t pt-4">
                         <p data-i18n="common.loading">加载中...</p>
                     </div>
                     <div id="selected-flavors-container" class="hidden pt-2">
                         <h4 class="text-sm font-semibold text-gray-600 mb-2" data-i18n="resultsPage.mainFlavors">主要风味:</h4>
                         <div id="flavors-display" class="flex flex-wrap"></div>
                     </div>
                 </div>
            </div>

            <section id="score-section" class="bg-white rounded-xl shadow-lg p-6 mb-8 flex flex-col md:flex-row gap-6 items-center">
                 </section>

             <div id="save-button-container" class="hidden mb-6">
                 <button id="save-rating-button" onclick="saveRating()" class="w-full py-3 px-6 bg-green-600 text-white font-bold text-lg rounded-lg shadow-md hover:bg-green-700 transition" data-i18n="resultsPage.saveAsMyRating">
                     保存为我的评分记录
                 </button>
             </div>

            <div class="space-y-4">
                 <details id="narrative-summary-details" class="group bg-white rounded-xl shadow-lg p-6 transition-all duration-300" open>
                     <summary class="flex justify-between items-center cursor-pointer font-bold text-lg text-gray-800">
                         <span>
                             <span data-i18n="resultsPage.narrativeSummary">综合评价</span>
                             <svg class="inline w-5 h-5 transform group-open:rotate-180 transition-transform ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                         </span>
                         <div class="tooltip">
                             <button id="copy-summary-button" onclick="copySummary(event)" class="ml-4 p-1.5 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition text-xs">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /> </svg>
                             </button>
                             <span id="copy-tooltip" class="tooltiptext" data-i18n="common.copy">复制</span>
                         </div>
                     </summary>
                     <div id="narrative-summary-container" class="mt-4 prose max-w-none"></div>
                 </details>
                 <details id="summary-details" class="group bg-white rounded-xl shadow-lg p-6">
                     <summary class="flex justify-between items-center cursor-pointer font-bold text-lg text-gray-800">
                         <span data-i18n="resultsPage.summaryDetails">评分详情汇总</span>
                         <svg class="w-5 h-5 transform group-open:rotate-180 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                     </summary>
                     <div id="summary-container" class="mt-4"></div>
                 </details>
            </div>

            <footer class="mt-8 flex flex-col sm:flex-row justify-center items-center gap-4">
                 <a href="rate.html" class="py-3 px-6 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition" data-i18n="resultsPage.backToRate">
                     &larr; 返回重新评分
                 </a>
            </footer>
        </div>

        <div id="share-card-container">
            <div id="share-card-image-wrapper">
                <img id="share-card-image" src="" alt="Cigar Cover Image" crossorigin="anonymous">
            </div>
            <div id="share-card-content">
                <div id="share-card-score-grade">
                    <span id="share-card-score">0.00</span>
                    <span id="share-card-grade-badge">? - ???</span>
                </div>
                <div class="share-card-footer">
                     <p id="share-card-watermark">
                         <span id="share-card-username">用户</span> 
                         </p>
                     <div id="share-card-qrcode"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Constants and Global Vars ---
        
        // **MODIFIED**: GRADING_SCALE uses nameKey for i18n
        const GRADING_SCALE = [
            { "grade": "P", "nameKey": "resultsPage.grade.P", "min_score": 95, "color": "gold" },
            { "grade": "I", "nameKey": "resultsPage.grade.I", "min_score": 90, "color": "indigo" },
            { "grade": "S", "nameKey": "resultsPage.grade.S", "min_score": 80, "color": "purple" },
            { "grade": "T", "nameKey": "resultsPage.grade.T", "min_score": 70, "color": "blue" },
            { "grade": "A", "nameKey": "resultsPage.grade.A", "min_score": 60, "color": "green" },
            { "grade": "C", "nameKey": "resultsPage.grade.C", "min_score": 50, "color": "gray" },
            { "grade": "H", "nameKey": "resultsPage.grade.H", "min_score": 30, "color": "orange" },
            { "grade": "O", "nameKey": "resultsPage.grade.O", "min_score": 0, "color": "red" }
        ];
        
        // **MODIFIED**: Global variables for refactored logic
        let currentAuthUser = null; 
        let resultsData = null; // **NEW**: Global resultsData
        let normalizedScore = 0; 
        let ratingId = null;
        const AUTHING_APP_ID = '68f5b0b6875017c02b3bfdb3'; 
        const AUTHING_HOST = 'https://xfvu647mcdbk-demo.authing.cn';
        let mainSwiper = null; 
        let thumbnailSwiper = null;

        // --- **NEW**: i18n Initialization Functions ---
        
        /**
         * Initializes i18next and loads the translation files.
         */
        async function initI18n() {
            await i18next
                .use(i18nextHttpBackend)
                .use(i18nextBrowserLanguageDetector)
                .init({
                    fallbackLng: 'zh',
                    debug: true, // Set to false in production
                    ns: ['translation'],
                    defaultNS: 'translation',
                    backend: {
                        loadPath: '/locales/{{lng}}.json' // Path to your JSON files
                    },
                    detection: {
                        order: ['localStorage', 'navigator'],
                        caches: ['localStorage']
                    }
                });
            
            // Set page title after loading translations
            document.title = i18next.t('resultsPage.pageTitle');
        }

        /**
         * Updates all static text elements with data-i18n attributes.
         */
        function updateContent() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const value = i18next.t(key);
                
                const isInput = el.tagName === 'INPUT' || el.tagName === 'TEXTAREA';
                const isPlaceholder = el.hasAttribute('placeholder');

                if (isInput && isPlaceholder) {
                    el.placeholder = value;
                } else if (el.tagName === 'OPTION') {
                    el.textContent = value;
                } else {
                    el.innerHTML = value;
                }
            });
        }

        /**
         * Sets up the language switcher dropdown.
         */
        function setupLanguageSwitcher() {
            const switcher = document.getElementById('language-switcher');
            if (!switcher) return;

            const currentLang = i18next.language.split('-')[0];
            if ([...switcher.options].some(opt => opt.value === currentLang)) {
                switcher.value = currentLang;
            } else {
                switcher.value = i18next.options.fallbackLng[0];
            }

            switcher.addEventListener('change', async (e) => {
                const newLang = e.target.value;
                await i18next.changeLanguage(newLang);
                
                // 1. Update static content
                updateContent();
                document.title = i18next.t('resultsPage.pageTitle');

                // 2. **NEW**: Re-render dynamic content
                renderLoginStatus(currentAuthUser); // Update login/logout button text
                renderPageContent(resultsData); // Re-render the entire page logic
            });
        }


        // --- Authentication ---
        window.login = function() { /* ... */ const redirectUri = window.location.origin; const authorizeUrl = new URL('/oidc/auth', AUTHING_HOST); authorizeUrl.search = new URLSearchParams({ client_id: AUTHING_APP_ID, redirect_uri: redirectUri, response_type: 'code', scope: 'openid profile email phone', state: Math.random().toString(36).substring(2) }).toString(); window.location.href = authorizeUrl.toString(); }
        window.logout = function() { /* ... */ const logoutUrl = new URL('/oidc/session/end', AUTHING_HOST); logoutUrl.search = new URLSearchParams({ post_logout_redirect_uri: window.location.origin }).toString(); sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken'); window.location.href = logoutUrl.toString(); }
        
        // **MODIFIED**: Uses i18next.t() for translations
        function renderLoginStatus(user) {
            const container = document.getElementById('login-status-container'); 
            if (!container) return; 
            if (user) { 
                const displayName = user.nickname || user.name || user.preferred_username || user.email || i18next.t('nav.loggedIn');
                container.innerHTML = `<span class="text-sm font-medium text-gray-700 mr-2 hidden sm:inline">${displayName}</span><button onclick="logout()" class="px-3 py-1 text-xs font-medium rounded-full bg-red-500 text-white hover:bg-red-600" data-i18n="nav.logout">${i18next.t('nav.logout')}</button>`; 
            } else { 
                container.innerHTML = `<button onclick="login()" class="px-3 py-1 text-xs font-medium rounded-full bg-green-500 text-white hover:bg-green-600" data-i18n="nav.login">${i18next.t('nav.login')}</button>`; 
            } 
        }

        async function handleOidcCallback(code) { 
            try { 
                const redirectUri = window.location.origin; 
                const apiUrl = new URL('/api/authing/callback', window.location.origin); 
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code: code, redirect_uri: redirectUri }) }); 
                if (!response.ok) { 
                    let errorText = i18next.t('errors.authCallbackFailed', { status: response.status });
                    try { const err = await response.json(); errorText = err.error || errorText; } catch(e){} 
                    throw new Error(errorText); 
                } 
                const fullUserProfile = await response.json(); 
                sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile)); 
                sessionStorage.setItem('accessToken', fullUserProfile.accessToken); 
                return fullUserProfile; 
            } catch (e) { 
                console.error('认证回调处理失败:', e); 
                alert(i18next.t('errors.loginFailed', { message: e.message }));
                sessionStorage.removeItem('userInfo'); 
                sessionStorage.removeItem('accessToken'); 
                return null; 
            } finally { 
                window.history.replaceState({}, document.title, window.location.pathname + window.location.search.replace(/&?code=[^&]*/, '').replace(/&?state=[^&]*/, '')); 
            } 
        }
        async function validateSessionAndGetUser() { /* ... (no text changes needed) ... */ const token = sessionStorage.getItem('accessToken'); if (!token) return null; try { const apiUrl = new URL('/api/me', window.location.origin); const response = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${token}` } }); if (!response.ok) { sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken'); return null; } const fullUserProfile = await response.json(); sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile)); return fullUserProfile; } catch (e) { console.error("Session validation failed:", e); return null; } }


        // --- Save Rating (Drafts only) ---
        window.saveRating = async function() { /* Placeholder */ };

        // --- Copy Summary Function ---
        window.copySummary = function(event) { /* Placeholder */ };

        // --- Initialize Swiper ---
        function initSwipers(imageUrls = []) {
             const mainWrapper = document.getElementById('main-swiper-wrapper'); const thumbWrapper = document.getElementById('thumbnail-swiper-wrapper'); const thumbContainer = document.querySelector('.thumbnail-swiper');
             mainWrapper.innerHTML = ''; thumbWrapper.innerHTML = '';
             // **MODIFIED**: Use i18next.t() for "No image" text
             if (!imageUrls || imageUrls.length === 0) { 
                 mainWrapper.innerHTML = `<div class="swiper-slide flex items-center justify-center text-gray-400 aspect-[1179/1572]">${i18next.t('common.noImage')}</div>`; 
                 thumbContainer.classList.add('hidden'); 
                 if(mainSwiper) mainSwiper.destroy(true, true); 
                 if(thumbnailSwiper) thumbnailSwiper.destroy(true, true); 
                 mainSwiper = null; thumbnailSwiper = null; 
                 return; 
             }
             // ... (rest of the function is fine) ...
             imageUrls.forEach(key => {
                 const imageUrl = `/api/image/${key}`;
                 const imgElement = `<img src="${imageUrl}" alt="${i18next.t('common.cigarImageAlt')}" crossorigin="anonymous" onerror="this.src='https://placehold.co/600x800/gray/white?text=Loading+Failed'; this.onerror=null;">`;
                 mainWrapper.innerHTML += `<div class="swiper-slide">${imgElement}</div>`;
                 thumbWrapper.innerHTML += `<div class="swiper-slide thumbnail-slide">${imgElement}</div>`;
             });
             if(mainSwiper) mainSwiper.destroy(true, true); if(thumbnailSwiper) thumbnailSwiper.destroy(true, true);
             const slidesInMain = mainWrapper.querySelectorAll('.swiper-slide');
             const hasMultipleItems = slidesInMain.length > 1;
             if (hasMultipleItems) {
                 thumbContainer.classList.remove('hidden');
                 thumbnailSwiper = new Swiper('.thumbnail-swiper', { spaceBetween: 10, slidesPerView: 'auto', freeMode: true, watchSlidesProgress: true, });
                 mainSwiper = new Swiper('.main-swiper', {
                     spaceBetween: 10, autoHeight: true,
                     navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev', },
                     pagination: { el: '.main-swiper .swiper-pagination', clickable: true, },
                     thumbs: { swiper: thumbnailSwiper, },
                     simulateTouch: true, touchRatio: 1, touchAngle: 45, grabCursor: true,
                 });
             } else {
                 thumbContainer.classList.add('hidden');
                 mainSwiper = new Swiper('.main-swiper', {
                      autoHeight: true,
                      pagination: { el: '.main-swiper .swiper-pagination', clickable: true, },
                      allowTouchMove: false
                 });
             }
        }


        // --- Function to Auto-Generate Share Image ---
        async function autoGenerateShareImage() {
            // ... (no text changes needed in this function's logic) ...
            // ... (However, it relies on renderPageContent being called FIRST
            //      to populate the share card with translated text)
            // ...
            const shareCardElement = document.getElementById('share-card-container');
            const coverImageElement = document.getElementById('share-card-image');
            const mainSwiperWrapper = document.getElementById('main-swiper-wrapper');
            const thumbSwiperWrapper = document.getElementById('thumbnail-swiper-wrapper');

            if (!shareCardElement || !coverImageElement || !html2canvas || !resultsData || !mainSwiperWrapper || !ratingId) {
                console.warn("无法自动生成分享图：缺少必要组件或 ratingId。"); return;
            }
            const coverImageUrl = coverImageElement.src;
            if (!coverImageUrl || coverImageUrl.includes('placehold.co') || !coverImageElement.complete || coverImageElement.naturalWidth === 0) {
                 console.warn("封面图片未加载或无效，无法自动生成分享图。"); return;
            }
            console.log("开始自动生成分享图...");
            shareCardElement.style.visibility = 'visible';
            shareCardElement.style.left = '-9999px';
            shareCardElement.style.zIndex = '-1';
            try {
                await new Promise(resolve => setTimeout(resolve, 300));
                const canvas = await html2canvas(shareCardElement, {
                    useCORS: true, allowTaint: true, scale: 2
                });
                const dataUrl = canvas.toDataURL('image/png');
                const newSlide = document.createElement('div');
                newSlide.className = 'swiper-slide share-image-slide';
                const newImg = document.createElement('img');
                newImg.src = dataUrl;
                newImg.alt = i18next.t('resultsPage.shareImageAlt'); // **MODIFIED**
                newSlide.appendChild(newImg);
                mainSwiperWrapper.appendChild(newSlide);
                if (thumbnailSwiper && thumbSwiperWrapper) {
                     const newThumbSlide = document.createElement('div');
                     newThumbSlide.className = 'swiper-slide thumbnail-slide';
                     const newThumbImg = document.createElement('img');
                     newThumbImg.src = dataUrl;
                     newThumbImg.alt = i18next.t('resultsPage.shareImageThumbAlt'); // **MODIFIED**
                     newThumbSlide.onclick = () => { if(mainSwiper) mainSwiper.slideTo(mainSwiper.slides.length - 1); };
                     newThumbSlide.appendChild(newThumbImg);
                     thumbSwiperWrapper.appendChild(newThumbSlide);
                }
                 console.log("分享图已添加到 DOM。");
                 if (mainSwiper) mainSwiper.update();
                 if (thumbnailSwiper) thumbnailSwiper.update();
            } catch (error) {
                console.error("自动生成或添加分享图片失败:", error);
            } finally {
                 shareCardElement.style.left = '-9999px';
                 shareCardElement.style.visibility = 'hidden';
                 shareCardElement.style.zIndex = '-1';
            }
        }
        
        // --- **NEW**: Refactored Page Rendering Logic ---
        /**
         * Renders all dynamic content based on the global resultsData object.
         * This function is re-runnable for language changes.
         * @param {object} data The global resultsData object.
         */
        function renderPageContent(data) {
            if (!data) {
                console.warn("renderPageContent called with no data.");
                return;
            }
            
            console.log("Rendering page content with data:", data);

            // --- Validation and Data Extraction ---
            const title = data.title || i18next.t('common.noTitle');
            const { cigarInfo, cigarReview, normalizedScore: score, isDraft } = data;
            const selectedFlavors = Array.isArray(data.selectedFlavors) ? data.selectedFlavors : [];
            
            // **MODIFIED**: Re-calculate finalGrade WITH translation
            const foundGrade = GRADING_SCALE.find(g => score >= g.min_score) || GRADING_SCALE[GRADING_SCALE.length - 1];
            const finalGrade = foundGrade ? {
                grade: foundGrade.grade,
                // **NEW**: Get translated names
                name_cn: i18next.t(foundGrade.nameKey), 
                name_en: i18next.t(foundGrade.nameKey), // Use the same key
                color: foundGrade.color
            } : null;

            if (!finalGrade) {
                console.error("Could not determine finalGrade.");
                // This should not happen if GRADING_SCALE is correct
                return; 
            }

            const userNickname = data.userNickname || data.userEmail || i18next.t('common.anonymous');

            // --- Render Page Content ---
             document.getElementById('user-nickname').textContent = userNickname;
             document.getElementById('rating-title').textContent = title;
             document.getElementById('cigar-name').textContent = cigarInfo.name;
             document.getElementById('cigar-size').textContent = cigarInfo.size;
             document.getElementById('cigar-origin').textContent = cigarInfo.origin;
             const reviewContainer = document.getElementById('cigar-review-container');
             if (cigarReview && cigarReview !== '无') { // Keep '无' check for old data
                 reviewContainer.innerHTML = `<p>${cigarReview}</p>`; 
             } else { 
                 reviewContainer.innerHTML = `<p class="text-gray-400 italic">${i18next.t('common.noReview')}</p>`; 
             }
             
             const flavorsContainer = document.getElementById('selected-flavors-container'); 
             const flavorsDisplay = document.getElementById('flavors-display'); 
             if (selectedFlavors.length > 0) { 
                 flavorsDisplay.innerHTML = selectedFlavors.map(f => `<span class="flavor-tag">${f}</span>`).join(''); 
                 flavorsContainer.classList.remove('hidden'); 
             } else { 
                 flavorsContainer.classList.add('hidden'); 
             }

            // --- Render Dynamic Sections ---
            renderScoreSection(document.getElementById('score-section'), score, finalGrade);
            
            const saveButtonContainer = document.getElementById('save-button-container'); 
            if (currentAuthUser && isDraft) { 
                saveButtonContainer?.classList.remove('hidden'); 
            } else {
                saveButtonContainer?.classList.add('hidden');
            }

            const narrativeDetails = document.getElementById('narrative-summary-details'); 
            const summaryDetails = document.getElementById('summary-details'); 
            const hasFullData = data.config && data.ratings && data.calculatedScore !== undefined; 
            
            if (hasFullData) { 
                const { config, ratings } = data; 
                const narrativeSummary = generateNarrativeSummary(cigarInfo, config, ratings, finalGrade, selectedFlavors); 
                document.getElementById('narrative-summary-container').innerHTML = narrativeSummary; 
                narrativeDetails.classList.remove('hidden'); 
                renderSummary(document.getElementById('summary-container'), config, ratings); 
                summaryDetails.classList.remove('hidden'); 
            } else { 
                narrativeDetails.classList.add('hidden'); 
                summaryDetails.classList.add('hidden'); 
                // (Limited data message logic removed for simplicity, assuming it's not needed now)
            }


            // --- Populate Hidden Share Card (with translations) ---
            const shareCardImage = document.getElementById('share-card-image');
            const shareCardScore = document.getElementById('share-card-score');
            const shareCardGradeBadge = document.getElementById('share-card-grade-badge');
            const shareCardUsername = document.getElementById('share-card-username');
            const shareCardWatermark = document.getElementById('share-card-watermark');
            const gradeStyles = getGradeStyles(finalGrade.color);

            if (shareCardScore) shareCardScore.className = `text-5xl font-black ${gradeStyles.textColor}`;
            if (shareCardGradeBadge) shareCardGradeBadge.className = `inline-block px-2 py-0.5 rounded-full text-xs font-semibold ${gradeStyles.bgColor} ${gradeStyles.textColor} bg-opacity-20`;
            if (shareCardScore) shareCardScore.textContent = score.toFixed(2);
            
            // **MODIFIED**: Use translated grade
            if (shareCardGradeBadge) { 
                shareCardGradeBadge.textContent = `${finalGrade.name_en}`; // 'name_en' now holds the translated text
            } 
            if (shareCardUsername) { 
                shareCardUsername.textContent = userNickname; 
            }
            // **MODIFIED**: Use i18n.t() for watermark
            if (shareCardWatermark) {
                shareCardWatermark.innerHTML = i18next.t('resultsPage.shareWatermark', { 
                    user: `<span id="share-card-username">${userNickname}</span>`,
                    url: "www.pista-cho.com"
                });
            }
            
            // (QR Code logic remains the same)
            const shareCardQrCode = document.getElementById('share-card-qrcode');
            if (shareCardQrCode && typeof QRCode !== 'undefined') {
                shareCardQrCode.innerHTML = '';
                const uniqueUrl = ratingId ? `${window.location.origin}/results.html?ratingId=${ratingId}` : window.location.href;
                new QRCode(shareCardQrCode, { text: uniqueUrl, width: 90, height: 90, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H });
            } else { console.error("QR Code container or library not found, or ratingId missing."); }

            // (Share card image logic remains the same)
            const images = data.imageUrls || [];
            if (images.length > 0 && shareCardImage && !shareCardImage.src.includes(images[0])) { // Check if src needs updating
                 shareCardImage.src = `/api/image/${images[0]}`;
                 // Note: onload/onerror should be set *before* src, but for re-renders this is tricky.
                 // We assume autoGenerateShareImage() is only called once in onload.
            } else if (images.length === 0) {
                 document.getElementById('share-card-image-wrapper').innerHTML = `<span class="text-gray-400 text-sm">${i18next.t('common.noCoverImage')}</span>`;
            }
        }


        // --- Page Load Logic ---
        // **MODIFIED**: Refactored to fetch data, then call renderPageContent
        window.onload = async function() {
            // **NEW**: 1. Initialize i18n
            await initI18n();
            
            // 2. Update all static text
            updateContent();

            const errorContainer = document.getElementById('error-container');
            const mainContent = document.getElementById('main-content');
            const loadingIndicator = document.getElementById('loading-indicator');

            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const ratingIdFromUrl = urlParams.get('ratingId');
            let user = null;

            // 3. Handle Auth
            if (code) { user = await handleOidcCallback(code); }
            else { user = await validateSessionAndGetUser(); }
            currentAuthUser = user;
            renderLoginStatus(currentAuthUser); // Render login status with translations

            loadingIndicator.classList.remove('hidden');
            mainContent.classList.add('opacity-0');
            mainContent.style.display = 'none';
            errorContainer.classList.add('hidden');

            try {
                // 4. Fetch/Load Data
                if (ratingIdFromUrl) {
                    console.log(`Loading data via ratingId from URL: ${ratingIdFromUrl}`);
                    ratingId = ratingIdFromUrl; // Set global ratingId
                    const token = sessionStorage.getItem('accessToken');
                    const apiUrl = new URL(`/api/ratings?id=${ratingId}`, window.location.origin);
                    const fetchOptions = token ? { headers: { 'Authorization': `Bearer ${token}` } } : {};
                    const response = await fetch(apiUrl, fetchOptions);
                    if (!response.ok) { 
                        let errorText = i18next.t('errors.loadRatingFailed', { status: response.status });
                        try { const err = await response.json(); errorText = err.error || errorText; } catch(e){} 
                        throw new Error(errorText); 
                    }
                    resultsData = await response.json(); // **Assign to global variable**
                    if (!resultsData) throw new Error(i18next.t('errors.ratingNotFound'));
                    sessionStorage.removeItem('cigarRatingResults');

                } else {
                    console.log("Loading data from sessionStorage.");
                    const storedData = sessionStorage.getItem('cigarRatingResults');
                    if (!storedData) throw new Error(i18next.t('errors.noRatingDataFound'));
                    resultsData = JSON.parse(storedData); // **Assign to global variable**
                    ratingId = resultsData.ratingId; // Set global ratingId
                }

                console.log("Final resultsData loaded:", resultsData);

                // --- Validation ---
                if (!resultsData || resultsData.normalizedScore === undefined || !resultsData.cigarInfo) { 
                    throw new Error(i18next.t('errors.missingEssentialData'));
                }
                
                // --- 5. Initial Swiper Setup (Only run once) ---
                let images = [];
                const imageUrlsData = resultsData.imageUrls || resultsData.imageUrl || [];
                if(Array.isArray(imageUrlsData)) { images = imageUrlsData; }
                else if (typeof imageUrlsData === 'string' && imageUrlsData) { try { images = JSON.parse(imageUrlsData); if (!Array.isArray(images)) images = [imageUrlsData]; } catch(e){ images = [imageUrlsData]; } }
                
                initSwipers(images);

                // --- 6. Initial Page Render ---
                renderPageContent(resultsData); // **Call the new render function**

                // --- 7. Setup Share Image (Only run once) ---
                if (images.length > 0) {
                     document.getElementById('share-card-image').onload = () => { autoGenerateShareImage(); };
                     document.getElementById('share-card-image').onerror = () => { console.error("Share card cover image failed to load."); };
                     // Src is set inside renderPageContent, but we set it here again just in case
                     document.getElementById('share-card-image').src = `/api/image/${images[0]}`;
                } else {
                     document.getElementById('share-card-image-wrapper').innerHTML = `<span class="text-gray-400 text-sm">${i18next.t('common.noCoverImage')}</span>`;
                     console.warn("No cover image, cannot generate share image.");
                }

                // --- 8. Show Content ---
                loadingIndicator.classList.add('hidden');
                mainContent.style.display = 'block';
                await new Promise(resolve => setTimeout(resolve, 50));
                mainContent.classList.remove('opacity-0');
                mainContent.classList.add('animate-fadeInUp');

                // --- 9. **NEW**: Setup Language Switcher ---
                setupLanguageSwitcher();

            } catch (e) {
                loadingIndicator.classList.add('hidden');
                // **MODIFIED**: Use i18n for error message
                const errorTitle = i18next.t('errors.pageLoadError');
                const backLink = i18next.t('common.backToCommunity');
                const rateLink = i18next.t('common.goToRate');
                errorContainer.innerHTML = `<p class="font-bold text-center">${errorTitle} <a href="index.html" class="text-indigo-600 underline">${backLink}</a> ${i18next.t('common.or')} <a href="rate.html" class="text-indigo-600 underline">${rateLink}</a></p><p class="text-sm text-gray-600">${e.message}</p>`;
                errorContainer.classList.remove('hidden');
                console.error("Results page error:", e);
            }
        };

        // --- Rendering Utilities ---
        
        // **MODIFIED**: Uses i18next.t() for translations
        function generateNarrativeSummary(cigarInfo, config, ratings, finalGrade, selectedFlavors) {
            if (!config || !ratings) { 
                return `<p class="text-gray-500 italic">${i18next.t('errors.noNarrativeData')}</p>`; 
            }
            
            const origin = cigarInfo?.origin || i18next.t('common.unknown');
            const name = cigarInfo?.name || i18next.t('common.unknown');
            const size = cigarInfo?.size || i18next.t('common.unknown');
            
            let summary = `<p class="text-base text-gray-700 leading-relaxed">`;
            summary += i18next.t('narrative.intro', { origin, name, size });

            let observations = [];
            (config?.ratingCriteria || []).forEach(category => {
                const categoryName = i18next.t(category.categoryKey); // **Translate categoryKey**
                (category.criteriaList || []).forEach(criterion => {
                    const id = getRatingId(category.categoryKey, criterion.nameKey); // **Use keys for ID**
                    const selectedOptionIndex = ratings[id];
                    if (selectedOptionIndex !== undefined && criterion.options?.[selectedOptionIndex]) {
                        const option = criterion.options[selectedOptionIndex];
                        const criterionText = i18next.t(criterion.nameKey); // **Translate nameKey**
                        const optionText = i18next.t(option.descriptionKey); // **Translate descriptionKey**
                        observations.push(i18next.t('narrative.observation', { criterion: criterionText, option: optionText }));
                    }
                });
            });

            if (observations.length > 0) { 
                summary += ` ${i18next.t('narrative.observationsPrefix')} ${observations.join('；')}。`; 
            } else { 
                summary += ` ${i18next.t('narrative.noObservations')}`; 
            }
            
            if (selectedFlavors && selectedFlavors.length > 0) { 
                summary += ` ${i18next.t('narrative.flavorsPrefix')} <strong class="font-semibold">${selectedFlavors.join(', ')}</strong>。`; 
            }
            
            const gradeHierarchy = GRADING_SCALE.map(g => g.grade).join('-'); // Just the letters
            // 'finalGrade.name_en' now holds the fully translated grade name
            summary += ` ${i18next.t('narrative.conclusion', { grade: `${finalGrade.grade} - ${finalGrade.name_en}`, hierarchy: gradeHierarchy })}`;
            summary += `</p>`;
            return summary;
        }

        // **MODIFIED**: Use keys for ID
        function getRatingId(categoryKey, criterionKey) {
            const catStr = String(categoryKey || '').trim();
            const critStr = String(criterionKey || '').trim();
            return `${catStr}-${critStr}`;
        }

        // **MODIFIED**: Uses i18next.t() for translations
        function renderSummary(container, config, ratings) {
            if (!container) return; 
            if (!config || !ratings) { 
                container.innerHTML = `<p class="text-gray-500 italic">${i18next.t('errors.noSummaryData')}</p>`; 
                return; 
            } 
            
            let summaryHtml = '';
            (config?.ratingCriteria || []).forEach((category) => {
                const categoryName = i18next.t(category.categoryKey); // **Translate categoryKey**
                summaryHtml += `<div class="mb-4"><h4 class="text-md font-semibold text-gray-600 mb-2 border-b pb-1">${categoryName}</h4><ul class="list-none space-y-1 text-sm">`;
                let hasCriteria = false;
                (category.criteriaList || []).forEach((criterion) => {
                    const id = getRatingId(category.categoryKey, criterion.nameKey); // **Use keys for ID**
                    const selectedOptionIndex = ratings[id];
                    if (selectedOptionIndex !== undefined && criterion.options?.[selectedOptionIndex]) {
                        const option = criterion.options[selectedOptionIndex];
                        const criterionText = i18next.t(criterion.nameKey); // **Translate nameKey**
                        const optionText = i18next.t(option.descriptionKey); // **Translate descriptionKey**
                        
                        summaryHtml += `<li class="flex justify-between items-center p-1"><div><span class="font-medium text-gray-700">${criterionText}:</span><span class="text-gray-500 ml-2">${optionText}</span></div></li>`;
                        hasCriteria = true;
                    }
                });
                if (!hasCriteria) { 
                    summaryHtml += `<li class="text-gray-400 italic text-xs">${i18next.t('common.noItems')}</li>`; 
                }
                summaryHtml += `</ul></div>`;
            });
            container.innerHTML = summaryHtml || `<p class="text-gray-500 italic">${i18next.t('common.noDetails')}</p>`;
        }
        
        function getScoreRange(gradeCode) { /* ... (no text changes needed) ... */ const index = GRADING_SCALE.findIndex(g => g.grade === gradeCode); if (index === -1) return ''; const min = GRADING_SCALE[index].min_score; if (index === 0) return `${min}-100`; const gradeAbove = GRADING_SCALE[index - 1]; if (!gradeAbove) return `< ${min}`; const max = gradeAbove.min_score - 0.01; if (gradeCode === 'O') return `0-${max.toFixed(2)}`; return `${min.toFixed(0)}-${max.toFixed(2)}`; }
        function getGradeStyles(color) { /* ... (no text changes needed) ... */ const stylesMap = { 'gold': { bgColor: 'bg-yellow-400', textColor: 'text-yellow-800', bgGradient: 'bg-gradient-to-br from-yellow-400 to-amber-500', shadowColor: 'shadow-yellow-500/50' }, 'indigo': { bgColor: 'bg-indigo-300', textColor: 'text-indigo-800', bgGradient: 'bg-gradient-to-br from-indigo-500 to-purple-600', shadowColor: 'shadow-indigo-500/50' }, 'purple': { bgColor: 'bg-purple-300', textColor: 'text-purple-800', bgGradient: 'bg-gradient-to-br from-purple-500 to-violet-600', shadowColor: 'shadow-purple-500/50' }, 'blue': { bgColor: 'bg-blue-300', textColor: 'text-blue-800', bgGradient: 'bg-gradient-to-br from-blue-500 to-cyan-600', shadowColor: 'shadow-blue-500/50' }, 'green': { bgColor: 'bg-green-300', textColor: 'text-green-800', bgGradient: 'bg-gradient-to-br from-green-500 to-lime-600', shadowColor: 'shadow-green-500/50' }, 'gray': { bgColor: 'bg-gray-300', textColor: 'text-gray-800', bgGradient: 'bg-gradient-to-br from-gray-500 to-slate-600', shadowColor: 'shadow-gray-500/50' }, 'orange': { bgColor: 'bg-orange-300', textColor: 'text-orange-800', bgGradient: 'bg-gradient-to-br from-orange-500 to-amber-600', shadowColor: 'shadow-orange-500/50' }, 'red': { bgColor: 'bg-red-300', textColor: 'text-red-800', bgGradient: 'bg-gradient-to-br from-red-500 to-rose-600', shadowColor: 'shadow-red-500/50' } }; return stylesMap[color] || stylesMap['gray']; }
         
         // **MODIFIED**: Uses i18next.t() for translations
         function renderScoreSection(container, score, grade) {
             if (!container || !grade) return; 
             const styles = getGradeStyles(grade.color);
             const scoreHtml = `
                 <div class="text-center md:text-left">
                     <p class="text-xl font-bold text-yellow-500 mb-1">${i18next.t('resultsPage.pistachoScore')}</p>
                     <p class="text-7xl font-black ${styles.textColor}">${score.toFixed(2)}</p>
                     <div class="mt-2 text-3xl lg:text-4xl font-black ${styles.textColor} leading-tight">
                         ${grade.name_en}
                     </div>
                 </div>
             `;
             
             let scaleHtml = '<div class="space-y-1 text-sm">';
             GRADING_SCALE.forEach(g => {
                 const gStyles = getGradeStyles(g.color);
                 const isCurrent = g.grade === grade.grade;
                 // **MODIFIED**: Use i18n.t(g.nameKey)
                 const gradeName = i18next.t(g.nameKey);
                 scaleHtml += `
                     <div class="flex items-center p-1 rounded ${isCurrent ? 'bg-gray-100' : ''}">
                         <div class="w-5 h-5 flex-shrink-0 rounded-full flex items-center justify-center font-bold text-xs ${gStyles.bgColor} ${gStyles.textColor} mr-2">${g.grade}</div>
                         <div class="flex-grow ${isCurrent ? 'font-semibold' : ''} ${gStyles.textColor}">${gradeName}</div>
                         <div class="font-mono text-xs text-gray-500 ml-2">${getScoreRange(g.grade)}</div>
                     </div>
                 `;
             });
             scaleHtml += '</div>';
             
             container.innerHTML = `
                 <div id="score-display" class="w-full md:w-1/3 flex-shrink-0">
                     ${scoreHtml}
                 </div>
                 <div id="grading-scale-explanation" class="w-full md:w-2/3 flex-grow border-t md:border-t-0 md:border-l border-gray-200 pt-4 md:pt-0 md:pl-6">
                     ${scaleHtml}
                 </div>
             `;
         }

    </script>
</body>
</html>