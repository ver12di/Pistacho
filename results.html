<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雪茄品鉴 - 点评报告</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/11.0.5/swiper-bundle.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/11.0.5/swiper-bundle.min.js" defer></script>

    <script src="https://unpkg.com/i18next/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-http-backend/i18nextHttpBackend.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector/i18nextBrowserLanguageDetector.min.js"></script>

    <script>
        // Tailwind config
        if (typeof tailwind !== 'undefined') { 
             tailwind.config = {
                 theme: { extend: { fontFamily: { sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'], }, } }
             }
         } else { console.warn('Tailwind object not found.'); }
    </script>
    <style>
        /* CSS styles (omitted for brevity, remains the same) */
        .tooltip { position: relative; display: inline-block; } 
        .tooltip .tooltiptext { visibility: hidden; width: 60px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 5px 0; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -30px; opacity: 0; transition: opacity 0.3s; font-size: 10px; } 
        .tooltip .tooltiptext::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #555 transparent transparent transparent; } 
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .swiper-container.main-swiper { width: 100%; position: relative; }
        .swiper-slide { height: auto; display: flex; flex-direction: column; }
        .swiper-slide img { display: block; width: 100%; height: auto; object-fit: contain; max-height: 80vh; }
        .swiper-slide.share-image-slide img { max-height: none; object-fit: contain; }
        .swiper-button-next, .swiper-button-prev { color: #fff; background-color: rgba(0,0,0,0.3); padding: 10px; border-radius: 50%; width: 40px; height: 40px; } .swiper-button-next::after, .swiper-button-prev::after { font-size: 1.2rem; }
        .swiper-pagination { position: absolute; bottom: 20px !important; left: 50%; transform: translateX(-50%); width: auto; z-index: 10; }
        .swiper-pagination-bullet { background-color: rgba(128, 128, 128, 0.7); opacity: 1; width: 8px; height: 8px; }
        .swiper-pagination-bullet-active { background: #FFFFFF; }
        .thumbnail-swiper .swiper-slide { width: 60px !important; height: 80px; opacity: 0.6; cursor: pointer; border: 2px solid transparent; transition: opacity 0.3s, border-color 0.3s; }
        .thumbnail-swiper .swiper-slide img { object-fit: cover; width: 100%; height: 100%;}
        .thumbnail-swiper .swiper-slide-thumb-active { opacity: 1; border-color: #4f46e5; } .thumbnail-swiper { margin-top: 0.5rem; padding: 5px 0; }
        #narrative-summary-container, #cigar-review-container, #selected-flavors-container { max-width: 100%; }
        .flavor-tag { display: inline-block; background-color: #e5e7eb; color: #374151; font-size: 0.75rem; font-weight: 600; margin-right: 0.5rem; margin-bottom: 0.5rem; padding: 0.125rem 0.625rem; border-radius: 9999px; }

        /* Share Card Styles */
        #share-card-container { position: absolute; left: -9999px; top: 0; width: 350px; background-color: white; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); overflow: hidden; border: 1px solid #e5e7eb; visibility: hidden; z-index: -1; }
        #share-card-image-wrapper { background-color: #e5e7eb; display: flex; align-items: center; justify-content: center; aspect-ratio: 1179 / 1572; }
        #share-card-image { width: 100%; height: 100%; object-fit: cover; }
        #share-card-content { padding: 0.25rem; position: relative; }
        #share-card-score-grade { display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 0.1rem; }
        #share-card-score { font-size: 2.75rem; font-weight: 900; line-height: 1; margin-bottom: 0.3rem; }
        #share-card-grade-badge { display: inline-block; padding: 0.1rem 0.4rem; border-radius: 9999px; font-size: 0.6rem; font-weight: 600; margin-bottom: 0.2rem; }
        .share-card-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 0; }
        #share-card-watermark { font-size: 0.55rem; color: #9ca3af; width: 65%; line-height: 1.1; margin: 0; }
        #share-card-qrcode { width: 32%; height: auto; background-color: white; padding: 0; border: 1px solid #eee; box-shadow: 0 0 2px rgba(0,0,0,0.1); }
        #share-card-qrcode img { display: block; width: 100%; height: 100%; }

        /* ========= 新增: 语言按钮样式 ========= */
        .lang-button {
            padding: 2px 6px;
            margin: 0 2px;
            border: 1px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem; /* text-xs */
            transition: background-color 0.2s, border-color 0.2s;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        .lang-button:hover {
            background-color: #e5e7eb; /* bg-gray-200 */
        }
        .lang-button.active {
            font-weight: bold;
            background-color: #e0e7ff; /* bg-indigo-100 */
            border-color: #a5b4fc; /* border-indigo-300 */
            color: #3730a3; /* text-indigo-800 */
            cursor: default;
        }
        /* ========= 结束: 语言按钮样式 ========= */
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">
    <div class="max-w-6xl mx-auto p-4 md:p-8 relative">
        <div id="error-container" class="hidden bg-red-100 p-6 rounded-lg shadow-lg text-red-700 font-medium"></div>
        <div id="loading-indicator" class="hidden text-center py-10 text-gray-500" data-i18n="common.loadingDetails">正在加载评分详情...</div>
        
        <div id="main-content" class="opacity-0">
            <nav class="mb-6 flex flex-wrap justify-between items-center bg-white p-3 rounded-lg shadow-sm gap-4">
                 <a href="index.html" class="text-xl font-bold text-indigo-600" data-i18n="nav.title">Pistacho评分</a>
                 <div class="flex items-center space-x-4 flex-grow justify-center md:justify-start md:flex-grow-0 order-3 md:order-2 w-full md:w-auto">
                     <a href="index.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.community">社区动态</a>
                     <a href="rate.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.rate">去评分</a>
                     <a href="history.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.myRatings">我的评分</a>
                     <a href="certified.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.certified">认证评分</a>
                 </div>
                 <div class="flex items-center order-2 md:order-3">
                    <div id="language-flags" class="flex items-center space-x-1 mr-2">
                        </div>
                    <div id="login-status-container" class="flex items-center"></div>
                 </div>
            </nav>

            <div class="flex flex-col md:flex-row gap-6 md:gap-8 mb-8">
                <div class="w-full md:w-2/5 flex-shrink-0">
                     <div id="image-gallery-container" class="bg-white rounded-lg shadow-md overflow-hidden">
                         <div class="swiper-container main-swiper bg-gray-200 relative">
                              <div class="swiper-wrapper" id="main-swiper-wrapper">
                                  <div class="swiper-slide flex items-center justify-center text-gray-400 aspect-[1179/1572]" data-i18n="common.loading">加载中...</div>
                              </div>
                              <div class="swiper-pagination"></div>
                              <div class="swiper-button-next"></div>
                              <div class="swiper-button-prev"></div>
                         </div>
                         <div class="swiper-container thumbnail-swiper hidden"> <div class="swiper-wrapper" id="thumbnail-swiper-wrapper"> </div> </div>
                     </div>
                </div>
                 <div class="w-full md:flex-grow bg-white rounded-lg shadow-md p-6">
                     <p class="text-sm text-gray-500 mb-1">
                         <span data-i18n="resultsPage.by">点评来自:</span> 
                         <span id="user-nickname" class="font-medium text-gray-700"></span>
                     </p>
                     <h1 id="rating-title" class="text-3xl font-bold mb-3"></h1>
                     <h2 id="cigar-name" class="text-xl font-semibold mb-1"></h2>
                     <div class="mb-4 text-sm text-gray-600 flex space-x-4">
                         <span><span data-i18n="resultsPage.size">尺寸</span>: <strong id="cigar-size"></strong></span>
                         <span><span data-i18n="resultsPage.origin">产地</span>: <strong id="cigar-origin"></strong></span>
                     </div>
                     <div id="cigar-review-container" class="prose prose-sm max-w-none text-gray-700 border-t pt-4">
                     </div>
                     <div id="selected-flavors-container" class="hidden pt-2">
                         <h4 class="text-sm font-semibold text-gray-600 mb-2" data-i18n="resultsPage.flavors">主要风味:</h4>
                         <div id="flavors-display" class="flex flex-wrap"></div>
                     </div>
                 </div>
            </div>

            <section id="score-section" class="bg-white rounded-xl shadow-lg p-6 mb-8 flex flex-col md:flex-row gap-6 items-center">
            </section>

             <div id="save-button-container" class="hidden mb-6">
                 <button id="save-rating-button" onclick="saveRating()" class="w-full py-3 px-6 bg-green-600 text-white font-bold text-lg rounded-lg shadow-md hover:bg-green-700 transition" data-i18n="resultsPage.saveRating">
                     保存为我的评分记录
                 </button>
             </div>

            <div class="space-y-4">
                 <details id="narrative-summary-details" class="group bg-white rounded-xl shadow-lg p-6 transition-all duration-300" open>
                     <summary class="flex justify-between items-center cursor-pointer font-bold text-lg text-gray-800">
                         <span>
                             <span data-i18n="resultsPage.narrativeTitle">综合评价</span>
                             <svg class="inline w-5 h-5 transform group-open:rotate-180 transition-transform ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                         </span>
                         <div class="tooltip">
                             <button id="copy-summary-button" onclick="copySummary(event)" class="ml-4 p-1.5 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition text-xs">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /> </svg>
                             </button>
                             <span id="copy-tooltip" class="tooltiptext" data-i18n="resultsPage.copy">复制</span>
                         </div>
                     </summary>
                     <div id="narrative-summary-container" class="mt-4 prose max-w-none"></div>
                 </details>
                 <details id="summary-details" class="group bg-white rounded-xl shadow-lg p-6">
                     <summary class="flex justify-between items-center cursor-pointer font-bold text-lg text-gray-800">
                         <span data-i18n="resultsPage.detailsTitle">评分详情汇总</span>
                         <svg class="w-5 h-5 transform group-open:rotate-180 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                     </summary>
                     <div id="summary-container" class="mt-4"></div>
                 </details>
            </div>

            <footer class="mt-8 flex flex-col sm:flex-row justify-center items-center gap-4">
                 <a href="rate.html" class="py-3 px-6 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition" data-i18n="resultsPage.backToRate">
                     &larr; 返回重新评分
                 </a>
            </footer>
        </div>

        <div id="share-card-container">
            <div id="share-card-image-wrapper">
                <img id="share-card-image" src="" alt="Cigar Cover Image" crossorigin="anonymous">
            </div>
            <div id="share-card-content">
                <div id="share-card-score-grade">
                    <span id="share-card-score">0.00</span>
                    <span id="share-card-grade-badge">? - ???</span>
                </div>
                <div class="share-card-footer">
                     <p id="share-card-watermark">
                         <span id="share-card-username">用户</span> 
                         </p>
                     <div id="share-card-qrcode"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Constants and Global Vars --- (remains the same)
        const GRADING_SCALE = [
            { "grade": "P", "nameKey": "resultsPage.grade.P", "min_score": 95, "color": "gold" },
            { "grade": "I", "nameKey": "resultsPage.grade.I", "min_score": 90, "color": "indigo" },
            { "grade": "S", "nameKey": "resultsPage.grade.S", "min_score": 80, "color": "purple" },
            { "grade": "T", "nameKey": "resultsPage.grade.T", "min_score": 70, "color": "blue" },
            { "grade": "A", "nameKey": "resultsPage.grade.A", "min_score": 60, "color": "green" },
            { "grade": "C", "nameKey": "resultsPage.grade.C", "min_score": 50, "color": "gray" },
            { "grade": "H", "nameKey": "resultsPage.grade.H", "min_score": 30, "color": "orange" },
            { "grade": "O", "nameKey": "resultsPage.grade.O", "min_score": 0, "color": "red" }
        ];
        
        let currentAuthUser = null; 
        let resultsData = null; 
        let ratingId = null;
        const AUTHING_APP_ID = '68f5b0b6875017c02b3bfdb3'; 
        const AUTHING_HOST = 'https://xfvu647mcdbk-demo.authing.cn';
        let mainSwiper = null; 
        let thumbnailSwiper = null;

        // --- i18n Initialization Functions ---
        // ========= 修改: initI18n 使用 Promise 和 回调 =========
        async function initI18n() {
             return new Promise((resolve, reject) => {
                 i18next
                     .use(i18nextHttpBackend)
                     .use(i18nextBrowserLanguageDetector)
                     .init({
                         fallbackLng: 'zh',
                         debug: true, // Keep debug on for now
                         ns: ['translation'],
                         defaultNS: 'translation',
                         backend: { loadPath: '/locales/{{lng}}.json?v=1' }, // Added version
                         detection: { order: ['localStorage', 'navigator'], caches: ['localStorage'] }
                     }, (err, t) => {
                         if (err) {
                             console.error('i18next initialization failed:', err);
                             document.title = 'Rating Report - Error';
                             return reject(err);
                         }
                         console.log('i18next initialized successfully.');
                         try {
                             updateContent(); // Perform initial update *inside* the callback
                             document.title = i18next.t('resultsPage.pageTitle');
                             resolve(); // Resolve the promise
                         } catch (updateErr) {
                             console.error('Error during initial updateContent:', updateErr);
                             reject(updateErr);
                         }
                     });
             });
        }
        // ========= 结束: initI18n 修改 =========

        function updateContent() {
            console.log("Running updateContent for results.html..."); // Add log
             document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                let value = '';
                try { value = i18next.t(key); if (value === key && key !== '') console.warn(`Translation missing: ${key}`); }
                catch (e) { console.error(`Error translating key "${key}":`, e); value = `[Error: ${key}]`; }

                // Skip language buttons
                if (el.classList.contains('lang-button')) return; 

                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    if (el.hasAttribute('placeholder')) el.placeholder = value;
                } else if (el.tagName === 'OPTION') {
                     el.textContent = value;
                } else if (el.id === 'copy-tooltip') {
                     el.textContent = value; // Use textContent for tooltip
                }
                 else {
                     el.innerHTML = (typeof value === 'string' || typeof value === 'number') ? value : '';
                 }
             });
             console.log("updateContent for results.html finished."); // Add log
        }

        // ========= 删除: setupLanguageSwitcher 函数 =========
        // function setupLanguageSwitcher() { ... } // REMOVED

        // ========= 新增: renderLanguageSwitcher 函数 =========
        function renderLanguageSwitcher() {
            const container = document.getElementById('language-flags');
            if (!container) return;
            container.innerHTML = '';
            const languages = ['zh', 'en', 'es'];
            const currentLang = i18next.language ? i18next.language.split('-')[0] : 'zh';

            languages.forEach(lang => {
                const button = document.createElement('button');
                button.textContent = lang.toUpperCase();
                button.className = `lang-button ${lang === currentLang ? 'active' : ''}`;
                button.dataset.lang = lang;
                button.onclick = async (e) => {
                    const newLang = e.target.dataset.lang;
                    const oldLang = i18next.language ? i18next.language.split('-')[0] : 'zh';
                    if (newLang === oldLang) return;

                    console.log(`results.html: Changing language to ${newLang}`);
                    try {
                        await i18next.changeLanguage(newLang);
                        console.log("results.html: Language changed, running updates...");
                        updateContent();             // Update static text
                        renderLanguageSwitcher();     // Update button active state
                        renderLoginStatus(currentAuthUser); // Update login/logout text
                        document.title = i18next.t('resultsPage.pageTitle'); // Update page title
                        if (resultsData) {
                             console.log("results.html: Re-rendering page content with new language...");
                             renderPageContent(resultsData); // Re-render dynamic page content
                             // Re-render potentially language-dependent parts of share card if needed
                             // Example: updateShareCardWatermark();
                        }
                        console.log("results.html: UI updates after language change finished.");
                    } catch (langErr) {
                        console.error(`results.html: Failed to change language to ${newLang}:`, langErr);
                    }
                };
                container.appendChild(button);
            });
        }
        // ========= 结束: renderLanguageSwitcher 函数 =========


        // --- Authentication --- (Functions remain the same)
        window.login = function() { /* ... */ }
        window.logout = function() { /* ... */ }
        function renderLoginStatus(user) {
             const container = document.getElementById('login-status-container'); 
             if (!container || !i18next.isInitialized) return; // Guard
             if (user) { 
                 const displayName = user.nickname || user.name || user.preferred_username || user.email || i18next.t('nav.loggedIn', 'Logged In');
                 container.innerHTML = `<span class="text-sm font-medium text-gray-700 mr-2 hidden sm:inline">${displayName}</span><button onclick="logout()" class="px-3 py-1 text-xs font-medium rounded-full bg-red-500 text-white hover:bg-red-600">${i18next.t('nav.logout')}</button>`; 
             } else { 
                 container.innerHTML = `<button onclick="login()" class="px-3 py-1 text-xs font-medium rounded-full bg-green-500 text-white hover:bg-green-600">${i18next.t('nav.login')}</button>`; 
             } 
        }
        async function handleOidcCallback(code) { /* ... */ }
        async function validateSessionAndGetUser() { /* ... */ }

        // --- Main Functions --- (saveRating, copySummary, initSwipers, autoGenerateShareImage remain the same)
        window.saveRating = async function() { /* ... */ };
        window.copySummary = function(event) { /* ... */ };
        function initSwipers(imageUrls = []) { /* ... */ }
        async function autoGenerateShareImage() { /* ... */ }

        // --- renderPageContent (remains the same as previous correct version) ---
        function renderPageContent(data) {
             if (!data || !i18next.isInitialized) return; // Add i18n check

             const { cigarInfo, cigarReview, normalizedScore, isDraft, selectedFlavors = [] } = data;
             const title = data.title || i18next.t('common.noTitle');
             const userNickname = data.userNickname || data.userEmail || i18next.t('common.anonymous');

             const foundGrade = GRADING_SCALE.find(g => normalizedScore >= g.min_score) || GRADING_SCALE[GRADING_SCALE.length - 1];
             const finalGrade = {
                 grade: foundGrade.grade,
                 name: i18next.t(foundGrade.nameKey), // Translate the grade name
                 color: foundGrade.color
             };

             document.getElementById('user-nickname').textContent = userNickname;
             document.getElementById('rating-title').textContent = title;
             document.getElementById('cigar-name').textContent = cigarInfo.name;
             document.getElementById('cigar-size').textContent = cigarInfo.size;
             document.getElementById('cigar-origin').textContent = cigarInfo.origin;
             const reviewContainer = document.getElementById('cigar-review-container');
             reviewContainer.innerHTML = (cigarReview && cigarReview.trim()) ? `<p>${cigarReview}</p>` : `<p class="text-gray-400 italic">${i18next.t('common.noReview')}</p>`;
             const flavorsContainer = document.getElementById('selected-flavors-container');
             if (selectedFlavors.length > 0) { document.getElementById('flavors-display').innerHTML = selectedFlavors.map(f => `<span class="flavor-tag">${f}</span>`).join(''); flavorsContainer.classList.remove('hidden'); } else { flavorsContainer.classList.add('hidden'); }
             renderScoreSection(document.getElementById('score-section'), normalizedScore, finalGrade);
             const saveButtonContainer = document.getElementById('save-button-container'); saveButtonContainer.style.display = (currentAuthUser && isDraft) ? 'block' : 'none';
             const hasFullData = data.config && data.ratings;
             ['narrative-summary-details', 'summary-details'].forEach(id => { const el = document.getElementById(id); if (el) el.style.display = hasFullData ? 'block' : 'none'; });
             if (hasFullData) { document.getElementById('narrative-summary-container').innerHTML = generateNarrativeSummary(cigarInfo, data.config, data.ratings, finalGrade, selectedFlavors); renderSummary(document.getElementById('summary-container'), data.config, data.ratings); }
             const shareCardImage = document.getElementById('share-card-image');
             const gradeStyles = getGradeStyles(finalGrade.color); document.getElementById('share-card-score').className = `text-5xl font-black ${gradeStyles.textColor}`; document.getElementById('share-card-grade-badge').className = `inline-block px-2 py-0.5 rounded-full text-xs font-semibold ${gradeStyles.bgColor} ${gradeStyles.textColor} bg-opacity-20`; document.getElementById('share-card-score').textContent = normalizedScore.toFixed(2); document.getElementById('share-card-grade-badge').textContent = finalGrade.name; document.getElementById('share-card-watermark').innerHTML = i18next.t('resultsPage.shareCard.userRatingOn', { user: `<span id="share-card-username">${userNickname}</span>` });
             const shareCardQrCode = document.getElementById('share-card-qrcode'); if (shareCardQrCode && typeof QRCode !== 'undefined') { shareCardQrCode.innerHTML = ''; const uniqueUrl = ratingId ? `${window.location.origin}/results.html?ratingId=${ratingId}` : window.location.href; new QRCode(shareCardQrCode, { text: uniqueUrl, width: 90, height: 90 }); } else if (!ratingId && typeof QRCode !== 'undefined') { console.warn(i18next.t('resultsPage.shareCard.qrError')); }
             const images = data.imageUrls || []; if (images.length > 0) { shareCardImage.src = `/api/image/${images[0]}`; } else { document.getElementById('share-card-image-wrapper').innerHTML = `<span class="text-gray-400 text-sm">${i18next.t('resultsPage.shareCard.noCover')}</span>`; }
        }

        // --- window.onload (Modified) ---
        window.onload = async function() {
             console.log("results.html window.onload started");
             const errorContainer = document.getElementById('error-container');
             const mainContent = document.getElementById('main-content');
             const loadingIndicator = document.getElementById('loading-indicator');

             try {
                 // 1. Initialize i18n (waits for callback)
                 console.log("Initializing i18n...");
                 await initI18n();
                 console.log("i18n initialized and first updateContent completed.");

                 // 2. Handle Authentication
                 console.log("Handling authentication...");
                 const urlParams = new URLSearchParams(window.location.search);
                 const code = urlParams.get('code');
                 ratingId = urlParams.get('ratingId'); // Get ratingId early
                 let user = code ? await handleOidcCallback(code) : await validateSessionAndGetUser();
                 currentAuthUser = user;
                 console.log("Authentication handled. User:", currentAuthUser ? currentAuthUser.sub : 'None');

                 // 3. Render User UI & Language Switcher (after i18n ready)
                 console.log("Rendering user UI elements...");
                 renderLoginStatus(currentAuthUser);
                 renderLanguageSwitcher(); // Render language buttons
                 console.log("User UI elements rendered.");

                 // 4. Load Rating Data
                 console.log("Fetching rating data...");
                 loadingIndicator.classList.remove('hidden');

                 if (ratingId) {
                     const token = sessionStorage.getItem('accessToken');
                     const apiUrl = new URL(`/api/ratings?id=${ratingId}`, window.location.origin);
                     const fetchOptions = token ? { headers: { 'Authorization': `Bearer ${token}` } } : {};
                     const response = await fetch(apiUrl, fetchOptions);
                     if (!response.ok) {
                         const errorBody = await response.text();
                         console.error(`Fetch API error for rating ${ratingId}: ${response.status} ${response.statusText}`, errorBody);
                         throw new Error(i18next.t('errors.loadRatingFailed', { status: response.status }));
                     }
                     resultsData = await response.json();
                     console.log("Rating data fetched from API for ID:", ratingId);
                 } else {
                     const storedData = sessionStorage.getItem('cigarRatingResults');
                     if (!storedData) throw new Error(i18next.t('errors.noRatingDataFound'));
                     resultsData = JSON.parse(storedData);
                     ratingId = resultsData.ratingId; // Update ratingId if loaded from session
                     console.log("Rating data loaded from sessionStorage.");
                 }

                 if (!resultsData || resultsData.normalizedScore === undefined) {
                     throw new Error(i18next.t('errors.missingEssentialData'));
                 }

                 // 5. Render Page Content
                 console.log("Rendering page content...");
                 initSwipers(resultsData.imageUrls || []);
                 renderPageContent(resultsData); // Uses resultsData
                 console.log("Page content rendered.");

                 // 6. Generate Share Image
                 console.log("Attempting to generate share image...");
                 const shareImg = document.getElementById('share-card-image');
                 if (shareImg && shareImg.src && !shareImg.src.includes('placehold.co')) {
                     if (shareImg.complete) { await autoGenerateShareImage(); }
                     else { shareImg.onload = async () => await autoGenerateShareImage(); shareImg.onerror = () => console.warn("Share card image failed to load, cannot generate share image."); }
                 } else if (ratingId) {
                      console.warn(i18next.t('resultsPage.shareCard.noCover'));
                      await autoGenerateShareImage();
                 }
                 console.log("Share image generation attempted.");

                 loadingIndicator.classList.add('hidden');
                 mainContent.classList.remove('opacity-0');
                 console.log("window.onload finished successfully.");

             } catch (e) {
                 console.error("Initialization error in window.onload:", e);
                 loadingIndicator.classList.add('hidden');
                 let errorMsg = i18next.isInitialized ? i18next.t('errors.initFailed', { msg: e.message || e }) : `Initialization failed: ${e.message || e}`;
                 const backLinkText = i18next.isInitialized ? i18next.t('common.backToCommunity') : "Back to Community";
                 if (errorContainer) {
                    errorContainer.innerHTML = `<p class="font-bold text-center">${errorMsg} <a href="index.html" class="text-indigo-600 underline">${backLinkText}</a></p>`;
                    errorContainer.classList.remove('hidden');
                 }
             }
        };

        // --- Rendering Utilities --- (generateNarrativeSummary, renderSummary, getScoreRange, getGradeStyles, renderScoreSection remain the same)
        function generateNarrativeSummary(cigarInfo, config, ratings, finalGrade, selectedFlavors) { /* ... */ }
        function renderSummary(container, config, ratings) { /* ... */ }
        function getScoreRange(gradeCode) { /* ... */ }
        function getGradeStyles(color) { /* ... */ }
        function renderScoreSection(container, score, grade) { /* ... */ }

    </script>
</body>
</html>