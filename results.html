<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雪茄品鉴 - 点评报告</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/11.0.5/swiper-bundle.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/11.0.5/swiper-bundle.min.js" defer></script>

    <script src="https://unpkg.com/i18next/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-http-backend/i18nextHttpBackend.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector/i18nextBrowserLanguageDetector.min.js"></script>

    <script>
        // Tailwind config
        if (typeof tailwind !== 'undefined') {
             tailwind.config = {
                 theme: { extend: { fontFamily: { sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'], }, } }
             }
         } else { console.warn('Tailwind object not found.'); }
    </script>
    <style>
        /* Tooltip style */
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext { visibility: hidden; width: 60px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 5px 0; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -30px; opacity: 0; transition: opacity 0.3s; font-size: 10px; }
        .tooltip .tooltiptext::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #555 transparent transparent transparent; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        /* Swiper styles */
        .swiper-container.main-swiper { width: 100%; position: relative; }
        .swiper-slide { height: auto; display: flex; flex-direction: column; align-items: center; /* Center content */ justify-content: center; /* Center content */ }
        .swiper-slide img { display: block; width: 100%; height: auto; object-fit: contain; max-height: 80vh; }
        .swiper-slide.share-image-slide img { max-height: none; object-fit: contain; }
        .swiper-button-next, .swiper-button-prev { color: #fff; background-color: rgba(0,0,0,0.3); padding: 10px; border-radius: 50%; width: 40px; height: 40px; } .swiper-button-next::after, .swiper-button-prev::after { font-size: 1.2rem; }
        .swiper-pagination { position: absolute; bottom: 20px !important; left: 50%; transform: translateX(-50%); width: auto; z-index: 10; }
        .swiper-pagination-bullet { background-color: rgba(128, 128, 128, 0.7); opacity: 1; width: 8px; height: 8px; }
        .swiper-pagination-bullet-active { background: #FFFFFF; }
        .thumbnail-swiper .swiper-slide { width: 60px !important; height: 80px; opacity: 0.6; cursor: pointer; border: 2px solid transparent; transition: opacity 0.3s, border-color 0.3s; }
        .thumbnail-swiper .swiper-slide img { object-fit: cover; width: 100%; height: 100%;}
        .thumbnail-swiper .swiper-slide-thumb-active { opacity: 1; border-color: #4f46e5; } .thumbnail-swiper { margin-top: 0.5rem; padding: 5px 0; }
        /* Content container width */
        #narrative-summary-container, #cigar-review-container, #selected-flavors-container { max-width: 100%; }
        /* Flavor tag style */
        .flavor-tag { display: inline-block; background-color: #e5e7eb; color: #374151; font-size: 0.75rem; font-weight: 600; margin-right: 0.5rem; margin-bottom: 0.5rem; padding: 0.125rem 0.625rem; border-radius: 9999px; }

        /* Share Card Styles (Hidden off-screen for generation) */
        #share-card-container { position: absolute; left: -9999px; top: 0; width: 350px; background-color: white; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); overflow: hidden; border: 1px solid #e5e7eb; visibility: hidden; z-index: -1; }
        #share-card-image-wrapper { background-color: #e5e7eb; display: flex; align-items: center; justify-content: center; aspect-ratio: 1179 / 1572; }
        #share-card-image { width: 100%; height: 100%; object-fit: cover; }
        #share-card-content { padding: 0.25rem; position: relative; }
        #share-card-score-grade { display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 0.1rem; }
        #share-card-score { font-size: 2.75rem; font-weight: 900; line-height: 1; margin-bottom: 0.3rem; }
        #share-card-grade-badge { display: inline-block; padding: 0.1rem 0.4rem; border-radius: 9999px; font-size: 0.6rem; font-weight: 600; margin-bottom: 0.2rem; }
        .share-card-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 0; }
        #share-card-watermark { font-size: 0.55rem; color: #9ca3af; width: 65%; line-height: 1.1; margin: 0; }
        #share-card-qrcode { width: 32%; height: auto; background-color: white; padding: 0; border: 1px solid #eee; box-shadow: 0 0 2px rgba(0,0,0,0.1); }
        /* Ensure QR code image is visible for html2canvas */
        #share-card-qrcode img { display: block; width: 100%; height: 100%; }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">
    <div class="max-w-6xl mx-auto p-4 md:p-8 relative">
        <!-- Error Container -->
        <div id="error-container" class="hidden bg-red-100 p-6 rounded-lg shadow-lg text-red-700 font-medium"></div>
        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden text-center py-10 text-gray-500" data-i18n="common.loadingDetails">正在加载评分详情...</div>

        <!-- Main Content (hidden initially) -->
        <div id="main-content" class="opacity-0">
            <!-- Navigation Bar -->
            <nav class="mb-6 flex flex-wrap justify-between items-center bg-white p-3 rounded-lg shadow-sm gap-4">
                 <a href="index.html" class="text-xl font-bold text-indigo-600" data-i18n="nav.title">Pistacho评分</a>
                 <!-- Nav Links -->
                 <div class="flex items-center space-x-4 flex-grow justify-center md:justify-start md:flex-grow-0 order-3 md:order-2 w-full md:w-auto">
                     <a href="index.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.community">社区动态</a>
                     <a href="rate.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.rate">去评分</a>
                     <a href="history.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.myRatings">我的评分</a>
                     <a href="certified.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.certified">认证评分</a>
                 </div>
                 <!-- Language Switcher & Login Status -->
                 <div class="flex items-center order-2 md:order-3">
                    <select id="language-switcher" class="text-xs p-1 rounded border border-gray-300 mr-2" style="height: 30px; line-height: 1.5;">
                        <option value="zh">简体中文</option>
                        <option value="en">English</option>
                        <option value="es">Español</option>
                    </select>
                    <div id="login-status-container" class="flex items-center"></div>
                 </div>
            </nav>

            <!-- Main Layout: Image Gallery + Details -->
            <div class="flex flex-col md:flex-row gap-6 md:gap-8 mb-8">
                <!-- Image Gallery -->
                <div class="w-full md:w-2/5 flex-shrink-0">
                     <div id="image-gallery-container" class="bg-white rounded-lg shadow-md overflow-hidden">
                         <!-- Main Swiper -->
                         <div class="swiper-container main-swiper bg-gray-200 relative">
                              <div class="swiper-wrapper" id="main-swiper-wrapper">
                                  <div class="swiper-slide flex items-center justify-center text-gray-400 aspect-[1179/1572]" data-i18n="common.loading">加载中...</div>
                              </div>
                              <div class="swiper-pagination"></div>
                              <div class="swiper-button-next"></div>
                              <div class="swiper-button-prev"></div>
                         </div>
                         <!-- Thumbnail Swiper (hidden if only one image) -->
                         <div class="swiper-container thumbnail-swiper hidden"> <div class="swiper-wrapper" id="thumbnail-swiper-wrapper"> </div> </div>
                     </div>
                </div>
                 <!-- Rating Details -->
                 <div class="w-full md:flex-grow bg-white rounded-lg shadow-md p-6">
                     <!-- Author -->
                     <p class="text-sm text-gray-500 mb-1">
                         <span data-i18n="resultsPage.by">点评来自:</span>
                         <span id="user-nickname" class="font-medium text-gray-700"></span>
                     </p>
                     <!-- Rating Title -->
                     <h1 id="rating-title" class="text-3xl font-bold mb-3"></h1>
                     <!-- Cigar Info -->
                     <h2 id="cigar-name" class="text-xl font-semibold mb-1"></h2>
                     <div class="mb-4 text-sm text-gray-600 flex space-x-4">
                         <span><span data-i18n="resultsPage.size">尺寸</span>: <strong id="cigar-size"></strong></span>
                         <span><span data-i18n="resultsPage.origin">产地</span>: <strong id="cigar-origin"></strong></span>
                     </div>
                     <!-- Written Review -->
                     <div id="cigar-review-container" class="prose prose-sm max-w-none text-gray-700 border-t pt-4">
                         <!-- Review content inserted by JS -->
                     </div>
                     <!-- Selected Flavors -->
                     <div id="selected-flavors-container" class="hidden pt-2">
                         <h4 class="text-sm font-semibold text-gray-600 mb-2" data-i18n="resultsPage.flavors">主要风味:</h4>
                         <div id="flavors-display" class="flex flex-wrap">
                             <!-- Flavor tags inserted by JS -->
                         </div>
                     </div>
                 </div>
            </div>

            <!-- Score Section -->
            <section id="score-section" class="bg-white rounded-xl shadow-lg p-6 mb-8 flex flex-col md:flex-row gap-6 items-center">
                <!-- Score and grade details inserted by JS -->
            </section>

             <!-- Save Button (visible only for drafts) -->
             <div id="save-button-container" class="hidden mb-6">
                 <button id="save-rating-button" onclick="saveRating()" class="w-full py-3 px-6 bg-green-600 text-white font-bold text-lg rounded-lg shadow-md hover:bg-green-700 transition" data-i18n="resultsPage.saveRating">
                     保存为我的评分记录
                 </button>
             </div>

            <!-- Details Sections (Narrative Summary, Rating Details) -->
            <div class="space-y-4">
                 <!-- Narrative Summary -->
                 <details id="narrative-summary-details" class="group bg-white rounded-xl shadow-lg p-6 transition-all duration-300" open>
                     <summary class="flex justify-between items-center cursor-pointer font-bold text-lg text-gray-800">
                         <span>
                             <span data-i18n="resultsPage.narrativeTitle">综合评价</span>
                             <!-- Arrow icon -->
                             <svg class="inline w-5 h-5 transform group-open:rotate-180 transition-transform ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                         </span>
                         <!-- Copy Button with Tooltip -->
                         <div class="tooltip">
                             <button id="copy-summary-button" onclick="copySummary(event)" class="ml-4 p-1.5 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition text-xs">
                                 <!-- Copy icon -->
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /> </svg>
                             </button>
                             <span id="copy-tooltip" class="tooltiptext" data-i18n="resultsPage.copy">复制</span>
                         </div>
                     </summary>
                     <div id="narrative-summary-container" class="mt-4 prose max-w-none">
                         <!-- Narrative summary inserted by JS -->
                     </div>
                 </details>
                 <!-- Rating Details Summary -->
                 <details id="summary-details" class="group bg-white rounded-xl shadow-lg p-6">
                     <summary class="flex justify-between items-center cursor-pointer font-bold text-lg text-gray-800">
                         <span data-i18n="resultsPage.detailsTitle">评分详情汇总</span>
                         <!-- Arrow icon -->
                         <svg class="w-5 h-5 transform group-open:rotate-180 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                     </summary>
                     <div id="summary-container" class="mt-4">
                         <!-- Rating details summary inserted by JS -->
                     </div>
                 </details>
            </div>

            <!-- Footer Navigation -->
            <footer class="mt-8 flex flex-col sm:flex-row justify-center items-center gap-4">
                 <a href="rate.html" class="py-3 px-6 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition" data-i18n="resultsPage.backToRate">
                     &larr; 返回重新评分
                 </a>
            </footer>
        </div>

        <!-- Hidden Share Card Container (for image generation) -->
        <div id="share-card-container">
            <div id="share-card-image-wrapper">
                <img id="share-card-image" src="" alt="Cigar Cover Image" crossorigin="anonymous">
            </div>
            <div id="share-card-content">
                <div id="share-card-score-grade">
                    <span id="share-card-score">0.00</span>
                    <span id="share-card-grade-badge">? - ???</span>
                </div>
                <div class="share-card-footer">
                     <p id="share-card-watermark">
                         <span id="share-card-username">用户</span>
                         <!-- Placeholder for 'rating on...' text -->
                         </p>
                     <div id="share-card-qrcode">
                         <!-- QR code img will be added here -->
                     </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Constants and Global Vars ---
        const GRADING_SCALE = [ // Defines grades, score ranges, and i18n keys
            { "grade": "P", "nameKey": "resultsPage.grade.P", "min_score": 95, "color": "gold" },
            { "grade": "I", "nameKey": "resultsPage.grade.I", "min_score": 90, "color": "indigo" },
            { "grade": "S", "nameKey": "resultsPage.grade.S", "min_score": 80, "color": "purple" },
            { "grade": "T", "nameKey": "resultsPage.grade.T", "min_score": 70, "color": "blue" },
            { "grade": "A", "nameKey": "resultsPage.grade.A", "min_score": 60, "color": "green" },
            { "grade": "C", "nameKey": "resultsPage.grade.C", "min_score": 50, "color": "gray" },
            { "grade": "H", "nameKey": "resultsPage.grade.H", "min_score": 30, "color": "orange" },
            { "grade": "O", "nameKey": "resultsPage.grade.O", "min_score": 0, "color": "red" }
        ];

        let currentAuthUser = null; // Stores logged-in user info
        let resultsData = null;     // Stores the rating data being displayed
        let ratingId = null;        // ID of the rating (if saved)
        const AUTHING_APP_ID = '68f5b0b6875017c02b3bfdb3'; // Authing App ID
        const AUTHING_HOST = 'https://xfvu647mcdbk-demo.authing.cn'; // Authing Host
        let mainSwiper = null;      // Swiper instance for main images
        let thumbnailSwiper = null; // Swiper instance for thumbnails
        let shareImageGenerated = false; // Flag to prevent multiple generations

        // --- i18n Initialization Functions ---
        async function initI18n() {
            // Initialize i18next
            await i18next
                .use(i18nextHttpBackend)
                .use(i18nextBrowserLanguageDetector)
                .init({
                    fallbackLng: 'zh',
                    debug: false, // Turn off for production
                    ns: ['translation'],
                    defaultNS: 'translation',
                    backend: {
                        loadPath: '/locales/{{lng}}.json?v=1' // Cache busting
                    },
                    detection: {
                        order: ['localStorage', 'navigator'],
                        caches: ['localStorage']
                    }
                });
            // Update static text after init
            // Note: Document title is set in updateContent after language detection
        }

        function updateContent() {
            // Update elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                let value = '';
                try {
                    value = i18next.t(key);
                    if (value === key && key !== '') console.warn(`Translation missing for key: ${key}`);
                } catch (e) { console.error(`Error translating key "${key}":`, e); value = `[Error: ${key}]`; }

                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    if (el.hasAttribute('placeholder')) el.placeholder = value;
                } else if (el.tagName === 'OPTION') {
                    el.textContent = value;
                } else {
                    // Handle specific elements like tooltip
                    if (el.id === 'copy-tooltip') {
                         el.textContent = value;
                    } else {
                         el.innerHTML = value; // Use innerHTML for others
                    }
                }
            });
            // Update page title
            document.title = i18next.t('resultsPage.pageTitle');
        }


        function setupLanguageSwitcher() {
            // Setup language dropdown
            const switcher = document.getElementById('language-switcher');
            if (!switcher) return;
            const currentLang = i18next.language ? i18next.language.split('-')[0] : 'zh';
            switcher.value = ['zh', 'en', 'es'].includes(currentLang) ? currentLang : 'zh';
            switcher.addEventListener('change', async (e) => {
                const newLang = e.target.value;
                await i18next.changeLanguage(newLang);
                updateContent(); // Update static text
                // Re-render dynamic content that depends on language
                renderLoginStatus(currentAuthUser);
                if (resultsData) {
                    renderPageContent(resultsData); // Re-render main content with new language
                    // Re-populate share card and QR before potential regeneration
                    populateShareCard(resultsData);
                    generateQRCode();
                    // Optionally regenerate share image on language change if needed
                    // shareImageGenerated = false; // Reset flag to allow regeneration
                    // tryAutoGenerateShareImage(); // Try generating again
                }
            });
        }

        // --- Authentication ---
        // Redirects to Authing for login
        window.login = function() {
            const redirectUri = window.location.origin; // Use base origin
            const authorizeUrl = new URL('/oidc/auth', AUTHING_HOST);
            authorizeUrl.search = new URLSearchParams({
                client_id: AUTHING_APP_ID,
                redirect_uri: redirectUri,
                response_type: 'code',
                scope: 'openid profile email phone',
                state: Math.random().toString(36).substring(2)
            }).toString();
            window.location.href = authorizeUrl.toString();
        }

        // Redirects to Authing for logout
        window.logout = function() {
            const logoutUrl = new URL('/oidc/session/end', AUTHING_HOST);
            logoutUrl.search = new URLSearchParams({ post_logout_redirect_uri: window.location.origin }).toString();
            sessionStorage.removeItem('userInfo');
            sessionStorage.removeItem('accessToken');
            window.location.href = logoutUrl.toString();
        }

        // Updates UI based on login status
        function renderLoginStatus(user) {
            const container = document.getElementById('login-status-container');
            if (!container || !i18next.isInitialized) return;
            if (user) {
                const displayName = user.nickname || user.name || user.preferred_username || user.email || i18next.t('nav.loggedIn');
                container.innerHTML = `<span class="text-sm font-medium text-gray-700 mr-2 hidden sm:inline">${displayName}</span><button onclick="logout()" class="px-3 py-1 text-xs font-medium rounded-full bg-red-500 text-white hover:bg-red-600">${i18next.t('nav.logout')}</button>`;
            } else {
                container.innerHTML = `<button onclick="login()" class="px-3 py-1 text-xs font-medium rounded-full bg-green-500 text-white hover:bg-green-600">${i18next.t('nav.login')}</button>`;
            }
        }

        // Handles the OIDC callback after login
        async function handleOidcCallback(code) {
            try {
                const redirectUri = window.location.origin; // Use base origin
                const apiUrl = new URL('/api/authing/callback', window.location.origin);
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code: code, redirect_uri: redirectUri }) });
                if (!response.ok) {
                    let errorText = i18next.t('errors.authCallbackFailed', { status: response.status });
                    try { const err = await response.json(); errorText = err.error || errorText; } catch(e){}
                    throw new Error(errorText);
                }
                const fullUserProfile = await response.json();
                sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile));
                sessionStorage.setItem('accessToken', fullUserProfile.accessToken);
                return fullUserProfile;
            } catch (e) {
                console.error('Authentication callback handling failed:', e);
                alert(i18next.t('errors.loginFailed', { message: e.message }));
                sessionStorage.removeItem('userInfo');
                sessionStorage.removeItem('accessToken');
                return null;
            } finally {
                // Clean URL
                // Keep search params like ?ratingId=... but remove code/state
                const cleanSearch = window.location.search
                    .replace(/&?code=[^&]*/, '')
                    .replace(/&?state=[^&]*/, '')
                    .replace(/^\?&/, '?') // Handle case where ? is followed by &
                    .replace(/&$/, '');   // Remove trailing &
                const cleanUrl = window.location.pathname + (cleanSearch !== '?' ? cleanSearch : ''); // Avoid leaving just '?'
                window.history.replaceState({}, document.title, cleanUrl);
            }
        }
        // Validates session token with backend
        async function validateSessionAndGetUser() {
            const token = sessionStorage.getItem('accessToken');
            if (!token) return null;
            try {
                const apiUrl = new URL('/api/me', window.location.origin);
                const response = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) {
                    sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken'); return null;
                }
                const fullUserProfile = await response.json();
                sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile));
                return fullUserProfile;
            } catch (e) { console.error("Session validation failed:", e); return null; }
        }

        // --- Main Functions ---
        // Handles saving the rating (only if it's a draft)
        window.saveRating = async function() {
            const token = sessionStorage.getItem('accessToken');
            if (!currentAuthUser || !token) { // Check login
                return alert(i18next.t('common.loginRequired'));
            }
            if (!resultsData || !resultsData.isDraft) { // Check if it's a draft
                return alert(i18next.t('errors.notADraft'));
            }

            const button = document.getElementById('save-rating-button');
            button.textContent = i18next.t('common.saving'); // Update button text
            button.disabled = true;

            try {
                const apiUrl = new URL('/api/ratings', window.location.origin);
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(resultsData)
                });
                if (!response.ok) { const err = await response.json(); throw new Error(err.error || i18next.t('errors.saveFailedNoMsg')); }
                const saveResult = await response.json();
                const newRatingId = saveResult.id; // Get the ID from the response
                alert(i18next.t('common.saveSuccess'));
                sessionStorage.removeItem('cigarRatingResults'); // Clear draft from session
                // Update button state to indicate success
                button.textContent = i18next.t('common.saveSuccess');
                button.classList.remove('bg-green-600', 'hover:bg-green-700');
                button.classList.add('bg-gray-400', 'cursor-not-allowed');
                // Update state if new ID is received
                if (newRatingId) {
                    ratingId = newRatingId; // Store the new ID globally
                    resultsData.isDraft = false; // Mark as no longer a draft
                    // Update URL with the new rating ID
                    const newUrl = new URL(window.location.href);
                    newUrl.searchParams.set('ratingId', newRatingId);
                    window.history.replaceState({}, document.title, newUrl.toString());
                    // Re-render to hide the save button based on isDraft=false
                    // Also regenerate QR code with the final URL
                    renderPageContent(resultsData);
                    generateQRCode(); // Regenerate QR for the new URL
                    // Try generating share image again now that we have the final ID/URL
                    shareImageGenerated = false; // Reset flag
                    tryAutoGenerateShareImage(); // Attempt generation
                }
            } catch (e) {
                console.error("保存评分失败:", e);
                alert(i18next.t('common.saveFailed', { msg: e.message }));
                // Reset button state on failure
                button.textContent = i18next.t('resultsPage.saveRating');
                button.disabled = false;
            }
        };

        // Copies the narrative summary text to the clipboard
        window.copySummary = function(event) {
            event.preventDefault(); // Prevent details section from toggling
            event.stopPropagation(); // Stop event bubbling
            const summaryContainer = document.getElementById('narrative-summary-container');
            const summaryText = summaryContainer ? summaryContainer.innerText || summaryContainer.textContent : ''; // Get text content
            const tooltip = document.getElementById('copy-tooltip');
            navigator.clipboard.writeText(summaryText.trim()).then(() => {
                tooltip.textContent = i18next.t('common.copied'); // Show 'Copied!'
                setTimeout(() => { tooltip.textContent = i18next.t('resultsPage.copy'); }, 2000); // Reset after 2s
            }, (err) => {
                console.error('Could not copy text: ', err);
                tooltip.textContent = i18next.t('common.copyFailed'); // Show 'Copy failed'
                setTimeout(() => { tooltip.textContent = i18next.t('resultsPage.copy'); }, 2000); // Reset after 2s
            });
        };

        // Initializes the Swiper image galleries (main and thumbnails)
        function initSwipers(imageUrls = []) {
             const mainWrapper = document.getElementById('main-swiper-wrapper');
             const thumbWrapper = document.getElementById('thumbnail-swiper-wrapper');
             const thumbContainer = document.querySelector('.thumbnail-swiper');
             mainWrapper.innerHTML = ''; // Clear existing slides
             thumbWrapper.innerHTML = '';

             // Handle case with no images
             if (!imageUrls || imageUrls.length === 0) {
                 mainWrapper.innerHTML = `<div class="swiper-slide flex items-center justify-center text-gray-400 aspect-[1179/1572]">${i18next.t('common.noImage')}</div>`;
                 thumbContainer.classList.add('hidden');
                 // Destroy existing Swiper instances if they exist
                 if(mainSwiper) mainSwiper.destroy(true, true);
                 if(thumbnailSwiper) thumbnailSwiper.destroy(true, true);
                 mainSwiper = null; thumbnailSwiper = null;
                 return;
             }

             // Populate sliders with image elements
             imageUrls.forEach(key => {
                 const imageUrl = `/api/image/${key}`;
                 // Added crossorigin="anonymous" for html2canvas
                 const imgElement = `<img src="${imageUrl}" alt="${i18next.t('common.cigarImageAlt')}" crossorigin="anonymous" onerror="this.src='https://placehold.co/600x800/gray/white?text=Loading+Failed'; this.onerror=null;">`;
                 mainWrapper.innerHTML += `<div class="swiper-slide">${imgElement}</div>`;
                 thumbWrapper.innerHTML += `<div class="swiper-slide thumbnail-slide">${imgElement}</div>`;
             });

             // Destroy previous instances before re-initializing
             if(mainSwiper) mainSwiper.destroy(true, true);
             if(thumbnailSwiper) thumbnailSwiper.destroy(true, true);

             const hasMultipleItems = imageUrls.length > 1;

             // Initialize thumbnails only if more than one image
             if (hasMultipleItems) {
                 thumbContainer.classList.remove('hidden');
                 thumbnailSwiper = new Swiper('.thumbnail-swiper', {
                     spaceBetween: 10,
                     slidesPerView: 'auto', // Adjust based on number of thumbs
                     freeMode: true,
                     watchSlidesProgress: true,
                 });
                 // Initialize main swiper linked to thumbnails
                 mainSwiper = new Swiper('.main-swiper', {
                     spaceBetween: 10,
                     autoHeight: false, // Keep consistent height if possible
                     navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev', },
                     pagination: { el: '.main-swiper .swiper-pagination', clickable: true, },
                     thumbs: { swiper: thumbnailSwiper, }, // Link thumbs
                 });
             } else { // Only one image
                 thumbContainer.classList.add('hidden'); // Hide thumbnails
                 // Initialize main swiper without navigation/thumbs
                 mainSwiper = new Swiper('.main-swiper', {
                     autoHeight: false, // Keep consistent height
                     pagination: { el: '.main-swiper .swiper-pagination', clickable: true, },
                     allowTouchMove: false // Disable swiping for single image
                 });
             }
        }

        // **MODIFIED**: Function to check if image is loaded
        function isImageLoaded(imgElement) {
            return imgElement && imgElement.complete && imgElement.naturalWidth !== 0;
        }

        // **MODIFIED**: Waits for images before generating share card
        async function autoGenerateShareImage() {
            if (shareImageGenerated) return; // Prevent multiple calls

            const shareCardElement = document.getElementById('share-card-container');
            const coverImageElement = document.getElementById('share-card-image');
            const qrCodeContainer = document.getElementById('share-card-qrcode');
            const mainSwiperWrapper = document.getElementById('main-swiper-wrapper');

            // Safety checks
            if (!shareCardElement || !coverImageElement || !qrCodeContainer || typeof html2canvas === 'undefined' || !resultsData || !mainSwiperWrapper) {
                console.warn("Cannot auto-generate share image: Missing required elements or libraries."); return;
            }

            // --- **NEW**: Wait for cover image and QR code image ---
            const coverImagePromise = new Promise((resolve, reject) => {
                if (isImageLoaded(coverImageElement)) {
                    resolve();
                } else if (!coverImageElement.src || coverImageElement.src.includes('placehold.co')) {
                    // No cover image or placeholder, resolve immediately but maybe skip generation later
                    console.log("No valid cover image set for share card.");
                    resolve('no-cover'); // Indicate no cover
                } else {
                    coverImageElement.onload = resolve;
                    coverImageElement.onerror = () => reject(new Error('Cover image failed to load for share card.'));
                }
            });

            const qrCodeImagePromise = new Promise((resolve, reject) => {
                 // Check if QR code img element exists and is loaded
                 const qrImg = qrCodeContainer.querySelector('img');
                 if (isImageLoaded(qrImg)) {
                      resolve();
                 } else if (qrImg) {
                     // If img exists but not loaded, wait for onload
                     qrImg.onload = resolve;
                     qrImg.onerror = () => reject(new Error('QR code image failed to load for share card.'));
                 } else {
                      // If no img tag yet, assume QR hasn't been generated or failed
                      // We might need to trigger QR generation again or wait differently
                      console.warn("QR code image element not found when trying to generate share card.");
                      // Resolve immediately, but html2canvas might capture blank space
                      resolve('no-qr-img');
                 }
            });

            const statusElement = document.getElementById('loading-indicator');
            try {
                 statusElement.textContent = i18next.t('resultsPage.shareCard.generating');
                 statusElement.classList.remove('hidden');

                 // Wait for both images to be ready
                 console.log("Waiting for share card images (cover & QR)...");
                 const [coverStatus] = await Promise.all([coverImagePromise, qrCodeImagePromise]);
                 console.log("Share card images ready.");

                 // Check if we should skip generation (e.g., no cover image)
                 if (coverStatus === 'no-cover') {
                      console.warn("Skipping share image generation because cover image is missing or invalid.");
                      statusElement.classList.add('hidden');
                      return;
                 }


                 // Temporarily make the hidden card visible
                 shareCardElement.style.visibility = 'visible';
                 await new Promise(resolve => setTimeout(resolve, 300)); // Ensure styles applied

                 // Generate canvas
                 const canvas = await html2canvas(shareCardElement, {
                     useCORS: true,
                     allowTaint: true,
                     scale: 2
                 });
                 const dataUrl = canvas.toDataURL('image/png');

                 // Create and add the new slide
                 const newSlide = document.createElement('div');
                 newSlide.className = 'swiper-slide share-image-slide';
                 newSlide.innerHTML = `<img src="${dataUrl}" alt="${i18next.t('resultsPage.shareImageAlt')}">`;
                 mainSwiperWrapper.appendChild(newSlide);
                 if (mainSwiper) mainSwiper.update(); // Update Swiper
                 shareImageGenerated = true; // Set flag
                 console.log("Share image generated and added to slider.");

            } catch (error) {
                 console.error(i18next.t('resultsPage.shareCard.generateFailed'), error);
                 statusElement.textContent = `${i18next.t('resultsPage.shareCard.generateFailed')} ${error.message}`;
                 // Don't retry automatically on failure
            } finally {
                 // Always hide the card element and status
                 shareCardElement.style.visibility = 'hidden';
                 setTimeout(() => { statusElement.classList.add('hidden'); }, 3000);
            }
        }

        // **NEW**: Helper to attempt share image generation safely
        function tryAutoGenerateShareImage() {
            // Only proceed if not already generated and we have resultsData
            if (!shareImageGenerated && resultsData) {
                // Check if the share card's cover image is set and not a placeholder
                const shareImg = document.getElementById('share-card-image');
                if (shareImg && shareImg.src && !shareImg.src.includes('placehold.co')) {
                    // Call the generation function
                     autoGenerateShareImage();
                } else {
                     console.log("Skipping auto-generation: No valid cover image set for share card yet.");
                }
            }
        }

        // **MODIFIED**: Populates the hidden share card elements (doesn't generate image here)
        function populateShareCard(data) {
             if (!data || !i18next.isInitialized) return;
             const { normalizedScore, finalGrade, userNickname, userEmail, imageUrls = [] } = data;
             const nickname = userNickname || userEmail || i18next.t('common.anonymous');

             // Check if finalGrade exists
             if (!finalGrade || !finalGrade.grade || !finalGrade.nameKey || !finalGrade.color) {
                  console.warn("populateShareCard: finalGrade data missing or incomplete. Cannot populate share card grade.");
                  // Populate score but indicate missing grade
                  document.getElementById('share-card-score').textContent = normalizedScore?.toFixed(2) ?? '?.??';
                  document.getElementById('share-card-grade-badge').textContent = i18next.t('common.unrated');
                  document.getElementById('share-card-grade-badge').className = 'inline-block px-2 py-0.5 rounded-full text-xs font-semibold bg-gray-300 text-gray-800 bg-opacity-20'; // Default style
             } else {
                  // Populate if grade exists
                  const gradeName = i18next.t(finalGrade.nameKey);
                  const gradeStyles = getGradeStyles(finalGrade.color);
                  const scoreEl = document.getElementById('share-card-score');
                  const gradeEl = document.getElementById('share-card-grade-badge');
                  scoreEl.className = `font-black ${gradeStyles.textColor}`;
                  scoreEl.textContent = normalizedScore.toFixed(2);
                  gradeEl.className = `inline-block px-2 py-0.5 rounded-full text-xs font-semibold ${gradeStyles.bgColor} ${gradeStyles.textColor} bg-opacity-20`;
                  gradeEl.textContent = gradeName;
             }

             // Populate other elements
             const watermarkEl = document.getElementById('share-card-watermark');
             watermarkEl.innerHTML = i18next.t('resultsPage.shareCard.userRatingOn', { user: `<span id="share-card-username">${nickname}</span>` });

             // Set cover image source
             const shareCardImage = document.getElementById('share-card-image');
             const shareCardImageWrapper = document.getElementById('share-card-image-wrapper');
             if (imageUrls.length > 0) {
                 shareCardImage.src = `/api/image/${imageUrls[0]}`;
                 shareCardImage.style.display = 'block'; // Ensure img tag is shown
                 // Remove potential placeholder text if image exists
                 const placeholder = shareCardImageWrapper.querySelector('span');
                 if(placeholder) placeholder.remove();
             } else {
                 shareCardImage.src = ''; // Clear src
                 shareCardImage.style.display = 'none'; // Hide img tag
                 // Add placeholder text if not already present
                 if(!shareCardImageWrapper.querySelector('span')) {
                     shareCardImageWrapper.innerHTML = `<span class="text-gray-400 text-sm">${i18next.t('resultsPage.shareCard.noCover')}</span>`;
                 }
             }
        }

        // **MODIFIED**: Generates QR code and resolves promise on image load/error
        function generateQRCode() {
            return new Promise((resolve, reject) => {
                 const qrCodeContainer = document.getElementById('share-card-qrcode');
                 if (qrCodeContainer && typeof QRCode !== 'undefined') {
                    qrCodeContainer.innerHTML = ''; // Clear previous
                    const uniqueUrl = ratingId ? `${window.location.origin}/results.html?ratingId=${ratingId}` : window.location.href.split('?')[0];
                    try {
                         new QRCode(qrCodeContainer, {
                             text: uniqueUrl, width: 90, height: 90,
                             colorDark : "#000000", colorLight : "#ffffff",
                             correctLevel : QRCode.CorrectLevel.H
                         });
                         // --- **NEW**: Wait for image inside QR code to load ---
                         const qrImg = qrCodeContainer.querySelector('img');
                         if (qrImg) {
                             if (isImageLoaded(qrImg)) {
                                 console.log("QR Code image already loaded.");
                                 resolve(); // Already loaded
                             } else {
                                 console.log("Waiting for QR Code image to load...");
                                 qrImg.onload = () => { console.log("QR Code image loaded."); resolve(); };
                                 qrImg.onerror = () => { console.error("QR Code image failed to load."); reject(new Error('QR Code image load failed')); };
                             }
                         } else {
                              console.warn("QR Code generated, but no img tag found immediately.");
                              // Resolve anyway, assuming it might appear later, but generation might fail
                              resolve('no-qr-img');
                         }
                         // --- End New ---
                    } catch (qrError) {
                         console.error("QR Code generation failed:", qrError);
                         qrCodeContainer.innerHTML = `<p class="text-2xs text-red-500">QR Error</p>`;
                         reject(qrError); // Reject promise on error
                    }
                 } else {
                     console.warn(i18next.t('resultsPage.shareCard.qrError'));
                     reject(new Error('QR Code container or library not found.')); // Reject promise
                 }
            });
        }


        // Renders the main content of the results page using the provided data
        function renderPageContent(data) {
            if (!data || !i18next.isInitialized) return; // Ensure data and i18n are ready

            const { cigarInfo, cigarReview, normalizedScore, isDraft, selectedFlavors = [], finalGrade } = data;
            const title = data.title || i18next.t('common.noTitle');
            const userNickname = data.userNickname || data.userEmail || i18next.t('common.anonymous');

            // Validate finalGrade exists before accessing properties
            if (!finalGrade || !finalGrade.grade || !finalGrade.nameKey || !finalGrade.color) {
                 console.error("renderPageContent: finalGrade data is missing or incomplete.", finalGrade);
                 // Handle the error gracefully, maybe display a placeholder
                 document.getElementById('score-section').innerHTML = `<p class="text-red-500">${i18next.t('resultsPage.scoreCalculationFailed')}</p>`;
                 document.getElementById('narrative-summary-container').innerHTML = `<p class="text-red-500 italic">${i18next.t('resultsPage.narrativeGenFailed')}</p>`;
                 document.getElementById('summary-container').innerHTML = ''; // Clear summary too
                 // Continue rendering other parts if possible
                 // Populate static info fields even if grade fails
                 document.getElementById('user-nickname').textContent = userNickname;
                 document.getElementById('rating-title').textContent = title;
                 document.getElementById('cigar-name').textContent = cigarInfo?.name ?? i18next.t('common.unknown');
                 document.getElementById('cigar-size').textContent = cigarInfo?.size ?? i18next.t('common.unknown');
                 document.getElementById('cigar-origin').textContent = cigarInfo?.origin ?? i18next.t('common.unknown');
                 // Render review and flavors (don't depend on grade)
                 const reviewContainer = document.getElementById('cigar-review-container');
                 reviewContainer.innerHTML = (cigarReview && cigarReview.trim() && cigarReview !== i18next.t('common.noReview'))
                    ? `<p>${cigarReview.replace(/\n/g, '<br>')}</p>`
                    : `<p class="text-gray-400 italic">${i18next.t('common.noReview')}</p>`;
                 const flavorsContainer = document.getElementById('selected-flavors-container');
                 if (selectedFlavors.length > 0) {
                     document.getElementById('flavors-display').innerHTML = selectedFlavors
                        .map(flavorKey => `<span class="flavor-tag">${i18next.t(flavorKey) || flavorKey}</span>`)
                        .join('');
                     flavorsContainer.classList.remove('hidden');
                 } else {
                     flavorsContainer.classList.add('hidden');
                 }
                 // Hide details sections if grade failed (as they depend on fullData which might be linked)
                 ['narrative-summary-details', 'summary-details'].forEach(id => {
                     document.getElementById(id).style.display = 'none';
                 });

            } else {
                 // Proceed with rendering if finalGrade is valid
                 const gradeName = i18next.t(finalGrade.nameKey); // Get translated grade name

                 // Populate static info fields
                 document.getElementById('user-nickname').textContent = userNickname;
                 document.getElementById('rating-title').textContent = title;
                 document.getElementById('cigar-name').textContent = cigarInfo?.name ?? i18next.t('common.unknown');
                 document.getElementById('cigar-size').textContent = cigarInfo?.size ?? i18next.t('common.unknown');
                 document.getElementById('cigar-origin').textContent = cigarInfo?.origin ?? i18next.t('common.unknown');


                 // Render written review
                 const reviewContainer = document.getElementById('cigar-review-container');
                 reviewContainer.innerHTML = (cigarReview && cigarReview.trim() && cigarReview !== i18next.t('common.noReview'))
                    ? `<p>${cigarReview.replace(/\n/g, '<br>')}</p>` // Replace newlines with <br>
                    : `<p class="text-gray-400 italic">${i18next.t('common.noReview')}</p>`;

                 // Render selected flavors
                 const flavorsContainer = document.getElementById('selected-flavors-container');
                 if (selectedFlavors.length > 0) {
                     document.getElementById('flavors-display').innerHTML = selectedFlavors
                        .map(flavorKey => `<span class="flavor-tag">${i18next.t(flavorKey) || flavorKey}</span>`) // Translate keys
                        .join('');
                     flavorsContainer.classList.remove('hidden');
                 } else {
                     flavorsContainer.classList.add('hidden');
                 }

                 // Render the score section with grade details
                 renderScoreSection(document.getElementById('score-section'), normalizedScore, { ...finalGrade, name: gradeName }); // Pass translated name

                 // Conditionally show/hide narrative and summary sections based on fullData
                 const hasFullData = data.config && data.ratings;
                 ['narrative-summary-details', 'summary-details'].forEach(id => {
                     const detailElement = document.getElementById(id);
                     if (detailElement) detailElement.style.display = hasFullData ? 'block' : 'none';
                 });


                 // Render narrative summary and details if full data exists
                 if (hasFullData) {
                     document.getElementById('narrative-summary-container').innerHTML = generateNarrativeSummary(cigarInfo, data.config, data.ratings, { ...finalGrade, name: gradeName }, selectedFlavors); // Pass translated name
                     renderSummary(document.getElementById('summary-container'), data.config, data.ratings);
                 }

                 // Populate Hidden Share Card (with translated grade name)
                 populateShareCard(data);

            } // End of else block for valid finalGrade

             // Show/hide save button based on user login and draft status
             const saveButtonContainer = document.getElementById('save-button-container');
             saveButtonContainer.style.display = (currentAuthUser && isDraft) ? 'block' : 'none';
        }

        // --- Initialization on page load ---
        window.onload = async function() {
            // **MODIFIED**: Moved DOM element gets outside try block
            const errorContainer = document.getElementById('error-container');
            const mainContent = document.getElementById('main-content');
            const loadingIndicator = document.getElementById('loading-indicator');

            try {
                 // 1. Init i18n First
                 await initI18n();
                 updateContent(); // Update static text immediately

                 // 2. Handle Authentication
                 const urlParams = new URLSearchParams(window.location.search);
                 const code = urlParams.get('code');
                 ratingId = urlParams.get('ratingId'); // Assign global ratingId

                 let user = code ? await handleOidcCallback(code) : await validateSessionAndGetUser();
                 currentAuthUser = user;
                 renderLoginStatus(currentAuthUser); // Render login status *after* i18n
                 setupLanguageSwitcher(); // Setup switcher

                 // 3. Show Loading Indicator
                 loadingIndicator.classList.remove('hidden');

                 // 4. Fetch Rating Data (either from ID or session storage)
                 if (ratingId) {
                     // Fetch by ID (token optional, handled by API)
                     const token = sessionStorage.getItem('accessToken');
                     const apiUrl = new URL(`/api/ratings?id=${ratingId}`, window.location.origin);
                     const fetchOptions = token ? { headers: { 'Authorization': `Bearer ${token}` } } : {};
                     const response = await fetch(apiUrl, fetchOptions);
                     if (!response.ok) throw new Error(i18next.t('errors.loadRatingFailed', { status: response.status }));
                     resultsData = await response.json();
                     // **FIX**: Explicitly set isDraft to false when loading by ID
                     resultsData.isDraft = false;
                 } else {
                     // Load from session storage (draft)
                     const storedData = sessionStorage.getItem('cigarRatingResults');
                     if (!storedData) throw new Error(i18next.t('errors.noRatingDataFound'));
                     try {
                          resultsData = JSON.parse(storedData);
                          // Ensure isDraft is correctly set (should be true if from session)
                          resultsData.isDraft = true;
                          ratingId = resultsData.ratingId; // Might be null for drafts not yet saved
                     } catch(parseError) {
                          console.error("Error parsing sessionStorage data:", parseError);
                          throw new Error(i18next.t('errors.invalidSessionData'));
                     }
                 }

                 // 5. Validate Essential Data
                 if (!resultsData || resultsData.normalizedScore === undefined || !resultsData.cigarInfo) {
                     throw new Error(i18next.t('errors.missingEssentialData'));
                 }

                 // 6. Initialize UI Components
                 initSwipers(resultsData.imageUrls || []);
                 renderPageContent(resultsData); // Render main content *after* i18n is ready

                 // 7. Generate QR Code and then attempt share image generation
                 // Generate QR Code first, as autoGenerateShareImage depends on it
                 await generateQRCode();
                 tryAutoGenerateShareImage(); // Attempt generation after QR is ready

                 // 8. Hide Loading, Show Content
                 loadingIndicator.classList.add('hidden');
                 mainContent.classList.remove('opacity-0');

            } catch (e) {
                // Handle Errors during initialization
                 loadingIndicator.classList.add('hidden'); // Hide loading indicator on error
                 const errorTitle = i18next.t('errors.pageLoadError');
                 const backLinkText = i18next.t('common.backToCommunity');
                 const rateLinkText = i18next.t('nav.rate');
                 errorContainer.innerHTML = `<p class="font-bold text-center">${errorTitle}: ${e.message}</p>
                                            <div class="mt-4 text-center space-x-4">
                                                 <a href="index.html" class="text-indigo-600 underline">${backLinkText}</a>
                                                 <a href="rate.html" class="text-green-600 underline">${rateLinkText}</a>
                                            </div>`;
                 errorContainer.classList.remove('hidden');
                 mainContent.classList.add('opacity-0'); // Keep main content hidden
                 console.error("Results page initialization error:", e);
            }
        };

        // --- Rendering Utilities ---

        // Generates the narrative summary text
        // **MODIFIED**: Handles potential missing keys and falls back to raw text
        function generateNarrativeSummary(cigarInfo, config, ratings, finalGrade, selectedFlavors) {
            if (!config || !ratings) return `<p class="text-gray-500 italic">${i18next.t('errors.noNarrativeData')}</p>`;

            const { origin = i18next.t('common.unknown'), name = i18next.t('common.unknown'), size = i18next.t('common.unknown') } = cigarInfo || {};
            let summary = `<p>${i18next.t('resultsPage.narrative.part1', { origin, name, size })}`;
            let observations = [];

            (config.ratingCriteria || []).forEach(category => {
                (category.criteriaList || []).forEach(criterion => {
                    // Try getting ID using Keys first (new format)
                    let id = null;
                    if (category.categoryKey && criterion.nameKey) {
                        id = `${category.categoryKey}-${criterion.nameKey}`;
                    } else if (category.category && criterion.name) {
                        // Fallback to using raw text (old format)
                        id = `${category.category}-${criterion.name}`;
                    }

                    if (id) {
                        const selectedOptionIndex = ratings[id];
                        if (selectedOptionIndex !== undefined && criterion.options && criterion.options[selectedOptionIndex]) {
                            const option = criterion.options[selectedOptionIndex];

                            // Try to translate using Keys, fallback to raw text, fallback to '?'
                            const criterionText = i18next.t(criterion.nameKey || criterion.name || '?');
                            const optionText = i18next.t(option.descriptionKey || option.description || '?');

                            // If translation failed (returned the key/text itself), use the raw text if available
                            const finalCriterionText = (criterionText === criterion.nameKey || criterionText === criterion.name || criterionText === '?') ? (criterion.name || '?') : criterionText;
                            const finalOptionText = (optionText === option.descriptionKey || optionText === option.description || optionText === '?') ? (option.description || '?') : optionText;

                            observations.push(i18next.t('resultsPage.narrative.observation', { criterion: finalCriterionText, option: finalOptionText }));
                        }
                    } else {
                         console.warn("Could not determine ID for criterion in generateNarrativeSummary:", {category, criterion});
                    }
                });
            });

            if (observations.length > 0) { summary += ` ${i18next.t('resultsPage.narrative.part2', { observations: observations.join('；') })}`; }
            else { summary += ` ${i18next.t('resultsPage.narrative.noObservations')}`; }

            // Translate flavor keys
            if (selectedFlavors.length > 0) {
                 const translatedFlavors = selectedFlavors.map(key => i18next.t(key) || key).join(', ');
                 summary += ` ${i18next.t('resultsPage.narrative.part3', { flavors: translatedFlavors })}`;
            }

            // Ensure finalGrade.name (translated) exists before using
            const gradeNameForNarrative = finalGrade?.name ?? i18next.t('common.unrated');
            const gradeLetterForNarrative = finalGrade?.grade ?? '?';

            const hierarchy = GRADING_SCALE.map(g => `${g.grade}(${i18next.t(g.nameKey)})`).join(', ');
            summary += ` ${i18next.t('resultsPage.narrative.part4', { grade: gradeLetterForNarrative, gradeName: gradeNameForNarrative, hierarchy: hierarchy })}`;
            summary += `</p>`;
            return summary;
        }


        // Renders the detailed rating summary section
        // **MODIFIED**: Handles potential missing keys and falls back to raw text
        function renderSummary(container, config, ratings) {
            if (!container || !config || !ratings) { container.innerHTML = `<p class="text-gray-500 italic">${i18next.t('errors.noSummaryData')}</p>`; return; }

            let summaryHtml = (config.ratingCriteria || []).map(category => {
                const criteriaHtml = (category.criteriaList || []).map(criterion => {
                    // Try getting ID using Keys first (new format)
                    let id = null;
                    if (category.categoryKey && criterion.nameKey) {
                        id = `${category.categoryKey}-${criterion.nameKey}`;
                    } else if (category.category && criterion.name) {
                        // Fallback to using raw text (old format)
                        id = `${category.category}-${criterion.name}`;
                    }

                    if (id) {
                        const selectedOptionIndex = ratings[id];
                        if (selectedOptionIndex !== undefined && criterion.options && criterion.options[selectedOptionIndex]) {
                            const option = criterion.options[selectedOptionIndex];

                            // Try to translate using Keys, fallback to raw text, fallback to '?'
                            const criterionText = i18next.t(criterion.nameKey || criterion.name || '?');
                            const optionText = i18next.t(option.descriptionKey || option.description || '?');

                             // If translation failed (returned the key/text itself), use the raw text if available
                            const finalCriterionText = (criterionText === criterion.nameKey || criterionText === criterion.name || criterionText === '?') ? (criterion.name || '?') : criterionText;
                            const finalOptionText = (optionText === option.descriptionKey || optionText === option.description || optionText === '?') ? (option.description || '?') : optionText;


                            return `<li><strong>${finalCriterionText}:</strong> ${finalOptionText}</li>`;
                        }
                    } else {
                         console.warn("Could not determine ID for criterion in renderSummary:", {category, criterion});
                    }
                    return ''; // Return empty string if not rated or ID not found
                }).join('');

                if (criteriaHtml.trim()) {
                    // Try to translate category title using Key, fallback to raw text
                    const categoryTitle = i18next.t(category.categoryKey || category.category || '?');
                    // If translation failed, use raw text
                    const finalCategoryTitle = (categoryTitle === category.categoryKey || categoryTitle === category.category || categoryTitle === '?') ? (category.category || '?') : categoryTitle;

                    return `<h4 class="font-semibold mt-4 mb-1 text-gray-700">${finalCategoryTitle}</h4><ul class="list-disc list-inside space-y-1 text-sm">${criteriaHtml}</ul>`;
                }
                return ''; // Return empty string if no criteria were rated in this category
            }).join('');

            container.innerHTML = summaryHtml || `<p>${i18next.t('resultsPage.summary.noItems')}</p>`;
        }
        // --- End Rendering Utilities ---
        // --- Rendering Utilities (Continued) ---

        // Generates the score range string (e.g., "80-89.99") for a grade
        function getScoreRange(gradeCode) {
            const index = GRADING_SCALE.findIndex(g => g.grade === gradeCode);
            if (index === -1) return ''; // Grade not found
            const min = GRADING_SCALE[index].min_score;
            if (index === 0) return `${min}-100`; // Highest grade
            // Lower bound of the grade above current
            const max = GRADING_SCALE[index - 1].min_score - 0.01;
            return `${min.toFixed(0)}-${max.toFixed(2)}`;
        }

        // Returns Tailwind CSS classes for a given grade color name
        function getGradeStyles(color) {
            const stylesMap = { // Mapping grade colors to Tailwind classes
                'gold': { textColor: 'text-yellow-800', bgColor: 'bg-yellow-400' },
                'indigo': { textColor: 'text-indigo-800', bgColor: 'bg-indigo-300' },
                'purple': { textColor: 'text-purple-800', bgColor: 'bg-purple-300' },
                'blue': { textColor: 'text-blue-800', bgColor: 'bg-blue-300' },
                'green': { textColor: 'text-green-800', bgColor: 'bg-green-300' },
                'gray': { textColor: 'text-gray-800', bgColor: 'bg-gray-300' },
                'orange': { textColor: 'text-orange-800', bgColor: 'bg-orange-300' },
                'red': { textColor: 'text-red-800', bgColor: 'bg-red-300' }
            };
            return stylesMap[color] || stylesMap['gray']; // Default to gray if color unknown
        }

         // Renders the score section with the main score, grade, and the grading scale visual
         function renderScoreSection(container, score, grade) {
             if (!container || !grade || !i18next.isInitialized) return; // Safety check
             const styles = getGradeStyles(grade.color); // Get color classes for the grade
             // HTML for the main score and grade display
             const scoreHtml = `
                <div>
                    <p class="text-xl font-bold text-yellow-500 mb-1">${i18next.t('resultsPage.scoreSectionTitle')}</p>
                    <p class="text-7xl font-black ${styles.textColor}">${score?.toFixed(2) ?? '?.??'}</p>
                    <div class="mt-2 text-3xl font-black ${styles.textColor}">${grade.name ?? i18next.t('common.unrated')}</div>
                </div>`;
             // HTML for the grading scale visual
             const scaleHtml = GRADING_SCALE.map(g => {
                 const gStyles = getGradeStyles(g.color); // Get colors for this scale item
                 const isCurrent = g.grade === grade.grade; // Check if this is the current grade
                 return `
                    <div class="flex items-center p-1 rounded ${isCurrent ? 'bg-gray-100' : ''}">
                        <div class="w-5 h-5 rounded-full flex items-center justify-center font-bold text-xs ${gStyles.bgColor} ${gStyles.textColor} mr-2">${g.grade}</div>
                        <div class="flex-grow ${isCurrent ? 'font-semibold' : ''} ${gStyles.textColor}">${i18next.t(g.nameKey)}</div>
                        <div class="font-mono text-xs text-gray-500 ml-2">${getScoreRange(g.grade)}</div>
                    </div>`;
             }).join('');
             // Combine score and scale HTML into the container
             container.innerHTML = `
                <div class="w-full md:w-1/3">${scoreHtml}</div>
                <div class="w-full md:w-2/3 border-t md:border-t-0 md:border-l border-gray-200 pt-4 md:pt-0 md:pl-6">
                    <div class="space-y-1">${scaleHtml}</div>
                </div>`;
         }
        // --- End Rendering Utilities ---

    </script>
</body>
</html>
