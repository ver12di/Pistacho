<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雪茄品鉴 - 评分报告</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind config remains the same
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const appId = 'pistacho-b9efe';
        const firebaseConfig = JSON.parse('{"apiKey":"AIzaSyDC-8qbWsjRyxBzJpfCi9n3ftzdg9FStF0","authDomain":"pistacho-b9efe.firebaseapp.com","projectId":"pistacho-b9efe","storageBucket":"pistacho-b9efe.appspot.com","messagingSenderId":"686695750713","appId":"1:686695750713:web:5314331be7b46e93f401e8","measurementId":"G-HQS7Q78LY7"}');

        const GRADING_SCALE = [ /* PISTACHO scale remains the same */ ];

        let db, auth;
        let currentAuthUser = null;
        let resultsData = null; 
        let normalizedScore = 0;
        let finalGrade = null;
        const RATINGS_COLLECTION_PATH = `/artifacts/${appId}/public/data/ratings`;

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) { console.error("Firebase init failed", e); }

        window.saveRating = async function() { /* saveRating function remains the same */ };

        window.onload = function() {
            const mainContent = document.getElementById('main-content');
            const errorContainer = document.getElementById('error-container');
            
            onAuthStateChanged(auth, (user) => {
                currentAuthUser = user;
                const storedData = sessionStorage.getItem('cigarRatingResults');
                if (!storedData) { /* ... error handling ... */ return; }

                try {
                    resultsData = JSON.parse(storedData);
                    const { config, ratings, calculatedScore, cigarInfo, cigarReview, isDraft } = resultsData;
                    
                    // ... (score and grade calculation remains the same) ...
                    
                    const maxScore = config.totalWeightMax || 100;
                    normalizedScore = maxScore > 0 ? (calculatedScore / maxScore) * 100 : 0;
                    
                    finalGrade = GRADING_SCALE[GRADING_SCALE.length - 1];
                    for (const grade of GRADING_SCALE) {
                        if (normalizedScore >= grade.min_score) {
                            finalGrade = grade;
                            break;
                        }
                    }

                    // (*** 已修改：根据 isDraft 标记来显示保存按钮 ***)
                    const saveButtonContainer = document.getElementById('save-button-container');
                    if (user && !user.isAnonymous && isDraft) { // Only show if it's a draft
                        if (saveButtonContainer) {
                            saveButtonContainer.classList.remove('hidden');
                        }
                    }
                    
                    // ... (All other rendering calls remain the same) ...
                } catch (e) {
                     // ... error handling ...
                }
            });
        }
        
        // --- All other rendering functions remain the same ---
    </script>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">
    <!-- Body HTML remains the same -->
</body>
</html>

