<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雪茄品鉴 - 点评报告</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- QRCode.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Swiper.js CSS (using cdnjs) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/11.0.5/swiper-bundle.min.css"/>
    <!-- Swiper.js JS (using cdnjs, deferred) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/11.0.5/swiper-bundle.min.js" defer></script>
    <script>
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: { sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'], },
                        keyframes: {
                            fadeInUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' }, },
                            highlight: { '0%, 100%': { transform: 'scale(1)', boxShadow: '0 0 0 rgba(66, 153, 225, 0)' }, '50%': { transform: 'scale(1.02)', boxShadow: '0 0 15px rgba(66, 153, 225, 0.4)' }, }
                        },
                        animation: { fadeInUp: 'fadeInUp 0.8s ease-out forwards', highlight: 'highlight 2.5s ease-in-out infinite', }
                    }
                }
            }
        } else { console.warn('Tailwind object not found. Skipping config.'); }
    </script>
    <style>
        .tooltip { position: relative; display: inline-block; } .tooltip .tooltiptext { visibility: hidden; width: 80px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 5px 0; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -40px; opacity: 0; transition: opacity 0.3s; } .tooltip .tooltiptext::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #555 transparent transparent transparent; } .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .swiper-container { width: 100%; } .swiper-slide img { display: block; width: 100%; height: 100%; object-fit: cover; } .swiper-button-next, .swiper-button-prev { color: #fff; background-color: rgba(0,0,0,0.3); padding: 10px; border-radius: 50%; width: 40px; height: 40px; } .swiper-button-next::after, .swiper-button-prev::after { font-size: 1.2rem; } .swiper-pagination-bullet-active { background: #4f46e5; /* Indigo */ } .thumbnail-swiper .swiper-slide { width: 60px !important; /* Fixed width for thumbnails */ height: 80px; opacity: 0.6; cursor: pointer; border: 2px solid transparent; transition: opacity 0.3s, border-color 0.3s; } .thumbnail-swiper .swiper-slide-thumb-active { opacity: 1; border-color: #4f46e5; /* Indigo */ } .thumbnail-swiper { margin-top: 0.5rem; padding: 5px 0; }
        #narrative-summary-container, #cigar-review-container, #selected-flavors-container { max-width: 100%; }
        /* Style for flavor tags */
        .flavor-tag {
            display: inline-block; background-color: #e5e7eb; color: #374151; font-size: 0.75rem; font-weight: 600; margin-right: 0.5rem; margin-bottom: 0.5rem; padding-left: 0.625rem; padding-right: 0.625rem; padding-top: 0.125rem; padding-bottom: 0.125rem; border-radius: 9999px;
        }
        /* Styles for the hidden share card */
        #share-card-container {
            position: absolute; left: -9999px; top: 0; width: 350px;
            background-color: white; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); overflow: hidden; border: 1px solid #e5e7eb;
        }
        #share-card-image-wrapper { height: 467px; background-color: #e5e7eb; display: flex; align-items: center; justify-content: center; }
        #share-card-image { width: 100%; height: 100%; object-fit: cover; }
        #share-card-content { padding: 1rem; position: relative; } /* Added relative positioning for QR code */
        #share-card-score-grade { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; /* Removed border-t */ }
        #share-card-score { font-size: 3rem; font-weight: 900; }
        #share-card-grade { text-align: right; }
        #share-card-grade-badge { display: inline-block; padding-left: 0.5rem; padding-right: 0.5rem; padding-top: 0.125rem; padding-bottom: 0.125rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        #share-card-watermark { font-size: 0.75rem; color: #9ca3af; padding-top: 0.5rem; margin-top: 0.5rem; }
        /* QR Code Styling */
        #share-card-qrcode {
            position: absolute;
            bottom: 0.5rem; /* Adjust as needed */
            right: 0.5rem; /* Adjust as needed */
            width: 30%; /* Approximately 1/3 */
            height: auto;
            border: 2px solid white; /* Optional: adds a border */
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
         #share-card-qrcode img { /* Ensure QR code image fits */
             display: block;
             width: 100%;
             height: 100%;
         }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">
    <div class="max-w-6xl mx-auto p-4 md:p-8">
        <div id="error-container" class="hidden bg-red-100 p-6 rounded-lg shadow-lg text-red-700 font-medium"></div>
        <div id="main-content" class="opacity-0">
            <nav class="mb-6 flex flex-wrap justify-between items-center bg-white p-3 rounded-lg shadow-sm gap-4">
                 <a href="index.html" class="text-xl font-bold text-indigo-600">Pistacho评分</a>
                 <div class="flex items-center space-x-4 flex-grow justify-center md:justify-start md:flex-grow-0 order-3 md:order-2 w-full md:w-auto"> <a href="index.html" class="text-gray-600 hover:text-indigo-600">社区动态</a> <a href="rate.html" class="text-gray-600 hover:text-indigo-600">去评分</a> <a href="history.html" class="text-gray-600 hover:text-indigo-600">我的评分</a> <a href="certified.html" class="text-gray-600 hover:text-indigo-600">认证评分</a> </div>
                 <div id="login-status-container" class="flex items-center order-2 md:order-3"></div>
            </nav>

            <div class="flex flex-col md:flex-row gap-6 md:gap-8 mb-8">
                <div class="w-full md:w-2/5 flex-shrink-0">
                     <div id="image-gallery-container" class="bg-white rounded-lg shadow-md overflow-hidden">
                         <div class="swiper-container main-swiper aspect-[1179/1572] bg-gray-200"> <div class="swiper-wrapper" id="main-swiper-wrapper"> <div class="swiper-slide flex items-center justify-center text-gray-400">无图</div> </div> <div class="swiper-pagination"></div> <div class="swiper-button-next"></div> <div class="swiper-button-prev"></div> </div>
                         <div class="swiper-container thumbnail-swiper hidden"> <div class="swiper-wrapper" id="thumbnail-swiper-wrapper"> </div> </div>
                     </div>
                </div>
                 <div class="w-full md:flex-grow bg-white rounded-lg shadow-md p-6">
                     <p class="text-sm text-gray-500 mb-1">点评来自: <span id="user-nickname" class="font-medium text-gray-700">加载中...</span></p>
                     <h1 id="rating-title" class="text-3xl font-bold mb-3">加载中...</h1>
                     <h2 id="cigar-name" class="text-xl font-semibold mb-1">加载中...</h2>
                     <div class="mb-4 text-sm text-gray-600 flex space-x-4"> <span>尺寸: <strong id="cigar-size">...</strong></span> <span>产地: <strong id="cigar-origin">...</strong></span> </div>
                     <div id="cigar-review-container" class="prose prose-sm max-w-none text-gray-700 border-t pt-4"> <p>加载中...</p> </div>
                     <div id="selected-flavors-container" class="hidden pt-2">
                         <h4 class="text-sm font-semibold text-gray-600 mb-2">主要风味:</h4>
                         <div id="flavors-display" class="flex flex-wrap"></div>
                     </div>
                 </div>
            </div>

            <section id="score-section" class="bg-white rounded-xl shadow-lg p-6 mb-8 flex flex-col md:flex-row gap-6 items-center">
                 <div id="score-display" class="w-full md:w-1/3 flex-shrink-0">
                 </div>
                 <div id="grading-scale-explanation" class="w-full md:w-2/3 flex-grow border-t md:border-t-0 md:border-l border-gray-200 pt-4 md:pt-0 md:pl-6">
                 </div>
            </section>

             <div id="save-button-container" class="hidden mb-6"> <button id="save-rating-button" onclick="saveRating()" class="w-full py-3 px-6 bg-green-600 text-white font-bold text-lg rounded-lg shadow-md hover:bg-green-700 transition"> 保存为我的评分记录 </button> </div>

            <div class="space-y-4">
                 <details id="narrative-summary-details" class="group bg-white rounded-xl shadow-lg p-6 transition-all duration-300" open> <summary class="flex justify-between items-center cursor-pointer font-bold text-lg text-gray-800"> <span> 综合评价 <svg class="inline w-5 h-5 transform group-open:rotate-180 transition-transform ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg> </span> <div class="tooltip"> <button id="copy-summary-button" onclick="copySummary(event)" class="ml-4 p-1.5 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition text-xs"> <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /> </svg> </button> <span id="copy-tooltip" class="tooltiptext">复制</span> </div> </summary> <div id="narrative-summary-container" class="mt-4 prose max-w-none"></div> </details>
                 <details id="summary-details" class="group bg-white rounded-xl shadow-lg p-6"> <summary class="flex justify-between items-center cursor-pointer font-bold text-lg text-gray-800"> 评分详情汇总 <svg class="w-5 h-5 transform group-open:rotate-180 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg> </summary> <div id="summary-container" class="mt-4"></div> </details>
            </div>

            <footer class="mt-8 flex flex-col sm:flex-row justify-center items-center gap-4">
                 <a href="rate.html" class="py-3 px-6 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition"> &larr; 返回重新评分 </a>
                 <!-- Modified Button -->
                 <button id="generate-share-card-btn" onclick="generateShareImage()" class="py-3 px-6 bg-teal-600 text-white font-bold rounded-lg shadow-md hover:bg-teal-700 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                     生成分享图
                 </button>
            </footer>
        </div>
    </div>

    <!-- Hidden structure for the share card -->
    <div id="share-card-container">
        <div id="share-card-image-wrapper">
            <img id="share-card-image" src="" alt="Cigar Cover Image" crossorigin="anonymous">
        </div>
        <!-- Modified Content Structure -->
        <div id="share-card-content">
            <div id="share-card-score-grade">
                <span id="share-card-score">0.00</span>
                <div id="share-card-grade">
                    <!-- Display full grade name -->
                    <span id="share-card-grade-badge">? - ???</span>
                </div>
            </div>
            <!-- Modified Watermark and QR Code Container -->
            <div class="flex justify-between items-end mt-2">
                 <p id="share-card-watermark">
                     <span id="share-card-username">用户</span> 评分于 Pistacho评分系统 www.pista-cho.com
                 </p>
                 <div id="share-card-qrcode"></div>
            </div>
        </div>
    </div>


    <script type="module">
        // --- Constants and Global Vars ---
        const GRADING_SCALE = [ { "grade": "P", "name_en": "Pinnacle", "name_cn": "顶峰 / 登峰造极", "min_score": 95, "color": "gold" }, { "grade": "I", "name_en": "Impeccable", "name_cn": "无暇 / 完美无瑕", "min_score": 90, "color": "indigo" }, { "grade": "S", "name_en": "Superior", "name_cn": "卓越 / 出众", "min_score": 80, "color": "purple" }, { "grade": "T", "name_en": "Terrific", "name_cn": "极好 / 绝佳", "min_score": 70, "color": "blue" }, { "grade": "A", "name_en": "Appreciable", "name_cn": "可圈可点 / 值得欣赏", "min_score": 60, "color": "green" }, { "grade": "C", "name_en": "Commonplace", "name_cn": "平庸 / 普通", "min_score": 50, "color": "gray" }, { "grade": "H", "name_en": "Hesitant", "name_cn": "犹豫 / 瑕瑜互见", "min_score": 30, "color": "orange" }, { "grade": "O", "name_en": "Objectionable", "name_cn": "令人反感 / 极差", "min_score": 0, "color": "red" } ];
        let currentAuthUser = null; let resultsData = null; let normalizedScore = 0; let finalGrade = null;
        const AUTHING_APP_ID = '68f5b0b6875017c02b3bfdb3'; const AUTHING_HOST = 'https://xfvu647mcdbk-demo.authing.cn';
        let mainSwiper = null; let thumbnailSwiper = null;

        // --- Authentication ---
         window.login = function() { const redirectUri = window.location.origin; const authorizeUrl = new URL('/oidc/auth', AUTHING_HOST); authorizeUrl.search = new URLSearchParams({ client_id: AUTHING_APP_ID, redirect_uri: redirectUri, response_type: 'code', scope: 'openid profile email phone', state: Math.random().toString(36).substring(2) }).toString(); window.location.href = authorizeUrl.toString(); }
         window.logout = function() { const logoutUrl = new URL('/oidc/session/end', AUTHING_HOST); logoutUrl.search = new URLSearchParams({ post_logout_redirect_uri: window.location.origin }).toString(); sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken'); window.location.href = logoutUrl.toString(); }
         function renderLoginStatus(user) { const container = document.getElementById('login-status-container'); if (!container) return; if (user) { const displayName = user.nickname || user.name || user.preferred_username || user.email || '已登录'; container.innerHTML = `<span class="text-sm font-medium text-gray-700 mr-2 hidden sm:inline">${displayName}</span><button onclick="logout()" class="px-3 py-1 text-xs font-medium rounded-full bg-red-500 text-white hover:bg-red-600">退出</button>`; } else { container.innerHTML = `<button onclick="login()" class="px-3 py-1 text-xs font-medium rounded-full bg-green-500 text-white hover:bg-green-600">登录/注册</button>`; } }
         async function handleOidcCallback(code) { try { const redirectUri = window.location.origin; const apiUrl = new URL('/api/authing/callback', window.location.origin); const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code: code, redirect_uri: redirectUri }) }); if (!response.ok) { let errorText = `认证回调失败: ${response.status}`; try { const err = await response.json(); errorText = err.error || errorText; } catch(e){} throw new Error(errorText); } const fullUserProfile = await response.json(); sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile)); sessionStorage.setItem('accessToken', fullUserProfile.accessToken); return fullUserProfile; } catch (e) { console.error('认证回调处理失败:', e); alert(`登录失败: ${e.message}`); sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken'); return null; } finally { window.history.replaceState({}, document.title, window.location.pathname); } }
         async function validateSessionAndGetUser() { const token = sessionStorage.getItem('accessToken'); if (!token) return null; try { const apiUrl = new URL('/api/me', window.location.origin); const response = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${token}` } }); if (!response.ok) { sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken'); return null; } const fullUserProfile = await response.json(); sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile)); return fullUserProfile; } catch (e) { console.error("Session validation failed:", e); return null; } }


        // --- Save Rating (Drafts only) ---
        window.saveRating = async function() { /* Placeholder */ };

        // --- Copy Summary Function ---
        window.copySummary = function(event) { /* Placeholder */ };

        // --- Initialize Swiper ---
        function initSwipers(imageUrls = []) { const mainWrapper = document.getElementById('main-swiper-wrapper'); const thumbWrapper = document.getElementById('thumbnail-swiper-wrapper'); const thumbContainer = document.querySelector('.thumbnail-swiper'); mainWrapper.innerHTML = ''; thumbWrapper.innerHTML = ''; if (!imageUrls || imageUrls.length === 0) { mainWrapper.innerHTML = '<div class="swiper-slide flex items-center justify-center text-gray-400">无图</div>'; thumbContainer.classList.add('hidden'); if(mainSwiper) mainSwiper.destroy(true, true); if(thumbnailSwiper) thumbnailSwiper.destroy(true, true); mainSwiper = null; thumbnailSwiper = null; return; } imageUrls.forEach(key => { const imageUrl = `/api/image/${key}`; const imgElement = `<img src="${imageUrl}" alt="雪茄图片" crossorigin="anonymous" onerror="this.src='https://placehold.co/600x800/gray/white?text=Loading+Failed'; this.onerror=null;">`; mainWrapper.innerHTML += `<div class="swiper-slide">${imgElement}</div>`; thumbWrapper.innerHTML += `<div class="swiper-slide thumbnail-slide">${imgElement}</div>`; }); if(mainSwiper) mainSwiper.destroy(true, true); if(thumbnailSwiper) thumbnailSwiper.destroy(true, true); if (imageUrls.length > 1) { thumbContainer.classList.remove('hidden'); thumbnailSwiper = new Swiper('.thumbnail-swiper', { spaceBetween: 10, slidesPerView: 'auto', freeMode: true, watchSlidesProgress: true, }); mainSwiper = new Swiper('.main-swiper', { spaceBetween: 10, navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev', }, pagination: { el: '.swiper-pagination', clickable: true, }, thumbs: { swiper: thumbnailSwiper, }, simulateTouch: true, touchRatio: 1, touchAngle: 45, grabCursor: true, }); } else { thumbContainer.classList.add('hidden'); mainSwiper = new Swiper('.main-swiper', { allowTouchMove: false, }); } }


        // --- Modified Function to Generate Share Image ---
        window.generateShareImage = async function() {
            const shareCardElement = document.getElementById('share-card-container');
            const generateBtn = document.getElementById('generate-share-card-btn');
            const coverImageElement = document.getElementById('share-card-image');
            const mainSwiperWrapper = document.getElementById('main-swiper-wrapper');
            const thumbSwiperWrapper = document.getElementById('thumbnail-swiper-wrapper');


            if (!shareCardElement || !coverImageElement || !html2canvas || !resultsData || !mainSwiperWrapper) {
                alert("无法生成图片：缺少必要组件。");
                return;
            }

            generateBtn.textContent = '正在生成...';
            generateBtn.disabled = true;

            const coverImageUrl = coverImageElement.src;
            if (!coverImageUrl || coverImageUrl.includes('placehold.co') || !coverImageElement.complete || coverImageElement.naturalWidth === 0) {
                 alert("封面图片未加载或加载失败，无法生成分享图。");
                 generateBtn.textContent = '生成分享图';
                 generateBtn.disabled = !(coverImageUrl && !coverImageUrl.includes('placehold.co'));
                 return;
            }

            shareCardElement.style.visibility = 'visible';
            shareCardElement.style.left = '0';
            shareCardElement.style.top = '0';
            shareCardElement.style.zIndex = '-1';

            try {
                await new Promise(resolve => setTimeout(resolve, 100));

                const canvas = await html2canvas(shareCardElement, {
                    useCORS: true,
                    allowTaint: true,
                    scale: 2
                });

                const dataUrl = canvas.toDataURL('image/png');

                // Create new slide elements
                const newSlide = document.createElement('div');
                newSlide.className = 'swiper-slide';
                const newImg = document.createElement('img');
                newImg.src = dataUrl;
                newImg.alt = '分享图片';
                newImg.style.cursor = 'pointer'; // Make it look clickable
                newImg.onclick = () => { // Add download on click
                     const link = document.createElement('a');
                     link.download = `pistacho-rating-${resultsData.cigarInfo?.name?.replace(/\s+/g, '-') || 'share'}.png`;
                     link.href = dataUrl;
                     link.click();
                };
                newSlide.appendChild(newImg);

                // Append to main swiper
                mainSwiperWrapper.appendChild(newSlide);
                if (mainSwiper) {
                    mainSwiper.update(); // Update the swiper instance
                    mainSwiper.slideTo(mainSwiper.slides.length - 1); // Go to the new slide
                }

                // (Optional) Add to thumbnail swiper
                if (thumbnailSwiper && thumbSwiperWrapper) {
                     const newThumbSlide = document.createElement('div');
                     newThumbSlide.className = 'swiper-slide thumbnail-slide';
                     const newThumbImg = document.createElement('img');
                     newThumbImg.src = dataUrl;
                     newThumbImg.alt = '分享缩略图';
                     newThumbSlide.appendChild(newThumbImg);
                     thumbSwiperWrapper.appendChild(newThumbSlide);
                     thumbnailSwiper.update();
                }

                generateBtn.textContent = '分享图已添加'; // Keep disabled

            } catch (error) {
                console.error("生成或添加分享图片失败:", error);
                alert(`生成或添加分享图片失败: ${error.message}`);
                generateBtn.textContent = '生成分享图'; // Re-enable on error
                generateBtn.disabled = false;
            } finally {
                 shareCardElement.style.left = '-9999px';
                 shareCardElement.style.visibility = 'hidden';
                 shareCardElement.style.zIndex = 'auto';
            }
        }

        // --- Page Load Logic ---
        window.onload = async function() {
            const storedData = sessionStorage.getItem('cigarRatingResults');
            const errorContainer = document.getElementById('error-container');
            const mainContent = document.getElementById('main-content');
            const generateBtn = document.getElementById('generate-share-card-btn'); // Changed ID

            const urlParams = new URLSearchParams(window.location.search); const code = urlParams.get('code'); let user = null;
            if (code) { user = await handleOidcCallback(code); } else { user = await validateSessionAndGetUser(); }
            currentAuthUser = user; renderLoginStatus(currentAuthUser);

            if (!storedData) { errorContainer.innerHTML = `<p class="font-bold text-center">没有找到评分数据！<a href="index.html" class="text-indigo-600 underline">返回社区</a> 或 <a href="rate.html" class="text-indigo-600 underline">去评分</a></p>`; errorContainer.classList.remove('hidden'); if (mainContent) mainContent.style.display = 'none'; return; }

            try {
                resultsData = JSON.parse(storedData);
                console.log("Results data loaded:", resultsData);

                if (!resultsData || resultsData.normalizedScore === undefined || !resultsData.finalGrade || !resultsData.cigarInfo) {
                     console.error("Loaded data is missing essential fields:", resultsData);
                     throw new Error("存储的点评数据缺少基本信息 (分数, 评级, 雪茄信息)。请尝试重新评分。");
                }
                const title = resultsData.title || '无标题点评';

                const { cigarInfo, cigarReview, normalizedScore: score, isDraft } = resultsData;
                const imageUrlsData = resultsData.imageUrls || resultsData.imageUrl || [];
                const selectedFlavors = Array.isArray(resultsData.selectedFlavors) ? resultsData.selectedFlavors : [];
                console.log("Selected Flavors:", selectedFlavors);

                normalizedScore = score;
                finalGrade = resultsData.finalGrade;
                if (!finalGrade || !finalGrade.grade || !finalGrade.color) {
                     console.warn("finalGrade object incomplete or missing, reconstructing from score...");
                     const foundGrade = GRADING_SCALE.find(g => normalizedScore >= g.min_score) || GRADING_SCALE[GRADING_SCALE.length - 1];
                     finalGrade = foundGrade ? { grade: foundGrade.grade, name_cn: foundGrade.name_cn, name_en: foundGrade.name_en, color: foundGrade.color } : null;
                }

                if (!finalGrade) { throw new Error("无法确定评级信息。"); }

                 const userNickname = resultsData.userNickname || resultsData.userEmail || '匿名用户'; // Get nickname for watermark
                 document.getElementById('user-nickname').textContent = userNickname;
                 document.getElementById('rating-title').textContent = title;
                 document.getElementById('cigar-name').textContent = cigarInfo.name;
                 document.getElementById('cigar-size').textContent = cigarInfo.size;
                 document.getElementById('cigar-origin').textContent = cigarInfo.origin;

                const reviewContainer = document.getElementById('cigar-review-container');
                if (cigarReview && cigarReview !== '无') { reviewContainer.innerHTML = `<p>${cigarReview}</p>`; }
                else { reviewContainer.innerHTML = `<p class="text-gray-400 italic">未填写文字评价。</p>`; }

                const flavorsContainer = document.getElementById('selected-flavors-container');
                const flavorsDisplay = document.getElementById('flavors-display');
                if (selectedFlavors.length > 0) {
                     flavorsDisplay.innerHTML = selectedFlavors.map(f => `<span class="flavor-tag">${f}</span>`).join('');
                     flavorsContainer.classList.remove('hidden');
                     console.log("Flavors displayed.");
                } else {
                     flavorsContainer.classList.add('hidden');
                     console.log("No flavors to display.");
                }

                let images = [];
                if(Array.isArray(imageUrlsData)) { images = imageUrlsData; }
                else if (typeof imageUrlsData === 'string' && imageUrlsData) { try { images = JSON.parse(imageUrlsData); if (!Array.isArray(images)) images = [imageUrlsData]; } catch(e){ images = [imageUrlsData]; } }
                initSwipers(images);

                renderScoreSection(document.getElementById('score-section'), normalizedScore, finalGrade);

                const saveButtonContainer = document.getElementById('save-button-container');
                if (currentAuthUser && isDraft) { saveButtonContainer?.classList.remove('hidden'); }

                const narrativeDetails = document.getElementById('narrative-summary-details'); const summaryDetails = document.getElementById('summary-details');
                const hasFullData = resultsData.config && resultsData.ratings && resultsData.calculatedScore !== undefined;

                if (hasFullData) {
                    const { config, ratings } = resultsData;
                    const narrativeSummary = generateNarrativeSummary(cigarInfo, config, ratings, finalGrade, selectedFlavors);
                    document.getElementById('narrative-summary-container').innerHTML = narrativeSummary; narrativeDetails.classList.remove('hidden');
                    renderSummary(document.getElementById('summary-container'), config, ratings); summaryDetails.classList.remove('hidden');
                } else {
                    narrativeDetails.classList.add('hidden'); summaryDetails.classList.add('hidden');
                    const limitedDataMessage = document.createElement('p'); limitedDataMessage.className = 'text-center text-sm text-gray-500 my-4 p-4 bg-yellow-100 rounded'; limitedDataMessage.textContent = '提示：此为旧版评分记录，部分详细信息无法显示。'; mainContent.insertBefore(limitedDataMessage, mainContent.querySelector('footer').previousSibling);
                }

                // --- Populate Hidden Share Card ---
                const shareCardImage = document.getElementById('share-card-image');
                const shareCardScore = document.getElementById('share-card-score');
                const shareCardGradeBadge = document.getElementById('share-card-grade-badge');
                const shareCardUsername = document.getElementById('share-card-username'); // Get username span
                const shareCardQrCode = document.getElementById('share-card-qrcode'); // Get QR code div
                const gradeStyles = getGradeStyles(finalGrade.color);

                if (images.length > 0 && shareCardImage) {
                     shareCardImage.src = `/api/image/${images[0]}`;
                     shareCardImage.onload = () => { if (generateBtn) generateBtn.disabled = false; };
                     shareCardImage.onerror = () => { if (generateBtn) generateBtn.disabled = true; };
                } else {
                     document.getElementById('share-card-image-wrapper').innerHTML = '<span class="text-gray-400 text-sm">无封面图</span>';
                     if (generateBtn) generateBtn.disabled = true;
                }
                if (shareCardScore) shareCardScore.textContent = normalizedScore.toFixed(2);
                if (shareCardScore) shareCardScore.className = `text-5xl font-black ${gradeStyles.textColor}`;
                if (shareCardGradeBadge) {
                    // Display full grade names
                    shareCardGradeBadge.textContent = `${finalGrade.name_en} - ${finalGrade.name_cn}`;
                    shareCardGradeBadge.className = `inline-block px-2 py-0.5 rounded-full text-xs font-semibold ${gradeStyles.bgColor} ${gradeStyles.textColor} bg-opacity-20`;
                }
                if (shareCardUsername) {
                    shareCardUsername.textContent = userNickname; // Set username in watermark
                }

                // Generate QR Code
                if (shareCardQrCode && typeof QRCode !== 'undefined') {
                    shareCardQrCode.innerHTML = ''; // Clear previous QR code if any
                    new QRCode(shareCardQrCode, {
                        text: window.location.href, // Link to the current results page
                        width: 100, // Adjust size as needed (will fit in the 1/3 width div)
                        height: 100,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H // High correction level
                    });
                } else {
                     console.error("QR Code container or library not found.");
                }


                mainContent.style.opacity = '1'; mainContent.classList.add('animate-fadeInUp');

            } catch (e) { errorContainer.innerHTML = `<p class="font-bold text-center">页面加载出错！<a href="index.html" class="text-indigo-600 underline">返回社区</a> 或 <a href="rate.html" class="text-indigo-600 underline">去评分</a></p><p class="text-sm text-gray-600">${e.message}</p>`; errorContainer.classList.remove('hidden'); if (mainContent) mainContent.style.display = 'none'; console.error("Results page error:", e); if(generateBtn) generateBtn.disabled = true; }
        };

        // --- Rendering Utilities ---
        function generateNarrativeSummary(cigarInfo, config, ratings, finalGrade, selectedFlavors) { if (!config || !ratings) { return '<p class="text-gray-500 italic">无法生成综合评价 (缺少原始评分数据)。</p>'; } let summary = `<p class="text-base text-gray-700 leading-relaxed">`; summary += `本次品鉴的雪茄是来自<strong class="font-semibold">${cigarInfo?.origin || '未知'}</strong>的<strong class="font-semibold">${cigarInfo?.name || '未知'}</strong>，尺寸为<strong class="font-semibold">${cigarInfo?.size || '未知'}</strong>。`; let observations = []; (config?.ratingCriteria || []).forEach(category => { (category.criteriaList || []).forEach(criterion => { const id = getRatingId(category.category, criterion.name); const selectedOptionIndex = ratings[id]; if (selectedOptionIndex !== undefined && criterion.options?.[selectedOptionIndex]) { const option = criterion.options[selectedOptionIndex]; observations.push(`在<strong class="font-semibold">${criterion.name}</strong>方面，其表现为“${option.description}”`); } }); }); if (observations.length > 0) { summary += ` 品鉴过程中，我们观察到：${observations.join('；')}。`; } else { summary += ` (未记录详细评分选项)。`; } if (selectedFlavors && selectedFlavors.length > 0) { summary += ` 感受到的主要风味包括：<strong class="font-semibold">${selectedFlavors.join(', ')}</strong>。`; } const gradeHierarchy = GRADING_SCALE.map(g => g.name_en).join('-'); summary += ` 综合来看，本次基于Pistacho Cigar Rating System（Pistacho雪茄评分）的最终评级为<strong class="font-semibold text-indigo-600">“${finalGrade.grade} - ${finalGrade.name_cn}”</strong>。Pistacho品分等级从高到低为${gradeHierarchy}`; summary += `</p>`; return summary; }
        function getRatingId(category, criterion) { const catStr = String(category || '').trim(); const critStr = String(criterion || '').trim(); return `${catStr}-${critStr}`; }
        function renderSummary(container, config, ratings) { if (!container) return; if (!config || !ratings) { container.innerHTML = '<p class="text-gray-500 italic">无法生成评分详情汇总 (缺少原始评分数据)。</p>'; return; } let summaryHtml = ''; (config?.ratingCriteria || []).forEach((category) => { summaryHtml += `<div class="mb-4"><h4 class="text-md font-semibold text-gray-600 mb-2 border-b pb-1">${category.category}</h4><ul class="list-none space-y-1 text-sm">`; let hasCriteria = false; (category.criteriaList || []).forEach((criterion) => { const id = getRatingId(category.category, criterion.name); const selectedOptionIndex = ratings[id]; if (selectedOptionIndex !== undefined && criterion.options?.[selectedOptionIndex]) { const option = criterion.options[selectedOptionIndex]; summaryHtml += `<li class="flex justify-between items-center p-1"><div><span class="font-medium text-gray-700">${criterion.name}:</span><span class="text-gray-500 ml-2">${option.description}</span></div></li>`; hasCriteria = true; } }); if (!hasCriteria) { summaryHtml += `<li class="text-gray-400 italic text-xs">(无评分项)</li>`; } summaryHtml += `</ul></div>`; }); container.innerHTML = summaryHtml || '<p class="text-gray-500 italic">(无评分详情)</p>'; }
        function getScoreRange(gradeCode) { const index = GRADING_SCALE.findIndex(g => g.grade === gradeCode); if (index === -1) return ''; const min = GRADING_SCALE[index].min_score; if (index === 0) return `${min}-100`; const gradeAbove = GRADING_SCALE[index - 1]; if (!gradeAbove) return `< ${min}`; const max = gradeAbove.min_score - 0.01; if (gradeCode === 'O') return `0-${max.toFixed(2)}`; return `${min.toFixed(0)}-${max.toFixed(2)}`; }
        function getGradeStyles(color) { const stylesMap = { 'gold': { bgColor: 'bg-yellow-400', textColor: 'text-yellow-800', bgGradient: 'bg-gradient-to-br from-yellow-400 to-amber-500', shadowColor: 'shadow-yellow-500/50' }, 'indigo': { bgColor: 'bg-indigo-300', textColor: 'text-indigo-800', bgGradient: 'bg-gradient-to-br from-indigo-500 to-purple-600', shadowColor: 'shadow-indigo-500/50' }, 'purple': { bgColor: 'bg-purple-300', textColor: 'text-purple-800', bgGradient: 'bg-gradient-to-br from-purple-500 to-violet-600', shadowColor: 'shadow-purple-500/50' }, 'blue': { bgColor: 'bg-blue-300', textColor: 'text-blue-800', bgGradient: 'bg-gradient-to-br from-blue-500 to-cyan-600', shadowColor: 'shadow-blue-500/50' }, 'green': { bgColor: 'bg-green-300', textColor: 'text-green-800', bgGradient: 'bg-gradient-to-br from-green-500 to-lime-600', shadowColor: 'shadow-green-500/50' }, 'gray': { bgColor: 'bg-gray-300', textColor: 'text-gray-800', bgGradient: 'bg-gradient-to-br from-gray-500 to-slate-600', shadowColor: 'shadow-gray-500/50' }, 'orange': { bgColor: 'bg-orange-300', textColor: 'text-orange-800', bgGradient: 'bg-gradient-to-br from-orange-500 to-amber-600', shadowColor: 'shadow-orange-500/50' }, 'red': { bgColor: 'bg-red-300', textColor: 'text-red-800', bgGradient: 'bg-gradient-to-br from-red-500 to-rose-600', shadowColor: 'shadow-red-500/50' } }; return stylesMap[color] || stylesMap['gray']; }
         function renderScoreSection(container, score, grade) { if (!container || !grade) return; const styles = getGradeStyles(grade.color); const scoreHtml = ` <div class="text-center md:text-left"> <p class="text-xl font-bold text-yellow-500 mb-1">Pistacho 评分</p> <p class="text-7xl font-black ${styles.textColor}">${score.toFixed(2)}</p> <div class="mt-2 text-3xl lg:text-4xl font-black ${styles.textColor} leading-tight"> ${grade.name_en} - ${grade.name_cn} </div> </div> `; let scaleHtml = '<div class="space-y-1 text-sm">'; GRADING_SCALE.forEach(g => { const gStyles = getGradeStyles(g.color); const isCurrent = g.grade === grade.grade; scaleHtml += ` <div class="flex items-center p-1 rounded ${isCurrent ? 'bg-gray-100' : ''}"> <div class="w-5 h-5 flex-shrink-0 rounded-full flex items-center justify-center font-bold text-xs ${gStyles.bgColor} ${gStyles.textColor} mr-2">${g.grade}</div> <div class="flex-grow ${isCurrent ? 'font-semibold' : ''} ${gStyles.textColor}">${g.name_cn}</div> <div class="font-mono text-xs text-gray-500 ml-2">${getScoreRange(g.grade)}</div> </div> `; }); scaleHtml += '</div>'; container.innerHTML = ` <div id="score-display" class="w-full md:w-1/3 flex-shrink-0"> ${scoreHtml} </div> <div id="grading-scale-explanation" class="w-full md:w-2/3 flex-grow border-t md:border-t-0 md:border-l border-gray-200 pt-4 md:pt-0 md:pl-6"> ${scaleHtml} </div> `; }

    </script>
</body>
</html>

