<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雪茄品鉴 - 点评报告</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/11.0.5/swiper-bundle.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/11.0.5/swiper-bundle.min.js" defer></script>

    <script src="https://unpkg.com/i18next/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-http-backend/i18nextHttpBackend.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector/i18nextBrowserLanguageDetector.min.js"></script>

    <script>
        // Tailwind config (omitted for brevity, remains the same)
        if (typeof tailwind !== 'undefined') { 
             tailwind.config = {
                 theme: { extend: { fontFamily: { sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'], }, } }
             }
         } else { console.warn('Tailwind object not found.'); }
    </script>
    <style>
        /* CSS styles (omitted for brevity, remains the same) */
        .tooltip { position: relative; display: inline-block; } 
        .tooltip .tooltiptext { visibility: hidden; width: auto; /* Adjusted for longer text */ white-space: nowrap; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 5px 8px; /* Adjusted padding */ position: absolute; z-index: 1; bottom: 125%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; font-size: 10px; } 
        .tooltip .tooltiptext::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #555 transparent transparent transparent; } 
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .swiper-container.main-swiper { width: 100%; position: relative; }
        .swiper-slide { height: auto; display: flex; flex-direction: column; }
        .swiper-slide img { display: block; width: 100%; height: auto; object-fit: contain; max-height: 80vh; }
        .swiper-slide.share-image-slide img { max-height: none; object-fit: contain; }
        .swiper-button-next, .swiper-button-prev { color: #fff; background-color: rgba(0,0,0,0.3); padding: 10px; border-radius: 50%; width: 40px; height: 40px; } .swiper-button-next::after, .swiper-button-prev::after { font-size: 1.2rem; }
        .swiper-pagination { position: absolute; bottom: 20px !important; left: 50%; transform: translateX(-50%); width: auto; z-index: 10; }
        .swiper-pagination-bullet { background-color: rgba(128, 128, 128, 0.7); opacity: 1; width: 8px; height: 8px; }
        .swiper-pagination-bullet-active { background: #FFFFFF; }
        .thumbnail-swiper .swiper-slide { width: 60px !important; height: 80px; opacity: 0.6; cursor: pointer; border: 2px solid transparent; transition: opacity 0.3s, border-color 0.3s; }
        .thumbnail-swiper .swiper-slide img { object-fit: cover; width: 100%; height: 100%;}
        .thumbnail-swiper .swiper-slide-thumb-active { opacity: 1; border-color: #4f46e5; } .thumbnail-swiper { margin-top: 0.5rem; padding: 5px 0; }
        #narrative-summary-container, #cigar-review-container, #selected-flavors-container { max-width: 100%; }
        .flavor-tag { display: inline-block; background-color: #e5e7eb; color: #374151; font-size: 0.75rem; font-weight: 600; margin-right: 0.5rem; margin-bottom: 0.5rem; padding: 0.125rem 0.625rem; border-radius: 9999px; }

        /* Share Card Styles */
        #share-card-container { position: absolute; left: -9999px; top: 0; width: 350px; background-color: white; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); overflow: hidden; border: 1px solid #e5e7eb; visibility: hidden; z-index: -1; }
        #share-card-image-wrapper { background-color: #e5e7eb; display: flex; align-items: center; justify-content: center; aspect-ratio: 1179 / 1572; }
        #share-card-image { width: 100%; height: 100%; object-fit: cover; }
        #share-card-content { padding: 0.25rem; position: relative; }
        #share-card-score-grade { display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 0.1rem; }
        #share-card-score { font-size: 2.75rem; font-weight: 900; line-height: 1; margin-bottom: 0.3rem; }
        #share-card-grade-badge { display: inline-block; padding: 0.1rem 0.4rem; border-radius: 9999px; font-size: 0.6rem; font-weight: 600; margin-bottom: 0.2rem; }
        .share-card-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 0; }
        #share-card-watermark { font-size: 0.55rem; color: #9ca3af; width: 65%; line-height: 1.1; margin: 0; }
        #share-card-qrcode { width: 32%; height: auto; background-color: white; padding: 0; border: 1px solid #eee; box-shadow: 0 0 2px rgba(0,0,0,0.1); }
        #share-card-qrcode img { display: block; width: 100%; height: 100%; }
         /* Fade in animation - Keep definition even if unused temporarily */
         @keyframes fadeInUp { from { opacity: 0; transform: translate3d(0, 20px, 0); } to { opacity: 1; transform: translate3d(0, 0, 0); } }
         .animate-fadeInUp { animation: fadeInUp 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">
    <div class="max-w-6xl mx-auto p-4 md:p-8 relative">
        <div id="error-container" class="hidden bg-red-100 p-6 rounded-lg shadow-lg text-red-700 font-medium"></div>
        <div id="loading-indicator" class="text-center py-10 text-gray-500" data-i18n="common.loadingDetails">正在加载评分详情...</div>
        
        <div id="main-content" class="opacity-0" style="display: none;"> <!-- Initially hidden -->
            <nav class="mb-6 flex flex-wrap justify-between items-center bg-white p-3 rounded-lg shadow-sm gap-4">
                 <a href="index.html" class="text-xl font-bold text-indigo-600" data-i18n="nav.title">Pistacho评分</a>
                 <div class="flex items-center space-x-4 flex-grow justify-center md:justify-start md:flex-grow-0 order-3 md:order-2 w-full md:w-auto">
                     <a href="index.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.community">社区动态</a>
                     <a href="rate.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.rate">去评分</a>
                     <a href="history.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.myRatings">我的评分</a>
                     <a href="certified.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.certified">认证评分</a>
                 </div>
                 <div class="flex items-center order-2 md:order-3">
                    <select id="language-switcher" class="text-xs p-1 rounded border border-gray-300 mr-2" style="height: 30px; line-height: 1.5;">
                        <option value="zh">简体中文</option>
                        <option value="en">English</option>
                        <option value="es">Español</option>
                    </select>
                    <div id="login-status-container" class="flex items-center"></div>
                 </div>
            </nav>

            <div class="flex flex-col md:flex-row gap-6 md:gap-8 mb-8">
                <div class="w-full md:w-2/5 flex-shrink-0">
                     <div id="image-gallery-container" class="bg-white rounded-lg shadow-md overflow-hidden">
                         <div class="swiper-container main-swiper bg-gray-200 relative">
                              <div class="swiper-wrapper" id="main-swiper-wrapper">
                                  <div class="swiper-slide flex items-center justify-center text-gray-400 aspect-[1179/1572]" data-i18n="common.loading">加载中...</div>
                              </div>
                              <div class="swiper-pagination"></div>
                              <div class="swiper-button-next"></div>
                              <div class="swiper-button-prev"></div>
                         </div>
                         <div class="swiper-container thumbnail-swiper hidden"> <div class="swiper-wrapper" id="thumbnail-swiper-wrapper"> </div> </div>
                     </div>
                </div>
                 <div class="w-full md:flex-grow bg-white rounded-lg shadow-md p-6">
                     <p class="text-sm text-gray-500 mb-1">
                         <span data-i18n="resultsPage.by">点评来自:</span> 
                         <span id="user-nickname" class="font-medium text-gray-700"></span>
                     </p>
                     <h1 id="rating-title" class="text-3xl font-bold mb-3"></h1>
                     <h2 id="cigar-name" class="text-xl font-semibold mb-1"></h2>
                     <div class="mb-4 text-sm text-gray-600 flex space-x-4">
                         <span><span data-i18n="resultsPage.size">尺寸</span>: <strong id="cigar-size"></strong></span>
                         <span><span data-i18n="resultsPage.origin">产地</span>: <strong id="cigar-origin"></strong></span>
                     </div>
                     <div id="cigar-review-container" class="prose prose-sm max-w-none text-gray-700 border-t pt-4">
                     </div>
                     <div id="selected-flavors-container" class="hidden pt-2">
                         <h4 class="text-sm font-semibold text-gray-600 mb-2" data-i18n="resultsPage.flavors">主要风味:</h4>
                         <div id="flavors-display" class="flex flex-wrap"></div>
                     </div>
                 </div>
            </div>

            <section id="score-section" class="bg-white rounded-xl shadow-lg p-6 mb-8 flex flex-col md:flex-row gap-6 items-center">
            </section>

             <div id="save-button-container" class="hidden mb-6">
                 <button id="save-rating-button" onclick="saveRating()" class="w-full py-3 px-6 bg-green-600 text-white font-bold text-lg rounded-lg shadow-md hover:bg-green-700 transition" data-i18n="resultsPage.saveRating">
                     保存为我的评分记录
                 </button>
             </div>

            <div class="space-y-4">
                 <details id="narrative-summary-details" class="group bg-white rounded-xl shadow-lg p-6 transition-all duration-300" open>
                     <summary class="flex justify-between items-center cursor-pointer font-bold text-lg text-gray-800">
                         <span>
                             <span data-i18n="resultsPage.narrativeTitle">综合评价</span>
                             <svg class="inline w-5 h-5 transform group-open:rotate-180 transition-transform ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                         </span>
                         <div class="tooltip">
                             <button id="copy-summary-button" onclick="copySummary(event)" class="ml-4 p-1.5 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition text-xs">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /> </svg>
                             </button>
                             <span id="copy-tooltip" class="tooltiptext" data-i18n="resultsPage.copy">复制</span>
                         </div>
                     </summary>
                     <div id="narrative-summary-container" class="mt-4 prose max-w-none"></div>
                 </details>
                 <details id="summary-details" class="group bg-white rounded-xl shadow-lg p-6">
                     <summary class="flex justify-between items-center cursor-pointer font-bold text-lg text-gray-800">
                         <span data-i18n="resultsPage.detailsTitle">评分详情汇总</span>
                         <svg class="w-5 h-5 transform group-open:rotate-180 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                     </summary>
                     <div id="summary-container" class="mt-4"></div>
                 </details>
            </div>

            <footer class="mt-8 flex flex-col sm:flex-row justify-center items-center gap-4">
                 <a href="rate.html" class="py-3 px-6 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition" data-i18n="resultsPage.backToRate">
                     &larr; 返回重新评分
                 </a>
            </footer>
        </div>

        <div id="share-card-container">
            <div id="share-card-image-wrapper">
                <img id="share-card-image" src="" alt="Cigar Cover Image" crossorigin="anonymous">
            </div>
            <div id="share-card-content">
                <div id="share-card-score-grade">
                    <span id="share-card-score">0.00</span>
                    <span id="share-card-grade-badge">? - ???</span>
                </div>
                <div class="share-card-footer">
                     <p id="share-card-watermark">
                         <span id="share-card-username">用户</span> 
                         </p>
                     <div id="share-card-qrcode"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Constants and Global Vars --- (remains the same)
        const GRADING_SCALE = [ /* ... */ ];
        let currentAuthUser = null; 
        let resultsData = null; 
        let ratingId = null;
        const AUTHING_APP_ID = '68f5b0b6875017c02b3bfdb3'; 
        const AUTHING_HOST = 'https://xfvu647mcdbk-demo.authing.cn';
        let mainSwiper = null; 
        let thumbnailSwiper = null;

        // --- i18n Initialization Functions --- (remains the same)
        async function initI18n() { /* ... */ }
        function updateContent() { /* ... */ }
        function setupLanguageSwitcher() { /* ... */ }

        // --- Authentication --- (remains the same)
        window.login = function() { /* ... */ }
        window.logout = function() { /* ... */ }
        function renderLoginStatus(user) { /* ... */ }
        async function handleOidcCallback(code) { /* ... */ }
        async function validateSessionAndGetUser() { /* ... */ }

        // --- Main Functions --- (saveRating, copySummary, initSwipers, autoGenerateShareImage remain the same)
        window.saveRating = async function() { /* ... */ };
        window.copySummary = function(event) { /* ... */ };
        function initSwipers(imageUrls = []) { /* ... */ }
        async function autoGenerateShareImage() { /* ... */ }
        
        // --- renderPageContent --- (Checks remain)
        function renderPageContent(data) { /* ... */ }
        
        // --- window.onload --- (Logging removed for clarity, try/catch around renderPageContent is key)
        window.onload = async function() { 
             console.log("[window.onload] Page loading started.");
             const errorContainer = document.getElementById('error-container');
             const mainContent = document.getElementById('main-content');
             const loadingIndicator = document.getElementById('loading-indicator');
             
             const showError = (message, errorObj = null) => {
                  console.error("[window.onload] showError called:", message, errorObj); 
                  loadingIndicator.style.display = 'none'; 
                  mainContent.style.display = 'none'; 
                  const errorTitle = i18next?.t('errors.pageLoadError') || "Page Load Error"; 
                  const backLink = i18next?.t('common.backToCommunity') || "Back to Community";
                  errorContainer.innerHTML = `<p class="font-bold text-center">${errorTitle}: ${message} <a href="index.html" class="text-indigo-600 underline">${backLink}</a></p>`;
                  if (errorObj) { 
                     errorContainer.innerHTML += `<pre class="text-xs text-red-600 mt-2 whitespace-pre-wrap">${errorObj.stack || JSON.stringify(errorObj)}</pre>`;
                  }
                  errorContainer.classList.remove('hidden');
             };

             try {
                 // --- Initialization ---
                 loadingIndicator.classList.remove('hidden'); 
                 mainContent.style.display = 'none';
                 errorContainer.classList.add('hidden');
                 
                 console.log("[window.onload] Initializing i18n...");
                 await initI18n();
                 updateContent(); 
                 console.log("[window.onload] i18n initialized.");

                 const urlParams = new URLSearchParams(window.location.search);
                 const code = urlParams.get('code');
                 ratingId = urlParams.get('ratingId');
                 console.log(`[window.onload] URL Params: code=${code}, ratingId=${ratingId}`);

                 // --- Auth ---
                 console.log("[window.onload] Validating session/handling callback...");
                 let user = code ? await handleOidcCallback(code) : await validateSessionAndGetUser();
                 currentAuthUser = user;
                 console.log("[window.onload] User:", currentAuthUser);
                 renderLoginStatus(currentAuthUser); 
                 setupLanguageSwitcher(); 
                 console.log("[window.onload] Auth handled, UI updated.");

                 // --- Data Loading ---
                 console.log("[window.onload] Starting data loading...");
                 if (ratingId) { 
                     console.log(`[window.onload] Fetching rating by ID: ${ratingId}`);
                     const token = sessionStorage.getItem('accessToken');
                     const apiUrl = new URL(`/api/ratings?id=${ratingId}`, window.location.origin);
                     const fetchOptions = token ? { headers: { 'Authorization': `Bearer ${token}` } } : {};
                     const response = await fetch(apiUrl, fetchOptions);
                     console.log(`[window.onload] Fetch response status: ${response.status}`);
                     if (!response.ok) throw new Error(i18next.t('errors.loadRatingFailed', { status: response.status }));
                     resultsData = await response.json();
                     console.log("[window.onload] Rating data fetched successfully."); 
                 } else { 
                     console.log("[window.onload] Loading rating from sessionStorage...");
                     let storedDataRaw = null;
                     try {
                         storedDataRaw = sessionStorage.getItem('cigarRatingResults');
                         console.log("[window.onload] Raw data from sessionStorage:", storedDataRaw ? storedDataRaw.substring(0, 200) + "..." : "null"); // Log beginning of data
                     } catch (storageError) { /* ... error handling ... */ }
                     if (!storedDataRaw) { /* ... error handling ... */ }
                     try {
                        resultsData = JSON.parse(storedDataRaw); 
                     } catch (parseError) { /* ... error handling ... */ }
                     ratingId = resultsData?.ratingId; 
                     console.log(`[window.onload] Rating data loaded from session. Rating ID: ${ratingId}`);
                 }
                 
                 // **DEBUG**: Log the structure of the config within resultsData
                 console.log("[window.onload] Inspecting resultsData.config structure:", JSON.stringify(resultsData?.config, null, 2));

                 console.log("[window.onload] Inspecting resultsData.finalGrade before rendering:", resultsData?.finalGrade);

                 if (!resultsData || resultsData.normalizedScore === undefined) { 
                     console.error("[window.onload] Loaded data is invalid or missing score.", resultsData);
                     throw new Error(i18next.t('errors.missingEssentialData')); 
                 }
                 
                 // --- Content Rendering --- 
                 console.log("[window.onload] Starting Content Rendering block...");
                 try {
                     console.log("[window.onload] Initializing Swipers..."); 
                     initSwipers(resultsData.imageUrls || []); 
                     console.log("[window.onload] Calling renderPageContent..."); 
                     renderPageContent(resultsData); 
                     console.log("[window.onload] renderPageContent finished."); 
                 } catch (renderError) { /* ... error handling ... */ }

                 // --- Share Image Generation --- 
                 console.log("[window.onload] Setting up share card generation...");
                 const shareImg = document.getElementById('share-card-image');
                 if (shareImg && shareImg.src && !shareImg.src.includes('placehold.co')) { /* ... */ } 
                 else if (ratingId) { /* ... */ } 
                 else { /* ... */ }

                 // --- Final Step: Show Content --- 
                 console.log("[window.onload] Hiding loader and showing main content..."); 
                 loadingIndicator.style.display = 'none'; 
                 mainContent.style.display = 'block'; 
                 mainContent.classList.remove('opacity-0'); 
                 console.log("[window.onload] Page load sequence finished successfully.");

             } catch (e) { /* ... error handling ... */ }
        };

        // --- Rendering Utilities ---

        // --- getRatingId function --- 
        function getRatingId(category, criterion) {
             const catStr = String(category || '').trim(); 
             const critStr = String(criterion || '').trim(); 
             if (!catStr || !critStr) { 
                 // console.warn("[getRatingId] Received empty category or criterion name", { category, criterion }); // Keep if needed for debugging
                 return null; 
             }
             return `${catStr}-${critStr}`; 
        }

        // --- generateNarrativeSummary (Use original names for lookup, key/name for display) ---
        function generateNarrativeSummary(cigarInfo, config, ratings, finalGrade, selectedFlavors) {
             // console.log("[generateNarrativeSummary] Start..."); 
             if (!config || !config.ratingCriteria || !ratings) { /* ... error handling ... */ }
             const { origin = i18next.t('common.unknown'), name = i18next.t('common.unknown'), size = i18next.t('common.unknown') } = cigarInfo || {}; 
             let summary = `<p class="text-base text-gray-700 leading-relaxed">`; 
             summary += i18next.t('resultsPage.narrative.part1', { origin, name, size }); 
             
             let observations = [];
             try { 
                 (config.ratingCriteria || []).forEach(category => {
                     const originalCategoryName = category.category; 
                     (category.criteriaList || []).forEach(criterion => { 
                         const originalCriterionName = criterion.name;   
                         const id = getRatingId(originalCategoryName, originalCriterionName); 
                         
                         // **DEBUG**: Log the ID being generated and looked up
                         // console.log(`  [Narrative] Trying ID: ${id}`);
                         
                         if (!id) { return; } 
                         const selectedOptionIndex = ratings[id]; 
                         
                         // **DEBUG**: Log if rating found
                         // if (selectedOptionIndex !== undefined) { console.log(`    -> Rating found for ID ${id}: ${selectedOptionIndex}`); }

                         if (selectedOptionIndex !== undefined && typeof selectedOptionIndex === 'number' && selectedOptionIndex >= 0) { 
                             const option = criterion.options?.[selectedOptionIndex]; 
                             const descriptionIdentifier = option?.descriptionKey || option?.description; 
                             const criterionIdentifier = criterion.nameKey || criterion.name; 
                             if (descriptionIdentifier && criterionIdentifier && option) { 
                                 observations.push(i18next.t('resultsPage.narrative.observation', { 
                                     criterion: i18next.t(criterionIdentifier), 
                                     option: i18next.t(descriptionIdentifier)  
                                 }));
                             } 
                         }
                     });
                 });
             } catch (iterError) { /* ... error handling ... */ }
             // ... (rest of the function remains the same) ...
             if (observations.length > 0) { summary += ` ${i18next.t('resultsPage.narrative.part2', { observations: observations.join('；') })}`; } 
             else { summary += ` ${i18next.t('resultsPage.narrative.noObservations')}`; }
             if (selectedFlavors && selectedFlavors.length > 0) { summary += ` ${i18next.t('resultsPage.narrative.part3', { flavors: selectedFlavors.join(', ') })}`; }
             if (finalGrade && finalGrade.grade && finalGrade.name) {
                 const hierarchy = GRADING_SCALE.map(g => `${g.grade}(${i18next.t(g.nameKey)})`).join(', ');
                 summary += ` ${i18next.t('resultsPage.narrative.part4', { grade: finalGrade.grade, gradeName: finalGrade.name, hierarchy: hierarchy })}`; 
             } else { console.warn("[generateNarrativeSummary] Missing finalGrade information."); }
             summary += `</p>`;
             // console.log("[generateNarrativeSummary] Finished."); 
             return summary; 
        }

        // --- **REWRITTEN: renderSummary (Based on results(6).html logic + i18n + DEBUG)** ---
        function renderSummary(container, config, ratings) {
             console.log("[renderSummary V_FINAL] Start..."); 
             if (!container || !config || !config.ratingCriteria || !ratings || typeof ratings !== 'object') { 
                 container.innerHTML = `<p class="text-gray-500 italic">${i18next.t('errors.noSummaryData')}</p>`; 
                 console.warn("[renderSummary V_FINAL] Aborting - Missing essential data.", { config: config ? 'Exists' : 'Missing', ratings: ratings ? 'Exists' : 'Missing' });
                 return; 
             } 
             // **DEBUG**: Log the keys present in the ratings object
             console.log("[renderSummary V_FINAL] Keys in ratings object:", Object.keys(ratings));

             let summaryHtml = '';
             let hasAnyContent = false; 
             try { 
                 summaryHtml = (config.ratingCriteria || []).map(category => {
                     // **CRITICAL: Get original name for lookup ID**
                     const originalCategoryName = category.category; 
                     // **Get key OR original name for display header**
                     const categoryDisplayIdentifier = category.categoryKey || category.category; 
                     
                     // **Check if original name exists for ID generation**
                     if (!originalCategoryName) { 
                         console.warn(`[renderSummary V_FINAL] Skipping category - missing original 'category' name needed for ID:`, category);
                         return ''; 
                     }
                     // **Check if display identifier exists**
                     if (!categoryDisplayIdentifier) {
                         console.warn(`[renderSummary V_FINAL] Skipping category - missing display identifier (key or name):`, category);
                          return ''; 
                     }

                     let criteriaRenderedCount = 0; 
                     const criteriaHtml = (category.criteriaList || []).map(criterion => {
                         // **CRITICAL: Get original name for lookup ID**
                         const originalCriterionName = criterion.name;
                         // **Get key OR original name for display label**
                         const criterionDisplayIdentifier = criterion.nameKey || criterion.name; 
                         
                         // **Check if original name exists for ID generation**
                         if (!originalCriterionName) { 
                              console.warn(`[renderSummary V_FINAL] Skipping criterion - missing original 'name' in category "${originalCategoryName}":`, criterion);
                             return ''; 
                         }
                         // **Check if display identifier exists**
                         if (!criterionDisplayIdentifier) {
                              console.warn(`[renderSummary V_FINAL] Skipping criterion - missing display identifier (key or name) in category "${originalCategoryName}":`, criterion);
                              return ''; 
                         }
                         
                         // **Generate ID using original names**
                         const id = getRatingId(originalCategoryName, originalCriterionName);
                         if (!id) {
                              console.warn(`[renderSummary V_FINAL] Failed to generate ID for ${originalCategoryName} - ${originalCriterionName}`);
                              return ''; // Skip if ID generation fails
                         }
                         
                         // **DEBUG**: Log the exact ID being looked up
                         console.log(`  [Summary] Looking for ID: "${id}" in ratings object.`);

                         const selectedOptionIndex = ratings[id]; // Use the generated ID
                         
                         // **DEBUG**: Log the result of the lookup
                         console.log(`    -> Found index for "${id}": ${selectedOptionIndex} (Type: ${typeof selectedOptionIndex})`);

                         if (selectedOptionIndex !== undefined && typeof selectedOptionIndex === 'number' && selectedOptionIndex >= 0) { 
                             const option = criterion.options?.[selectedOptionIndex]; 
                             // **Get key OR original description for display text**
                             const descriptionDisplayIdentifier = option?.descriptionKey || option?.description; 
                             
                             if (option && descriptionDisplayIdentifier) { 
                                 criteriaRenderedCount++; 
                                 hasAnyContent = true; 
                                 // **Translate identifiers for display**
                                 const translatedCriterion = i18next.t(criterion.nameKey || criterion.name);
                                 const translatedDescription = i18next.t(option.descriptionKey || option.description);
                                 // **Use structure similar to results(6).html**
                                 return `<li class="flex justify-between items-center p-1">
                                             <div>
                                                 <span class="font-medium text-gray-700">${translatedCriterion}:</span>
                                                 <span class="text-gray-500 ml-2">${translatedDescription}</span>
                                             </div>
                                         </li>`; 
                             } else {
                                  console.warn(`[renderSummary V_FINAL] Incomplete option data for criterion "${criterionDisplayIdentifier}" at index ${selectedOptionIndex}. Option found:`, option); 
                             }
                         } 
                         return ''; 
                     }).join(''); 
                     
                     if (criteriaRenderedCount > 0) { 
                         // **Translate category identifier for display**
                         const translatedCategory = i18next.t(category.categoryKey || category.category);
                         // **Use structure similar to results(6).html**
                         return `<div class="mb-4">
                                     <h4 class="text-md font-semibold text-gray-600 mb-2 border-b pb-1">${translatedCategory}</h4>
                                     <ul class="list-none space-y-1 text-sm">${criteriaHtml}</ul>
                                 </div>`; 
                     } 
                     return ''; 
                 }).join(''); 
             } catch (iterError) {
                  console.error("[renderSummary V_FINAL] Error during iteration:", iterError);
                  summaryHtml = `<p class="text-red-500">${i18next.t('errors.renderDetailsFailed')}</p>`; 
                  hasAnyContent = true; 
             }
            
             container.innerHTML = hasAnyContent ? summaryHtml : `<p>${i18next.t('resultsPage.summary.noItems')}</p>`; 
             console.log("[renderSummary V_FINAL] Finished rendering summary HTML.");
        }
        
        // getScoreRange, getGradeStyles, renderScoreSection remain the same
        function getScoreRange(gradeCode) { /* ... */ }
        function getGradeStyles(color) { const stylesMap = { /* ... */ }; return stylesMap[color] || stylesMap['gray']; } 
         
         function renderScoreSection(container, score, grade) { /* ... */ }
    </script>
</body>
</html>

