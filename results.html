<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雪茄品鉴 - 评分报告</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        highlight: {
                            '0%, 100%': { transform: 'scale(1)', boxShadow: '0 0 0 rgba(66, 153, 225, 0)' },
                            '50%': { transform: 'scale(1.02)', boxShadow: '0 0 15px rgba(66, 153, 225, 0.4)' },
                        }
                    },
                    animation: {
                        fadeInUp: 'fadeInUp 0.8s ease-out forwards',
                        highlight: 'highlight 2.5s ease-in-out infinite',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">

    <div class="max-w-4xl mx-auto p-4 md:p-8">
        
        <div id="error-container" class="hidden bg-red-100 p-6 rounded-lg shadow-lg text-center text-red-700 font-medium">
            <!-- JS will be injected here -->
        </div>

        <div id="main-content" class="opacity-0" style="animation-delay: 0.2s;">
             <nav class="mb-4 flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                 <a href="index.html" class="text-xl font-bold text-indigo-600">Pistacho评分</a>
                 <div class="space-x-4">
                     <a href="history.html" class="text-gray-600 hover:text-indigo-600">历史记录</a>
                     <a href="certified.html" class="text-gray-600 hover:text-indigo-600">认证评分</a>
                 </div>
            </nav>
            <header class="mb-6 text-center">
                <h1 class="text-4xl font-extrabold text-gray-800 mb-2">评分报告</h1>
            </header>
            
            <section id="cigar-info-container" class="mb-6">
                <!-- JS will inject cigar info here -->
            </section>

            <section id="results-card-container" class="mb-8">
                <!-- JS will be injected here -->
            </section>

            <div class="space-y-4">
                <details class="group bg-white rounded-xl shadow-lg p-6 transition-all duration-300" open>
                    <summary class="flex justify-between items-center cursor-pointer font-bold text-lg text-gray-800">
                        文字评价
                        <svg class="w-5 h-5 transform group-open:rotate-180 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </summary>
                    <div id="cigar-review-container" class="mt-4 text-gray-700 prose max-w-none">
                        <!-- JS will inject cigar review here -->
                    </div>
                </details>

                <details class="group bg-white rounded-xl shadow-lg p-6 transition-all duration-300">
                    <summary class="flex justify-between items-center cursor-pointer font-bold text-lg text-gray-800">
                        分数详情
                        <svg class="w-5 h-5 transform group-open:rotate-180 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </summary>
                    <div id="score-details-container" class="mt-4 text-center">
                        <!-- JS will be injected here -->
                    </div>
                </details>

                <details class="group bg-white rounded-xl shadow-lg p-6 transition-all duration-300">
                    <summary class="flex justify-between items-center cursor-pointer font-bold text-lg text-gray-800">
                        评分详情汇总
                        <svg class="w-5 h-5 transform group-open:rotate-180 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </summary>
                    <div id="summary-container" class="mt-4">
                         <!-- JS will be injected here -->
                    </div>
                </details>

                <details class="group bg-white rounded-xl shadow-lg p-6 transition-all duration-300 open">
                    <summary class="flex justify-between items-center cursor-pointer font-bold text-lg text-gray-800">
                        PISTACHO 评级体系
                        <svg class="w-5 h-5 transform group-open:rotate-180 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </summary>
                    <div id="full-scale-container" class="mt-4">
                         <!-- JS will be injected here -->
                    </div>
                </details>
            </div>


            <footer class="mt-8 text-center">
                <a href="index.html" 
                   class="py-3 px-6 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition">
                    &larr; 返回重新评分
                </a>
            </footer>
        </div>
    </div>

    <script>
        const GRADING_SCALE = [
          { "grade": "P", "name_en": "Pinnacle", "name_cn": "顶峰 / 登峰造极", "min_score": 95, "color": "gold" },
          { "grade": "I", "name_en": "Impeccable", "name_cn": "无暇 / 完美无瑕", "min_score": 90, "color": "indigo" },
          { "grade": "S", "name_en": "Superior", "name_cn": "卓越 / 出众", "min_score": 85, "color": "purple" },
          { "grade": "T", "name_en": "Terrific", "name_cn": "极好 / 绝佳", "min_score": 80, "color": "blue" },
          { "grade": "A", "name_en": "Appreciable", "name_cn": "可圈可点 / 值得欣赏", "min_score": 70, "color": "green" },
          { "grade": "C", "name_en": "Commonplace", "name_cn": "平庸 / 普通", "min_score": 60, "color": "gray" },
          { "grade": "H", "name_en": "Hesitant", "name_cn": "犹豫 / 瑕瑜互见", "min_score": 40, "color": "orange" },
          { "grade": "O", "name_en": "Ordinary", "name_cn": "乏善可陈 / 平淡", "min_score": 0, "color": "red" }
        ];

        function getRatingId(category, criterion) {
            return `${String(category).trim()}-${String(criterion).trim()}`;
        }

        window.onload = function() {
            const mainContent = document.getElementById('main-content');
            const cigarInfoContainer = document.getElementById('cigar-info-container');
            const resultsCardContainer = document.getElementById('results-card-container');
            const scoreDetailsContainer = document.getElementById('score-details-container');
            const summaryContainer = document.getElementById('summary-container');
            const errorContainer = document.getElementById('error-container');
            const fullScaleContainer = document.getElementById('full-scale-container');
            const cigarReviewContainer = document.getElementById('cigar-review-container');
            
            mainContent.classList.add('animate-fadeInUp');

            const storedData = sessionStorage.getItem('cigarRatingResults');
            
            if (!storedData) {
                errorContainer.classList.remove('hidden');
                errorContainer.innerHTML = `<p class="font-bold">没有找到评分数据！</p><p>请从主页完成一次评分。</p><a href="index.html" class="inline-block mt-4 text-indigo-600 underline">返回</a>`;
                mainContent.style.display = 'none';
                return;
            }
            
            try {
                const { config, ratings, calculatedScore, cigarInfo, cigarReview } = JSON.parse(storedData);
                const maxScore = config.totalWeightMax || 100;
                const normalizedScore = maxScore > 0 ? (calculatedScore / maxScore) * 100 : 0;
                
                let finalGrade = GRADING_SCALE[GRADING_SCALE.length - 1];
                for (const grade of GRADING_SCALE) {
                    if (normalizedScore >= grade.min_score) {
                        finalGrade = grade;
                        break;
                    }
                }
                
                if (cigarInfo) renderCigarInfo(cigarInfoContainer, cigarInfo);
                if (cigarReview) cigarReviewContainer.textContent = cigarReview;

                renderResultsCard(resultsCardContainer, normalizedScore, finalGrade);
                scoreDetailsContainer.innerHTML = `<p class="text-lg text-gray-600">原始得分: <span class="font-bold text-gray-800">${calculatedScore.toFixed(2)}</span> / ${maxScore.toFixed(2)}</p>`;
                renderSummary(summaryContainer, config, ratings);
                renderFullScale(fullScaleContainer, finalGrade);
                
            } catch (e) {
                 errorContainer.classList.remove('hidden');
                 mainContent.style.display = 'none';
                 errorContainer.innerHTML = `<p class="font-bold">解析数据出错！</p><p>${e.message}</p><a href="index.html" class="inline-block mt-4 text-indigo-600 underline">返回</a>`;
                 console.error("Results page error:", e);
            }
        }
        
        // --- 渲染函数 ---
        function renderCigarInfo(container, info) {
            container.innerHTML = `<div class="bg-white rounded-xl shadow-lg p-6 text-center"><h2 class="text-3xl font-bold text-gray-800">${info.name}</h2><div class="mt-2 flex justify-center items-center space-x-6 text-gray-500"><span><strong class="font-semibold text-gray-600">尺寸:</strong> ${info.size}</span><span class="border-l border-gray-300 h-4"></span><span><strong class="font-semibold text-gray-600">产地:</strong> ${info.origin}</span></div></div>`;
        }
        function renderResultsCard(container, score, grade) {
            if (!grade || !grade.color) return;
            const styles = getGradeStyles(grade.color);
            container.innerHTML = `<div class="relative rounded-2xl p-8 text-white overflow-hidden shadow-2xl ${styles.bgGradient} ${styles.shadowColor}"><div class="relative z-10 flex justify-between items-center"><div><p class="font-medium opacity-80">${grade.name_en}</p><h2 class="text-4xl font-extrabold tracking-tight">${grade.name_cn}</h2><p class="mt-4 text-7xl font-black">${score.toFixed(2)}</p></div><div class="flex-shrink-0 w-32 h-32 rounded-full border-4 border-white border-opacity-50 flex flex-col items-center justify-center bg-white bg-opacity-10 backdrop-blur-sm"><span class="text-6xl font-black">${grade.grade}</span><span class="font-semibold tracking-widest uppercase text-sm">${grade.name_en}</span></div></div></div>`;
        }
        function renderSummary(container, config, ratings) {
            let summaryHtml = '';
            (config.ratingCriteria || []).forEach((category) => {
                summaryHtml += `<div class="mb-4"><h4 class="text-md font-semibold text-gray-600 mb-2 border-b pb-1">${category.category}</h4><ul class="list-none space-y-1 text-sm">`;
                (category.criteriaList || []).forEach((criterion) => {
                    const id = getRatingId(category.category, criterion.name);
                    const selectedOptionIndex = ratings[id];
                    if (selectedOptionIndex !== undefined && criterion.options && criterion.options[selectedOptionIndex]) {
                        const option = criterion.options[selectedOptionIndex];
                        const weightedScore = (criterion.weight || 0) * (option.scorePct || 0);
                        summaryHtml += `<li class="flex justify-between items-center p-1"><div><span class="font-medium text-gray-700">${criterion.name}:</span><span class="text-gray-500 ml-2">${option.description}</span></div><span class="font-semibold text-green-600">+${weightedScore.toFixed(2)}</span></li>`;
                    }
                });
                summaryHtml += `</ul></div>`;
            });
            container.innerHTML = summaryHtml;
        }
        function renderFullScale(container, finalGrade) {
            let scaleHtml = '<div class="space-y-3">';
            GRADING_SCALE.forEach(grade => {
                const isCurrentGrade = grade.grade === finalGrade.grade;
                const styles = getGradeStyles(grade.color);
                const highlightClasses = isCurrentGrade ? `border-blue-500 bg-blue-50 ring-2 ring-blue-200 animate-highlight` : 'border-gray-200 bg-white hover:bg-gray-50';
                scaleHtml += `<div class="p-4 rounded-lg border-2 transition-all duration-300 ${highlightClasses}"><div class="flex items-center space-x-4"><div class="w-8 h-8 flex-shrink-0 rounded-full flex items-center justify-center font-black text-xl ${styles.textColor} ${styles.bgColor}">${grade.grade}</div><div class="flex-grow"><p class="font-bold text-lg ${styles.textColor}">${grade.name_cn}</p><p class="text-sm text-gray-500">${grade.name_en}</p></div><p class="font-mono font-semibold text-gray-700 text-right">${getScoreRange(grade.grade)}</p></div></div>`;
            });
            scaleHtml += '</div>';
            container.innerHTML = scaleHtml;
        }

        // --- 样式辅助函数 ---
        function getScoreRange(grade) {
            const index = GRADING_SCALE.findIndex(g => g.grade === grade);
            const min = GRADING_SCALE[index].min_score;
            const max = index === 0 ? 100 : GRADING_SCALE[index - 1].min_score - 0.01;
            return index === 0 ? `${min}-100` : `${min.toFixed(0)}-${max.toFixed(2)}`;
        }
        function getGradeStyles(color) {
            const stylesMap = {
                'gold':   { bgColor: 'bg-yellow-400', textColor: 'text-yellow-800', bgGradient: 'bg-gradient-to-br from-yellow-400 to-amber-500', shadowColor: 'shadow-yellow-500/50' },
                'indigo': { bgColor: 'bg-indigo-300', textColor: 'text-indigo-800', bgGradient: 'bg-gradient-to-br from-indigo-500 to-purple-600', shadowColor: 'shadow-indigo-500/50' },
                'purple': { bgColor: 'bg-purple-300', textColor: 'text-purple-800', bgGradient: 'bg-gradient-to-br from-purple-500 to-violet-600', shadowColor: 'shadow-purple-500/50' },
                'blue':   { bgColor: 'bg-blue-300',   textColor: 'text-blue-800',   bgGradient: 'bg-gradient-to-br from-blue-500 to-cyan-600',   shadowColor: 'shadow-blue-500/50' },
                'green':  { bgColor: 'bg-green-300',  textColor: 'text-green-800',  bgGradient: 'bg-gradient-to-br from-green-500 to-lime-600',   shadowColor: 'shadow-green-500/50' },
                'gray':   { bgColor: 'bg-gray-300',   textColor: 'text-gray-800',   bgGradient: 'bg-gradient-to-br from-gray-500 to-slate-600',    shadowColor: 'shadow-gray-500/50' },
                'orange': { bgColor: 'bg-orange-300', textColor: 'text-orange-800', bgGradient: 'bg-gradient-to-br from-orange-500 to-amber-600',  shadowColor: 'shadow-orange-500/50' },
                'red':    { bgColor: 'bg-red-300',    textColor: 'text-red-800',    bgGradient: 'bg-gradient-to-br from-red-500 to-rose-600',     shadowColor: 'shadow-red-500/50' }
            };
            return stylesMap[color] || stylesMap['gray'];
        }
    </script>
</body>
</html>

