<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雪茄品鉴 - 点评报告</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/8.4.7/swiper-bundle.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/8.4.7/swiper-bundle.min.js" defer></script>
    <script>
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: { sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'], },
                        keyframes: { fadeInUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' }, }, highlight: { '0%, 100%': { transform: 'scale(1)', boxShadow: '0 0 0 rgba(66, 153, 225, 0)' }, '50%': { transform: 'scale(1.02)', boxShadow: '0 0 15px rgba(66, 153, 225, 0.4)' }, } },
                        animation: { fadeInUp: 'fadeInUp 0.8s ease-out forwards', highlight: 'highlight 2.5s ease-in-out infinite', }
                    }
                }
            }
        }
    </script>
    <style>
        /* Tooltip styles */
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext { visibility: hidden; width: 80px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 5px 0; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -40px; opacity: 0; transition: opacity 0.3s; }
        .tooltip .tooltiptext::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #555 transparent transparent transparent; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

        /* Swiper adjustments */
        .swiper { width: 100%; }
        .swiper-slide img { display: block; width: 100%; height: 100%; object-fit: cover; }
        .swiper-button-next, .swiper-button-prev { color: #fff; background-color: rgba(0,0,0,0.3); padding: 10px; border-radius: 50%; width: 40px; height: 40px; }
        .swiper-button-next::after, .swiper-button-prev::after { font-size: 1.2rem; }
        .swiper-pagination-bullet-active { background: #4f46e5; }
        .thumbnail-swiper .swiper-slide { width: 60px !important; height: 80px; opacity: 0.6; cursor: pointer; border: 2px solid transparent; transition: opacity 0.3s, border-color 0.3s; }
        .thumbnail-swiper .swiper-slide-thumb-active { opacity: 1; border-color: #4f46e5; }
        .thumbnail-swiper { margin-top: 0.5rem; padding: 5px 0; }

        /* Flavor tags */
        .flavor-tag {
            display: inline-block;
            background-color: #DBEAFE;
            color: #1E40AF;
            font-size: 0.75rem;
            font-weight: 500;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            padding: 0.125rem 0.625rem;
            border-radius: 9999px;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">
<div class="max-w-6xl mx-auto p-4 md:p-8">
    <div id="error-container" class="hidden bg-red-100 p-6 rounded-lg shadow-lg text-red-700 font-medium"></div>
    <div id="main-content" class="opacity-0">

        <!-- Navbar -->
        <nav class="mb-6 flex flex-wrap justify-between items-center bg-white p-3 rounded-lg shadow-sm gap-4">
            <a href="index.html" class="text-xl font-bold text-indigo-600">Pistacho评分</a>
            <div class="flex items-center space-x-4 flex-grow justify-center md:justify-start md:flex-grow-0 order-3 md:order-2 w-full md:w-auto">
                <a href="index.html" class="text-gray-600 hover:text-indigo-600">社区动态</a>
                <a href="rate.html" class="text-gray-600 hover:text-indigo-600">去评分</a>
                <a href="history.html" class="text-gray-600 hover:text-indigo-600">我的点评历史</a>
                <a href="certified.html" class="text-gray-600 hover:text-indigo-600">认证评分</a>
            </div>
            <div id="login-status-container" class="flex items-center order-2 md:order-3"></div>
        </nav>

        <div class="flex flex-col md:flex-row gap-6 md:gap-8 mb-8">
            <!-- Left Column: Image Gallery -->
            <div class="w-full md:w-2/5 flex-shrink-0">
                <div id="image-gallery-container" class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="swiper main-swiper aspect-[1179/1572] bg-gray-200">
                        <div class="swiper-wrapper" id="main-swiper-wrapper">
                            <div class="swiper-slide flex items-center justify-center text-gray-400">无图</div>
                        </div>
                        <div class="swiper-pagination"></div>
                        <div class="swiper-button-next"></div>
                        <div class="swiper-button-prev"></div>
                    </div>
                    <div class="swiper thumbnail-swiper hidden">
                        <div class="swiper-wrapper" id="thumbnail-swiper-wrapper"></div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Details -->
            <div class="w-full md:flex-grow bg-white rounded-lg shadow-md p-6">
                <p class="text-sm text-gray-500 mb-1">点评来自: <span id="user-nickname" class="font-medium text-gray-700">加载中...</span></p>
                <h1 id="rating-title" class="text-3xl font-bold mb-3">加载中...</h1>
                <h2 id="cigar-name" class="text-xl font-semibold mb-1">加载中...</h2>
                <div class="mb-4 text-sm text-gray-600 flex space-x-4">
                    <span>尺寸: <strong id="cigar-size">...</strong></span>
                    <span>产地: <strong id="cigar-origin">...</strong></span>
                </div>

                <!-- 文字评价 -->
                <div id="cigar-review-container" class="prose prose-sm max-w-none text-gray-700 border-t pt-4 mb-2">
                    <p>加载中...</p>
                </div>

                <!-- 风味标签 -->
                <div id="selected-flavors-container" class="pt-2 hidden">
                    <h3 class="text-sm font-medium text-gray-600 mb-2">主要风味:</h3>
                    <div id="flavors-list" class="flex flex-wrap"></div>
                </div>
            </div>
        </div>

        <!-- Integrated Score Section -->
        <section id="score-section" class="bg-white rounded-xl shadow-lg p-6 mb-8 flex flex-col md:flex-row gap-6 items-center"></section>

        <!-- Save Button (Drafts Only) -->
        <div id="save-button-container" class="hidden mb-6">
            <button id="save-rating-button" onclick="saveRating()" class="w-full py-3 px-6 bg-green-600 text-white font-bold text-lg rounded-lg shadow-md hover:bg-green-700 transition">
                保存为我的评分记录
            </button>
        </div>

        <!-- 综合评价 & 评分详情 -->
        <div class="space-y-4">
            <details id="narrative-summary-details" class="group bg-white rounded-xl shadow-lg p-6 transition-all duration-300" open>
                <summary class="flex justify-between items-center cursor-pointer font-bold text-lg text-gray-800">
                    <span> 综合评价
                        <svg class="inline w-5 h-5 transform group-open:rotate-180 transition-transform ml-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </span>
                    <div class="tooltip">
                        <button id="copy-summary-button" onclick="copySummary(event)" class="ml-4 p-1.5 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition text-xs">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                        </button>
                        <span id="copy-tooltip" class="tooltiptext">复制</span>
                    </div>
                </summary>
                <div id="narrative-summary-container" class="mt-4 prose max-w-none"></div>
            </details>
            <details id="summary-details" class="group bg-white rounded-xl shadow-lg p-6">
                <summary class="flex justify-between items-center cursor-pointer font-bold text-lg text-gray-800">
                    评分详情汇总
                    <svg class="w-5 h-5 transform group-open:rotate-180 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </summary>
                <div id="summary-container" class="mt-4"></div>
            </details>
        </div>

        <footer class="mt-8 text-center">
            <a href="rate.html" class="py-3 px-6 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition">
                &larr; 返回重新评分
            </a>
        </footer>
    </div>
</div>

<script type="module">
// ==== JS逻辑保持原样，只修改风味处理 ====

// 渲染风味标签时支持字符串或数组
function renderFlavors(selectedFlavorsRaw) {
    const flavorsContainer = document.getElementById('selected-flavors-container');
    const flavorsListDiv = document.getElementById('flavors-list');
    if (!selectedFlavorsRaw) {
        flavorsContainer.classList.add('hidden');
        return;
    }
    let selectedFlavors = [];
    if (Array.isArray(selectedFlavorsRaw)) {
        selectedFlavors = selectedFlavorsRaw;
    } else if (typeof selectedFlavorsRaw === 'string') {
        selectedFlavors = selectedFlavorsRaw.split(',').map(s => s.trim()).filter(Boolean);
    }
    if (selectedFlavors.length > 0) {
        flavorsListDiv.innerHTML = selectedFlavors.map(flavor => `<span class="flavor-tag">${flavor}</span>`).join('');
        flavorsContainer.classList.remove('hidden');
    } else {
        flavorsContainer.classList.add('hidden');
    }
}

// 示例：页面加载后调用
window.onload = async function() {
    const storedData = sessionStorage.getItem('cigarRatingResults');
    if (!storedData) return;
    const resultsData = JSON.parse(storedData);

    document.getElementById('cigar-review-container').innerHTML = `<p>${resultsData.cigarReview || '未填写文字评价'}</p>`;
    renderFlavors(resultsData.selectedFlavors);
    // 其余逻辑保持原样，如 Swiper、评分显示等
};
</script>
</body>
</html>
