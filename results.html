<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雪茄品鉴 - 评分报告</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                    },
                    keyframes: {
                        fadeInUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        highlight: { '0%, 100%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.02)' } }
                    },
                    animation: {
                        fadeInUp: 'fadeInUp 0.8s ease-out forwards',
                        highlight: 'highlight 2.5s ease-in-out infinite',
                    }
                }
            }
        }
    </script>
    <script>
        const __app_id = 'pistacho-b9efe'; 
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyDC-8qbWsjRyxBzJpfCi9n3ftzdg9FStF0", 
            authDomain: "pistacho-b9efe.firebaseapp.com",
            projectId: "pistacho-b9efe",
            storageBucket: "pistacho-b9efe.firebasestorage.app",
            messagingSenderId: "686695750713",
            appId: "1:686695750713:web:5314331be7b46e93f401e8",
            measurementId: "G-HQS7Q78LY7"
        });
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        let db, auth;
        let currentAuthUser = null;
        let resultsData = null; // Will hold all rating data
        let normalizedScore = 0;
        let finalGrade = null;
        const RATINGS_COLLECTION_PATH = `/artifacts/${appId}/public/data/ratings`;

        // Initialize Firebase
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase init failed", e);
        }

        window.saveRating = async function() {
            if (!currentAuthUser || currentAuthUser.isAnonymous) {
                alert("请登录后保存您的评分记录。");
                return;
            }
            if (!resultsData) {
                alert("没有可保存的评分数据。");
                return;
            }

            const saveButton = document.getElementById('save-rating-button');
            saveButton.textContent = "正在保存...";
            saveButton.disabled = true;

            try {
                const ratingToSave = {
                    userId: currentAuthUser.uid,
                    userEmail: currentAuthUser.email,
                    timestamp: serverTimestamp(),
                    cigarInfo: resultsData.cigarInfo,
                    cigarReview: resultsData.cigarReview,
                    calculatedScore: resultsData.calculatedScore,
                    normalizedScore: normalizedScore, // 保存百分制分数
                    finalGrade: finalGrade,           // 保存最终等级
                    ratings: resultsData.ratings,
                    config: resultsData.config,
                };

                await addDoc(collection(db, RATINGS_COLLECTION_PATH), ratingToSave);

                saveButton.textContent = "已保存";
                saveButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                saveButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                alert("评分已成功保存到您的历史记录！");

            } catch (error) {
                console.error("保存评分失败:", error);
                alert(`保存失败: ${error.message}`);
                saveButton.textContent = "保存为我的评分记录";
                saveButton.disabled = false;
            }
        }

        window.onload = function() {
            const mainContent = document.getElementById('main-content');
            const errorContainer = document.getElementById('error-container');
            
            // Wait for auth state to be known
            onAuthStateChanged(auth, (user) => {
                currentAuthUser = user;
                
                const storedData = sessionStorage.getItem('cigarRatingResults');
                if (!storedData) {
                    errorContainer.classList.remove('hidden');
                    errorContainer.innerHTML = `<p class="font-bold">没有找到评分数据！</p><a href="index.html" class="underline">返回评分</a>`;
                    mainContent.style.display = 'none';
                    return;
                }

                try {
                    resultsData = JSON.parse(storedData); // Store in global var
                    const { config, ratings, calculatedScore, cigarInfo, cigarReview } = resultsData;
                    
                    const maxScore = config.totalWeightMax || 100;
                    normalizedScore = maxScore > 0 ? (calculatedScore / maxScore) * 100 : 0;
                    
                    finalGrade = GRADING_SCALE[GRADING_SCALE.length - 1];
                    for (const grade of GRADING_SCALE) {
                        if (normalizedScore >= grade.min_score) {
                            finalGrade = grade;
                            break;
                        }
                    }

                    // Show save button only for logged-in users
                    const saveButtonContainer = document.getElementById('save-button-container');
                    if (user && !user.isAnonymous) {
                        saveButtonContainer.classList.remove('hidden');
                    }
                    
                    // Render all sections
                    if (cigarInfo) document.getElementById('cigar-info-container').innerHTML = `<div class="bg-white rounded-xl shadow-lg p-6 text-center"><h2 class="text-3xl font-bold">${cigarInfo.name}</h2><div class="mt-2 flex justify-center space-x-6 text-gray-500"><span><strong>尺寸:</strong> ${cigarInfo.size}</span><span><strong>产地:</strong> ${cigarInfo.origin}</span></div></div>`;
                    if (cigarReview) document.getElementById('cigar-review-container').textContent = cigarReview;
                    
                    renderResultsCard(document.getElementById('results-card-container'), normalizedScore, finalGrade);
                    document.getElementById('score-details-container').innerHTML = `<p class="text-lg text-gray-600">原始得分: <span class="font-bold">${calculatedScore.toFixed(2)}</span> / ${maxScore.toFixed(2)}</p>`;
                    renderSummary(document.getElementById('summary-container'), config, ratings);
                    renderFullScale(document.getElementById('full-scale-container'), finalGrade);

                    mainContent.classList.add('animate-fadeInUp');
                } catch (e) {
                     errorContainer.classList.remove('hidden');
                     mainContent.style.display = 'none';
                     errorContainer.innerHTML = `<p class="font-bold">解析数据出错！</p><p>${e.message}</p><a href="index.html" class="underline">返回</a>`;
                }
            });
        }
        
        // --- All other rendering and utility functions are here ---
    </script>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">
    <div class="max-w-4xl mx-auto p-4 md:p-8">
        <div id="error-container" class="hidden ..."></div>
        <div id="main-content" class="opacity-0">
            <nav class="mb-4 flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                 <a href="index.html" class="text-xl font-bold text-indigo-600">Pistacho评分</a>
                 <div class="space-x-4">
                     <a href="history.html" class="text-gray-600 hover:text-indigo-600">历史记录</a>
                     <a href="certified.html" class="text-gray-600 hover:text-indigo-600">认证评分</a>
                 </div>
            </nav>
            <header class="mb-6 text-center">
                <h1 class="text-4xl font-extrabold text-gray-800 mb-2">评分报告</h1>
            </header>
            <section id="cigar-info-container" class="mb-6"></section>
            
            <div id="save-button-container" class="hidden mb-6">
                <button id="save-rating-button" onclick="saveRating()" class="w-full py-3 px-6 bg-green-600 text-white font-bold text-lg rounded-lg shadow-md hover:bg-green-700 transition">
                    保存为我的评分记录
                </button>
            </div>

            <section id="results-card-container" class="mb-8"></section>
            <div class="space-y-4">
                <!-- Details sections... -->
            </div>
            <footer class="mt-8 text-center">
                <a href="index.html" class="py-3 px-6 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition">
                    &larr; 返回重新评分
                </a>
            </footer>
        </div>
    </div>
</body>
</html>

