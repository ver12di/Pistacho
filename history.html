<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的点评历史</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: {
                            sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                        }
                    }
                }
            }
        } else {
             console.warn('Tailwind object not found. Skipping config.');
        }
    </script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="max-w-4xl mx-auto p-4 md:p-8">
        <!-- **NAVBAR UPDATED** -->
        <nav class="mb-6 flex flex-wrap justify-between items-center bg-white p-3 rounded-lg shadow-sm gap-4">
            <a href="index.html" class="text-xl font-bold text-indigo-600">Pistacho评分</a>
            <div class="flex items-center space-x-4 flex-grow justify-center md:justify-start md:flex-grow-0 order-3 md:order-2 w-full md:w-auto">
                <a href="index.html" class="text-gray-600 hover:text-indigo-600">社区动态</a>
                <a href="rate.html" class="text-gray-600 hover:text-indigo-600">去评分</a>
                <!-- Highlight current page -->
                <a href="history.html" class="text-indigo-600 font-bold underline">我的点评历史</a>
                <a href="certified.html" class="text-gray-600 hover:text-indigo-600">认证评分</a>
            </div>
            <div id="login-status-container" class="flex items-center order-2 md:order-3">
                 <!-- Login/Logout button will be rendered here -->
            </div>
        </nav>
        <!-- **END NAVBAR UPDATE** -->

        <header class="mb-6">
            <h1 id="history-title" class="text-4xl font-extrabold text-gray-800">我的点评历史</h1>
        </header>
        <div id="history-container">
            <!-- Loading message or initial content -->
            <p id="loading-message" class="text-center text-gray-500">正在加载...</p>
        </div>
         <footer class="mt-8 text-center">
            <!-- **LINK UPDATED**: Point to index.html (community) -->
            <a href="index.html" class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">&larr; 返回社区首页</a>
        </footer>
    </div>

    <script type="module">
        let historicalRatings = {}; // Cache for viewing details
        let currentAuthUser = null;
        let userRole = 'unknown'; // To control button visibility
        const loadingMessage = document.getElementById('loading-message');
        const historyContainer = document.getElementById('history-container');
        const historyTitle = document.getElementById('history-title');

        const AUTHING_APP_ID = '68f5b0b6875017c02b3bfdb3';
        const AUTHING_HOST = 'https://xfvu647mcdbk-demo.authing.cn';

        // --- Authentication ---
         window.login = function() {
            const redirectUri = window.location.origin; // Redirect back to history
            const authorizeUrl = new URL('/oidc/auth', AUTHING_HOST);
            authorizeUrl.search = new URLSearchParams({
                client_id: AUTHING_APP_ID,
                redirect_uri: redirectUri,
                response_type: 'code',
                scope: 'openid profile email phone',
                state: Math.random().toString(36).substring(2)
            }).toString();
            window.location.href = authorizeUrl.toString();
        }

        window.logout = function() {
             const logoutUrl = new URL('/oidc/session/end', AUTHING_HOST);
             logoutUrl.search = new URLSearchParams({
                post_logout_redirect_uri: window.location.origin
             }).toString();
             sessionStorage.removeItem('userInfo');
             sessionStorage.removeItem('accessToken');
             window.location.href = logoutUrl.toString();
        }

        function renderLoginStatus(user) {
            const container = document.getElementById('login-status-container');
            if (!container) return;
            if (user) {
                const displayName = user.nickname || user.name || user.preferred_username || user.email || '已登录';
                container.innerHTML = `<span class="text-sm font-medium text-gray-700 mr-2 hidden sm:inline">${displayName}</span><button onclick="logout()" class="px-3 py-1 text-xs font-medium rounded-full bg-red-500 text-white hover:bg-red-600">退出</button>`;
            } else {
                container.innerHTML = `<button onclick="login()" class="px-3 py-1 text-xs font-medium rounded-full bg-green-500 text-white hover:bg-green-600">登录/注册</button>`;
            }
        }

        async function handleOidcCallback(code) {
             try {
                const redirectUri = window.location.origin;
                const apiUrl = new URL('/api/authing/callback', window.location.origin);
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code, redirect_uri: redirectUri })
                });
                if (!response.ok) {
                    const err = await response.json(); throw new Error(err.error || '认证回调失败');
                }
                const fullUserProfile = await response.json();
                sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile));
                sessionStorage.setItem('accessToken', fullUserProfile.accessToken);
                return fullUserProfile;
            } catch (e) {
                console.error('认证回调处理失败:', e); alert(`登录失败: ${e.message}`);
                sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken'); return null;
            } finally {
                // Use replaceState to clean URL without reloading
                window.history.replaceState({}, document.title, window.location.pathname + window.location.hash); // Keep hash if exists
            }
        }


        async function validateSessionAndGetUser() {
            const token = sessionStorage.getItem('accessToken'); if (!token) return null;
            try {
                const apiUrl = new URL('/api/me', window.location.origin);
                const response = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) {
                    sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken'); return null;
                }
                const fullUserProfile = await response.json();
                sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile)); return fullUserProfile;
            } catch (e) { console.error("Session validation failed:", e); return null; }
        }
        // --- End of Auth ---


        // --- Rating Actions ---
        window.editRating = function(ratingId, event) {
            event.stopPropagation();
            window.location.href = `rate.html?edit=${ratingId}`;
        }

        window.deleteRating = async function(ratingId, event) {
            event.stopPropagation();
            if (!confirm("确定要永久删除这条点评记录吗？")) return;

            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '删除中...';
            button.disabled = true;

            const token = sessionStorage.getItem('accessToken');
            if (!token) {
                 alert("请先登录。");
                 button.textContent = originalText; button.disabled = false;
                 return;
            }

            try {
                 const apiUrl = new URL(`/api/ratings`, window.location.origin);
                 const response = await fetch(apiUrl, {
                     method: 'DELETE',
                     headers: {
                         'Authorization': `Bearer ${token}`,
                         'Content-Type': 'application/json'
                     },
                     body: JSON.stringify({ ratingId: ratingId })
                 });
                 if (!response.ok) {
                     const err = await response.json();
                     throw new Error(err.error || '删除失败');
                 }
                 // Remove the card from the UI
                 const cardToRemove = document.getElementById(`rating-card-${ratingId}`);
                 if (cardToRemove) {
                     cardToRemove.style.transition = 'opacity 0.5s ease-out';
                     cardToRemove.style.opacity = '0';
                     setTimeout(() => cardToRemove.remove(), 500);
                 }
                 alert("点评已删除。");

            } catch (error) {
                 console.error("删除失败:", error);
                 alert(`删除失败: ${error.message}`);
                 button.textContent = originalText; button.disabled = false;
            }
        }

        window.updateCertification = async function(ratingId, shouldCertify, event) {
            event.stopPropagation();
            const button = event.target;
            const isCertifying = shouldCertify;
            const actionText = isCertifying ? '认证' : '取消认证';
            const originalText = button.textContent;

            button.textContent = actionText + '中...';
            button.disabled = true;

            const token = sessionStorage.getItem('accessToken');
            if (!token) {
                 alert("请先登录。");
                 button.textContent = originalText; button.disabled = false;
                 return;
            }

            try {
                const apiUrl = new URL('/api/certify', window.location.origin);
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                         'Authorization': `Bearer ${token}`,
                         'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ratingId: ratingId, certify: isCertifying })
                });

                if (!response.ok) {
                     const err = await response.json();
                     throw new Error(err.error || `${actionText}失败`);
                }

                // Update UI immediately (swap buttons)
                const card = document.getElementById(`rating-card-${ratingId}`);
                if (card) {
                    const buttonContainer = card.querySelector('.action-buttons');
                    if (buttonContainer) {
                         const certifyButton = buttonContainer.querySelector('button[data-action="certify"]');
                         const uncertifyButton = buttonContainer.querySelector('button[data-action="uncertify"]');

                         if (isCertifying) {
                             certifyButton?.classList.add('hidden');
                             uncertifyButton?.classList.remove('hidden');
                             uncertifyButton?.disabled = false;
                         } else {
                             certifyButton?.classList.remove('hidden');
                             certifyButton?.disabled = false;
                             uncertifyButton?.classList.add('hidden');
                         }
                    }
                }
                alert(`操作成功！`);

            } catch (error) {
                 console.error(`${actionText}失败:`, error);
                 alert(`${actionText}失败: ${error.message}`);
                 button.textContent = originalText;
                 button.disabled = false;
            }
        }

        window.viewRatingDetails = function(ratingId) {
            const ratingData = historicalRatings[ratingId];
             if (ratingData) {
                  // Pass the necessary data to results.html
                  // Ensure we always pass the essential top-level fields
                  let detailedData = {
                      cigarInfo: ratingData.cigarInfo,
                      cigarReview: ratingData.cigarReview,
                      imageUrl: ratingData.imageUrl,
                      normalizedScore: ratingData.normalizedScore,
                      finalGrade: ratingData.finalGrade,
                      timestamp: ratingData.timestamp,
                      userNickname: ratingData.userNickname,
                      userEmail: ratingData.userEmail,
                      isDraft: false // From history, never a draft
                  };

                  // Add fullData parts ONLY if they exist and are valid
                  const hasCompleteFullData = ratingData.fullData &&
                                              ratingData.fullData.config &&
                                              ratingData.fullData.ratings &&
                                              ratingData.fullData.calculatedScore !== undefined;

                  if (hasCompleteFullData) {
                       detailedData.config = ratingData.fullData.config;
                       detailedData.ratings = ratingData.fullData.ratings;
                       detailedData.calculatedScore = ratingData.fullData.calculatedScore;
                       console.log("Sending COMPLETE data from history:", detailedData);
                  } else {
                       console.warn(`fullData for rating ${ratingId} from history is missing or incomplete. Sending only top-level data.`);
                       console.log("Sending INCOMPLETE data from history:", detailedData);
                  }

                   try {
                       sessionStorage.setItem('cigarRatingResults', JSON.stringify(detailedData));
                       window.location.href = `results.html`;
                   } catch (e) {
                        console.error("Error setting sessionStorage:", e);
                        alert("无法保存会话数据以查看详情。");
                   }
             } else {
                 alert("无法加载该点评的详细信息。");
             }
        }
        // --- End Rating Actions ---

        // --- Data Fetching and Rendering ---
        async function fetchAndRenderHistory(user) {
            loadingMessage.textContent = '正在加载历史记录...';
            loadingMessage.style.display = 'block';
            historyContainer.innerHTML = '';

            if (!user) {
                historyTitle.textContent = "我的点评历史";
                historyContainer.innerHTML = `<div class="text-center p-6 bg-white rounded-lg shadow"><p>请<button onclick="login()" class="text-indigo-600 underline font-semibold">登录</button>以查看您的点评历史。</p></div>`;
                loadingMessage.style.display = 'none';
                return;
            }

            const token = sessionStorage.getItem('accessToken');
            if (!token) {
                historyTitle.textContent = "我的点评历史";
                historyContainer.innerHTML = `<div class="text-center p-6 bg-yellow-100 text-yellow-700 rounded-lg shadow"><p>您的会话已过期，请<button onclick="login()" class="text-indigo-600 underline font-semibold">重新登录</button>。</p></div>`;
                 loadingMessage.style.display = 'none';
                return;
            }

            try {
                 const apiUrl = new URL('/api/ratings', window.location.origin);
                 const response = await fetch(apiUrl, {
                     headers: { 'Authorization': `Bearer ${token}` }
                 });

                 if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || '加载历史记录失败');
                 }

                 const ratings = await response.json();
                 historicalRatings = {}; // Reset cache
                 ratings.forEach(r => historicalRatings[r.id] = r); // Populate cache

                 userRole = currentAuthUser?.db_role || 'general';

                 // **TITLE UPDATE**
                 if (userRole === 'admin' || userRole === 'super_admin') {
                     historyTitle.textContent = "所有用户的点评历史";
                 } else {
                     historyTitle.textContent = "我的点评历史";
                 }

                if (ratings.length === 0) {
                    historyContainer.innerHTML = `<div class="text-center p-6 bg-white rounded-lg shadow"><p>还没有任何点评记录。</p></div>`;
                } else {
                    let historyHtml = '<div class="space-y-4">';
                    // **SORT**: Ensure latest first
                    ratings.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    ratings.forEach(data => {
                        historyHtml += renderRatingCard(data, user.sub, userRole);
                    });
                    historyHtml += '</div>';
                    historyContainer.innerHTML = historyHtml;
                }
                 loadingMessage.style.display = 'none';

            } catch (error) {
                console.error("获取历史记录失败:", error);
                historyContainer.innerHTML = `<div class="text-center p-6 bg-red-100 text-red-700 rounded-lg shadow"><p>加载历史记录失败: ${error.message}</p></div>`;
                 loadingMessage.style.display = 'none';
            }
        }

        // **LAYOUT UPDATED for compactness**
        function renderRatingCard(data, currentUserId, currentUserRole) {
            const ratingId = data.id;
            const date = data.timestamp ? new Date(data.timestamp).toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }) : '未知日期';
            const scoreDisplay = data.normalizedScore !== undefined ? data.normalizedScore.toFixed(2) : 'N/A';
            const gradeDisplay = data.finalGrade ? `${data.finalGrade.grade} - ${data.finalGrade.name_cn}` : '未评级';
            const isOwner = data.userId === currentUserId;
            const isAdmin = currentUserRole === 'admin' || currentUserRole === 'super_admin';
            const canModify = isOwner || isAdmin;
            const canCertify = isAdmin;

            const authorDisplay = data.userNickname || data.userEmail || data.userId || '未知用户';

            let actionButtonsHtml = '';
            if (canModify) {
                actionButtonsHtml += `<button onclick="editRating('${ratingId}', event)" class="py-1 px-3 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition">修改</button>`;
                actionButtonsHtml += `<button onclick="deleteRating('${ratingId}', event)" class="py-1 px-3 bg-red-500 text-white text-xs rounded hover:bg-red-600 transition ml-2">删除</button>`;
            }
            if (canCertify) {
                 actionButtonsHtml += `<button data-action="certify" onclick="updateCertification('${ratingId}', true, event)" class="py-1 px-3 bg-green-500 text-white text-xs rounded hover:bg-green-600 transition ml-2 ${data.isCertified ? 'hidden' : ''}">认证</button>`;
                actionButtonsHtml += `<button data-action="uncertify" onclick="updateCertification('${ratingId}', false, event)" class="py-1 px-3 bg-yellow-600 text-white text-xs rounded hover:bg-yellow-700 transition ml-2 ${!data.isCertified ? 'hidden' : ''}">取消认证</button>`;
            }

            return `
                <div id="rating-card-${ratingId}" class="block bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer" onclick="viewRatingDetails('${ratingId}')">
                    <!-- Combined Info, Score, and Buttons Row -->
                    <div class="flex flex-wrap justify-between items-center gap-2">
                        <!-- Left: Info -->
                        <div class="flex-grow min-w-0">
                             <p class="text-lg font-bold text-gray-800 truncate" title="${data.cigarInfo?.name || ''}">${data.cigarInfo?.name || '未知名称'}</p>
                            <p class="text-sm text-gray-500 truncate">
                                ${data.cigarInfo?.size || '未知尺寸'} | ${data.cigarInfo?.origin || '未知产地'} | ${date}
                                ${ isAdmin ? `<span class="font-medium text-gray-600 ml-2">| 用户: ${authorDisplay}</span>` : '' }
                            </p>
                        </div>
                        <!-- Right: Score + Buttons -->
                        <div class="flex items-center flex-shrink-0 space-x-3">
                             <!-- Score -->
                            <div class="text-right">
                                <p class="text-xl font-black text-indigo-600">${scoreDisplay}</p>
                                <p class="font-bold text-gray-600 text-xs">${gradeDisplay}</p>
                            </div>
                            <!-- Buttons -->
                            <div class="action-buttons flex items-center space-x-2 ${!actionButtonsHtml ? 'hidden' : ''}">
                                ${actionButtonsHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        // --- End Data Fetching and Rendering ---


        // --- Initialization ---
        window.onload = async function() {
             const urlParams = new URLSearchParams(window.location.search);
             const code = urlParams.get('code');
             let user = null;

             if (code) {
                 user = await handleOidcCallback(code);
             } else {
                 user = await validateSessionAndGetUser();
             }
             currentAuthUser = user; // Set global user
             renderLoginStatus(currentAuthUser); // Render login button
             fetchAndRenderHistory(currentAuthUser); // Fetch data based on user
        };
    </script>
</body>
</html>

