<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="historyPage.title">我的评分</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/i18next/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-http-backend/i18nextHttpBackend.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector/i18nextBrowserLanguageDetector.min.js"></script>
    
    <script>
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: {
                            sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                        }
                    }
                }
            }
        } else {
             console.warn('Tailwind object not found. Skipping config.');
        }
    </script>
    <style>
        .rating-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        /* ... (other styles remain same) ... */
        .pinned-indicator {
             position: absolute;
             top: 0.5rem;
             right: 0.5rem;
             background-color: #ec4899; /* Pink */
             color: white;
             padding: 0.1rem 0.5rem;
             border-radius: 9999px;
             font-size: 0.7rem;
             font-weight: bold;
             display: flex;
             align-items: center;
        }
         .pinned-indicator svg {
             width: 0.7rem;
             height: 0.7rem;
             margin-right: 0.2rem;
         }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="max-w-4xl mx-auto p-4 md:p-8">
        <nav class="mb-6 flex flex-wrap justify-between items-center bg-white p-3 rounded-lg shadow-sm gap-4">
            <a href="index.html" class="text-xl font-bold text-indigo-600" data-i18n="nav.title">Pistacho评分</a>
            <div class="flex items-center space-x-4 flex-grow justify-center md:justify-start md:flex-grow-0 order-3 md:order-2 w-full md:w-auto">
                <a href="index.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.community">社区动态</a>
                <a href="rate.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.rate">去评分</a>
                <a href="history.html" class="text-indigo-600 font-bold underline" data-i18n="nav.myRatings">我的评分</a>
                <a href="certified.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.certified">认证评分</a>
            </div>
            <div class="flex items-center order-2 md:order-3">
               <select id="language-switcher" class="text-xs p-1 rounded border border-gray-300 mr-2 h-7" style="line-height: 1;">
                   <option value="zh">简体中文</option>
                   <option value="en">English</option>
                   <option value="es">Español</option>
               </select>
               <div id="login-status-container" class="flex items-center"></div>
            </div>
        </nav>
        <header class="mb-6">
            <h1 id="history-title" class="text-4xl font-extrabold text-gray-800" data-i18n="historyPage.title">我的评分</h1>
        </header>

        <div id="login-prompt" class="hidden text-center p-6 bg-yellow-100 text-yellow-800 rounded-lg shadow mb-8">
             <p class="font-semibold mb-3" data-i18n="historyPage.loginPrompt">请先登录才能查看您的评分记录。</p>
             <button onclick="login()" class="px-5 py-2 text-sm font-medium rounded-lg bg-green-500 text-white hover:bg-green-600" data-i18n="nav.login">前往登录/注册</button>
        </div>

        <div id="history-container">
            <p id="loading-message" class="text-center text-gray-500 py-10" data-i18n="common.loading">正在加载...</p>
        </div>

         <footer class="mt-8 text-center">
            <a href="index.html" class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700" data-i18n="nav.community">&larr; 返回社区首页</a>
        </footer>
    </div>

    <script type="module">
        // --- i18n Functions ---
        async function initI18n() {
            await i18next
                .use(i18nextHttpBackend)
                .use(i18nextBrowserLanguageDetector)
                .init({
                    fallbackLng: 'zh',
                    debug: false,
                    ns: ['translation'],
                    defaultNS: 'translation',
                    backend: {
                        loadPath: '/locales/{{lng}}.json?v=1'
                    },
                    detection: {
                        order: ['localStorage', 'navigator'],
                        caches: ['localStorage']
                    }
                });
            updateContent();
        }

        function updateContent() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const value = i18next.t(key);
                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    el.placeholder = value;
                } else if (el.tagName === 'OPTION') {
                    el.textContent = value;
                } else {
                    el.innerHTML = value;
                }
            });
            document.title = i18next.t('historyPage.title');
        }

        function setupLanguageSwitcher() {
            const switcher = document.getElementById('language-switcher');
            if (!switcher) return;
            const currentLang = i18next.language.split('-')[0];
            switcher.value = ['zh', 'en', 'es'].includes(currentLang) ? currentLang : 'zh';
            
            switcher.addEventListener('change', async (e) => {
                const newLang = e.target.value;
                await i18next.changeLanguage(newLang);
                updateContent();
                // 重新渲染动态内容
                await fetchAndRenderHistory(currentAuthUser); // 重载数据和UI
                renderLoginStatus(currentAuthUser);
            });
        }
        // --- End i18n Functions ---

        let historicalRatings = {};
        let currentAuthUser = null;
        let userRole = 'guest';
        const loadingMessage = document.getElementById('loading-message');
        const historyContainer = document.getElementById('history-container');
        const historyTitle = document.getElementById('history-title');
        const loginPrompt = document.getElementById('login-prompt');

        const AUTHING_APP_ID = '68f5b0b6875017c02b3bfdb3';
        const AUTHING_HOST = 'https://xfvu647mcdbk-demo.authing.cn';

        // --- Authentication ---
         window.login = function() { /* ... (same) ... */ }
         window.logout = function() { /* ... (same) ... */ }
         
         function renderLoginStatus(user) {
            const container = document.getElementById('login-status-container');
            if (!container) return;
            if (user) {
                const displayName = user.nickname || user.name || user.preferred_username || user.email || i18next.t('nav.login');
                container.innerHTML = `<span class="text-sm font-medium text-gray-700 mr-2 hidden sm:inline">${displayName}</span><button onclick="logout()" class="px-3 py-1 text-xs font-medium rounded-full bg-red-500 text-white hover:bg-red-600">${i18next.t('nav.logout')}</button>`;
            } else {
                container.innerHTML = `<button onclick="login()" class="px-3 py-1 text-xs font-medium rounded-full bg-green-500 text-white hover:bg-green-600">${i18next.t('nav.login')}</button>`;
            }
         }
         
         async function handleOidcCallback(code) { /* ... (same) ... */ }
         async function validateSessionAndGetUser() { /* ... (same) ... */ }
        // --- End Auth ---


        // --- Rating Actions ---
         window.editRating = function(ratingId, event) { /* ... (same) ... */ }
         
         window.deleteRating = async function(ratingId, event) {
            event?.stopPropagation();
            if (!confirm(i18next.t('common.confirmDeletion'))) { return; }
            const button = event ? (event.currentTarget || event.target) : null;
            const originalText = button ? button.textContent : i18next.t('common.delete');
            if (button) { button.textContent = i18next.t('common.loading'); button.disabled = true; }
            const token = sessionStorage.getItem('accessToken');
            if (!token) {
                alert(i18next.t('common.loginRequired'));
                if (button) { button.textContent = originalText; button.disabled = false; }
                return;
            }
            try {
                const apiUrl = new URL(`/api/ratings`, window.location.origin);
                const response = await fetch(apiUrl, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ ratingId: ratingId }) });
                const responseText = await response.text();
                let data;
                try { data = JSON.parse(responseText); } catch (parseError) { if (response.ok) { data = { success: true }; } else { data = { error: `Server returned invalid response (status ${response.status})` }; } }
                if (!response.ok) throw new Error(data?.error || `Delete failed (status ${response.status})`);
                const cardToRemove = document.getElementById(`rating-card-${ratingId}`);
                if (cardToRemove) { cardToRemove.style.transition = 'opacity 0.5s ease-out'; cardToRemove.style.opacity = '0'; setTimeout(() => cardToRemove.remove(), 500); }
                alert(i18next.t('common.deleteSuccess'));
            } catch (error) {
                console.error("[deleteRating] Caught error:", error);
                alert(i18next.t('common.deleteFailed', { msg: error.message }));
                if (button) { button.textContent = originalText; button.disabled = false; }
            }
         }
         
         window.updateCertification = async function(ratingId, shouldCertify, event) {
            event?.stopPropagation();
            const button = event ? (event.currentTarget || event.target) : null;
            const isCertifying = shouldCertify;
            const actionText = isCertifying ? i18next.t('common.certify') : i18next.t('common.uncertify');
            const originalText = button ? button.textContent : actionText;
            if (button) { button.textContent = i18next.t('common.loading'); button.disabled = true; }
            const token = sessionStorage.getItem('accessToken');
            if (!token) {
                alert(i18next.t('common.loginRequired'));
                if (button) { button.textContent = originalText; button.disabled = false; }
                return;
            }
            try {
                const apiUrl = new URL('/api/certify', window.location.origin);
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ ratingId: ratingId, certify: isCertifying }) });
                if (!response.ok) { let errorText = `${actionText} failed: ${response.status}`; try { const err = await response.json(); errorText = err.error || errorText; } catch(e){/*ignore*/} throw new Error(errorText); }
                const data = await response.json();
                const card = document.getElementById(`rating-card-${ratingId}`);
                if (card) {
                    const buttonContainer = card.querySelector('.action-buttons');
                    if (buttonContainer) {
                        const certifyButton = buttonContainer.querySelector('button[data-action="certify"]');
                        const uncertifyButton = buttonContainer.querySelector('button[data-action="uncertify"]');
                        if (isCertifying) {
                            if (certifyButton) certifyButton.classList.add('hidden');
                            if (uncertifyButton) { uncertifyButton.classList.remove('hidden'); uncertifyButton.disabled = false; }
                        } else {
                            if (certifyButton) { certifyButton.classList.remove('hidden'); certifyButton.disabled = false; }
                            if (uncertifyButton) uncertifyButton.classList.add('hidden');
                        }
                    }
                }
                alert(i18next.t('common.opSuccess'));
            } catch (error) {
                console.error(`${actionText} failed:`, error);
                alert(i18next.t('common.opFailed', { msg: error.message }));
                if (button) { button.textContent = originalText; button.disabled = false; }
            }
         }
         
         window.updatePinStatus = async function(ratingId, shouldPin, event) {
            event?.stopPropagation();
            const button = event ? (event.currentTarget || event.target) : null;
            const actionText = shouldPin ? i18next.t('common.pin') : i18next.t('common.unpin');
            const originalText = button ? button.textContent : actionText;
            if (button) { button.textContent = i18next.t('common.loading'); button.disabled = true; }
            const token = sessionStorage.getItem('accessToken');
            if (!token) {
                alert(i18next.t('common.loginRequired'));
                if (button) { button.textContent = originalText; button.disabled = false; }
                return;
            }
            try {
                const apiUrl = new URL('/api/pin', window.location.origin);
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ ratingId: ratingId, pin: shouldPin }) });
                if (!response.ok) { let errorText = `${actionText} failed: ${response.status}`; try { const err = await response.json(); errorText = err.error || errorText; } catch(e){/*ignore*/} throw new Error(errorText); }
                const data = await response.json();
                const card = document.getElementById(`rating-card-${ratingId}`);
                if (card) {
                    if(historicalRatings[ratingId]) historicalRatings[ratingId].isPinned = shouldPin;
                    const buttonContainer = card.querySelector('.action-buttons');
                    if (buttonContainer) {
                        const pinButton = buttonContainer.querySelector('button[data-action="pin"]');
                        const unpinButton = buttonContainer.querySelector('button[data-action="unpin"]');
                        if (shouldPin) {
                            if (pinButton) pinButton.classList.add('hidden');
                            if (unpinButton) { unpinButton.classList.remove('hidden'); unpinButton.disabled = false; }
                        } else {
                            if (pinButton) { pinButton.classList.remove('hidden'); pinButton.disabled = false; }
                            if (unpinButton) unpinButton.classList.add('hidden');
                        }
                    }
                    const indicator = card.querySelector('.pinned-indicator');
                    if(indicator) indicator.style.display = shouldPin ? 'flex' : 'none';
                }
                alert(i18next.t('common.opSuccess'));
            } catch (error) {
                console.error(`${actionText} failed:`, error);
                alert(i18next.t('common.opFailed', { msg: error.message }));
                if (button) { button.textContent = originalText; button.disabled = false; }
            }
         }

         window.viewRatingDetails = function(ratingId) {
             const ratingData = historicalRatings[ratingId];
             if (ratingData) {
                 let detailedData = {
                     ratingId: ratingData.id,
                     title: ratingData.title || '无标题点评',
                     cigarInfo: ratingData.cigarInfo || { name: ratingData.cigarName, size: ratingData.cigarSize, origin: ratingData.cigarOrigin },
                     cigarReview: ratingData.cigarReview || '无',
                     imageUrls: Array.isArray(ratingData.imageUrl) ? ratingData.imageUrl : [],
                     normalizedScore: ratingData.normalizedScore,
                     // **MODIFIED**: Pass the raw grade data. results.html will handle translation.
                     finalGrade: ratingData.finalGrade ? { grade: ratingData.finalGrade.grade } : { grade: 'O' },
                     timestamp: ratingData.timestamp,
                     userNickname: ratingData.userNickname,
                     userEmail: ratingData.userEmail,
                     selectedFlavors: Array.isArray(ratingData.fullData?.selectedFlavors) ? ratingData.fullData.selectedFlavors : [],
                     isDraft: false
                 };

                 const hasCompleteFullData = ratingData.fullData && ratingData.fullData.config && ratingData.fullData.ratings && ratingData.fullData.calculatedScore !== undefined;
                 if (hasCompleteFullData) {
                     detailedData.config = ratingData.fullData.config;
                     detailedData.ratings = ratingData.fullData.ratings;
                     detailedData.calculatedScore = ratingData.fullData.calculatedScore;
                 } else {
                     console.warn(`fullData for rating ${ratingId} from history is missing or incomplete.`);
                 }

                 try {
                     sessionStorage.setItem('cigarRatingResults', JSON.stringify(detailedData));
                     window.location.href = `results.html`;
                 } catch (e) {
                     console.error("Error setting sessionStorage:", e);
                     alert(i18next.t('common.sessionStoreFailed'));
                 }
             } else {
                 alert(i18next.t('common.loadDetailFailed'));
             }
         }
        // --- End Rating Actions ---

        // --- Data Fetching and Rendering ---
        async function fetchAndRenderHistory(user) {
            if (!user) {
                historyTitle.textContent = i18next.t('historyPage.title');
                historyContainer.style.display = 'none';
                loginPrompt.classList.remove('hidden');
                loadingMessage.style.display = 'none';
                return;
            } else {
                 historyContainer.style.display = 'block';
                 loginPrompt.classList.add('hidden');
            }

            const token = sessionStorage.getItem('accessToken');
            if (!token) {
                 historyTitle.textContent = i18next.t('historyPage.title');
                 historyContainer.style.display = 'none';
                 loginPrompt.classList.remove('hidden');
                 loginPrompt.querySelector('p').textContent = i18next.t('historyPage.loginExpired');
                 loadingMessage.style.display = 'none';
                 return;
            }

            loadingMessage.textContent = i18next.t('historyPage.loadingHistory');
            loadingMessage.style.display = 'block';
            historyContainer.innerHTML = '';

            try {
                 const apiUrl = new URL('/api/ratings', window.location.origin);
                 const response = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${token}` } });
                 if (!response.ok) { let errorText = `Load failed: ${response.status}`; try { const err = await response.json(); errorText = err.error || errorText; } catch(e){/*ignore*/} throw new Error(errorText); }
                 const ratings = await response.json();
                 historicalRatings = {}; ratings.forEach(r => historicalRatings[r.id] = r);
                 userRole = currentAuthUser?.db_role || 'general';

                 if (userRole === 'admin' || userRole === 'super_admin') {
                    historyTitle.textContent = i18next.t('historyPage.allRatingsTitle');
                 } else {
                    historyTitle.textContent = i18next.t('historyPage.title');
                 }

                if (ratings.length === 0) {
                    historyContainer.innerHTML = `<div class="text-center p-6 bg-white rounded-lg shadow"><p>${i18next.t('historyPage.noRatings')}</p></div>`;
                }
                else {
                    let historyHtml = '<div class="space-y-4">';
                    ratings.sort((a, b) => (b.isPinned - a.isPinned) || (new Date(b.timestamp) - new Date(a.timestamp)));
                    ratings.forEach(data => {
                        // Ensure finalGrade exists (from DB)
                        if (!data.finalGrade || !data.finalGrade.grade || !data.finalGrade.name_cn) {
                            data.finalGrade = { grade: 'N/A', name_cn: i18next.t('historyPage.unrated') };
                        }
                        historyHtml += renderRatingCard(data, user.sub, userRole);
                    });
                    historyHtml += '</div>';
                    historyContainer.innerHTML = historyHtml;
                }
                 loadingMessage.style.display = 'none';
            } catch (error) {
                console.error("获取历史记录失败:", error);
                historyTitle.textContent = i18next.t('historyPage.title');
                historyContainer.innerHTML = `<div class="text-center p-6 bg-red-100 text-red-700 rounded-lg shadow"><p>${i18next.t('historyPage.loadFailed', { msg: error.message })}</p></div>`;
                loadingMessage.style.display = 'none';
            }
        }

        function renderRatingCard(data, currentUserId, currentUserRole) {
            const ratingId = data.id;
            const date = data.timestamp ? new Date(data.timestamp).toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }) : i18next.t('historyPage.unknownDate');
            const scoreDisplay = data.normalizedScore !== undefined ? data.normalizedScore.toFixed(2) : 'N/A';
            
            // **NOTE**: This name_cn comes from the DB and will remain in Chinese
            const gradeDisplay = data.finalGrade ? `${data.finalGrade.grade} - ${data.finalGrade.name_cn}` : i18next.t('historyPage.unrated');
            
            const isOwner = data.userId === currentUserId;
            const isAdmin = currentUserRole === 'admin' || currentUserRole === 'super_admin';
            const canModify = isOwner || isAdmin;
            const canCertifyOrPin = isAdmin;
            const authorDisplay = data.userNickname || data.userEmail || data.userId || i18next.t('historyPage.unknownUser');
            const isPinned = data.isPinned;

            let actionButtonsHtml = '';
            if (canModify) {
                actionButtonsHtml += `<button onclick="editRating('${ratingId}', event)" class="py-1 px-3 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition">${i18next.t('common.edit')}</button>`;
                actionButtonsHtml += `<button onclick="deleteRating('${ratingId}', event)" class="py-1 px-3 bg-red-500 text-white text-xs rounded hover:bg-red-600 transition ml-2">${i18next.t('common.delete')}</button>`;
            }
            if (canCertifyOrPin) {
                actionButtonsHtml += `<button data-action="certify" onclick="updateCertification('${ratingId}', true, event)" class="py-1 px-3 bg-green-500 text-white text-xs rounded hover:bg-green-600 transition ml-2 ${data.isCertified ? 'hidden' : ''}">${i18next.t('common.certify')}</button>`;
                actionButtonsHtml += `<button data-action="uncertify" onclick="updateCertification('${ratingId}', false, event)" class="py-1 px-3 bg-yellow-600 text-white text-xs rounded hover:bg-yellow-700 transition ml-2 ${!data.isCertified ? 'hidden' : ''}">${i18next.t('common.uncertify')}</button>`;
                actionButtonsHtml += `<button data-action="pin" onclick="updatePinStatus('${ratingId}', true, event)" class="py-1 px-3 bg-pink-500 text-white text-xs rounded hover:bg-pink-600 transition ml-2 ${isPinned ? 'hidden' : ''}">${i18next.t('common.pin')}</button>`;
                actionButtonsHtml += `<button data-action="unpin" onclick="updatePinStatus('${ratingId}', false, event)" class="py-1 px-3 bg-gray-500 text-white text-xs rounded hover:bg-gray-600 transition ml-2 ${!isPinned ? 'hidden' : ''}">${i18next.t('common.unpin')}</button>`;
            }

            const pinIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M9.03 2.5a.75.75 0 0 0-1.06 0l-4 4a.75.75 0 1 0 1.06 1.06L7 5.81v4.44a3.752 3.752 0 0 0-1.36.47l-1.88 1.1-.31.18a.75.75 0 0 0 .8 1.3l.3-.18 1.88-1.1a2.252 2.252 0 0 1 2.12 0l1.88 1.1.3.18a.75.75 0 0 0 .8-1.3l-.3-.18-1.88-1.1a3.752 3.752 0 0 0-1.36-.47V5.81l1.97 1.97a.75.75 0 1 0 1.06-1.06l-4-4Z"/></svg>`;

            return `
                <div id="rating-card-${ratingId}" class="rating-card block bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer relative" onclick="viewRatingDetails('${ratingId}')">
                     ${isAdmin && isPinned ? `<div class="pinned-indicator" title="${i18next.t('common.pin')}">${pinIconSvg} ${i18next.t('common.pin')}</div>` : ''}
                    <div class="flex flex-wrap justify-between items-center gap-2">
                        <div class="flex-grow min-w-0 pr-4">
                             <p class="text-lg font-bold text-gray-800 truncate" title="${data.title || ''}">${data.title || i18next.t('certifiedPage.noTitle')}</p>
                             <p class="text-sm text-gray-500 truncate" title="${data.cigarInfo?.name || ''}">
                                ${data.cigarInfo?.name || i18next.t('certifiedPage.unnamedCigar')} |
                                ${data.cigarInfo?.size || i18next.t('common.noData')} |
                                ${data.cigarInfo?.origin || i18next.t('common.noData')} | ${date}
                                ${ isAdmin ? `<span class="font-medium text-gray-600 ml-2">| ${i18next.t('historyPage.userLabel')} ${authorDisplay}</span>` : '' }
                             </p>
                        </div>
                        <div class="flex items-center flex-shrink-0 space-x-3">
                            <div class="text-right"> <p class="text-xl font-black text-indigo-600">${scoreDisplay}</p> <p class="font-bold text-gray-600 text-xs">${gradeDisplay}</p> </div>
                            <div class="action-buttons flex items-center space-x-2 flex-wrap gap-1 ${!actionButtonsHtml ? 'hidden' : ''}"> ${actionButtonsHtml} </div>
                        </div>
                    </div>
                </div>
            `;
        }
        // --- End Data Fetching and Rendering ---

        // --- Initialization ---
        window.addEventListener('load', async function() {
             await initI18n(); // Wait for i18n
             
             const urlParams = new URLSearchParams(window.location.search);
             const code = urlParams.get('code');
             let user = null;
             if (code) { user = await handleOidcCallback(code); } else { user = await validateSessionAndGetUser(); }
             currentAuthUser = user;
             userRole = currentAuthUser?.db_role ?? 'guest';
             
             renderLoginStatus(currentAuthUser); // Render login *after* i18n
             setupLanguageSwitcher(); // Setup switcher
             
             await fetchAndRenderHistory(currentAuthUser); // Pass user object
        });
    </script>
</body>
</html>