<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>评分历史</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- 
      移除了 Firebase/Firestore 相关的 imports.
      此页面现在将使用 sessionStorage 和 /api/ratings 端点,
      与 index.html 保持一致。
    -->
    <script type="module">
        window.onload = function() {
            let userRole = 'unknown';
            let historicalRatings = {}; 
            let accessToken = null;

            // 从 sessionStorage 获取认证信息
            accessToken = sessionStorage.getItem('accessToken');
            const storedUser = sessionStorage.getItem('userInfo');
            let currentAuthUser = storedUser ? JSON.parse(storedUser) : null;
            
            // 如果 currentAuthUser 存在，从中获取角色
            if (currentAuthUser && currentAuthUser.db_role) {
                userRole = currentAuthUser.db_role;
            }

            // --- 认证和数据获取 ---
            async function fetchAndRenderHistory() {
                const container = document.getElementById('history-container');
                const title = document.getElementById('history-title');

                // 1. 检查是否存在 token
                if (!accessToken) {
                    title.textContent = "评分历史";
                    container.innerHTML = `<div class="text-center p-6 bg-white rounded-lg shadow"><p>请<a href="index.html" class="text-indigo-600 underline">登录</a>以查看您的评分历史。</p></div>`;
                    return;
                }

                // 2. 如果 token 存在 (但可能角色未知), 尝试从 /api/me 获取最新角色
                //    这可以确保角色信息是最新的
                if (userRole === 'unknown' || !currentAuthUser) {
                     try {
                        const meResponse = await fetch('/api/me', {
                             headers: { 'Authorization': `Bearer ${accessToken}` }
                        });
                        if (meResponse.ok) {
                            currentAuthUser = await meResponse.json();
                            userRole = currentAuthUser.db_role;
                            sessionStorage.setItem('userInfo', JSON.stringify(currentAuthUser)); // 更新 sessionStorage
                        } else {
                             // 如果 /api/me 失败 (例如 token 过期), 则抛出错误
                             sessionStorage.removeItem('accessToken'); 
                             sessionStorage.removeItem('userInfo');
                             throw new Error('会话无效或已过期，请重新登录。');
                        }
                     } catch (e) {
                        title.textContent = "评分历史";
                        container.innerHTML = `<div class="text-center p-6 bg-red-100 text-red-700 rounded-lg shadow"><p>${e.message}</p><p class="mt-2"><a href="index.html" class="text-indigo-600 underline">返回主页登录</a></p></div>`;
                        return;
                     }
                }

                // 3. 获取评分数据
                container.innerHTML = `<div class="text-center p-6"><p>正在加载历史记录...</p></div>`;
                
                try {
                    // 调用 /api/ratings (GET)
                    const response = await fetch('/api/ratings', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    
                    if (!response.ok) {
                        const err = await response.json();
                        // 如果 token 再次失效 (例如在 /api/me 和此次调用之间失效)
                        if (response.status === 401) {
                             sessionStorage.removeItem('accessToken'); 
                             sessionStorage.removeItem('userInfo');
                             throw new Error('会话无效或已过期，请重新登录。');
                        }
                        throw new Error(err.error || `服务器错误 (${response.status})`);
                    }
                    
                    const ratings = await response.json();

                    if (userRole === 'super_admin') {
                        title.textContent = "所有用户的评分历史";
                    } else {
                        title.textContent = "我的评分历史";
                    }

                    if (!ratings || ratings.length === 0) {
                        container.innerHTML = `<div class="text-center p-6 bg-white rounded-lg shadow"><p>还没有任何评分记录。</p></div>`;
                        return;
                    }

                    let historyHtml = '<div class="space-y-4">';
                    
                    // 遍历从 D1 API 返回的数据
                    ratings.forEach(row => {
                        // `row` 是 D1 数据库的行
                        // `row.fullData` 包含了原始的 JSON 对象
                        const data = row.fullData; 
                        const ratingId = row.id; 
                        
                        // 存储原始对象以便查看详情
                        if(data) {
                           historicalRatings[ratingId] = data; 
                        }

                        // 解析 timestamp (ISO string from D1)
                        const date = row.timestamp ? new Date(row.timestamp).toLocaleDateString('zh-CN') : '未知日期';
                        
                        // 使用 D1 的列 (如果 fullData 解析失败, 也能优雅降级)
                        const scoreDisplay = row.normalizedScore !== null ? Number(row.normalizedScore).toFixed(2) : 'N/A';
                        const gradeDisplay = row.finalGrade_grade ? `${row.finalGrade_grade} - ${row.finalGrade_name_cn}` : '未评级';
                        const cigarName = row.cigarName || data?.cigarInfo?.name || '未知雪茄';
                        const cigarSize = row.cigarSize || data?.cigarInfo?.size || '未知尺寸';
                        const cigarOrigin = row.cigarOrigin || data?.cigarInfo?.origin || '未知产地';

                        let certifyButtonHtml = '';
                        // 认证逻辑需要一个新的 API 端点, 暂时禁用
                        /*
                        if (userRole === 'super_admin') {
                            if (row.isCertified && row.certifiedRatingId) {
                                certifyButtonHtml = `<button onclick="uncertifyRating('${ratingId}', '${row.certifiedRatingId}', event)" class="mt-2 w-full text-sm py-1 px-3 bg-red-500 text-white rounded-md hover:bg-red-600 transition">取消认证 (TBD)</button>`;
                            } else {
                                certifyButtonHtml = `<button onclick="certifyRating('${ratingId}', event)" class="mt-2 w-full text-sm py-1 px-3 bg-green-500 text-white rounded-md hover:bg-green-600 transition">认证 (TBD)</button>`;
                            }
                        }
                        */

                        historyHtml += `
                            <a href="#" onclick="viewRatingDetails('${ratingId}'); return false;" class="block bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="text-lg font-bold text-gray-800">${cigarName}</p>
                                        <p class="text-sm text-gray-500">${cigarSize} | ${cigarOrigin} | ${date}</p>
                                        ${ userRole === 'super_admin' ? `<p class="text-xs text-gray-400 pt-1">用户: ${row.userEmail || row.userId}</p>` : '' }
                                    </div>
                                    <div class="text-right flex-shrink-0 ml-4">
                                        <p class="text-2xl font-black text-indigo-600">${scoreDisplay}</p>
                                        <p class="font-bold text-gray-600">${gradeDisplay}</p>
                                    </div>
                                </div>
                                ${certifyButtonHtml ? `<div class="mt-2 border-t pt-2">${certifyButtonHtml}</div>` : ''}
                            </a>
                        `;
                    });
                    historyHtml += '</div>';
                    container.innerHTML = historyHtml;

                } catch (error) {
                    console.error("获取历史记录失败:", error);
                    let errorMsg = `加载历史记录失败: ${error.message}`;
                    if (error.message.includes('重新登录')) {
                         errorMsg += ` <a href="index.html" class="text-indigo-600 underline">返回主页登录</a>`;
                    }
                    container.innerHTML = `<div class="text-center p-6 bg-red-100 text-red-700 rounded-lg shadow"><p>${errorMsg}</p></div>`;
                }
            }
            
            // --- 认证功能 (TBD) ---
            // TODO: 这些功能需要一个新的 /api/certify 端点
            window.certifyRating = async function(ratingId, event) {
                event.stopPropagation();
                alert("认证功能正在开发中。");
                // ...
            }

            window.uncertifyRating = async function(ratingId, certifiedRatingId, event) {
                event.stopPropagation();
                if (!confirm("确定要取消这条记录的 Pistacho 认证吗？")) return;
                alert("取消认证功能正在开发中。");
                // ...
            }
            
            // --- 查看详情 ---
            window.viewRatingDetails = function(ratingId) {
                const ratingData = historicalRatings[ratingId];
                if (ratingData) {
                    // 确保 isDraft 标志被移除 (或设为 false), 
                    // 这样 "保存" 按钮就不会出现在 results 页面
                    ratingData.isDraft = false; 
                    sessionStorage.setItem('cigarRatingResults', JSON.stringify(ratingData));
                    window.location.href = 'results.html';
                } else {
                    alert("无法加载该评分的详细信息。 (ID: " + ratingId + ")");
                }
            }
            
            // --- 启动 ---
            fetchAndRenderHistory();
        }
    </script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="max-w-4xl mx-auto p-4 md:p-8">
        <nav class="mb-4 flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
             <a href="index.html" class="text-xl font-bold text-indigo-600">Pistacho评分</a>
             <div class="space-x-4">
                 <a href="history.html" class="text-indigo-600 font-bold underline">历史记录</a>
                 <a href="certified.html" class="text-gray-600 hover:text-indigo-600">认证评分</a>
             </div>
        </nav>
        <header class="mb-6">
            <h1 id="history-title" class="text-4xl font-extrabold text-gray-800">评分历史</h1>
        </header>
        <div id="history-container">
            <!-- History items will be rendered here -->
        </div>
         <footer class="mt-8 text-center">
            <a href="index.html" class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">&larr; 返回主页</a>
        </footer>
    </div>
</body>
</html>
