<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>评分历史</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <script type="module">
        // ---------------------------------------------------
        // 1. 全局变量
        // ---------------------------------------------------
        let currentAuthUser = null;
        let accessToken = null;
        let historicalRatings = {}; // 用于在 'view' 时传递数据

        // ---------------------------------------------------
        // 2. 认证和 API 调用 (无 Firebase 依赖)
        // ---------------------------------------------------
        
        /**
         * 从 sessionStorage 获取登录状态
         */
        function initializeAuth() {
            const storedUser = sessionStorage.getItem('userInfo');
            const storedToken = sessionStorage.getItem('accessToken');
            
            if (storedUser && storedToken) {
                currentAuthUser = JSON.parse(storedUser);
                accessToken = storedToken;
                return true;
            }
            return false;
        }

        /**
         * 调用后端 API
         */
        async function apiFetch(endpoint, options = {}) {
            const headers = { 'Content-Type': 'application/json', ...options.headers };
            if (!accessToken) { 
                 throw new Error("用户未认证或会话已过期。"); 
            }
            headers['Authorization'] = `Bearer ${accessToken}`;
            
            const apiUrl = new URL(endpoint, window.location.origin);
            const response = await fetch(apiUrl, { ...options, headers });
            
            if (!response.ok) {
                let errorData = { error: `请求失败 (${response.status})` };
                try {
                    errorData = await response.json();
                } catch(e) { /* Ignore */ }
                throw new Error(errorData.error || `请求失败 (${response.status})`);
            }
            return response.json();
        }

        // ---------------------------------------------------
        // 3. 页面功能
        // ---------------------------------------------------
        
        /**
         * 查看评分详情
         */
        window.viewRatingDetails = function(ratingId) {
            const ratingData = historicalRatings[ratingId];
            if (ratingData && ratingData.fullData) {
                // 使用 fullData (它包含了 config)
                sessionStorage.setItem('cigarRatingResults', JSON.stringify(ratingData.fullData));
                window.location.href = 'results.html';
            } else {
                alert("无法加载该评分的详细信息。");
            }
        }

        /**
         * **NEW**: 修改评分
         */
        window.editRating = function(ratingId, event) {
            event.stopPropagation(); // 防止触发 viewRatingDetails
            const ratingData = historicalRatings[ratingId];
            if (ratingData && ratingData.fullData) {
                // 1. 将完整的评分数据 (fullData) 存入 sessionStorage, 供 index.html 读取
                sessionStorage.setItem('cigarRatingDraft', JSON.stringify(ratingData.fullData));
                // 2. 跳转到 index.html 并带上 'edit' 参数
                window.location.href = `index.html?edit=${ratingId}`;
            } else {
                alert("无法加载评分数据进行编辑。");
            }
        }
        
        /**
         * **NEW**: 删除评分
         */
        window.deleteRating = async function(ratingId, cigarName, event) {
            event.stopPropagation(); // 防止触发 viewRatingDetails
            
            if (!confirm(`确定要永久删除评分 "${cigarName}" 吗？此操作无法撤销。`)) {
                return;
            }

            const button = event.target;
            button.textContent = '删除中...';
            button.disabled = true;

            try {
                await apiFetch(`/api/ratings?id=${ratingId}`, { method: 'DELETE' });
                // 成功后, 重新加载列表
                fetchAndRenderHistory(); 
            } catch (error) {
                alert(`删除失败: ${error.message}`);
                button.textContent = '删除';
                button.disabled = false;
            }
        }

        /**
         * **MOCKUP**: 认证功能 (尚未实现)
         */
        window.certifyRating = function(ratingId, event) {
            event.stopPropagation();
            alert("认证功能正在开发中。\n (需要后端 /api/certify 接口支持)");
        }
        window.uncertifyRating = function(ratingId, certifiedRatingId, event) {
            event.stopPropagation();
            alert("取消认证功能正在开发中。");
        }
        
        /**
         * 获取并渲染历史记录
         */
        async function fetchAndRenderHistory() {
            const container = document.getElementById('history-container');
            const title = document.getElementById('history-title');

            if (!currentAuthUser) {
                title.textContent = "评分历史";
                container.innerHTML = `<div class="text-center p-6 bg-white rounded-lg shadow"><p>请<a href="index.html" class="text-indigo-600 underline">登录</a>以查看您的评分历史。</p></div>`;
                return;
            }

            container.innerHTML = `<div class="text-center p-6"><p>正在加载历史记录...</p></div>`;
            
            try {
                // 调用 D1 API (GET /api/ratings)
                const ratings = await apiFetch('/api/ratings');
                
                // 更新标题
                const userRole = currentAuthUser.db_role;
                if (userRole === 'super_admin') {
                    title.textContent = "所有用户的评分历史";
                } else {
                    title.textContent = "我的评分历史";
                }

                if (!ratings || ratings.length === 0) {
                    container.innerHTML = `<div class="text-center p-6 bg-white rounded-lg shadow"><p>还没有任何评分记录。</p></div>`;
                    return;
                }

                let historyHtml = '<div class="space-y-4">';
                historicalRatings = {}; // 清空缓存

                ratings.forEach(data => {
                    const ratingId = data.id;
                    historicalRatings[ratingId] = data; // 缓存完整数据
                    
                    const date = data.timestamp ? new Date(data.timestamp).toLocaleDateString('zh-CN') : '未知日期';
                    const scoreDisplay = data.normalizedScore !== undefined ? data.normalizedScore.toFixed(2) : 'N/A';
                    const gradeDisplay = data.finalGrade_grade ? `${data.finalGrade_grade} - ${data.finalGrade_name_cn}` : '未评级';
                    
                    // **NEW**: 优先使用昵称
                    const displayName = data.userNickname || data.userEmail || data.userId; // 昵称 > 邮箱 > ID
                    const cigarName = data.cigarName || '未命名雪茄';
                    const cigarSize = data.cigarSize || '未知尺寸';
                    const cigarOrigin = data.cigarOrigin || '未知产地';

                    // --- 按钮逻辑 ---
                    let certifyButtonHtml = '';
                    let actionButtonHtml = '';
                    
                    const isOwner = currentAuthUser.sub === data.userId;
                    const isSuperAdmin = userRole === 'super_admin';
                    // **NEW**: Check for admin role as well
                    const isAdmin = userRole === 'admin' || isSuperAdmin;

                    // 1. 认证/取消认证按钮 (仅超级管理员)
                    if (isSuperAdmin) {
                        if (data.isCertified && data.certifiedRatingId) {
                            certifyButtonHtml = `<button onclick="uncertifyRating('${ratingId}', '${data.certifiedRatingId}', event)" class="flex-1 text-sm py-1 px-3 bg-red-500 text-white rounded-md hover:bg-red-600 transition">取消认证</button>`;
                        } else {
                            certifyButtonHtml = `<button onclick="certifyRating('${ratingId}', event)" class="flex-1 text-sm py-1 px-3 bg-green-500 text-white rounded-md hover:bg-green-600 transition">认证</button>`;
                        }
                    }
                    
                    // 2. 修改/删除按钮 (本人 或 管理员/超级管理员)
                    if (isOwner || isAdmin) {
                        actionButtonHtml = `
                            <button onclick="editRating('${ratingId}', event)" class="flex-1 text-sm py-1 px-3 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">修改</button>
                            <button onclick="deleteRating('${ratingId}', '${cigarName.replace(/'/g, "\\'")}', event)" class="flex-1 text-sm py-1 px-3 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition">删除</button>
                        `;
                    }
                    
                    // 组合按钮区域
                    let buttonAreaHtml = '';
                    if (certifyButtonHtml || actionButtonHtml) {
                        buttonAreaHtml = `
                        <div class="mt-2 border-t pt-2">
                           <div class="flex space-x-2">
                                ${actionButtonHtml}
                                ${certifyButtonHtml}
                           </div>
                        </div>`;
                    }

                    historyHtml += `
                        <a href="#" onclick="viewRatingDetails('${ratingId}'); return false;" class="block bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-lg font-bold text-gray-800">${cigarName}</p>
                                    <p class="text-sm text-gray-500">${cigarSize} | ${cigarOrigin} | ${date}</p>
                                    ${ isSuperAdmin ? `<p class="text-xs text-gray-400 pt-1">用户: ${displayName}</p>` : '' }
                                </div>
                                <div class="text-right flex-shrink-0 ml-4">
                                    <p class="text-2xl font-black text-indigo-600">${scoreDisplay}</p>
                                    <p class="font-bold text-gray-600">${gradeDisplay}</p>
                                </div>
                            </div>
                            ${buttonAreaHtml}
                        </a>
                    `;
                });
                historyHtml += '</div>';
                container.innerHTML = historyHtml;

            } catch (error) {
                console.error("获取历史记录失败:", error);
                container.innerHTML = `<div class="text-center p-6 bg-red-100 text-red-700 rounded-lg shadow"><p>加载历史记录失败: ${error.message}</p></div>`;
            }
        }

        // ---------------------------------------------------
        // 4. 页面启动
        // ---------------------------------------------------
        window.onload = function() {
            if (initializeAuth()) {
                fetchAndRenderHistory();
            } else {
                fetchAndRenderHistory(); // 函数内部会处理未登录状态
            }
        }
    </script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="max-w-4xl mx-auto p-4 md:p-8">
        <nav class="mb-4 flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
             <a href="index.html" class="text-xl font-bold text-indigo-600">Pistacho评分</a>
             <div class="space-x-4">
                 <a href="history.html" class="text-indigo-600 font-bold underline">历史记录</a>
                 <a href="certified.html" class="text-gray-600 hover:text-indigo-600">认证评分</a>
             </div>
        </nav>
        <header class="mb-6">
            <h1 id="history-title" class="text-4xl font-extrabold text-gray-800">评分历史</h1>
        </header>
        <div id="history-container">
            <!-- History items will be rendered here -->
        </div>
         <footer class="mt-8 text-center">
            <a href="index.html" class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">&larr; 返回主页</a>
        </footer>
    </div>
</body>
</html>


