<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="historyPage.title">我的评分</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/i18next/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-http-backend/i18nextHttpBackend.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector/i18nextBrowserLanguageDetector.min.js"></script>
    <script type="module" src="scripts/navbar.js"></script>

    <script>
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: {
                            sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                        }
                    }
                }
            }
        } else {
             console.warn('Tailwind object not found. Skipping config.');
        }
    </script>
    <style>
        .rating-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .action-buttons button, .action-buttons a {
            padding: 0.25rem 0.75rem; /* py-1 px-3 */
            font-size: 0.75rem; /* text-xs */
            border-radius: 0.25rem; /* rounded */
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        .pinned-indicator {
             position: absolute;
             top: 0.5rem;
             right: 0.5rem;
             background-color: #ec4899; /* Pink */
             color: white;
             padding: 0.1rem 0.5rem;
             border-radius: 9999px;
             font-size: 0.7rem;
             font-weight: bold;
             display: flex;
             align-items: center;
             z-index: 10;
        }
         .pinned-indicator svg {
             width: 0.7rem;
             height: 0.7rem;
             margin-right: 0.2rem;
         }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="px-4 sm:px-6 lg:px-8 pt-4">
        <div class="mx-auto max-w-7xl">
            <div data-include-nav data-active="history" data-language="switcher"></div>
        </div>
    </div>
    <div class="max-w-4xl mx-auto p-4 md:p-8">
        <header class="mb-6">
            <h1 id="history-title" class="text-4xl font-extrabold text-gray-800" data-i18n="historyPage.title">我的评分</h1>
        </header>

        <div id="login-prompt" class="hidden text-center p-6 bg-yellow-100 text-yellow-800 rounded-lg shadow mb-8">
             <p class="font-semibold mb-3" data-i18n="historyPage.loginPrompt">请先登录才能查看您的评分记录。</p>
             <button onclick="login()" class="px-5 py-2 text-sm font-medium rounded-lg bg-green-500 text-white hover:bg-green-600" data-i18n="nav.login">前往登录/注册</button>
        </div>

        <div id="history-container">
            <p id="loading-message" class="text-center text-gray-500 py-10" data-i18n="common.loading">正在加载...</p>
        </div>

        <section id="comment-participation-section" class="hidden mt-10">
            <h2 class="text-2xl font-bold text-gray-800" data-i18n="historyPage.commentHistoryTitle">我参与的其他点评</h2>
            <div id="comment-participation-container" class="mt-4 space-y-4"></div>
        </section>

         <footer class="mt-8 text-center">
            <a href="index.html" class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700" data-i18n="nav.community">&larr; 返回社区首页</a>
        </footer>
    </div>

    <script type="module">
        // --- i18n Functions ---
        async function initI18n() {
            await i18next
                .use(i18nextHttpBackend)
                .use(i18nextBrowserLanguageDetector)
                .init({
                    fallbackLng: 'zh',
                    debug: false,
                    ns: ['translation'],
                    defaultNS: 'translation',
                    backend: {
                        loadPath: '/locales/{{lng}}.json?v=1'
                    },
                    detection: {
                        order: ['localStorage', 'navigator'],
                        caches: ['localStorage']
                    }
                });
            updateContent();
        }

        function updateContent() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const value = i18next.t(key);
                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    el.placeholder = value;
                } else if (el.tagName === 'OPTION') {
                    el.textContent = value;
                } else {
                    el.innerHTML = value;
                }
            });
            // Update title based on whether admin view is active
            const isAdmin = currentAuthUser && (currentAuthUser.db_role === 'admin' || currentAuthUser.db_role === 'super_admin');
            document.title = i18next.t(isAdmin ? 'historyPage.allRatingsTitle' : 'historyPage.title');
            historyTitle.textContent = i18next.t(isAdmin ? 'historyPage.allRatingsTitle' : 'historyPage.title');
            renderCommentParticipation(commentParticipationData);
        }

        function setupLanguageSwitcher() {
            const switcher = document.getElementById('language-switcher');
            if (!switcher) return;
            const currentLang = i18next.language.split('-')[0];
            switcher.value = ['zh', 'en', 'es'].includes(currentLang) ? currentLang : 'zh';

            switcher.addEventListener('change', async (e) => {
                const newLang = e.target.value;
                await i18next.changeLanguage(newLang);
                updateContent();
                // 重新渲染动态内容
                await fetchAndRenderHistory(currentAuthUser); // 重载数据和UI
                renderLoginStatus(currentAuthUser);
            });
        }
        document.addEventListener('navbar:loaded', () => {
            setupLanguageSwitcher();
            renderLoginStatus(currentAuthUser);
        });

        // --- End i18n Functions ---

        // --- Global Variables ---
        let historicalRatings = {}; // Cache fetched ratings by ID
        let currentAuthUser = null;
        let userRole = 'guest';
        const loadingMessage = document.getElementById('loading-message');
        const historyContainer = document.getElementById('history-container');
        const historyTitle = document.getElementById('history-title');
        const loginPrompt = document.getElementById('login-prompt');
        const commentParticipationSection = document.getElementById('comment-participation-section');
        const commentParticipationContainer = document.getElementById('comment-participation-container');

        const AUTHING_APP_ID = '68f5b0b6875017c02b3bfdb3';
        const AUTHING_HOST = 'https://xfvu647mcdbk-demo.authing.cn';

        // GRADING_SCALE constant definition
        const GRADING_SCALE = [
            { "grade": "P", "nameKey": "resultsPage.grade.P", "min_score": 95, "color": "gold" },
            { "grade": "I", "nameKey": "resultsPage.grade.I", "min_score": 90, "color": "indigo" },
            { "grade": "S", "nameKey": "resultsPage.grade.S", "min_score": 80, "color": "purple" },
            { "grade": "T", "nameKey": "resultsPage.grade.T", "min_score": 70, "color": "blue" },
            { "grade": "A", "nameKey": "resultsPage.grade.A", "min_score": 60, "color": "green" },
            { "grade": "C", "nameKey": "resultsPage.grade.C", "min_score": 50, "color": "gray" },
            { "grade": "H", "nameKey": "resultsPage.grade.H", "min_score": 30, "color": "orange" },
            { "grade": "O", "nameKey": "resultsPage.grade.O", "min_score": 0, "color": "red" }
        ];
        // --- End Global Variables ---

        let commentParticipationData = [];


        // --- Authentication ---
         window.login = function() { const redirectUri = window.location.origin; const authorizeUrl = new URL('/oidc/auth', AUTHING_HOST); authorizeUrl.search = new URLSearchParams({ client_id: AUTHING_APP_ID, redirect_uri: redirectUri, response_type: 'code', scope: 'openid profile email phone', state: Math.random().toString(36).substring(2) }).toString(); window.location.href = authorizeUrl.toString(); }
         window.logout = function() { const logoutUrl = new URL('/oidc/session/end', AUTHING_HOST); logoutUrl.search = new URLSearchParams({ post_logout_redirect_uri: window.location.origin }).toString(); sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken'); window.location.href = logoutUrl.toString(); }

         function renderLoginStatus(user) {
            const container = document.getElementById('login-status-container');
            if (!container) return;
            if (user) {
                const displayName = user.nickname || user.name || user.preferred_username || user.email || i18next.t('nav.login');
                container.innerHTML = `<span class="text-sm font-medium text-gray-700 mr-2 hidden sm:inline">${displayName}</span><button onclick="logout()" class="px-3 py-1 text-xs font-medium rounded-full bg-red-500 text-white hover:bg-red-600">${i18next.t('nav.logout')}</button>`;
            } else {
                container.innerHTML = `<button onclick="login()" class="px-3 py-1 text-xs font-medium rounded-full bg-green-500 text-white hover:bg-green-600">${i18next.t('nav.login')}</button>`;
            }
         }

         async function handleOidcCallback(code) { try { const redirectUri = window.location.origin; const apiUrl = new URL('/api/authing/callback', window.location.origin); const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code: code, redirect_uri: redirectUri }) }); if (!response.ok) { const err = await response.json(); throw new Error(err.error || `Token exchange failed (status ${response.status})`); } const fullUserProfile = await response.json(); sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile)); sessionStorage.setItem('accessToken', fullUserProfile.accessToken); return fullUserProfile; } catch (e) { console.error('认证回调处理失败:', e); alert(`登录失败: ${e.message}`); sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken'); return null; } finally { window.history.replaceState({}, document.title, window.location.pathname); } }
         async function validateSessionAndGetUser() { const token = sessionStorage.getItem('accessToken'); if (!token) return null; try { const apiUrl = new URL('/api/me', window.location.origin); const response = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${token}` } }); if (!response.ok) { console.warn("Session validation failed:", response.status); sessionStorage.removeItem('userInfo'); sessionStorage.removeItem('accessToken'); return null; } const fullUserProfile = await response.json(); sessionStorage.setItem('userInfo', JSON.stringify(fullUserProfile)); return fullUserProfile; } catch (e) { console.error("Session validation failed:", e); return null; } }
        // --- End Auth ---


        // --- Rating Actions ---
         window.editRating = function(ratingId, event) {
            event?.stopPropagation();
            window.location.href = `rate.html?edit=${ratingId}`;
         }

         window.deleteRating = async function(ratingId, event) {
            event?.stopPropagation();
            if (!confirm(i18next.t('common.confirmDeletion'))) { return; }
            const button = event ? (event.currentTarget || event.target) : null;
            const originalText = button ? button.textContent : i18next.t('common.delete');
            if (button) { button.textContent = i18next.t('common.loading'); button.disabled = true; }
            const token = sessionStorage.getItem('accessToken');
            if (!token) {
                alert(i18next.t('common.loginRequired'));
                if (button) { button.textContent = originalText; button.disabled = false; }
                return;
            }
            try {
                const apiUrl = new URL(`/api/ratings`, window.location.origin);
                const response = await fetch(apiUrl, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ ratingId: ratingId }) });
                const responseText = await response.text();
                let data;
                try { data = JSON.parse(responseText); } catch (parseError) { if (response.ok) { data = { success: true }; } else { data = { error: `Server returned invalid response (status ${response.status})` }; } }
                if (!response.ok) throw new Error(data?.error || `Delete failed (status ${response.status})`);
                const cardToRemove = document.getElementById(`rating-card-${ratingId}`);
                if (cardToRemove) { cardToRemove.style.transition = 'opacity 0.5s ease-out'; cardToRemove.style.opacity = '0'; setTimeout(() => cardToRemove.remove(), 500); }
                delete historicalRatings[ratingId]; // Remove from cache
                alert(i18next.t('common.deleteSuccess'));
            } catch (error) {
                console.error("[deleteRating] Caught error:", error);
                alert(i18next.t('common.deleteFailed', { msg: error.message }));
                if (button) { button.textContent = originalText; button.disabled = false; }
            }
         }

         window.updateCertification = async function(ratingId, shouldCertify, event) {
            event?.stopPropagation();
            const button = event ? (event.currentTarget || event.target) : null;
            const isCertifying = shouldCertify;
            const actionText = isCertifying ? i18next.t('common.certify') : i18next.t('common.uncertify');
            const originalText = button ? button.textContent : actionText;
            if (button) { button.textContent = i18next.t('common.loading'); button.disabled = true; }
            const token = sessionStorage.getItem('accessToken');
            if (!token) {
                alert(i18next.t('common.loginRequired'));
                if (button) { button.textContent = originalText; button.disabled = false; }
                return;
            }
            try {
                const apiUrl = new URL('/api/certify', window.location.origin);
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ ratingId: ratingId, certify: isCertifying }) });
                if (!response.ok) { let errorText = `${actionText} failed: ${response.status}`; try { const err = await response.json(); errorText = err.error || errorText; } catch(e){/*ignore*/} throw new Error(errorText); }
                const data = await response.json();
                const card = document.getElementById(`rating-card-${ratingId}`);
                if (card) {
                    if(historicalRatings[ratingId]) historicalRatings[ratingId].isCertified = isCertifying; // Update cache
                    const buttonContainer = card.querySelector('.action-buttons');
                    if (buttonContainer) {
                        const certifyButton = buttonContainer.querySelector('button[data-action="certify"]');
                        const uncertifyButton = buttonContainer.querySelector('button[data-action="uncertify"]');
                        if (isCertifying) {
                            if (certifyButton) certifyButton.classList.add('hidden');
                            if (uncertifyButton) { uncertifyButton.classList.remove('hidden'); uncertifyButton.disabled = false; }
                        } else {
                            if (certifyButton) { certifyButton.classList.remove('hidden'); certifyButton.disabled = false; }
                            if (uncertifyButton) uncertifyButton.classList.add('hidden');
                        }
                    }
                }
                alert(i18next.t('common.opSuccess'));
            } catch (error) {
                console.error(`${actionText} failed:`, error);
                alert(i18next.t('common.opFailed', { msg: error.message }));
                if (button) { button.textContent = originalText; button.disabled = false; }
            }
         }

         window.updatePinStatus = async function(ratingId, shouldPin, event) {
            event?.stopPropagation();
            const button = event ? (event.currentTarget || event.target) : null;
            const actionText = shouldPin ? i18next.t('common.pin') : i18next.t('common.unpin');
            const originalText = button ? button.textContent : actionText;
            if (button) { button.textContent = i18next.t('common.loading'); button.disabled = true; }
            const token = sessionStorage.getItem('accessToken');
            if (!token) {
                alert(i18next.t('common.loginRequired'));
                if (button) { button.textContent = originalText; button.disabled = false; }
                return;
            }
            try {
                const apiUrl = new URL('/api/pin', window.location.origin);
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ ratingId: ratingId, pin: shouldPin }) });
                if (!response.ok) { let errorText = `${actionText} failed: ${response.status}`; try { const err = await response.json(); errorText = err.error || errorText; } catch(e){/*ignore*/} throw new Error(errorText); }
                const data = await response.json();
                const card = document.getElementById(`rating-card-${ratingId}`);
                if (card) {
                    if(historicalRatings[ratingId]) historicalRatings[ratingId].isPinned = shouldPin; // Update cache
                    const buttonContainer = card.querySelector('.action-buttons');
                    if (buttonContainer) {
                        const pinButton = buttonContainer.querySelector('button[data-action="pin"]');
                        const unpinButton = buttonContainer.querySelector('button[data-action="unpin"]');
                        if (shouldPin) {
                            if (pinButton) pinButton.classList.add('hidden');
                            if (unpinButton) { unpinButton.classList.remove('hidden'); unpinButton.disabled = false; }
                        } else {
                            if (pinButton) { pinButton.classList.remove('hidden'); pinButton.disabled = false; }
                            if (unpinButton) unpinButton.classList.add('hidden');
                        }
                    }
                    const indicator = card.querySelector('.pinned-indicator');
                    if(indicator) indicator.style.display = shouldPin ? 'flex' : 'none';
                    else if (shouldPin) { // Add indicator if missing
                         const pinIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M9.03 2.5a.75.75 0 0 0-1.06 0l-4 4a.75.75 0 1 0 1.06 1.06L7 5.81v4.44a3.752 3.752 0 0 0-1.36.47l-1.88 1.1-.31.18a.75.75 0 0 0 .8 1.3l.3-.18 1.88-1.1a2.252 2.252 0 0 1 2.12 0l1.88 1.1.3.18a.75.75 0 0 0 .8-1.3l-.3-.18-1.88-1.1a3.752 3.752 0 0 0-1.36-.47V5.81l1.97 1.97a.75.75 0 1 0 1.06-1.06l-4-4Z"/></svg>`;
                         const newIndicator = document.createElement('div');
                         newIndicator.className = 'pinned-indicator';
                         newIndicator.title = i18next.t('common.pin');
                         newIndicator.innerHTML = `${pinIconSvg} ${i18next.t('common.pin')}`;
                         card.prepend(newIndicator); // Add to the top
                    }
                }
                alert(i18next.t('common.opSuccess'));
            } catch (error) {
                console.error(`${actionText} failed:`, error);
                alert(i18next.t('common.opFailed', { msg: error.message }));
                if (button) { button.textContent = originalText; button.disabled = false; }
            }
         }

        // *** MODIFIED: viewRatingDetails to ensure complete data is stored ***
         window.viewRatingDetails = function(ratingId) {
             const ratingData = historicalRatings[ratingId]; // Get data from cache
             if (!ratingData) {
                 console.error(`[history.html viewRatingDetails] Rating data not found in cache for ID: ${ratingId}`);
                 alert(i18next.t('common.loadDetailFailed'));
                 return;
             }

             // --- START: Construct finalGrade object robustly ---
             let finalGrade = null;
             // Try getting grade info directly from the ratingData (preferred)
             if (ratingData.finalGrade?.grade) {
                 const foundGrade = GRADING_SCALE.find(g => g.grade === ratingData.finalGrade.grade);
                 if (foundGrade) {
                     finalGrade = {
                         grade: foundGrade.grade,
                         nameKey: foundGrade.nameKey, // MUST include nameKey
                         color: foundGrade.color      // MUST include color
                     };
                 }
                 // If grade letter exists but not in scale, keep finalGrade null
             }
             // Fallback: Calculate from score ONLY if grade info is missing AND score exists
             else if (ratingData.normalizedScore !== undefined) {
                 console.warn(`[history.html viewRatingDetails] Rating ${ratingId} missing finalGrade object, calculating from score.`);
                 const foundGrade = GRADING_SCALE.find(g => ratingData.normalizedScore >= g.min_score) || GRADING_SCALE[GRADING_SCALE.length - 1];
                 finalGrade = {
                     grade: foundGrade.grade,
                     nameKey: foundGrade.nameKey,
                     color: foundGrade.color
                 };
             }
             // --- END: Construct finalGrade ---

             // Basic validation: Ensure score and cigar info exist
             if (!ratingData || ratingData.normalizedScore === undefined || !ratingData.cigarInfo) {
                 console.error("[history.html viewRatingDetails] Essential data (score, cigarInfo) missing!", {ratingData});
                 alert(i18next.t('resultsPage.loadErrorMissing')); // Use a more specific error
                 return;
             }
             // Also check if finalGrade could be constructed (critical for results page)
             if (!finalGrade) {
                 console.error("[history.html viewRatingDetails] Could not determine finalGrade!", {ratingData});
                 alert(i18next.t('resultsPage.scoreCalculationFailed')); // Use specific error
                 return;
             }


             // Prepare data structure expected by results.html
             let imageUrls = [];
             // Handle imageUrl which might be stringified JSON array or just a single key string
             if (typeof ratingData.imageUrl === 'string') {
                 try {
                     const parsed = JSON.parse(ratingData.imageUrl);
                     if (Array.isArray(parsed)) { imageUrls = parsed; }
                     else { imageUrls = [ratingData.imageUrl]; } // Assume single string if parse fails or not array
                 } catch(e) { imageUrls = [ratingData.imageUrl]; } // Treat as single string on parse error
             } else if (Array.isArray(ratingData.imageUrl)) {
                  imageUrls = ratingData.imageUrl;
             }

             // Ensure fullData exists for narrative/summary, provide defaults
             const hasCompleteFullData = ratingData.fullData && ratingData.fullData.config && ratingData.fullData.ratings && ratingData.fullData.calculatedScore !== undefined;

             const detailedData = {
                 ratingId: ratingData.id,
                 title: ratingData.title || i18next.t('common.noTitle'),
                 cigarInfo: ratingData.cigarInfo || { name: ratingData.cigarName, size: ratingData.cigarSize, origin: ratingData.cigarOrigin }, // Provide fallback cigarInfo
                 cigarReview: ratingData.cigarReview || i18next.t('common.noReview'),
                 imageUrls: imageUrls,
                 normalizedScore: ratingData.normalizedScore,
                 finalGrade: finalGrade, // Pass the constructed finalGrade object
                 selectedFlavors: Array.isArray(ratingData.fullData?.selectedFlavors) ? ratingData.fullData.selectedFlavors : [],
                 timestamp: ratingData.timestamp,
                 userNickname: ratingData.userNickname,
                 userEmail: ratingData.userEmail,
                 isDraft: false, // Data from history is never a draft
                 // Include config and ratings ONLY if fullData is complete
                 config: hasCompleteFullData ? ratingData.fullData.config : null,
                 ratings: hasCompleteFullData ? ratingData.fullData.ratings : null,
                 calculatedScore: hasCompleteFullData ? ratingData.fullData.calculatedScore : null
             };

            console.log("[history.html viewRatingDetails] Storing data to sessionStorage:", JSON.stringify(detailedData).substring(0,500) + '...'); // Log data being stored

             try {
                 sessionStorage.setItem('cigarRatingResults', JSON.stringify(detailedData));
                 window.location.href = 'results.html'; // Navigate to results page (will load from sessionStorage)
             } catch (e) {
                 console.error("Error setting sessionStorage:", e);
                 alert(i18next.t('common.sessionStoreFailed'));
             }
         }
        // --- End Rating Actions ---

        // --- Data Fetching and Rendering ---
        async function fetchAndRenderHistory(user) {
            if (!user) {
                // historyTitle.textContent = i18next.t('historyPage.title'); // Title updated in updateContent
                historyContainer.style.display = 'none';
                loginPrompt.classList.remove('hidden');
                loadingMessage.style.display = 'none';
                if (commentParticipationSection) commentParticipationSection.classList.add('hidden');
                commentParticipationData = [];
                return;
            } else {
                 historyContainer.style.display = 'block';
                 loginPrompt.classList.add('hidden');
            }

            const token = sessionStorage.getItem('accessToken');
            if (!token) {
                 // historyTitle.textContent = i18next.t('historyPage.title'); // Title updated in updateContent
                 historyContainer.style.display = 'none';
                 loginPrompt.classList.remove('hidden');
                 loginPrompt.querySelector('p').textContent = i18next.t('historyPage.loginExpired');
                 loadingMessage.style.display = 'none';
                 if (commentParticipationSection) commentParticipationSection.classList.add('hidden');
                 commentParticipationData = [];
                 return;
            }

            loadingMessage.textContent = i18next.t('historyPage.loadingHistory');
            loadingMessage.style.display = 'block';
            historyContainer.innerHTML = ''; // Clear previous results

            try {
                 const apiUrl = new URL('/api/ratings', window.location.origin);
                 // No need to pass userId, API determines based on token/role
                 const response = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${token}` } });
                 if (!response.ok) { let errorText = `Load failed: ${response.status}`; try { const err = await response.json(); errorText = err.error || errorText; } catch(e){/*ignore*/} throw new Error(errorText); }

                 const ratings = await response.json();
                 historicalRatings = {}; // Reset cache
                 ratings.forEach(r => historicalRatings[r.id] = r); // Populate cache
                 userRole = currentAuthUser?.db_role || 'general'; // Use the globally set role

                 updateContent(); // Update title based on role

                if (ratings.length === 0) {
                    historyContainer.innerHTML = `<div class="text-center p-6 bg-white rounded-lg shadow"><p>${i18next.t('historyPage.noRatings')}</p></div>`;
                }
                else {
                    let historyHtml = '<div class="space-y-4">';
                    // Sort ratings: Pinned first, then by timestamp descending
                    ratings.sort((a, b) => (b.isPinned - a.isPinned) || (new Date(b.timestamp) - new Date(a.timestamp)));
                    ratings.forEach(data => {
                        // Ensure required fields exist, provide defaults if not
                        data.finalGrade = data.finalGrade || {}; // Ensure finalGrade object exists
                        data.cigarInfo = data.cigarInfo || {}; // Ensure cigarInfo object exists
                        historyHtml += renderRatingCard(data, user.sub, userRole);
                    });
                    historyHtml += '</div>';
                    historyContainer.innerHTML = historyHtml;
                }
                 loadingMessage.style.display = 'none'; // Hide loading indicator
                await fetchCommentParticipation(user);
            } catch (error) {
                console.error("获取历史记录失败:", error);
                // updateContent(); // Update title even on error
                historyContainer.innerHTML = `<div class="text-center p-6 bg-red-100 text-red-700 rounded-lg shadow"><p>${i18next.t('historyPage.loadFailed', { msg: error.message })}</p></div>`;
                loadingMessage.style.display = 'none';
            }
        }

        function renderRatingCard(data, currentUserId, currentUserRole) {
            const ratingId = data.id;
            const date = data.timestamp ? new Date(data.timestamp).toLocaleDateString(i18next.language, { year: 'numeric', month: '2-digit', day: '2-digit' }) : i18next.t('historyPage.unknownDate');
            const scoreDisplay = data.normalizedScore !== undefined ? data.normalizedScore.toFixed(2) : 'N/A';

            // Use GRADING_SCALE and i18n
            let gradeDisplay = i18next.t('historyPage.unrated'); // Default text
            // Check based on finalGrade_grade property from API response
            if (data.finalGrade_grade) {
                 const foundGrade = GRADING_SCALE.find(g => g.grade === data.finalGrade_grade);
                 if (foundGrade) {
                     const gradeName = i18next.t(foundGrade.nameKey); // Use i18n to get translated name
                     gradeDisplay = `${data.finalGrade_grade} - ${gradeName}`;
                 } else {
                     gradeDisplay = `${data.finalGrade_grade} - ?`; // Fallback if grade letter not found in scale
                 }
            } else if (data.normalizedScore !== undefined) {
                 // Fallback: Calculate grade from score if grade info is missing in data
                 console.warn(`[history.html renderRatingCard] Rating ${ratingId} missing finalGrade_grade, calculating from score.`);
                 const foundGrade = GRADING_SCALE.find(g => data.normalizedScore >= g.min_score) || GRADING_SCALE[GRADING_SCALE.length - 1];
                 const gradeName = i18next.t(foundGrade.nameKey);
                 gradeDisplay = `${foundGrade.grade} - ${gradeName}`;
            }
            // --- End Modification ---

            const isOwner = data.userId === currentUserId;
            const isAdmin = currentUserRole === 'admin' || currentUserRole === 'super_admin';
            const canModify = isOwner || isAdmin;
            const canCertifyOrPin = isAdmin;
            // Display author only if admin is viewing all ratings
            const authorDisplay = data.userNickname || data.userEmail || data.userId || i18next.t('historyPage.unknownUser');
            const showAuthor = isAdmin; // Only show author for admin view
            const isPinned = data.isPinned;

            let actionButtonsHtml = '';
            if (canModify) {
                actionButtonsHtml += `<button onclick="editRating('${ratingId}', event)" class="py-1 px-3 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition">${i18next.t('common.edit')}</button>`;
                actionButtonsHtml += `<button onclick="deleteRating('${ratingId}', event)" class="py-1 px-3 bg-red-500 text-white text-xs rounded hover:bg-red-600 transition ml-2">${i18next.t('common.delete')}</button>`;
            }
            if (canCertifyOrPin) {
                actionButtonsHtml += `<button data-action="certify" onclick="updateCertification('${ratingId}', true, event)" class="py-1 px-3 bg-green-500 text-white text-xs rounded hover:bg-green-600 transition ml-2 ${data.isCertified ? 'hidden' : ''}">${i18next.t('common.certify')}</button>`;
                actionButtonsHtml += `<button data-action="uncertify" onclick="updateCertification('${ratingId}', false, event)" class="py-1 px-3 bg-yellow-600 text-white text-xs rounded hover:bg-yellow-700 transition ml-2 ${!data.isCertified ? 'hidden' : ''}">${i18next.t('common.uncertify')}</button>`;
                actionButtonsHtml += `<button data-action="pin" onclick="updatePinStatus('${ratingId}', true, event)" class="py-1 px-3 bg-pink-500 text-white text-xs rounded hover:bg-pink-600 transition ml-2 ${isPinned ? 'hidden' : ''}">${i18next.t('common.pin')}</button>`;
                actionButtonsHtml += `<button data-action="unpin" onclick="updatePinStatus('${ratingId}', false, event)" class="py-1 px-3 bg-gray-500 text-white text-xs rounded hover:bg-gray-600 transition ml-2 ${!isPinned ? 'hidden' : ''}">${i18next.t('common.unpin')}</button>`;
            }

            const pinIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M9.03 2.5a.75.75 0 0 0-1.06 0l-4 4a.75.75 0 1 0 1.06 1.06L7 5.81v4.44a3.752 3.752 0 0 0-1.36.47l-1.88 1.1-.31.18a.75.75 0 0 0 .8 1.3l.3-.18 1.88-1.1a2.252 2.252 0 0 1 2.12 0l1.88 1.1.3.18a.75.75 0 0 0 .8-1.3l-.3-.18-1.88-1.1a3.752 3.752 0 0 0-1.36-.47V5.81l1.97 1.97a.75.75 0 1 0 1.06-1.06l-4-4Z"/></svg>`;

            return `
                <div id="rating-card-${ratingId}" class="rating-card block bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer relative" onclick="viewRatingDetails('${ratingId}')">
                     ${isAdmin && isPinned ? `<div class="pinned-indicator" title="${i18next.t('common.pin')}">${pinIconSvg} ${i18next.t('common.pin')}</div>` : ''}
                    <div class="flex flex-wrap justify-between items-center gap-2">
                        <div class="flex-grow min-w-0 pr-4">
                             <p class="text-lg font-bold text-gray-800 truncate" title="${data.title || ''}">${data.title || i18next.t('certifiedPage.noTitle')}</p>
                             <p class="text-sm text-gray-500 truncate" title="${data.cigarInfo?.name || ''}">
                                ${data.cigarName || i18next.t('certifiedPage.unnamedCigar')} |
                                ${data.cigarSize || i18next.t('common.noData')} |
                                ${data.cigarOrigin || i18next.t('common.noData')} | ${date}
                                ${ showAuthor ? `<span class="font-medium text-gray-600 ml-2">| ${i18next.t('historyPage.userLabel')} ${authorDisplay}</span>` : '' }
                             </p>
                        </div>
                        <div class="flex items-center flex-shrink-0 space-x-3">
                            <div class="text-right"> <p class="text-xl font-black text-indigo-600">${scoreDisplay}</p> <p class="font-bold text-gray-600 text-xs">${gradeDisplay}</p> </div>
                            <div class="action-buttons flex items-center space-x-2 flex-wrap gap-1 ${!actionButtonsHtml ? 'hidden' : ''}"> ${actionButtonsHtml} </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function formatParticipationDate(isoString) {
            if (!isoString) return '';
            try {
                const locale = i18next.language || 'zh';
                const date = new Date(isoString);
                if (Number.isNaN(date.getTime())) return isoString;
                return date.toLocaleString(locale, { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                return isoString;
            }
        }

        function renderCommentParticipation(items = []) {
            if (!commentParticipationSection || !commentParticipationContainer) return;
            if (!currentAuthUser) {
                commentParticipationSection.classList.add('hidden');
                return;
            }

            commentParticipationContainer.innerHTML = '';

            if (!items.length) {
                commentParticipationSection.classList.remove('hidden');
                const emptyMessage = document.createElement('p');
                emptyMessage.className = 'text-sm text-gray-500';
                emptyMessage.textContent = i18next.t('historyPage.noCommentHistory');
                commentParticipationContainer.appendChild(emptyMessage);
                return;
            }

            commentParticipationSection.classList.remove('hidden');

            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg border border-gray-200 shadow-sm p-4';

                const titleEl = document.createElement('h3');
                titleEl.className = 'text-lg font-semibold text-gray-800';
                titleEl.textContent = item.title || i18next.t('common.noTitle');
                card.appendChild(titleEl);

                const cigarInfoEl = document.createElement('p');
                cigarInfoEl.className = 'text-sm text-gray-500 mt-1';
                const cigarName = item.cigarName || i18next.t('certifiedPage.unnamedCigar');
                const cigarSize = item.cigarSize || i18next.t('common.unknown');
                const cigarOrigin = item.cigarOrigin || i18next.t('common.unknown');
                cigarInfoEl.textContent = `${cigarName} • ${cigarSize} • ${cigarOrigin}`;
                card.appendChild(cigarInfoEl);

                const metaEl = document.createElement('p');
                metaEl.className = 'text-xs text-gray-500 mt-1';
                const authorName = item.ratingUserNickname || i18next.t('historyPage.unknownUser');
                metaEl.textContent = `${authorName} · ${formatParticipationDate(item.createdAt)}`;
                card.appendChild(metaEl);

                if (item.content) {
                    const commentBlock = document.createElement('div');
                    commentBlock.className = 'mt-3 text-sm text-gray-700 whitespace-pre-wrap break-words bg-gray-50 border border-gray-100 rounded-md p-3';
                    const label = document.createElement('span');
                    label.className = 'font-semibold text-gray-600 mr-2';
                    label.textContent = i18next.t('historyPage.commentPreviewLabel');
                    const text = document.createElement('span');
                    text.textContent = item.content;
                    commentBlock.appendChild(label);
                    commentBlock.appendChild(text);
                    card.appendChild(commentBlock);
                }

                const footer = document.createElement('div');
                footer.className = 'mt-3 flex items-center justify-between text-xs text-gray-500';

                const scoreParts = [];
                if (typeof item.normalizedScore === 'number') {
                    scoreParts.push(`${i18next.t('common.score')}: ${item.normalizedScore.toFixed(2)}`);
                }
                if (item.finalGrade_grade) {
                    scoreParts.push(`${i18next.t('historyPage.gradeShortLabel')}: ${item.finalGrade_grade}`);
                }
                if (scoreParts.length > 0) {
                    const scoreLabel = document.createElement('span');
                    scoreLabel.textContent = scoreParts.join(' · ');
                    footer.appendChild(scoreLabel);
                }

                const viewLink = document.createElement('a');
                viewLink.href = `results.html?ratingId=${item.ratingId}`;
                viewLink.className = 'inline-flex items-center font-semibold text-indigo-600 hover:text-indigo-700';
                viewLink.textContent = i18next.t('historyPage.viewRating');
                footer.appendChild(viewLink);

                card.appendChild(footer);
                commentParticipationContainer.appendChild(card);
            });
        }

        async function fetchCommentParticipation(user) {
            if (!commentParticipationSection || !user) {
                if (commentParticipationSection) commentParticipationSection.classList.add('hidden');
                commentParticipationData = [];
                return;
            }

            const token = sessionStorage.getItem('accessToken');
            if (!token) {
                commentParticipationSection.classList.add('hidden');
                commentParticipationData = [];
                return;
            }

            try {
                const apiUrl = new URL('/api/comments', window.location.origin);
                apiUrl.searchParams.set('mine', 'true');
                const response = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) {
                    let errorText = `HTTP ${response.status}`;
                    try {
                        const err = await response.json();
                        errorText = err.error || errorText;
                    } catch (e) { /* ignore */ }
                    throw new Error(errorText);
                }
                const data = await response.json();
                const participation = Array.isArray(data.participation) ? data.participation : [];
                const deduped = [];
                const seen = new Set();
                participation.forEach(item => {
                    if (!item.ratingId || seen.has(item.ratingId)) return;
                    if (item.ratingUserId && item.ratingUserId === user.sub) return; // Skip own ratings
                    seen.add(item.ratingId);
                    deduped.push(item);
                });
                commentParticipationData = deduped;
                renderCommentParticipation(commentParticipationData);
            } catch (error) {
                console.error('Failed to load comment participation:', error);
                commentParticipationSection.classList.remove('hidden');
                commentParticipationContainer.innerHTML = `<div class="bg-red-100 text-red-700 rounded-lg p-4 text-sm">${i18next.t('historyPage.commentHistoryError', { msg: error.message })}</div>`;
            }
        }

        // --- End Data Fetching and Rendering ---

        // --- Initialization ---
        window.addEventListener('load', async function() {
             await initI18n(); // Wait for i18n

             const urlParams = new URLSearchParams(window.location.search);
             const code = urlParams.get('code');
             let user = null;
             if (code) { user = await handleOidcCallback(code); } else { user = await validateSessionAndGetUser(); }
             currentAuthUser = user;
             userRole = currentAuthUser?.db_role ?? 'guest';

             renderLoginStatus(currentAuthUser); // Render login *after* i18n
             setupLanguageSwitcher(); // Setup switcher

             await fetchAndRenderHistory(currentAuthUser); // Pass user object

             // Clean URL after callback
             if (code) { window.history.replaceState({}, document.title, window.location.pathname); }
        });
    </script>
</body>
</html>
