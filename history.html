<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>评分历史</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind config remains the same
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, orderBy, doc, getDoc, updateDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.onload = function() {
            const appId = 'pistacho-b9efe';
            const firebaseConfig = JSON.parse('{"apiKey":"AIzaSyDC-8qbWsjRyxBzJpfCi9n3ftzdg9FStF0","authDomain":"pistacho-b9efe.firebaseapp.com","projectId":"pistacho-b9efe","storageBucket":"pistacho-b9efe.appspot.com","messagingSenderId":"686695750713","appId":"1:686695750713:web:5314331be7b46e93f401e8","measurementId":"G-HQS7Q78LY7"}');
            
            let db, auth;
            let userRole = 'unknown';
            let historicalRatings = {}; // (*** 新增：用于存储完整数据 ***)

            const RATINGS_COLLECTION_PATH = `/artifacts/${appId}/public/data/ratings`;
            const CERTIFIED_COLLECTION_PATH = `/artifacts/${appId}/public/data/certified_ratings`;
            const USERS_COLLECTION_PATH = 'users';

            async function fetchUserRole(user) { /* ... fetch role logic ... */ }

            window.certifyRating = async function(ratingId, event) {
                event.stopPropagation(); // Prevent click from bubbling up to the link
                /* ... certify logic ... */
            }
            
            // (*** 新增：点击后跳转到详情页的函数 ***)
            window.viewRatingDetails = function(ratingId) {
                const ratingData = historicalRatings[ratingId];
                if (ratingData) {
                    sessionStorage.setItem('cigarRatingResults', JSON.stringify(ratingData));
                    window.location.href = 'results.html';
                } else {
                    alert("无法加载该评分的详细信息。");
                }
            }

            async function fetchAndRenderHistory(user) {
                const container = document.getElementById('history-container');
                /* ... loading and no-user states ... */
                
                try {
                    /* ... query logic ... */
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty) { /* ... empty state ... */ return; }

                    let historyHtml = '<div class="space-y-4">';
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        const ratingId = doc.id;
                        historicalRatings[ratingId] = data; // 存储完整数据

                        /* ... score and grade display logic ... */

                        // (*** 已修改：将整个卡片包裹在 <a> 标签中 ***)
                        historyHtml += `
                            <a href="#" onclick="viewRatingDetails('${ratingId}'); return false;" class="block bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="text-lg font-bold text-gray-800">${data.cigarInfo.name}</p>
                                        <p class="text-sm text-gray-500">${data.cigarInfo.size} | ${data.cigarInfo.origin} | ${date}</p>
                                        ${ userRole === 'super_admin' ? `<p class="text-xs text-gray-400 pt-1">用户: ${data.userEmail || data.userId}</p>` : '' }
                                    </div>
                                    <div class="text-right flex-shrink-0 ml-4">
                                        <p class="text-2xl font-black text-indigo-600">${scoreDisplay}</p>
                                        <p class="font-bold text-gray-600">${gradeDisplay}</p>
                                    </div>
                                </div>
                                ${certifyButtonHtml ? `<div class="mt-2 border-t pt-2">${certifyButtonHtml.replace("certifyRating('"+ratingId+"')", "certifyRating('"+ratingId+"', event)")}</div>` : ''}
                            </a>
                        `;
                    });
                    historyHtml += '</div>';
                    container.innerHTML = historyHtml;

                } catch (error) { /* ... error handling ... */ }
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, async (user) => {
                    userRole = await fetchUserRole(user);
                    fetchAndRenderHistory(user);
                });
            } catch(e) { /* ... error handling ... */ }
        }
    </script>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Body HTML remains the same -->
</body>
</html>

