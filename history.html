<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的评分历史</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <script>
        const __app_id = 'pistacho-b9efe'; 
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyDC-8qbWsjRyxBzJpfCi9n3ftzdg9FStF0", 
            authDomain: "pistacho-b9efe.firebaseapp.com",
            projectId: "pistacho-b9efe",
            storageBucket: "pistacho-b9efe.firebasestorage.app",
            messagingSenderId: "686695750713",
            appId: "1:686695750713:web:5314331be7b46e93f401e8",
            measurementId: "G-HQS7Q78LY7"
        });
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        let db, auth;
        const RATINGS_COLLECTION_PATH = `/artifacts/${appId}/public/data/ratings`;

        async function fetchAndRenderHistory(user) {
            const container = document.getElementById('history-container');
            if (!user || user.isAnonymous) {
                container.innerHTML = `<div class="text-center p-6 bg-white rounded-lg shadow"><p>请<a href="index.html" class="text-indigo-600 underline">登录</a>以查看您的评分历史。</p></div>`;
                return;
            }

            container.innerHTML = `<div class="text-center p-6"><p>正在加载历史记录...</p></div>`;
            
            try {
                const ratingsCollection = collection(db, RATINGS_COLLECTION_PATH);
                // (*** 已修改：使用 where 查询来获取当前用户的记录 ***)
                const q = query(ratingsCollection, where("userId", "==", user.uid), orderBy("timestamp", "desc"));
                
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    container.innerHTML = `<div class="text-center p-6 bg-white rounded-lg shadow"><p>您还没有任何评分记录。</p></div>`;
                    return;
                }

                let historyHtml = '<div class="space-y-4">';
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.timestamp?.toDate ? data.timestamp.toDate().toLocaleDateString('zh-CN') : '未知日期';
                    
                    historyHtml += `
                        <div class="bg-white p-4 rounded-lg shadow-md flex justify-between items-center">
                            <div>
                                <p class="text-lg font-bold text-gray-800">${data.cigarInfo.name}</p>
                                <p class="text-sm text-gray-500">${data.cigarInfo.size} | ${data.cigarInfo.origin} | ${date}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-black text-indigo-600">${data.normalizedScore.toFixed(2)}</p>
                                <p class="font-bold text-gray-600">${data.finalGrade.grade} - ${data.finalGrade.name_cn}</p>
                            </div>
                        </div>
                    `;
                });
                historyHtml += '</div>';
                container.innerHTML = historyHtml;

            } catch (error) {
                console.error("获取历史记录失败:", error);
                container.innerHTML = `<div class="text-center p-6 bg-red-100 text-red-700 rounded-lg shadow"><p>加载历史记录失败: ${error.message}</p></div>`;
            }
        }

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            onAuthStateChanged(auth, (user) => {
                fetchAndRenderHistory(user);
            });
        } catch(e) {
            document.getElementById('history-container').innerHTML = `<div class="p-6 bg-red-100 text-red-700">Firebase 初始化失败: ${e.message}</div>`;
        }

    </script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="max-w-4xl mx-auto p-4 md:p-8">
        <nav class="mb-4 flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
             <a href="index.html" class="text-xl font-bold text-indigo-600">Pistacho评分</a>
             <div class="space-x-4">
                 <a href="history.html" class="text-indigo-600 font-bold underline">历史记录</a>
                 <a href="certified.html" class="text-gray-600 hover:text-indigo-600">认证评分</a>
             </div>
        </nav>
        <header class="mb-6">
            <h1 class="text-4xl font-extrabold text-gray-800">我的评分历史</h1>
        </header>
        <div id="history-container">
            <!-- History items will be rendered here -->
        </div>
         <footer class="mt-8 text-center">
            <a href="index.html" class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">&larr; 返回主页</a>
        </footer>
    </div>
</body>
</html>

