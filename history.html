<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>评分历史</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, orderBy, doc, getDoc, updateDoc, addDoc, serverTimestamp, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.onload = function() {
            const appId = 'pistacho-b9efe';
            const firebaseConfig = JSON.parse('{"apiKey":"AIzaSyDC-8qbWsjRyxBzJpfCi9n3ftzdg9FStF0","authDomain":"pistacho-b9efe.firebaseapp.com","projectId":"pistacho-b9efe"}');
            
            let db, auth;
            let userRole = 'unknown';
            let historicalRatings = {}; 

            const RATINGS_COLLECTION_PATH = `/artifacts/${appId}/public/data/ratings`;
            const CERTIFIED_COLLECTION_PATH = `/artifacts/${appId}/public/data/certified_ratings`;
            const USERS_COLLECTION_PATH = 'users';

            async function fetchUserRole(user) {
                if (!user) return 'general';
                const roleDocRef = doc(db, USERS_COLLECTION_PATH, user.uid);
                try {
                    const docSnap = await getDoc(roleDocRef);
                    if (docSnap.exists() && docSnap.data().role) {
                        return docSnap.data().role;
                    }
                } catch(e) { console.error("获取角色失败:", e); }
                return 'general';
            }

            window.certifyRating = async function(ratingId, event) {
                event.stopPropagation();
                const button = document.querySelector(`button[onclick*="certifyRating('${ratingId}')"]`);
                button.textContent = '认证中...';
                button.disabled = true;

                try {
                    const ratingDocRef = doc(db, RATINGS_COLLECTION_PATH, ratingId);
                    const ratingSnap = await getDoc(ratingDocRef);
                    if (!ratingSnap.exists()) throw new Error("原始评分记录不存在。");
                    
                    const ratingData = ratingSnap.data();
                    
                    const newCertifiedDocRef = await addDoc(collection(db, CERTIFIED_COLLECTION_PATH), {
                        ...ratingData,
                        originalRatingId: ratingId,
                        certifiedAt: serverTimestamp()
                    });
                    
                    await updateDoc(ratingDocRef, { 
                        certified: true,
                        certifiedRatingId: newCertifiedDocRef.id
                    });
                    
                    fetchAndRenderHistory(auth.currentUser);
                } catch (error) {
                    console.error("认证失败:", error);
                    alert(`认证失败: ${error.message}`);
                    button.textContent = "认证";
                    button.disabled = false;
                }
            }

            window.uncertifyRating = async function(ratingId, certifiedRatingId, event) {
                event.stopPropagation();
                if (!confirm("确定要取消这条记录的 Pistacho 认证吗？")) return;

                const button = document.querySelector(`button[onclick*="uncertifyRating('${ratingId}')"]`);
                button.textContent = '取消中...';
                button.disabled = true;

                try {
                    const batch = writeBatch(db);
                    const certifiedDocRef = doc(db, CERTIFIED_COLLECTION_PATH, certifiedRatingId);
                    batch.delete(certifiedDocRef);
                    const ratingDocRef = doc(db, RATINGS_COLLECTION_PATH, ratingId);
                    batch.update(ratingDocRef, {
                        certified: false,
                        certifiedRatingId: null
                    });

                    await batch.commit();
                    fetchAndRenderHistory(auth.currentUser);
                } catch (error) {
                    console.error("取消认证失败:", error);
                    alert(`取消认证失败: ${error.message}`);
                    button.textContent = "取消认证";
                    button.disabled = false;
                }
            }
            
            window.viewRatingDetails = function(ratingId) {
                const ratingData = historicalRatings[ratingId];
                if (ratingData) {
                    sessionStorage.setItem('cigarRatingResults', JSON.stringify(ratingData));
                    window.location.href = 'results.html';
                } else {
                    alert("无法加载该评分的详细信息。");
                }
            }

            async function fetchAndRenderHistory(user) {
                const container = document.getElementById('history-container');
                const title = document.getElementById('history-title');

                if (!user || user.isAnonymous) {
                    title.textContent = "评分历史";
                    container.innerHTML = `<div class="text-center p-6 bg-white rounded-lg shadow"><p>请<a href="index.html" class="text-indigo-600 underline">登录</a>以查看您的评分历史。</p></div>`;
                    return;
                }

                container.innerHTML = `<div class="text-center p-6"><p>正在加载历史记录...</p></div>`;
                
                try {
                    const ratingsCollection = collection(db, RATINGS_COLLECTION_PATH);
                    let q;

                    if (userRole === 'super_admin') {
                        title.textContent = "所有用户的评分历史";
                        q = query(ratingsCollection, orderBy("timestamp", "desc"));
                    } else {
                        title.textContent = "我的评分历史";
                        q = query(ratingsCollection, where("userId", "==", user.uid), orderBy("timestamp", "desc"));
                    }
                    
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        container.innerHTML = `<div class="text-center p-6 bg-white rounded-lg shadow"><p>还没有任何评分记录。</p></div>`;
                        return;
                    }

                    let historyHtml = '<div class="space-y-4">';
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        const ratingId = doc.id;
                        historicalRatings[ratingId] = data;

                        const date = data.timestamp?.toDate ? data.timestamp.toDate().toLocaleDateString('zh-CN') : '未知日期';
                        const scoreDisplay = data.normalizedScore !== undefined ? data.normalizedScore.toFixed(2) : 'N/A';
                        const gradeDisplay = data.finalGrade ? `${data.finalGrade.grade} - ${data.finalGrade.name_cn}` : '未评级';

                        let certifyButtonHtml = '';
                        if (userRole === 'super_admin') {
                            if (data.certified && data.certifiedRatingId) {
                                certifyButtonHtml = `<button onclick="uncertifyRating('${ratingId}', '${data.certifiedRatingId}', event)" class="mt-2 w-full text-sm py-1 px-3 bg-red-500 text-white rounded-md hover:bg-red-600 transition">取消认证</button>`;
                            } else {
                                certifyButtonHtml = `<button onclick="certifyRating('${ratingId}', event)" class="mt-2 w-full text-sm py-1 px-3 bg-green-500 text-white rounded-md hover:bg-green-600 transition">认证</button>`;
                            }
                        }

                        historyHtml += `
                            <a href="#" onclick="viewRatingDetails('${ratingId}'); return false;" class="block bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="text-lg font-bold text-gray-800">${data.cigarInfo.name}</p>
                                        <p class="text-sm text-gray-500">${data.cigarInfo.size} | ${data.cigarInfo.origin} | ${date}</p>
                                        ${ userRole === 'super_admin' ? `<p class="text-xs text-gray-400 pt-1">用户: ${data.userEmail || data.userId}</p>` : '' }
                                    </div>
                                    <div class="text-right flex-shrink-0 ml-4">
                                        <p class="text-2xl font-black text-indigo-600">${scoreDisplay}</p>
                                        <p class="font-bold text-gray-600">${gradeDisplay}</p>
                                    </div>
                                </div>
                                ${certifyButtonHtml ? `<div class="mt-2 border-t pt-2">${certifyButtonHtml}</div>` : ''}
                            </a>
                        `;
                    });
                    historyHtml += '</div>';
                    container.innerHTML = historyHtml;

                } catch (error) {
                    console.error("获取历史记录失败:", error);
                    container.innerHTML = `<div class="text-center p-6 bg-red-100 text-red-700 rounded-lg shadow"><p>加载历史记录失败: ${error.message}</p></div>`;
                }
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, async (user) => {
                    userRole = await fetchUserRole(user);
                    fetchAndRenderHistory(user);
                });
            } catch(e) {
                document.getElementById('history-container').innerHTML = `<div class="p-6 bg-red-100 text-red-700">Firebase 初始化失败: ${e.message}</div>`;
            }
        }
    </script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="max-w-4xl mx-auto p-4 md:p-8">
        <nav class="mb-4 flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
             <a href="index.html" class="text-xl font-bold text-indigo-600">Pistacho评分</a>
             <div class="space-x-4">
                 <a href="history.html" class="text-indigo-600 font-bold underline">历史记录</a>
                 <a href="certified.html" class="text-gray-600 hover:text-indigo-600">认证评分</a>
             </div>
        </nav>
        <header class="mb-6">
            <h1 id="history-title" class="text-4xl font-extrabold text-gray-800">评分历史</h1>
        </header>
        <div id="history-container">
            <!-- History items will be rendered here -->
        </div>
         <footer class="mt-8 text-center">
            <a href="index.html" class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">&larr; 返回主页</a>
        </footer>
    </div>
</body>
</html>

