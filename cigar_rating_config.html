<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯„åˆ†é…ç½®ç®¡ç† - è¡¨å•ç¼–è¾‘å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // 1. Tailwind CSS é…ç½®
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <script>
        const __app_id = 'pistacho-b9efe'; 

        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyDC-8qbWsjRyxBzJpfCi9n3ftzdg9FStF0", 
            authDomain: "pistacho-b9efe.firebaseapp.com",
            projectId: "pistacho-b9efe",
            storageBucket: "pistacho-b9efe.firebasestorage.app",
            messagingSenderId: "686695750713",
            appId: "1:686695750713:web:5314331be7b46e93f401e8",
            measurementId: "G-HQS7Q78LY7"
        });
    </script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- å¸¸é‡ä¸çŠ¶æ€ ---
        let db;
        let editorConfig = {}; 
        let userRole = 'unknown'; // æ–°å¢ï¼šå½“å‰ç™»å½•ç”¨æˆ·çš„è§’è‰²
        const CONFIG_DOC_PATH = `/artifacts/${__app_id}/public/data/cigar_config/latest`;
        const USERS_COLLECTION_PATH = 'users'; // æ–°å¢
        
        // DOM å…ƒç´ 
        const editorContainer = document.getElementById('config-editor-container');
        const loadStatus = document.getElementById('config-load-status');
        const saveButton = document.getElementById('save-config-btn');
        const totalMaxScoreDisplay = document.getElementById('total-max-score');

        // --- æ ¸å¿ƒå·¥å…·å‡½æ•° ---

        // è®¡ç®—æƒé‡ (ä¸ index.html ä¿æŒä¸€è‡´)
        function calculateWeights(config) {
            let grandTotal = 0;
            config.ratingCriteria.forEach(category => {
                let categoryTotal = 0;
                category.criteriaList.forEach(criterion => {
                    categoryTotal += (criterion.weight || 0);
                });
                category.totalWeight = categoryTotal;
                grandTotal += categoryTotal;
            });
            config.totalWeightMax = grandTotal;
        }

        // æ¸²æŸ“çŠ¶æ€æ›´æ–°
        function updateStatus(message, className) {
            loadStatus.textContent = message;
            loadStatus.className = `text-sm font-medium ${className}`;
        }
        
        // --- æƒé™æ£€æŸ¥ä¸æ¸²æŸ“å‡½æ•° ---
        
        /**
         * æ£€æŸ¥æƒé™å¹¶å†³å®šæ˜¯å¦åŠ è½½ç¼–è¾‘å™¨ã€‚
         */
        function checkPermissionAndLoad() {
            if (userRole === 'admin' || userRole === 'super_admin') {
                updateStatus('æƒé™éªŒè¯æˆåŠŸ (Admin/Super Admin)ã€‚æ­£åœ¨åŠ è½½é…ç½®...', 'text-yellow-600');
                loadConfig(); // æœ‰æƒé™ï¼Œå¼€å§‹åŠ è½½é…ç½®
            } else {
                updateStatus(`âŒ æƒé™ä¸è¶³ã€‚å½“å‰è§’è‰²: ${userRole.toUpperCase()}ã€‚`, 'text-red-600');
                saveButton.disabled = true;
                saveButton.textContent = 'æƒé™ä¸è¶³ï¼Œæ— æ³•ä¿å­˜';
                editorContainer.innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mt-10" role="alert">
                        <strong class="font-bold">è®¿é—®è¢«æ‹’ç»!</strong>
                        <span class="block sm:inline">æ‚¨éœ€è¦ç®¡ç†å‘˜ (Admin) æˆ–è¶…çº§ç®¡ç†å‘˜ (Super Admin) æƒé™æ‰èƒ½ä¿®æ”¹é…ç½®ã€‚</span>
                    </div>
                `;
            }
        }

        // --- [å…¶ä½™çš„æ¸²æŸ“å’Œæ•°æ®æ¨¡å‹å‡½æ•°ä¿æŒä¸å˜] ---
        // ... (çœç•¥ renderEditor, renderCategory, renderCriterion, renderOption, update..., add..., remove... ç­‰å‡½æ•°) ...
        
        // å°†æ ¸å¿ƒæ›´æ–°å‡½æ•°æš´éœ²ç»™å…¨å±€ä½œç”¨åŸŸï¼Œä»¥ä¾¿ HTML å…ƒç´ çš„ onclick/onchange è°ƒç”¨
        window.updateGeneralConfig = (key, value) => { editorConfig[key] = value; };
        window.updateCategoryTitle = (catIndex, value) => { editorConfig.ratingCriteria[catIndex].category = value; renderEditor(); };
        window.updateCategoryDetail = (catIndex, value) => { editorConfig.ratingCriteria[catIndex].detail = value; };
        window.updateCriterionName = (catIndex, critIndex, value) => { editorConfig.ratingCriteria[catIndex].criteriaList[critIndex].name = value; };
        window.updateCriterionWeight = (catIndex, critIndex, value) => { editorConfig.ratingCriteria[catIndex].criteriaList[critIndex].weight = parseFloat(value) || 0; renderEditor(); };
        window.updateOptionDescription = (catIndex, critIndex, optIndex, value) => { editorConfig.ratingCriteria[catIndex].criteriaList[critIndex].options[optIndex].description = value; };
        window.updateOptionScorePct = (catIndex, critIndex, optIndex, value) => { editorConfig.ratingCriteria[catIndex].criteriaList[critIndex].options[optIndex].scorePct = parseFloat(value) || 0; renderEditor(); };
        window.addCategory = () => { editorConfig.ratingCriteria.push({ category: "æ–°ç±»åˆ«æ ‡é¢˜", detail: "æ–°ç±»åˆ«æè¿°", criteriaList: [{ name: "æ–°æ ‡å‡†åç§°", weight: 10, options: [{ description: "ä¸€èˆ¬", scorePct: 0.5 }, { description: "ä¼˜ç§€", scorePct: 1.0 }] }] }); renderEditor(); };
        window.removeCategory = (catIndex) => { if (confirm("ç¡®å®šè¦åˆ é™¤æ­¤è¯„åˆ†ç±»åˆ«å—ï¼Ÿ")) { editorConfig.ratingCriteria.splice(catIndex, 1); renderEditor(); } };
        window.addCriterion = (catIndex) => { editorConfig.ratingCriteria[catIndex].criteriaList.push({ name: "æ–°è¯„åˆ†æ ‡å‡†", weight: 10, options: [{ description: "æ–°é€‰é¡¹1", scorePct: 0.5 }, { description: "æ–°é€‰é¡¹2", scorePct: 1.0 }] }); renderEditor(); };
        window.removeCriterion = (catIndex, critIndex) => { if (confirm("ç¡®å®šè¦åˆ é™¤æ­¤è¯„åˆ†æ ‡å‡†å—ï¼Ÿ")) { editorConfig.ratingCriteria[catIndex].criteriaList.splice(critIndex, 1); renderEditor(); } };
        window.addOption = (catIndex, critIndex) => { editorConfig.ratingCriteria[catIndex].criteriaList[critIndex].options.push({ description: "æ–°é€‰é¡¹", scorePct: 0.5 }); renderEditor(); };
        window.removeOption = (catIndex, critIndex, optIndex) => { editorConfig.ratingCriteria[catIndex].criteriaList[critIndex].options.splice(optIndex, 1); renderEditor(); };

        // ** [é‡æ–°æ’å…¥å‰é¢æ­¥éª¤ä¸­ renderEditor åŠç›¸å…³è¾…åŠ©å‡½æ•°ï¼Œä¿æŒä»£ç å®Œæ•´æ€§] **
        function renderEditor() {
            calculateWeights(editorConfig);
            totalMaxScoreDisplay.textContent = editorConfig.totalWeightMax.toFixed(2);
            
            const generalConfig = `
                <div class="bg-white p-6 rounded-xl shadow-lg mb-8 border-t-4 border-indigo-500">
                    <h2 class="text-2xl font-bold text-indigo-700 mb-4">åº”ç”¨åŸºç¡€ä¿¡æ¯</h2>
                    <div class="space-y-4">
                        <label class="block">
                            <span class="text-gray-700">åº”ç”¨æ ‡é¢˜ (appTitle)</span>
                            <input type="text" id="appTitle" value="${editorConfig.appTitle || ''}" onchange="updateGeneralConfig(this.id, this.value)" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        </label>
                        <label class="block">
                            <span class="text-gray-700">åº”ç”¨æè¿° (description)</span>
                            <textarea id="description" onchange="updateGeneralConfig(this.id, this.value)" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">${editorConfig.description || ''}</textarea>
                        </label>
                    </div>
                </div>
            `;
            
            const categoriesHtml = editorConfig.ratingCriteria.map((cat, catIndex) => renderCategory(cat, catIndex)).join('');
            
            const addCategoryButton = `
                <button onclick="addCategory()" class="w-full mt-4 py-3 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition duration-150 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    æ·»åŠ æ–°çš„è¯„åˆ†ç±»åˆ«
                </button>
            `;

            editorContainer.innerHTML = generalConfig + '<div id="categories-list">' + categoriesHtml + '</div>' + addCategoryButton;
        }

        function renderCategory(cat, catIndex) {
            const criteriaHtml = cat.criteriaList.map((crit, critIndex) => renderCriterion(crit, catIndex, critIndex)).join('');
            
            return `
                <div class="bg-white p-6 rounded-xl shadow-lg mb-8 border-l-4 border-yellow-500" data-cat-index="${catIndex}">
                    <div class="flex justify-between items-center mb-4 border-b pb-3">
                        <h3 class="text-xl font-bold text-yellow-700">ç±»åˆ« ${catIndex + 1}: <input type="text" value="${cat.category || ''}" onchange="updateCategoryTitle(${catIndex}, this.value)" class="border-b-2 border-yellow-500 font-bold text-lg p-1"></h3>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-semibold text-gray-500">æ€»æƒé‡: ${cat.totalWeight.toFixed(2)}</span>
                            <button onclick="removeCategory(${catIndex})" class="text-red-500 hover:text-red-700 transition duration-150">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>
                    </div>
                    <label class="block mb-4">
                        <span class="text-gray-700 text-sm">ç±»åˆ«æè¿° (detail)</span>
                        <input type="text" value="${cat.detail || ''}" onchange="updateCategoryDetail(${catIndex}, this.value)" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm p-1">
                    </label>
                    <div class="space-y-4 pt-2" data-criteria-list>
                        ${criteriaHtml}
                    </div>
                    <button onclick="addCriterion(${catIndex})" class="w-full mt-4 py-2 text-sm bg-yellow-100 text-yellow-800 font-medium rounded-lg hover:bg-yellow-200 transition duration-150">
                        + æ·»åŠ è¯„åˆ†æ ‡å‡†
                    </button>
                </div>
            `;
        }
        
        function renderCriterion(crit, catIndex, critIndex) {
            const optionsHtml = crit.options.map((opt, optIndex) => renderOption(opt, catIndex, critIndex, optIndex)).join('');
            const maxScore = crit.weight || 0;

            return `
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200" data-crit-index="${critIndex}">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-md font-semibold text-gray-800">æ ‡å‡† ${critIndex + 1}</h4>
                        <button onclick="removeCriterion(${catIndex}, ${critIndex})" class="text-red-400 hover:text-red-600 transition duration-150">åˆ é™¤æ ‡å‡†</button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <span class="text-gray-700 text-sm block">åç§° (name)</span>
                            <input type="text" value="${crit.name || ''}" onchange="updateCriterionName(${catIndex}, ${critIndex}, this.value)" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm p-1">
                        </div>
                        <div>
                            <span class="text-gray-700 text-sm block">æƒé‡ (weight) - æœ€å¤§ ${maxScore} åˆ†</span>
                            <input type="number" step="1" value="${crit.weight || 0}" onchange="updateCriterionWeight(${catIndex}, ${critIndex}, this.value)" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm p-1">
                        </div>
                    </div>

                    <p class="text-sm font-medium mb-2 text-indigo-600">è¯„åˆ†é€‰é¡¹ (Options)</p>
                    <div class="space-y-2 border p-3 rounded-md bg-white">
                        ${optionsHtml}
                        <button onclick="addOption(${catIndex}, ${critIndex})" class="w-full mt-2 py-1 text-xs bg-indigo-50 text-indigo-700 rounded-md hover:bg-indigo-100 transition duration-150">
                            + æ·»åŠ é€‰é¡¹
                        </button>
                    </div>
                </div>
            `;
        }
        
        function renderOption(opt, catIndex, critIndex, optIndex) {
            const currentCriterion = editorConfig.ratingCriteria[catIndex].criteriaList[critIndex];
            const maxScore = currentCriterion.weight || 0;
            const scoreDisplay = ((opt.scorePct || 0) * maxScore).toFixed(2);
            return `
                <div class="flex items-center space-x-2" data-option-index="${optIndex}">
                    <input type="text" placeholder="æè¿°" value="${opt.description || ''}" onchange="updateOptionDescription(${catIndex}, ${critIndex}, ${optIndex}, this.value)" class="block w-2/3 rounded-md border-gray-300 shadow-sm text-xs p-1">
                    <input type="number" step="0.01" placeholder="å¾—åˆ†æ¯”ä¾‹(0.0-1.0)" value="${opt.scorePct || 0}" onchange="updateOptionScorePct(${catIndex}, ${critIndex}, ${optIndex}, this.value)" class="block w-1/4 rounded-md border-gray-300 shadow-sm text-xs p-1 text-right">
                    <span class="text-xs text-gray-500 w-1/5 shrink-0">(å¾— ${scoreDisplay} åˆ†)</span>
                    <button onclick="removeOption(${catIndex}, ${critIndex}, ${optIndex})" class="text-red-400 hover:text-red-600 text-xs shrink-0">X</button>
                </div>
            `;
        }
        // --- [é‡æ–°æ’å…¥å‰é¢æ­¥éª¤ä¸­ renderEditor åŠç›¸å…³è¾…åŠ©å‡½æ•°ç»“æŸ] ---

        // --- Firebase æ“ä½œ ---

        async function fetchUserRole(uid) {
            const roleDocRef = doc(db, USERS_COLLECTION_PATH, uid);
            try {
                const docSnap = await getDoc(roleDocRef);
                return docSnap.exists() ? docSnap.data().role : 'general'; // é»˜è®¤æ˜¯ general
            } catch (e) {
                console.warn("Failed to fetch user role, assuming general:", e);
                return 'general';
            }
        }

        async function loadConfig() {
            updateStatus('æ­£åœ¨ä»äº‘ç«¯åŠ è½½é…ç½®...', 'text-yellow-500');
            try {
                const configDocRef = doc(db, CONFIG_DOC_PATH);
                const docSnap = await getDoc(configDocRef);

                if (docSnap.exists() && docSnap.data().ratingCriteria) {
                    editorConfig = docSnap.data();
                    updateStatus(`é…ç½®åŠ è½½æˆåŠŸã€‚å½“å‰è§’è‰²: ${userRole.toUpperCase()}`, 'text-green-600');
                } else {
                    editorConfig = { appTitle: "æ–°è¯„åˆ†ä½“ç³» (è¯·ç¼–è¾‘)", description: "åœ¨æ­¤æ·»åŠ æ‚¨çš„æè¿°ã€‚", ratingCriteria: [] };
                    updateStatus(`è­¦å‘Šï¼šæœªæ‰¾åˆ°äº‘ç«¯é…ç½®æ–‡æ¡£ï¼Œå·²åŠ è½½ç©ºé»˜è®¤ç»“æ„ã€‚å½“å‰è§’è‰²: ${userRole.toUpperCase()}`, 'text-orange-500');
                }
                
                renderEditor();
            } catch (error) {
                console.error("Error loading config:", error);
                updateStatus(`åŠ è½½å¤±è´¥ (å¯èƒ½å› é…ç½®ä¸å­˜åœ¨): ${error.message}`, 'text-red-500');
            }
        }

        async function saveConfig() {
            if (userRole !== 'admin' && userRole !== 'super_admin') {
                updateStatus('âŒ æƒé™ä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œä¿å­˜æ“ä½œã€‚', 'text-red-600');
                return;
            }

            saveButton.disabled = true;
            saveButton.textContent = 'æ­£åœ¨ä¿å­˜...';
            try {
                calculateWeights(editorConfig);

                if (!editorConfig.ratingCriteria || !Array.isArray(editorConfig.ratingCriteria)) {
                    throw new Error("æ•°æ®ç»“æ„é”™è¯¯ï¼šç¼ºå°‘ 'ratingCriteria' æ•°ç»„ã€‚");
                }
                
                const configDocRef = doc(db, CONFIG_DOC_PATH);
                await setDoc(configDocRef, editorConfig);

                updateStatus(`âœ… é…ç½®ä¿å­˜æˆåŠŸï¼æ€»åˆ†ï¼š${editorConfig.totalWeightMax.toFixed(2)}ã€‚`, 'text-green-600');
                renderEditor(); 

            } catch (error) {
                console.error("Error saving config:", error);
                updateStatus(`âŒ ä¿å­˜å¤±è´¥ (å¯èƒ½æ˜¯ Firestore è§„åˆ™æ‹’ç»): ${error.message}`, 'text-red-600');
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'ä¿å­˜å¹¶åŒæ­¥åˆ°äº‘ç«¯';
            }
        }

        async function initFirebase() {
            updateStatus('æ­£åœ¨åˆå§‹åŒ– Firebase å’ŒéªŒè¯èº«ä»½...');
            if (Object.keys(JSON.parse(__firebase_config)).length === 0) {
                document.getElementById('app-container').innerHTML = `<div class="p-6 text-red-600 bg-red-100 rounded-lg max-w-xl mx-auto mt-10">ğŸ”´ Firebase é…ç½®ä¿¡æ¯ç¼ºå¤±ã€‚</div>`;
                return;
            }
            try {
                const app = initializeApp(JSON.parse(__firebase_config));
                db = getFirestore(app);
                const auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userRole = await fetchUserRole(user.uid);
                        checkPermissionAndLoad(); // è®¤è¯åæ£€æŸ¥æƒé™å¹¶åŠ è½½
                        saveButton.addEventListener('click', saveConfig);
                    } else {
                        await signInAnonymously(auth); // é¦–æ¬¡åŠ è½½æ—¶è¿›è¡ŒåŒ¿åç™»å½•
                        updateStatus('æ­£åœ¨è¿›è¡ŒåŒ¿åç™»å½•...', 'text-yellow-500');
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                updateStatus(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'text-red-500');
            }
        }
        
        // åˆå§‹åŒ–
        window.onload = initFirebase;
    </script>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">

    <div id="app-container" class="max-w-5xl mx-auto p-4 md:p-8">

        <header class="mb-8 p-6 bg-indigo-700 text-white rounded-xl shadow-2xl">
            <h1 class="text-3xl font-extrabold mb-1">é›ªèŒ„è¯„åˆ†æ ‡å‡†é…ç½®ä¸­å¿ƒ</h1>
            <p class="text-indigo-200 text-sm">é€šè¿‡è¡¨å•å®æ—¶ç¼–è¾‘è¯„åˆ†æ ‡å‡†ã€‚å®Œæˆåç‚¹å‡»ä¿å­˜ï¼Œæ‰€æœ‰ä½¿ç”¨è¯¥é…ç½®çš„ä¸»åº”ç”¨å°†ç«‹å³æ›´æ–°ã€‚</p>
            
            <div class="flex justify-between items-end mt-4">
                 <div class="flex items-end space-x-2">
                    <span class="text-lg font-medium text-indigo-200">å½“å‰æœ€å¤§æ€»åˆ†:</span>
                    <span id="total-max-score" class="text-4xl font-black leading-none text-yellow-300">0.00</span>
                </div>
                <a href="index.html" class="inline-flex items-center px-4 py-2 border border-white text-sm font-medium rounded-full shadow-sm text-white bg-indigo-600 hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                    è¿”å›è¯„åˆ†ä¸»é¡µ
                </a>
            </div>
        </header>

        <div id="config-editor-container">
            <p class="text-center text-gray-500 mt-10">æ­£åœ¨åŠ è½½ç¼–è¾‘å™¨...</p>
        </div>
        
        <div class="fixed bottom-0 left-0 right-0 bg-white p-4 shadow-2xl border-t border-gray-200">
            <div class="max-w-5xl mx-auto flex justify-between items-center">
                <span id="config-load-status" class="text-sm font-medium text-yellow-500">æ­£åœ¨ç­‰å¾…åˆå§‹åŒ–...</span>
                <button id="save-config-btn" 
                        class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-full shadow-lg hover:bg-indigo-700 transition duration-300 disabled:bg-gray-400"
                        disabled>
                    ä¿å­˜å¹¶åŒæ­¥åˆ°äº‘ç«¯
                </button>
            </div>
        </div>

    </div>
    <div class="h-20"></div> 

</body>
</html>
