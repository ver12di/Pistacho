<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雪茄品鉴配置管理</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // 2. 样式修复：确保 Tailwind 配置块存在
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <script>
        // 请在此处放置您的 Firebase 配置变量
        const __app_id = 'pistacho-b9efe'; 

        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyDC-8qbWsjRyxBzJpfCi9n3ftzdg9FStF0", 
            authDomain: "pistacho-b9efe.firebaseapp.com",
            projectId: "pistacho-b9efe",
            storageBucket: "pistacho-b9efe.firebasestorage.app",
            messagingSenderId: "686695750713",
            appId: "1:686695750713:web:5314331be7b46e93f401e8",
            measurementId: "G-HQS7Q78LY7"
        });

        // 【关键修复】使用 window 对象检查，以避免 const 的 Temporal Dead Zone (TDZ) 错误。
        // 如果全局 window.initial_auth_token 存在，则使用它，否则使用空字符串。
        const __initial_auth_token = (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token)
            ? window.__initial_auth_token
            : '';
    </script>

    <script type="module">
        // 导入 Firebase 核心和必要的服务
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, 
            onAuthStateChanged, createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, onSnapshot, collection, query, where, getDocs, updateDoc,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 设置 Firebase 日志级别
        setLogLevel('debug');

        // 全局变量
        // 注意：这里的 __app_id, __firebase_config, __initial_auth_token 是在上面的 <script> 块中定义的
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = __initial_auth_token; // 在模块脚本内使用一个更容易引用的名字

        let app;
        let db;
        let auth;
        let userId = null;
        let unsubscribeConfig = null; // 用于存储配置监听器的取消函数

        // 默认配置结构
        const defaultConfig = {
            appTitle: "我的雪茄品鉴评分表",
            description: "自定义雪茄品鉴评分的评分项和权重。",
            ratingCriteria: [
                { id: 'appearance', label: '外观 (Appearance)', weight: 20, description: '茄衣颜色、油性、结构、环径等。' },
                { id: 'construction', label: '结构 (Construction)', weight: 30, description: '燃烧均匀性、烟灰保持性、抽吸阻力等。' },
                { id: 'flavor', label: '风味 (Flavor)', weight: 40, description: '核心风味、复杂度和风味变化。' },
                { id: 'experience', label: '体验 (Experience)', weight: 10, description: '整体愉悦感、回味和独特性。' }
            ],
            totalWeight: 100,
            version: 1
        };

        const configDocPath = () => {
            if (!userId) {
                // 如果没有 userId，理论上不应该调用，但为了安全返回一个无效路径
                return `artifacts/${appId}/temp/configs/invalid`;
            }
            // 存储在用户的私有配置路径
            return `artifacts/${appId}/users/${userId}/configs/cigar_rating_config`;
        };

        // UI 辅助函数
        function showMessage(message, type = 'info') {
            const container = document.getElementById('error-container');
            if (container) {
                const colors = {
                    'error': 'bg-red-100 border-red-400 text-red-700',
                    'success': 'bg-green-100 border-green-400 text-green-700',
                    'info': 'bg-blue-100 border-blue-400 text-blue-700'
                };
                container.innerHTML = `
                    <div class="border ${colors[type]} px-4 py-3 rounded relative mb-4" role="alert">
                        <strong class="font-bold">${type === 'error' ? '错误' : (type === 'success' ? '成功' : '提示')}!</strong>
                        <span class="block sm:inline ml-2">${message}</span>
                    </div>
                `;
                // 3秒后自动清除信息
                setTimeout(() => container.innerHTML = '', 3000);
            }
        }

        // --- 核心业务逻辑：配置管理 ---

        /**
         * 渲染配置表单
         * @param {object} config - 当前的配置对象
         */
        function renderConfigForm(config) {
            const container = document.getElementById('config-form-container');
            if (!container) return;

            // 1. 渲染应用基本信息
            document.getElementById('app-title-input').value = config.appTitle || '';
            document.getElementById('app-description-input').value = config.description || '';

            let html = `
                <h2 class="text-xl font-bold text-indigo-700 mb-4 pt-4 border-t border-gray-200">评分项配置</h2>
            `;

            config.ratingCriteria.forEach((item, index) => {
                html += `
                    <div class="criteria-item p-4 bg-gray-50 rounded-lg shadow-sm border border-gray-200" data-index="${index}">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-semibold text-gray-800">${item.label || '新评分项'}</h3>
                            <button type="button" class="text-red-500 hover:text-red-700 transition" onclick="removeCriteria(${index})">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        <label class="block mb-3">
                            <span class="text-sm font-medium text-gray-600">名称 (Label)</span>
                            <input type="text" class="w-full p-2 border border-gray-300 rounded-md mt-1 criteria-input" value="${item.label || ''}" 
                                oninput="handleCriteriaChange(this, ${index}, 'label')">
                        </label>
                        <label class="block mb-3">
                            <span class="text-sm font-medium text-gray-600">权重 (%)</span>
                            <input type="number" min="1" max="100" class="w-full p-2 border border-gray-300 rounded-md mt-1 criteria-input" value="${item.weight || 1}" 
                                oninput="handleCriteriaChange(this, ${index}, 'weight')">
                        </label>
                        <label class="block">
                            <span class="text-sm font-medium text-gray-600">描述 (Description)</span>
                            <textarea class="w-full p-2 border border-gray-300 rounded-md mt-1 criteria-input" rows="2" 
                                oninput="handleCriteriaChange(this, ${index}, 'description')">${item.description || ''}</textarea>
                        </label>
                    </div>
                `;
            });

            // 底部统计和按钮
            const totalWeight = config.ratingCriteria.reduce((sum, item) => sum + (parseInt(item.weight) || 0), 0);
            const isTotalWeightValid = totalWeight === 100;

            html += `
                <div class="mt-6 p-4 rounded-lg ${isTotalWeightValid ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'} font-bold transition-colors duration-300">
                    当前总权重: <span id="total-weight-display">${totalWeight}</span>% 
                    ${isTotalWeightValid ? '(完美!)' : `(需调整至 100%)`}
                </div>
                <div class="flex space-x-4 mt-6">
                    <button type="button" class="flex-1 py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition" onclick="addCriteria()">
                        + 添加新评分项
                    </button>
                </div>
            `;
            
            container.innerHTML = html;
            
            // 更新保存按钮状态
            const saveButton = document.getElementById('save-button');
            if (saveButton) {
                 saveButton.disabled = !isTotalWeightValid;
                 saveButton.classList.toggle('opacity-50', !isTotalWeightValid);
                 saveButton.classList.toggle('cursor-not-allowed', !isTotalWeightValid);
            }
        }

        // --- 数据操作和状态管理 ---

        // 用于在内存中存储当前配置的变量
        let currentConfig = defaultConfig; 

        // 全局操作函数
        window.handleInputChange = (element) => {
            const field = element.dataset.field;
            currentConfig = { ...currentConfig, [field]: element.value };
        }

        window.handleCriteriaChange = (element, index, field) => {
            const value = element.type === 'number' ? parseInt(element.value) : element.value;
            
            // 更新内存中的配置
            const newCriteria = [...currentConfig.ratingCriteria];
            newCriteria[index] = { ...newCriteria[index], [field]: value };
            currentConfig = { ...currentConfig, ratingCriteria: newCriteria };

            // 重新渲染以更新总权重显示
            renderConfigForm(currentConfig);
        }

        window.addCriteria = () => {
            const newCriteria = [...currentConfig.ratingCriteria, { 
                id: `custom_${Date.now()}`, 
                label: '新评分项', 
                weight: 10, 
                description: '新的评分描述' 
            }];
            currentConfig = { ...currentConfig, ratingCriteria: newCriteria };
            renderConfigForm(currentConfig);
        }

        window.removeCriteria = (index) => {
            const newCriteria = currentConfig.ratingCriteria.filter((_, i) => i !== index);
            currentConfig = { ...currentConfig, ratingCriteria: newCriteria };
            renderConfigForm(currentConfig);
        }


        window.saveConfig = async () => {
            const totalWeight = currentConfig.ratingCriteria.reduce((sum, item) => sum + (parseInt(item.weight) || 0), 0);
            if (totalWeight !== 100) {
                showMessage(`保存失败：总权重必须为 100%，当前为 ${totalWeight}%。`, 'error');
                return;
            }

            try {
                // 清理数据，去除空描述
                const cleanedConfig = {
                    ...currentConfig,
                    ratingCriteria: currentConfig.ratingCriteria.map(c => ({
                        ...c,
                        description: c.description || ''
                    }))
                };

                await setDoc(doc(db, configDocPath()), cleanedConfig);
                showMessage('配置已成功保存!', 'success');
            } catch (error) {
                console.error("保存配置失败:", error);
                showMessage(`保存配置失败。请检查 Firestore 权限或网络连接。错误: ${error.message}`, 'error');
            }
        }


        // --- Firebase 初始化与认证 ---

        async function initFirebaseAndAuth() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 尝试使用自定义令牌或匿名登录
                // 这里的 initialAuthToken 就是上面安全获取到的 __initial_auth_token 的值
                if (initialAuthToken) { 
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("使用自定义令牌登录成功。");
                } else {
                    await signInAnonymously(auth);
                    console.log("匿名登录成功。");
                }
                
                // 监听认证状态变化
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("用户已认证，UID:", userId);
                        // 启动配置监听
                        startConfigListener();
                    } else {
                        userId = null;
                        console.log("用户未认证。");
                        // 停止配置监听
                        stopConfigListener();
                        // 渲染默认配置（或显示登录提示）
                        renderConfigForm(defaultConfig);
                    }
                });

            } catch (error) {
                console.error("Firebase 初始化或认证失败:", error);
                showMessage(`系统错误: Firebase 初始化失败。请检查控制台。错误: ${error.message}`, 'error');
            }
        }
        
        function startConfigListener() {
            if (unsubscribeConfig) {
                unsubscribeConfig(); // 先停止旧的监听器
            }

            const docRef = doc(db, configDocPath());
            
            // 启动新的配置监听器
            unsubscribeConfig = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    // 配置存在，加载数据
                    currentConfig = docSnap.data();
                    console.log("实时配置数据:", currentConfig);
                    renderConfigForm(currentConfig);
                } else {
                    // 配置不存在，使用默认配置并尝试创建
                    console.log("配置文档不存在，使用默认配置。");
                    currentConfig = defaultConfig;
                    renderConfigForm(currentConfig);
                    // 首次使用时写入默认配置
                    setDoc(docRef, defaultConfig).catch(e => console.error("尝试写入默认配置失败:", e));
                }
            }, (error) => {
                 // 权限错误等会在这里捕获
                console.error("监听配置变化失败:", error);
                showMessage(`加载配置失败，可能需要检查 Firestore 权限。错误: ${error.message}`, 'error');
                // 停止监听并使用默认配置作为回退
                stopConfigListener();
                renderConfigForm(defaultConfig);
            });
        }
        
        function stopConfigListener() {
            if (unsubscribeConfig) {
                unsubscribeConfig();
                unsubscribeConfig = null;
                console.log("配置监听器已停止。");
            }
        }


        // 页面加载完成后启动
        window.onload = initFirebaseAndAuth;

    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-4 sm:p-8 max-w-4xl">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-extrabold text-indigo-800">雪茄品鉴配置</h1>
            <a href="index.html" class="py-2 px-4 text-sm font-medium rounded-lg bg-indigo-100 text-indigo-600 hover:bg-indigo-200 hover:text-white transition">← 返回主页</a>
        </header>
        
        <div id="error-container">
            </div>

        <section class="mb-8 p-6 bg-white rounded-xl shadow-lg">
             <h2 class="text-xl font-bold text-indigo-700 mb-4">应用基本信息</h2>
             <label class="block mb-4">
                 <span class="text-gray-700 font-medium">应用标题 (App Title)</span>
                 <input type="text" id="app-title-input" class="w-full p-2 border border-gray-300 rounded-md mt-1" oninput="handleInputChange(this)" data-field="appTitle">
             </label>
             <label class="block mb-4">
                 <span class="text-gray-700 font-medium">应用描述 (Description)</span>
                 <textarea id="app-description-input" class="w-full p-2 border border-gray-300 rounded-md mt-1" rows="3" oninput="handleInputChange(this)" data-field="description"></textarea>
             </label>
        </section>


        <form id="config-form">
            <section id="config-form-container" class="space-y-6">
                <div class="p-6 text-center text-gray-500">正在加载配置...</div>
            </section>
        
            <div class="mt-8 pt-4 border-t border-gray-300">
                <button type="button" id="save-button" onclick="saveConfig()" class="w-full py-3 px-4 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    保存配置
                </button>
            </div>
        </form>
    </div>
</body>
</html>
