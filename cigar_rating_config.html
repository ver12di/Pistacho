<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雪茄品鉴配置管理</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/a42b10a2f8.js" crossorigin="anonymous"></script> <!-- Font Awesome for icons -->
    <script>
        // 2. 样式修复：确保 Tailwind 配置块存在
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <script>
        // 请在此处放置您的 Firebase 配置变量
        const __app_id = 'pistacho-b9efe'; 

        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyDC-8qbWsjRyxBzJpfCi9n3ftzdg9FStF0", 
            authDomain: "pistacho-b9efe.firebaseapp.com",
            projectId: "pistacho-b9efe",
            storageBucket: "pistacho-b9efe.firebasestorage.app",
            messagingSenderId: "686695750713",
            appId: "1:686695750713:web:5314331be7b46e93f401e8",
            measurementId: "G-HQS7Q78LY7"
        });
        
        // Canvas 环境提供的初始认证 Token
        const __initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 设置 Firebase 日志级别
        setLogLevel('Debug');

        // 全局变量
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let userId = null;
        let isAuthReady = false;
        let currentConfig = {}; // 存储当前配置数据

        // --- 辅助函数：显示错误消息 ---
        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `
                <div class="p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400" role="alert">
                    <span class="font-medium">错误!</span> ${message}
                </div>
            `;
            // 确保错误消息能显示出来
            console.error("Application Error:", message); 
            // 即使出错也要尝试渲染默认配置，避免卡死
            if (!isAuthReady) {
                 renderConfig(getDefaultConfig());
            }
            setTimeout(() => { container.innerHTML = ''; }, 10000);
        }

        // 辅助函数：显示状态消息
        function showStatus(message, isError = false) {
            const statusElement = document.getElementById('save-status');
            statusElement.className = isError 
                ? 'text-center mt-2 text-sm text-red-500' 
                : 'text-center mt-2 text-sm text-gray-500';
            statusElement.textContent = message;
        }

        /**
         * 检查用户是否已认证，如果未认证，则尝试登录。
         * @param {Object} user Firebase User 对象
         */
        async function handleAuth(user) {
            if (!user) {
                try {
                    if (__initial_auth_token) {
                        // 1. 尝试使用 custom token 登录
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        // 2. 否则，使用匿名登录
                        await signInAnonymously(auth);
                    }
                    // 成功登录后 onAuthStateChanged 会再次触发，本次直接返回
                    return; 
                } catch (error) {
                    console.error("Authentication process failed:", error);
                    showError('用户认证失败，无法连接到云端。');
                    // 认证失败后，渲染默认配置
                    renderConfig(getDefaultConfig()); 
                    return; 
                }
            }
            
            // 认证成功
            userId = user.uid;
            isAuthReady = true;
            
            // 更新用户 ID 显示
            const userInfoEl = document.getElementById('user-info-display');
            userInfoEl.textContent = `当前用户 ID: ${userId.substring(0, 8)}...`;
            userInfoEl.classList.remove('hidden');

            listenToConfig();
        }

        // 认证状态监听
        onAuthStateChanged(auth, handleAuth);


        // --- 配置的实时监听 (onSnapshot) ---
        function listenToConfig() {
            if (!db || !isAuthReady || !userId) {
                // 如果未就绪，则不执行监听
                showError("认证未就绪或用户ID缺失，无法加载配置。");
                return;
            }

            // 配置存储在 private/user/{userId}/config
            const configRef = doc(db, `artifacts/${appId}/users/${userId}`, 'config');
            const configContainer = document.getElementById('config-form-container');


            onSnapshot(configRef, (docSnap) => {
                
                if (docSnap.exists()) {
                    currentConfig = docSnap.data();
                    renderConfig(currentConfig);
                    showStatus("配置已从云端加载", false);
                } else {
                    // 如果文档不存在，则使用默认配置并渲染
                    currentConfig = getDefaultConfig();
                    renderConfig(currentConfig);
                    showStatus("云端配置不存在，已使用默认配置", false);
                }
            }, (error) => {
                console.error("Error listening to config:", error);
                showError("监听配置失败，请检查网络连接或权限。");
                // 确保在出错时，‘正在加载配置’的消息被清除
                configContainer.innerHTML = '<div class="p-6 text-center text-red-500">加载配置失败！请检查错误信息。</div>';
            });
        }

        // --- 默认配置 ---
        function getDefaultConfig() {
            return {
                appTitle: '我的雪茄品鉴评分表',
                description: '用于记录和评估雪茄品鉴体验的自定义评分系统。',
                sections: [
                    { 
                        id: 'appearance', 
                        name: '外观 (Appearance)', 
                        items: [
                            { id: 'wrapper', name: '茄衣颜色/纹理', maxScore: 5 },
                            { id: 'construction', name: '结构/卷制', maxScore: 5 }
                        ],
                        maxScore: 10
                    },
                    { 
                        id: 'prelight', 
                        name: '点燃前 (Pre-light)', 
                        items: [
                            { id: 'draw', name: '通畅度', maxScore: 5 },
                            { id: 'aroma', name: '冷香/气味', maxScore: 5 }
                        ],
                        maxScore: 10
                    },
                    { 
                        id: 'smoking', 
                        name: '品鉴 (Smoking)', 
                        items: [
                            { id: 'flavor', name: '风味复杂度/变化', maxScore: 35 },
                            { id: 'burn', name: '燃烧均匀性', maxScore: 15 },
                            { id: 'balance', name: '平衡感/强度', maxScore: 10 }
                        ],
                        maxScore: 60
                    },
                    { 
                        id: 'overall', 
                        name: '整体评价 (Overall)', 
                        items: [
                            { id: 'finalImpression', name: '最终印象/体验', maxScore: 10 }
                        ],
                        maxScore: 10
                    }
                ]
            };
        }

        // --- 渲染配置表单 ---
        function renderConfig(config) {
            const configContainer = document.getElementById('config-form-container');
            const appTitleInput = document.getElementById('app-title-input');
            const appDescriptionInput = document.getElementById('app-description-input');
            
            // 填充应用基本信息
            appTitleInput.value = config.appTitle || '';
            appDescriptionInput.value = config.description || '';

            let html = '';
            
            // 渲染每个评分部分
            config.sections.forEach((section, sectionIndex) => {
                html += `
                    <section class="p-6 bg-white rounded-xl shadow-lg border border-indigo-100" data-section-id="${section.id}">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="text-lg font-bold text-indigo-600">${section.name}</h3>
                            <div class="text-sm text-gray-500">总分: <span class="font-semibold text-indigo-700">${section.maxScore}</span></div>
                        </div>

                        <label class="block mb-4">
                            <span class="text-gray-700 font-medium">部分标题 (Section Title)</span>
                            <input type="text" 
                                class="w-full p-2 border border-gray-300 rounded-md mt-1" 
                                value="${section.name}" 
                                oninput="handleInputChange(this)" 
                                data-field="sections.${sectionIndex}.name">
                        </label>
                        
                        <h4 class="text-md font-semibold mt-6 mb-3 text-gray-800">评分项目</h4>
                        <div class="space-y-3">
                `;

                // 渲染每个评分项目
                section.items.forEach((item, itemIndex) => {
                    html += `
                        <div class="flex space-x-3 items-end p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <div class="flex-1">
                                <label class="block">
                                    <span class="text-gray-600 text-sm">项目名称</span>
                                    <input type="text" 
                                        class="w-full p-2 border border-gray-300 rounded-md mt-1 text-sm" 
                                        value="${item.name}" 
                                        oninput="handleInputChange(this)" 
                                        data-field="sections.${sectionIndex}.items.${itemIndex}.name">
                                </label>
                            </div>
                            <div class="w-24">
                                <label class="block">
                                    <span class="text-gray-600 text-sm">最高分</span>
                                    <input type="number" 
                                        class="w-full p-2 border border-gray-300 rounded-md mt-1 text-sm text-right" 
                                        value="${item.maxScore}" 
                                        min="1" 
                                        oninput="handleMaxScoreChange(this)" 
                                        data-field="sections.${sectionIndex}.items.${itemIndex}.maxScore">
                                </label>
                            </div>
                            <button type="button" onclick="removeItem(${sectionIndex}, ${itemIndex})" class="p-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-150 shadow-md flex-shrink-0" title="删除项目">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                });

                // 添加新项目按钮
                html += `
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <button type="button" onclick="addItem(${sectionIndex})" class="w-full py-2 bg-indigo-100 text-indigo-600 font-semibold rounded-lg hover:bg-indigo-200 transition duration-150 flex items-center justify-center">
                                <i class="fas fa-plus mr-2"></i> 添加新评分项目
                            </button>
                        </div>
                    </section>
                `;
            });
            
            configContainer.innerHTML = html;
            calculateTotalScore();
        }

        // --- 数据变更处理 ---
        window.handleInputChange = function(element) {
            const fieldPath = element.getAttribute('data-field');
            const value = element.value;
            
            // 使用 Lodash-style path (e.g., 'sections.0.name' or 'appTitle') 来更新 currentConfig
            let obj = currentConfig;
            const parts = fieldPath.split('.');
            
            for (let i = 0; i < parts.length; i++) {
                const part = parts[i];
                if (i === parts.length - 1) {
                    obj[part] = value;
                } else {
                    // 处理数组索引
                    if (!isNaN(parseInt(parts[i+1]))) {
                        const index = parseInt(parts[i+1]);
                        obj = obj[part][index];
                        i++; // 跳过索引部分
                    } else {
                        obj = obj[part];
                    }
                }
            }
            showStatus("配置已更改，请点击保存同步到云端");
        }
        
        window.handleMaxScoreChange = function(element) {
            let value = parseInt(element.value);
            if (isNaN(value) || value < 1) {
                value = 1;
                element.value = 1;
            }
            
            const fieldPath = element.getAttribute('data-field');
            const parts = fieldPath.split('.');
            const sectionIndex = parseInt(parts[1]);
            const itemIndex = parseInt(parts[3]);
            
            // 更新当前配置
            currentConfig.sections[sectionIndex].items[itemIndex].maxScore = value;
            
            calculateTotalScore();
            showStatus("配置已更改，请点击保存同步到云端");
        }

        // --- 动态计算总分和部分总分 ---
        function calculateTotalScore() {
            let totalMaxScore = 0;
            
            currentConfig.sections.forEach(section => {
                let sectionMaxScore = section.items.reduce((sum, item) => sum + (item.maxScore || 0), 0);
                section.maxScore = sectionMaxScore;
                totalMaxScore += sectionMaxScore;
            });
            
            document.getElementById('total-score').textContent = totalMaxScore;
            
            // 重新渲染以更新各部分的 maxScore 显示
            // 注意: 在输入变化时频繁调用 renderConfig 可能会导致性能问题，
            // 但为了确保 Section Max Score 及时更新，暂时保留。
            // 更好的做法是只更新 DOM 中 Max Score 的部分。
            // renderConfig(currentConfig); 
        }

        // --- 增删项目逻辑 ---
        window.addItem = function(sectionIndex) {
            const newId = `item_${Date.now()}`;
            const newItem = { id: newId, name: '新评分项', maxScore: 5 };
            
            currentConfig.sections[sectionIndex].items.push(newItem);
            renderConfig(currentConfig);
            calculateTotalScore();
            showStatus("已添加新项目，请点击保存同步到云端");
        }

        window.removeItem = function(sectionIndex, itemIndex) {
            // 使用自定义的模态框代替 window.confirm
            showCustomModal('确认删除', '您确定要删除此评分项目吗？', () => {
                currentConfig.sections[sectionIndex].items.splice(itemIndex, 1);
                renderConfig(currentConfig);
                calculateTotalScore();
                showStatus("项目已删除，请点击保存同步到云端");
                hideCustomModal();
            });
        }


        // --- 保存配置 (Save) ---
        window.saveConfig = async function() {
            if (!db || !isAuthReady || !userId) {
                showError("云端服务未就绪，请稍候或刷新页面。");
                return;
            }
            
            const saveButton = document.getElementById('save-button');
            saveButton.disabled = true;
            showStatus("正在保存中...");

            // 配置存储在 private/user/{userId}/config
            const configRef = doc(db, `artifacts/${appId}/users/${userId}`, 'config');
            
            // 最终检查并清理数据
            const dataToSave = JSON.parse(JSON.stringify(currentConfig)); // 深拷贝
            dataToSave.sections.forEach(section => {
                section.items.forEach(item => {
                    // 确保分数是数字
                    item.maxScore = parseInt(item.maxScore) || 1; 
                });
            });

            try {
                await setDoc(configRef, dataToSave, { merge: true });
                showStatus("保存成功！已同步到云端。", false);
            } catch (error) {
                console.error("Error saving config:", error);
                showError(`保存失败: ${error.message}`);
            } finally {
                saveButton.disabled = false;
            }
        }

        // --- 自定义模态框 (替代 alert/confirm) ---
        function showCustomModal(title, message, onConfirm) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            
            const confirmBtn = document.getElementById('modal-confirm-btn');
            confirmBtn.onclick = onConfirm;

            modal.classList.remove('hidden');
        }

        window.hideCustomModal = function() {
            document.getElementById('custom-modal').classList.add('hidden');
        }

        // 绑定回车键触发保存 (可选)
        document.addEventListener('keydown', function(event) {
            if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                event.preventDefault();
                document.getElementById('save-button').click();
            }
        });
    </script>
</head>
<body class="bg-gray-100 min-h-screen">

    <header class="bg-indigo-600 shadow-md p-4 sticky top-0 z-10">
        <div class="container mx-auto max-w-4xl flex justify-between items-center">
            <h1 class="text-2xl font-extrabold text-white">雪茄品鉴配置管理</h1>
            <div class="flex items-center space-x-3">
                 <span id="user-info-display" class="text-white text-xs bg-indigo-500 px-2 py-1 rounded-full hidden">
                    <!-- 用户 ID 信息将由 JS 填充 -->
                 </span>
                <a href="index.html" class="px-3 py-1 bg-white/20 rounded-lg text-white text-sm hover:bg-indigo-700 hover:text-white transition">← 返回主页</a>
            </div>
        </div>
    </header>

    <!-- 主内容区域, 增加底部内边距以避免被固定底部遮挡 -->
    <main class="container mx-auto p-4 pb-28 max-w-4xl">
        
        <div id="error-container">
            </div>

        <section class="mb-8 p-6 bg-white rounded-xl shadow-lg">
             <h2 class="text-xl font-bold text-indigo-700 mb-4">应用基本信息</h2>
             <label class="block mb-4">
                 <span class="text-gray-700 font-medium">应用标题 (App Title)</span>
                 <input type="text" id="app-title-input" class="w-full p-2 border border-gray-300 rounded-md mt-1" oninput="handleInputChange(this)" data-field="appTitle">
             </label>
             <label class="block mb-4">
                 <span class="text-gray-700 font-medium">应用描述 (Description)</span>
                 <textarea id="app-description-input" class="w-full p-2 border border-gray-300 rounded-md mt-1" rows="3" oninput="handleInputChange(this)" data-field="description"></textarea>
             </label>
        </section>


        <form id="config-form">
            <h2 class="text-2xl font-bold text-indigo-700 mb-6">评分细则配置 (总分: <span id="total-score" class="text-red-500">100</span>)</h2>
            
            <section id="config-form-container" class="space-y-6">
                <!-- 配置内容将由 JavaScript 渲染 -->
                <div class="p-6 text-center text-gray-500">正在加载配置...</div>
            </section>
        
            <!-- 原始的保存按钮区域已移除 -->
        </form>

    </main>
    
    <!-- Fixed Footer for Save Button - 固定在页面底部 -->
    <div id="fixed-save-footer" class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-300 shadow-2xl z-50">
        <div class="container mx-auto max-w-4xl">
            <!-- Save Button and Status -->
            <button type="button" id="save-button" onclick="saveConfig()" class="w-full py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-xl hover:bg-indigo-700 transition duration-150 disabled:bg-indigo-400">
                <i class="fas fa-cloud-upload-alt mr-2"></i> 保存同步到云端
            </button>
            <p id="save-status" class="text-center mt-2 text-sm text-gray-500">按 Ctrl+S/Cmd+S 快速保存</p>
        </div>
    </div>


    <!-- 自定义模态框 (Confirm替代品) -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center z-[100]">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm m-4">
            <h3 id="modal-title" class="text-lg font-bold mb-4 text-gray-800"></h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button onclick="hideCustomModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">
                    取消
                </button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition shadow-md">
                    确认
                </button>
            </div>
        </div>
    </div>
</body>
</html>
