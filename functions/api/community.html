<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pistacho 评分社区</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/i18next/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-http-backend/i18nextHttpBackend.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector/i18nextBrowserLanguageDetector.min.js"></script>
    
    <script>
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: {
                            sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
                        },
                    }
                }
            }
        } else {
            console.warn('Tailwind object not found. Skipping config.');
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/masonry/4.2.2/masonry.pkgd.min.js" integrity="sha512-NrSOvoRT3VoF8AhlXBOhDLaBFVfB/iN5xefpXkUaU/L/Y2R5jL/btbQVpabMvM1EBlEqxAcU1N0isj1XhKQr1g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        /* ... (Your Masonry styles remain) ... */
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">

    <div id="app-container" class="max-w-7xl mx-auto p-4 md:p-8">
        
        <nav class="mb-4 flex flex-wrap justify-between items-center bg-white p-3 rounded-lg shadow-sm">
             <a href="index.html" class="text-xl font-bold text-indigo-600" data-i18n="nav.title">Pistacho评分</a>
             <div class="flex items-center space-x-4">
                 <a href="community.html" class="text-indigo-600 font-bold underline" data-i18n="nav.community">社区动态</a>
                 <a href="history.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.myRatings">历史记录</a>
                 <a href="certified.html" class="text-gray-600 hover:text-indigo-600" data-i18n="nav.certified">认证评分</a>
                 <select id="language-switcher" class="text-xs p-1 rounded border border-gray-300 mr-2" style="height: 30px; line-height: 1.5;">
                    <option value="zh">简体中文</option>
                    <option value="en">English</option>
                    <option value="es">Español</option>
                </select>
             </div>
        </nav>

        <header class="mb-6">
            <h1 class="text-4xl font-extrabold text-gray-800" data-i18n="communityPage.headerTitle">社区动态</h1>
            <p class="mt-2 text-lg text-gray-600" data-i18n="communityPage.headerDescription">查看来自所有用户的最新评分。</p>
        </header>

        <div class="mb-6 p-4 bg-white rounded-lg shadow-sm flex flex-col sm:flex-row gap-4">
            <div class="flex-grow">
                <label for="search-input" class="block text-sm font-medium text-gray-700" data-i18n="communityPage.searchLabel">搜索雪茄或用户</label>
                <input type="text" id="search-input" oninput="window.filterAndRender()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" data-i18n="communityPage.searchPlaceholder" placeholder="例如：D5 或 diuser">
            </div>
            <div class="flex-shrink-0">
                <label for="sort-select" class="block text-sm font-medium text-gray-700" data-i18n="communityPage.sortLabel">排序方式</label>
                <select id="sort-select" onchange="window.filterAndRender()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    <option value="newest" data-i18n="indexPage.sortLatest">最新发布</option>
                    <option value="highest" data-i18n="indexPage.sortHighest">分数最高</option>
                    <option value="lowest" data-i18n="indexPage.sortLowest">分数最低</option>
                </select>
            </div>
        </div>

        <div id="loading-indicator" class="text-center p-10 text-gray-500">
            <p data-i18n="communityPage.loadingFeed">正在加载评分动态...</p>
        </div>
        <div id="grid-container" class="mx-auto" style="opacity: 0; transition: opacity 0.5s ease-in-out;">
            <div class="grid-sizer"></div>
        </div>

    </div>

    <script type="module">
        // --- **NEW**: i18n Initialization Functions ---
        
        async function initI18n() {
            await i18next
                .use(i18nextHttpBackend)
                .use(i18nextBrowserLanguageDetector)
                .init({
                    fallbackLng: 'zh',
                    debug: true,
                    ns: ['translation'],
                    defaultNS: 'translation',
                    backend: {
                        loadPath: '/locales/{{lng}}.json'
                    },
                    detection: {
                        order: ['localStorage', 'navigator'],
                        caches: ['localStorage']
                    }
                });
            document.title = i18next.t('communityPage.pageTitle');
            updateContent(); // Initial content update
        }

        function updateContent() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const value = i18next.t(key);
                if (el.tagName === 'INPUT' && el.hasAttribute('placeholder')) {
                    el.placeholder = value;
                } else if (el.tagName === 'BUTTON' || el.tagName === 'OPTION') {
                     el.textContent = value;
                }
                 else {
                    el.innerHTML = value;
                }
            });
        }

        function setupLanguageSwitcher() {
            const switcher = document.getElementById('language-switcher');
            if (!switcher) return;
            const currentLang = i18next.language.split('-')[0];
            if ([...switcher.options].some(opt => opt.value === currentLang)) {
                switcher.value = currentLang;
            } else {
                switcher.value = i18next.options.fallbackLng[0];
            }
            switcher.addEventListener('change', async (e) => {
                await i18next.changeLanguage(e.target.value);
                updateContent();
                document.title = i18next.t('communityPage.pageTitle');
                // Re-render grid
                filterAndRender();
            });
        }
        
        // --- 全局变量 ---
        let allRatings = []; 
        let masonry; 
        const gridContainer = document.getElementById('grid-container');
        const loadingIndicator = document.getElementById('loading-indicator');

        // --- 核心功能 ---

        /**
         * 1. 页面加载时获取所有评分
         */
        window.onload = async function() {
            // **NEW**: 1. Initialize i18n
            await initI18n();

            try {
                const response = await fetch('/api/ratings');
                if (!response.ok) {
                    throw new Error(i18next.t('errors.apiError', { status: response.statusText }));
                }
                const ratings = await response.json();
                allRatings = ratings.filter(r => r.cigarName && r.normalizedScore !== undefined);
                
                if (allRatings.length === 0) {
                    loadingIndicator.textContent = i18next.t('common.noPublicRatings');
                    return;
                }
                
                sortRatings("newest");
                renderGrid(allRatings);

            } catch (error) {
                console.error("加载评分失败:", error);
                loadingIndicator.innerHTML = `<p class="text-red-500">${i18next.t('errors.loadFailed', { msg: error.message })}</p>`;
            }
            
            // **NEW**: 2. Setup switcher at the end
            setupLanguageSwitcher();
        };

        /**
         * 2. 过滤并渲染网格
         */
        window.filterAndRender = function() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const sortValue = document.getElementById('sort-select').value;
            let filteredRatings = allRatings.filter(rating => {
                const nameMatch = rating.cigarName?.toLowerCase().includes(searchTerm);
                const userMatch = rating.userNickname?.toLowerCase().includes(searchTerm);
                return nameMatch || userMatch;
            });
            sortRatings(sortValue, filteredRatings);
            renderGrid(filteredRatings);
        }
        
        /**
         * 3. 渲染瀑布流网格
         */
        function renderGrid(ratingsToShow) {
            if (!gridContainer) return;
            gridContainer.innerHTML = '<div class="grid-sizer"></div>'; 
            if (ratingsToShow.length === 0) {
                 loadingIndicator.textContent = i18next.t('common.noMatch');
                 loadingIndicator.style.display = 'block';
                 if(masonry) masonry.destroy();
                 masonry = null;
                 return;
            }
            loadingIndicator.style.display = 'none';
            gridContainer.style.opacity = 1;
            const fragment = document.createDocumentFragment();
            ratingsToShow.forEach(rating => {
                const card = document.createElement('div');
                card.className = 'grid-item bg-white shadow-lg';
                card.innerHTML = createCardHTML(rating);
                card.onclick = () => viewRatingDetails(rating.id);
                fragment.appendChild(card);
            });
            gridContainer.appendChild(fragment);
            if (masonry) {
                masonry.reloadItems();
                masonry.layout();
            } else {
                masonry = new Masonry(gridContainer, {
                    itemSelector: '.grid-item',
                    columnWidth: '.grid-sizer',
                    percentPosition: true,
                    gutter: 20
                });
            }
        }

        /**
         * 4. 创建单个评分卡的 HTML
         * **MODIFIED**: Uses i18next.t()
         */
        function createCardHTML(rating) {
            const date = formatDate(rating.timestamp);
            const author = rating.userNickname || i18next.t('common.anonymous');
            const grade = rating.finalGrade_grade || 'N/A';
            // **MODIFIED**: Need to get translated grade name
            // This is tricky as GRADING_SCALE isn't defined here.
            // We'll just use the name_cn or a fallback.
            // For full i18n, GRADING_SCALE should be defined here too.
            const gradeName = rating.finalGrade_name_cn || i18next.t('common.unrated');
            const score = rating.normalizedScore?.toFixed(2) || '0.00';
            
            const imageUrl = rating.imageUrl 
                ? `/api/image/${rating.imageUrl}` 
                : `https://placehold.co/600x400/94a3b8/ffffff?text=${encodeURIComponent(rating.cigarName)}`;
            const placeholder = `https://placehold.co/600x400/94a3b8/ffffff?text=${encodeURIComponent(rating.cigarName)}`;

            const cigarName = rating.cigarName || i18next.t('common.unnamed');
            const cigarSize = rating.cigarSize || i18next.t('common.unknown');
            const cigarOrigin = rating.cigarOrigin || i18next.t('common.unknown');
            const cigarReview = rating.cigarReview || i18next.t('common.noReview');

            return `
                <a href="#" class="block cursor-pointer">
                    <img 
                        src="${imageUrl}" 
                        alt="${cigarName}" 
                        class="w-full h-auto object-cover"
                        onerror="this.onerror=null; this.src='${placeholder}';"
                    >
                    <div class="p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-3xl font-black text-indigo-600">${score}</span>
                            <span class="text-right">
                                <span class="block text-lg font-bold text-indigo-600">${grade}</span>
                                <span class="block text-sm text-gray-500">${gradeName}</span>
                            </span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900">${cigarName}</h3>
                        <p class="text-sm text-gray-500 mb-3">${cigarSize} | ${cigarOrigin}</p>
                        <p class="text-gray-700 text-sm mb-4">${cigarReview}</p>
                        <div class="border-t pt-2 text-xs text-gray-400">
                            <span>${i18next.t('common.by')} <strong>${author}</strong></span>
                            <span class="float-right">${date}</span>
                        </div>
                    </div>
                </a>
            `;
        }
        
        // --- 辅助工具 ---
        
        function sortRatings(sortBy, arrayToSort) { /* ... (no changes needed) ... */ }

        // **MODIFIED**: Uses i18n
        function formatDate(isoString) {
            if (!isoString) return i18next.t('common.unknownDate');
            try {
                // Use i18next.language to format date correctly
                const lang = i18next.language || 'zh-CN';
                return new Date(isoString).toLocaleDateString(lang, {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            } catch (e) {
                return i18next.t('common.invalidDate');
            }
        }
        
        // **MODIFIED**: Uses i18n
        window.viewRatingDetails = function(ratingId) {
            const ratingData = allRatings.find(r => r.id === ratingId);
            if (ratingData) {
                const resultsData = ratingData.fullData; 
                if (resultsData && resultsData.config && resultsData.ratings) {
                    resultsData.isDraft = false; 
                    sessionStorage.setItem('cigarRatingResults', JSON.stringify(resultsData));
                    window.location.href = 'results.html';
                } else {
                    alert(i18next.t('errors.loadFullDetailsFailed'));
                    console.warn("缺少 fullData: ", ratingData);
                }
            } else {
                alert(i18next.t('errors.loadDetailsFailed'));
            }
        }

    </script>
</body>
</html>